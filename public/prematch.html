<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prematch - FSCOREBOARD</title>
    <style>
        @font-face {
            font-family: 'RPL';
            src: url('/public/fonts/RPL.ttf') format('truetype');
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background: transparent;
            font-family: 'RPL', Arial, sans-serif;
        }

        .prematch-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.1s ease-in;
        }

        body.elements-loaded .prematch-container {
            opacity: 1;
        }

        .image-container {
            position: absolute;
            bottom: 220px;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            height: auto;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stripe-image {
            width: auto;
            height: auto;
            max-width: none;
            max-height: none;
            display: block;
        }

        .team1-logo {
            position: absolute;
            width: 250px;
            height: 250px;
            object-fit: contain;
            z-index: 2;
            left: 0;
            top: 0;
        }

        .team2-logo {
            position: absolute;
            width: 250px;
            height: 250px;
            object-fit: contain;
            z-index: 2;
            left: 0;
            top: 0;
        }

        .team1-info {
            position: absolute;
            left: 0;
            top: 0;
            text-align: center;
            color: white;
            z-index: 2;
            width: 520px;
        }

        .team2-info {
            position: absolute;
            left: 0;
            top: 0;
            text-align: center;
            color: white;
            z-index: 2;
            width: 520px;
        }

        .team-name {
            font-size: 35px;
            font-weight: bold;
            margin-bottom: 10px;
            white-space: nowrap;
        }

        .team-city {
            font-size: 25px;
            font-weight: normal;
            white-space: nowrap;
        }

        /* Фиксированные размеры - без адаптивности */
    </style>
</head>
<body>
    <div class="prematch-container">
        <!-- Контейнер изображения с привязанными элементами -->
        <div class="image-container">
            <!-- Фоновое изображение -->
            <img src="/public/img/stripe_default.png" alt="Prematch Stripe" class="stripe-image" id="stripeImage">
            
            <!-- Логотип команды 1 -->
            <img id="team1Logo" src="" alt="Team 1 Logo" class="team1-logo" style="display: none;">
            
            <!-- Логотип команды 2 -->
            <img id="team2Logo" src="" alt="Team 2 Logo" class="team2-logo" style="display: none;">
            
            <!-- Информация о команде 1 -->
            <div class="team1-info">
                <div id="team1Name" class="team-name">Команда 1</div>
                <div id="team1City" class="team-city">Город 1</div>
            </div>
            
            <!-- Информация о команде 2 -->
            <div class="team2-info">
                <div id="team2Name" class="team-name">Команда 2</div>
                <div id="team2City" class="team-city">Город 2</div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Подключение к WebSocket
        const socket = io();

        // Элементы DOM
        const team1NameEl = document.getElementById('team1Name');
        const team1CityEl = document.getElementById('team1City');
        const team1LogoEl = document.getElementById('team1Logo');
        const team2NameEl = document.getElementById('team2Name');
        const team2CityEl = document.getElementById('team2City');
        const team2LogoEl = document.getElementById('team2Logo');
        const stripeImage = document.getElementById('stripeImage');

        // Load graphic style from config
        async function loadGraphicStyle() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const config = await response.json();
                    const style = config.graphicStyle || 'default';
                    const customStyleData = config.customStyleData || null;
                    console.log('Loaded graphic style from config:', style);
                    applyGraphicStyle(style, customStyleData);
                } else {
                    console.error('Failed to load config:', response.status);
                    applyGraphicStyle('default', null);
                }
            } catch (error) {
                console.error('Error loading graphic style:', error);
                applyGraphicStyle('default', null);
            }
        }

        // Apply graphic style
        function applyGraphicStyle(style, customStyleData) {
            console.log('Applying graphic style:', style, customStyleData);
            if (style === 'iskracup') {
                if (stripeImage) {
                    stripeImage.src = '/public/img/iskracup_stripe_prematch.png';
                }
            } else if (style === 'winterleague') {
                if (stripeImage) {
                    stripeImage.src = '/public/img/winterleague_stripe_prematch.png';
                }
            } else if (style && style.startsWith('custom:') && customStyleData) {
                // Apply custom style
                if (stripeImage) {
                    if (customStyleData.prematchStripe) {
                        stripeImage.src = customStyleData.prematchStripe;
                    } else {
                        stripeImage.src = '/public/img/stripe_default.png';
                    }
                }
            } else {
                if (stripeImage) {
                    stripeImage.src = '/public/img/stripe_default.png';
                }
            }
        }

        // Обработка обновлений от сервера
        socket.on('scoreboardUpdate', function(data) {
            updateDisplay(data);
        });

        // Функция обновления отображения
        function updateDisplay(data) {
            // Обновляем названия команд
            if (data.team1Name) {
                team1NameEl.textContent = data.team1Name;
            }
            if (data.team1City) {
                team1CityEl.textContent = data.team1City;
            }
            if (data.team2Name) {
                team2NameEl.textContent = data.team2Name;
            }
            if (data.team2City) {
                team2CityEl.textContent = data.team2City;
            }

            // Обновляем логотипы
            if (data.team1Logo && data.team1Logo !== '') {
                team1LogoEl.src = data.team1Logo;
                team1LogoEl.style.display = 'block';
            } else {
                team1LogoEl.style.display = 'none';
            }

            if (data.team2Logo && data.team2Logo !== '') {
                team2LogoEl.src = data.team2Logo;
                team2LogoEl.style.display = 'block';
            } else {
                team2LogoEl.style.display = 'none';
            }
            
            // Автоматически подстраиваем размер шрифта
            const team1Info = document.querySelector('.team1-info');
            const team2Info = document.querySelector('.team2-info');
            if (team1Info) adjustFontSize(team1Info);
            if (team2Info) adjustFontSize(team2Info);
        }

        // Функция позиционирования логотипов и текстовых блоков
        function positionLogos() {
            const team1Info = document.querySelector('.team1-info');
            const team2Info = document.querySelector('.team2-info');
            
            if (stripeImage && team1LogoEl && team2LogoEl && team1Info && team2Info) {
                // Получаем размеры изображения
                const imageWidth = stripeImage.offsetWidth;
                const imageHeight = stripeImage.offsetHeight;
                
                console.log('Image dimensions:', imageWidth, 'x', imageHeight);
                
                // Вычисляем центр изображения
                const imageCenterX = imageWidth / 2; // Центр по ширине
                const imageCenterY = imageHeight / 2; // Центр по высоте
                
                // Позиционируем логотипы: ±759px от центра изображения
                const leftLogoX = imageCenterX - 759 - 125; // Центр - 759px - половина логотипа
                const leftLogoY = imageCenterY - 125; // Центр по высоте - половина логотипа
                team1LogoEl.style.left = leftLogoX + 'px';
                team1LogoEl.style.top = leftLogoY + 'px';
                
                const rightLogoX = imageCenterX + 759 - 125; // Центр + 759px - половина логотипа
                const rightLogoY = imageCenterY - 125; // Центр по высоте - половина логотипа
                team2LogoEl.style.left = rightLogoX + 'px';
                team2LogoEl.style.top = rightLogoY + 'px';
                
                // Позиционируем текстовые блоки: смещение на 365px от центра
                const leftTextX = imageCenterX - 365 - 260; // Центр - 365px - половина ширины блока (260px)
                const leftTextY = imageCenterY - 30; // Центр по высоте - 30px (сдвиг на 10px вниз)
                team1Info.style.left = leftTextX + 'px';
                team1Info.style.top = leftTextY + 'px';
                
                const rightTextX = imageCenterX + 365 - 260; // Центр + 365px - половина ширины блока (260px)
                const rightTextY = imageCenterY - 30; // Центр по высоте - 30px (сдвиг на 10px вниз)
                team2Info.style.left = rightTextX + 'px';
                team2Info.style.top = rightTextY + 'px';
                
                console.log('Image center:', imageCenterX, imageCenterY);
                console.log('Left logo position:', leftLogoX, leftLogoY);
                console.log('Right logo position:', rightLogoX, rightLogoY);
                console.log('Left text position:', leftTextX, leftTextY);
                console.log('Right text position:', rightTextX, rightTextY);
            }
        }

        // Функция автоматического уменьшения шрифта для текстовых блоков
        function adjustFontSize(teamInfo) {
            const teamName = teamInfo.querySelector('.team-name');
            const teamCity = teamInfo.querySelector('.team-city');
            
            if (teamName && teamCity) {
                // Стандартные размеры (уменьшенные)
                let nameSize = 35;
                let citySize = 25;
                
                // Проверяем, помещается ли текст
                teamName.style.fontSize = nameSize + 'px';
                teamCity.style.fontSize = citySize + 'px';
                
                // Уменьшаем шрифт пока текст не поместится (более агрессивно)
                while ((teamName.scrollWidth > teamInfo.offsetWidth || teamCity.scrollWidth > teamInfo.offsetWidth) && nameSize > 12) {
                    nameSize -= 0.5; // Уменьшаем на 0.5px для более точной подгонки
                    citySize -= 0.5;
                    teamName.style.fontSize = nameSize + 'px';
                    teamCity.style.fontSize = citySize + 'px';
                }
            }
        }

        // Запрос текущего состояния при загрузке страницы
        socket.emit('getCurrentState');
        
        socket.on('currentState', function(data) {
            updateDisplay(data);
        });

        // Ждем загрузки всех изображений перед показом элементов
        function waitForElements() {
            const images = [];
            
            // Проверяем stripe изображение
            if (stripeImage && stripeImage.src) {
                const img = new Image();
                img.src = stripeImage.src;
                images.push(new Promise((resolve) => {
                    img.onload = resolve;
                    img.onerror = resolve;
                }));
            }
            
            // Проверяем возможные stripe изображения из стилей
            const possibleStripes = [
                '/public/img/stripe_default.png',
                '/public/img/iskracup_stripe_prematch.png',
                '/public/img/winterleague_stripe_prematch.png'
            ];
            
            possibleStripes.forEach(src => {
                const img = new Image();
                img.src = src;
                images.push(new Promise((resolve) => {
                    img.onload = resolve;
                    img.onerror = resolve;
                }));
            });
            
            Promise.all(images).then(() => {
                // Все элементы загружены, показываем все разом
                document.body.classList.add('elements-loaded');
                // Позиционируем логотипы после показа
                positionLogos();
            });
        }

        // Позиционируем логотипы после загрузки изображения
        if (stripeImage) {
            stripeImage.addEventListener('load', function() {
                console.log('Stripe image loaded, positioning logos...');
                positionLogos();
                waitForElements();
            });
            
            // Если изображение уже загружено
            if (stripeImage.complete) {
                console.log('Stripe image already loaded, positioning logos...');
                positionLogos();
                waitForElements();
            } else {
                // Если изображение еще не загружено, ждем его
                waitForElements();
            }
        } else {
            waitForElements();
        }

        // Позиционируем логотипы при изменении размера окна
        window.addEventListener('resize', positionLogos);

        // Listen for config updates
        socket.on('configUpdate', (data) => {
            console.log('Received configUpdate event:', data);
            if (data.graphicStyle) {
                console.log('Updating graphic style to:', data.graphicStyle);
                applyGraphicStyle(data.graphicStyle, data.customStyleData || null);
                // Перепозиционируем элементы после смены изображения
                if (stripeImage) {
                    stripeImage.addEventListener('load', positionLogos, { once: true });
                }
            }
        });

        // Load style on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadGraphicStyle);
        } else {
            loadGraphicStyle();
        }
    </script>
</body>
</html>
