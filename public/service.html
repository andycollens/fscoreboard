<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service ‚Äî –°–æ—Å—Ç–∞–≤—ã –∫–æ–º–∞–Ω–¥</title>
    <style>
        @font-face {
            font-family: 'RPL';
            src: url('/public/fonts/RPL.ttf') format('truetype');
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background: transparent;
            font-family: 'RPL', Arial, sans-serif;
            overflow: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url('/public/img/memberspage_bg.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            opacity: 0.9375;
            z-index: -2;
            clip-path: inset(0 0 100% 0);
            animation: none;
        }

        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: -1;
            clip-path: inset(0 0 100% 0);
            animation: none;
        }

        body.background-loaded::before,
        body.background-loaded::after {
            animation: slideDownBackground 0.5s ease-out forwards;
        }

        @keyframes slideDownBackground {
            from {
                clip-path: inset(0 0 100% 0);
            }
            to {
                clip-path: inset(0 0 0 0);
            }
        }

        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: -1;
        }

        body.rosters-mode,
        body.rosters-mode #scoreboardMode {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .stadium-container {
            position: fixed;
            inset: 0;
            display: grid !important;
            grid-template-rows: 30px 320px 1fr;
            min-height: 0;
            height: 100vh;
            width: 100vw;
            background: transparent;
            opacity: 0;
            animation: none;
        }

        body.content-ready .stadium-container {
            animation: fadeInContent 0.4s ease-in 0.5s forwards;
        }

        @keyframes fadeInContent {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .top-section {
            display: block !important;
            height: 30px;
            width: 100%;
            background: transparent;
        }

        .tournament-title {
            display: none !important;
        }

        .rosters-subtitle {
            display: none !important;
        }

        .middle-section {
            display: grid !important;
            grid-template-columns: 1fr 1fr;
            height: 320px;
            min-height: 0;
            width: 100%;
            background: transparent;
            gap: 0;
            overflow: hidden;
        }

        .middle-content {
            display: grid !important;
            grid-template-columns: 1fr auto 1fr;
            width: 100%;
            height: 100%;
            min-height: 0;
            padding: 0;
            box-sizing: border-box;
            gap: 0;
            grid-column: 1 / -1;
            align-items: center;
        }
        .middle-content .team1-section { grid-column: 1; padding-left: 80px; }
        .middle-content .jingle-player-block { grid-column: 2; align-self: flex-start; }
        .middle-content .team2-section { grid-column: 3; padding-right: 80px; }

        .team-penalty-track {
            display: none !important;
        }

        .score1-section,
        .score2-section {
            display: none !important;
        }

        .team1-score,
        .team2-score {
            display: none !important;
        }

        .team1-section {
            display: flex !important;
            flex-direction: row;
            align-items: center;
            justify-content: flex-end;
            gap: clamp(12px, 2vw, 28px);
            min-width: 0;
            min-height: 0;
        }
        .team2-section {
            display: flex !important;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: clamp(12px, 2vw, 28px);
            min-width: 0;
            min-height: 0;
        }
        .team1-meta { order: 1; justify-content: flex-end; text-align: right; flex-shrink: 0; }
        .team1-logo-wrap { order: 2; }
        .team2-logo-wrap { order: 1; }
        .team2-meta { order: 2; justify-content: flex-start; text-align: left; flex-shrink: 0; }

        .team1-logo-wrap,
        .team2-logo-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .jingle-select-row {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        .team1-logo,

        .team2-logo,
        .team1-no-logo,
        .team2-no-logo {
            width: 200px;
            height: 200px;
            flex-shrink: 0;
        }
        .middle-section .team1-logo,
        .middle-section .team2-logo,
        .middle-section .team1-no-logo,
        .middle-section .team2-no-logo {
            width: 170px;
            height: 170px;
        }

        .team1-logo,
        .team2-logo {
            object-fit: contain;
            display: none;
        }

        .team1-logo.show,
        .team2-logo.show {
            display: block;
        }

        .team1-no-logo,
        .team2-no-logo {
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4vw;
            color: #fff;
            font-weight: bold;
        }

        .team1-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0;
            min-width: 0;
            text-align: right;
        }

        .team1-meta .team1-name {
            margin-bottom: 1vh;
        }

        .team1-meta .team1-city {
            margin-top: 0;
            align-self: flex-end;
        }

        .team2-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0;
            min-width: 0;
            text-align: left;
        }

        .team2-meta .team2-name {
            margin-bottom: 1vh;
        }

        .team2-meta .team2-city {
            margin-top: 0;
            align-self: flex-start;
        }

        .team1-name,
        .team2-name {
            font-size: 3vw;
            margin: 0;
            margin-top: 40px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #fff;
        }

        .team1-stripe,
        .team2-stripe {
            width: clamp(60px, 8vw, 140px);
            height: clamp(8px, 0.6vw, 14px);
            margin: 0;
            opacity: 1 !important;
            display: none !important;
        }

        .team1-city,
        .team2-city {
            font-size: 2.5vw;
            margin: 0;
            margin-top: 40px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #fff;
        }

        .bottom-section {
            display: grid !important;
            grid-template-columns: 1fr auto 1fr;
            width: 100%;
            height: 100%;
            background: transparent;
            overflow: hidden;
            gap: 0;
        }

        .roster-team1,
        .roster-team2 {
            display: flex !important;
            position: relative !important;
            visibility: visible !important;
            pointer-events: auto !important;
            flex-direction: column;
            width: 100%;
            height: 100%;
            min-width: 0;
            min-height: 0;
            padding: 2vh 2vw;
            box-sizing: border-box;
            overflow: hidden;
        }

        .roster-team1 {
            grid-column: 1;
            align-items: flex-start;
            padding-left: 80px;
        }

        .roster-divider {
            grid-column: 2;
            display: flex !important;
            position: relative !important;
            visibility: visible !important;
            pointer-events: auto !important;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 100%;
            z-index: 10;
        }

        .roster-colon {
            width: 8px;
            height: 80%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0) 0%, #ffffff 50%, rgba(255, 255, 255, 0) 100%);
            border-radius: 8px;
            opacity: 1;
        }

        .roster-team2 {
            grid-column: 3;
            align-items: flex-end;
            padding-right: 80px;
        }

        .roster-coach-label,
        .roster-players-label {
            font-weight: 700;
            font-size: 2.1vw;
            margin: 0 0 0.5vh 0;
            display: block;
            color: #b0b0b0;
        }

        .roster-coach-name {
            font-size: 2.0vw;
            font-weight: 500;
            margin: 0 0 2vh 0;
            display: block;
            color: #fff;
        }

        .roster-players-list {
            font-weight: 500;
            line-height: 1.5;
            display: block;
            width: 100%;
            color: #fff;
            flex: 1;
            min-height: 0;
            overflow: hidden;
            position: relative;
        }

        .roster-players-scroll {
            font-size: 1.6vw;
            column-count: 2;
            column-gap: 2vw;
            width: 100%;
            will-change: transform;
        }

        .roster-players-list.many-players {
            padding-bottom: 60px;
            padding-top: 30px;
            box-sizing: border-box;
            -webkit-mask-image: linear-gradient(to bottom, transparent 0, black 40px, black calc(100% - 50px), transparent 100%);
            mask-image: linear-gradient(to bottom, transparent 0, black 40px, black calc(100% - 50px), transparent 100%);
        }

        .roster-players-list.many-players .roster-players-scroll {
            font-size: 1.6vw;
        }

        .roster-player-item {
            display: flex;
            align-items: baseline;
            gap: 0.5vw;
        }

        .roster-player-number {
            text-align: right;
            min-width: 2.5vw;
            flex-shrink: 0;
            font-size: 1.5vw;
            color: #b0b0b0;
        }

        .roster-player-name {
            flex: 1;
        }

        .roster-team1 .roster-coach-label,
        .roster-team1 .roster-coach-name,
        .roster-team1 .roster-players-label,
        .roster-team1 .roster-players-list {
            text-align: left;
        }

        .roster-team2 .roster-coach-label,
        .roster-team2 .roster-coach-name,
        .roster-team2 .roster-players-label,
        .roster-team2 .roster-players-list {
            text-align: right;
        }

        .roster-team2 .roster-player-item {
            flex-direction: row;
            gap: 0.5vw;
            justify-content: flex-end;
        }

        .roster-team2 .roster-player-number {
            text-align: left;
            min-width: 2.0vw;
            flex-shrink: 0;
        }

        .roster-team2 .roster-player-name {
            text-align: right;
            flex: 1;
        }

        .divider-section,
        .timer {
            display: none !important;
        }

        .match-score-label,
        .penalty-label,
        .penalty-overlay {
            display: none !important;
        }

        .jingle-player-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
            padding: 0 12px;
            min-width: 0;
        }
        .jingle-play-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: #555;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            padding: 0;
            flex-shrink: 0;
        }
        .jingle-play-btn:hover { opacity: 0.9; }
        .jingle-play-btn.playing { opacity: 1; }
        .jingle-select {
            font-size: 10px;
            padding: 6px 8px;
            width: 200px;
            min-width: 200px;
            max-width: 200px;
            box-sizing: border-box;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            outline: none;
            transition: background 0.12s linear;
        }
        .jingle-select option { background: #2a2a2a; color: #fff; }
        .jingle-volume-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .jingle-volume-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 14px;
            flex-shrink: 0;
        }
        .jingle-volume-track-wrap {
            position: relative;
            flex: 1;
            height: 6px;
            min-width: 80px;
            margin-top: -15px;
        }
        .jingle-volume-row input[type="range"] {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            outline: none;
        }
        .jingle-volume-row input[type="range"]::-webkit-slider-runnable-track {
            height: 6px;
            background: #444;
            border-radius: 3px;
        }
        .jingle-volume-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            border: none;
            margin-top: -4px;
        }
        .jingle-volume-row input[type="range"]::-moz-range-track {
            height: 6px;
            background: #444;
            border-radius: 3px;
        }
        .jingle-volume-row input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            border: none;
        }
        .football-anthem-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 14px;
            font-size: 12px;
            font-family: inherit;
            color: #888;
            background: transparent;
            border: 2px solid #555;
            border-radius: 999px;
            cursor: pointer;
            outline: none;
            white-space: nowrap;
        }
        .football-anthem-btn:hover { color: #aaa; border-color: #666; }
        .football-anthem-btn.playing { color: #fff; background: #4a7fc7; border-color: #4a7fc7; }
        .break-music-spacer { height: 30px; }
        .break-music-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            width: 220px;
            min-width: 220px;
            max-width: 220px;
            box-sizing: border-box;
        }
        .break-music-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        .break-music-nav-btn {
            background: none; border: none; color: #666; cursor: pointer;
            font-size: 24px; font-weight: bold; line-height: 1; padding: 6px; font-family: inherit;
        }
        .break-music-nav-btn:hover { color: #aaa; }
        .break-music-nav-btn:disabled { color: #333; cursor: default; }
        .break-music-play {
            width: 44px; height: 44px; font-size: 18px;
        }
        .break-music-play:disabled {
            background: #444 !important;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .break-music-play.playing { opacity: 1; }
        .break-music-now-row {
            font-size: 15px; color: #888; letter-spacing: 0.05em; text-align: center;
            margin-bottom: 4px; max-width: 220px; margin-left: auto; margin-right: auto;
            overflow: hidden; white-space: nowrap;
        }
        .break-music-now-row.playing { color: #aaa; }
        .break-music-track-wrap { width: 220px; min-width: 220px; max-width: 220px; margin: 0 auto; margin-top: 2px; display: none; box-sizing: border-box; }
        .break-music-track-wrap.break-music-queue-ready { display: block; }
        .break-music-now-inner { display: inline-block; white-space: nowrap; }
        .break-music-now-row.scroll .break-music-now-inner {
            animation: break-track-scroll 20s ease-in-out infinite;
        }
        .break-music-progress-wrap {
            display: none; width: 100%; margin: 0 auto 6px; box-sizing: border-box;
        }
        .break-music-progress-wrap.visible { display: block; }
        .break-music-progress-track {
            width: 100%; height: 3px; background: #444; border-radius: 2px;
            position: relative;
        }
        .break-music-progress-thumb {
            position: absolute; width: 8px; height: 8px; border-radius: 50%;
            background: #888; top: 50%; margin-top: -4px; margin-left: -4px;
            left: 0%; transition: left 0.15s linear;
        }
        .break-music-controls-row { position: relative; display: flex; justify-content: center; width: 100%; }
        .break-music-progress-time {
            position: absolute; top: 50%; transform: translateY(-50%);
            font-size: 11px; color: #666; min-width: 36px;
            visibility: hidden; margin-top: 3px;
        }
        .break-music-progress-time.elapsed { left: 0; text-align: left; }
        .break-music-progress-time.remaining { right: 0; text-align: right; }
        .break-music-progress-time.visible { visibility: visible; }
        .break-music-queue-list { display: flex; flex-direction: column; gap: 2px; max-height: 130px; overflow-y: auto; overflow-x: hidden; position: relative; z-index: 2; width: 100%; min-width: 0; box-sizing: border-box; }
        .break-music-queue-row {
            display: flex; align-items: center; gap: 4px;
            font-size: 10px; color: #666;
            padding: 3px 6px; min-height: 22px; box-sizing: border-box;
        }
        .break-music-queue-row .queue-row-name {
            flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .break-music-queue-row .queue-row-move {
            flex-shrink: 0; background: none; border: none; color: #555; cursor: pointer;
            font-size: 10px; padding: 0 2px; font-family: inherit; line-height: 1;
        }
        .break-music-queue-row .queue-row-move:hover { color: #888; }
        .break-music-queue-row .queue-row-move:disabled { color: #333; cursor: default; }
        @keyframes break-track-scroll {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(var(--track-scroll-dx, 0)); }
        }
        .jingle-confirm-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }
        .jingle-confirm-box {
            background: #222;
            color: #fff;
            padding: 16px 20px;
            border-radius: 8px;
            max-width: 440px;
            box-sizing: border-box;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-line;
            text-align: left;
        }
    </style>
</head>
<body class="rosters-mode">
    <div class="stadium-container" id="scoreboardMode">
        <!-- –í–µ—Ä—Ö–Ω—è—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="top-section">
            <div class="tournament-title" id="tournamentTitle">ISKRA CUP 2025</div>
            <div class="rosters-subtitle" id="rostersSubtitle">–°–æ—Å—Ç–∞–≤—ã –∫–æ–º–∞–Ω–¥</div>
        </div>

        <!-- –°—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å: —Å–ª–µ–≤–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ | –ª–æ–≥–æ+–≤—ã–ø–∞–¥–∞–π–∫–∏, —Ü–µ–Ω—Ç—Ä –≥—Ä–æ–º–∫–æ—Å—Ç—å+–≥–∏–º–Ω, —Å–ø—Ä–∞–≤–∞ –ª–æ–≥–æ+–≤—ã–ø–∞–¥–∞–π–∫–∏ | –Ω–∞–∑–≤–∞–Ω–∏–µ -->
        <div class="middle-section">
            <div class="middle-content">
                <div class="team1-section">
                    <div class="team1-meta">
                        <div class="team1-name" id="team1Name">–ö–æ–º–∞–Ω–¥–∞ 1</div>
                        <div id="team1Stripe" class="team1-stripe"></div>
                        <div class="team1-city" id="team1City">–ì–æ—Ä–æ–¥ 1</div>
                    </div>
                    <div class="team1-logo-wrap">
                        <div class="jingle-select-row">
                            <select class="jingle-select" id="jingleSelect1" title="Jingle team 1"></select>
                            <button type="button" class="jingle-play-btn" id="jinglePlay1" title="Play">‚ñ∂</button>
                        </div>
                        <img id="team1Logo" class="team1-logo" alt="Team 1 logo">
                        <div id="team1NoLogo" class="team1-no-logo" style="background-color: #2b2b2b;"></div>
                    </div>
                </div>
                <div class="jingle-player-block">
                    <div class="jingle-volume-row">
                        <span class="jingle-volume-icon" aria-hidden="true">üîà</span>
                        <div class="jingle-volume-track-wrap">
                            <input type="range" id="jingleVolume" min="0" max="1" step="0.01" value="0.7" title="Volume">
                        </div>
                        <span class="jingle-volume-icon" aria-hidden="true">üîä</span>
                    </div>
                    <button type="button" class="football-anthem-btn" id="footballAnthemBtn" title="Football anthem">–§—É—Ç–±–æ–ª—å–Ω—ã–π –≥–∏–º–Ω</button>
                    <div class="break-music-spacer"></div>
                    <div class="break-music-block">
                        <input type="file" id="breakMusicFileInput" accept=".mp3,audio/mpeg" webkitdirectory directory hidden>
                        <div class="break-music-now-row" id="breakMusicNowRow"><span class="break-music-now-inner" id="breakMusicNowInner"></span></div>
                        <div class="break-music-progress-wrap" id="breakMusicProgressWrap">
                            <div class="break-music-progress-track">
                                <div class="break-music-progress-thumb" id="breakMusicProgressThumb"></div>
                            </div>
                        </div>
                        <div class="break-music-controls-row">
                            <span class="break-music-progress-time elapsed" id="breakMusicElapsedTime"></span>
                            <div class="break-music-controls">
                                <button type="button" class="break-music-nav-btn" id="breakMusicPrevBtn" title="–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∏–π">‚Äπ</button>
                                <button type="button" class="jingle-play-btn break-music-play" id="breakMusicPlayBtn" title="–ú—É–∑—ã–∫–∞ –ø–µ—Ä–µ—Ä—ã–≤–∞" disabled>‚ñ∂</button>
                                <button type="button" class="break-music-nav-btn" id="breakMusicNextBtn" title="–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫" aria-label="–°–ª–µ–¥—É—é—â–∏–π">‚Ä∫</button>
                            </div>
                            <span class="break-music-progress-time remaining" id="breakMusicProgressTime"></span>
                        </div>
                        <div class="break-music-track-wrap" id="breakMusicTrackWrap">
                            <div class="break-music-queue-list" id="breakMusicQueueList"></div>
                        </div>
                    </div>
                </div>
                <div class="team2-section">
                    <div class="team2-logo-wrap">
                        <div class="jingle-select-row">
                            <button type="button" class="jingle-play-btn" id="jinglePlay2" title="Play">‚ñ∂</button>
                            <select class="jingle-select" id="jingleSelect2" title="Jingle team 2"></select>
                        </div>
                        <img id="team2Logo" class="team2-logo" alt="Team 2 logo">
                        <div id="team2NoLogo" class="team2-no-logo" style="background-color: #2b2b2b;"></div>
                    </div>
                    <div class="team2-meta">
                        <div class="team2-name" id="team2Name">–ö–æ–º–∞–Ω–¥–∞ 2</div>
                        <div id="team2Stripe" class="team2-stripe"></div>
                        <div class="team2-city" id="team2City">–ì–æ—Ä–æ–¥ 2</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ù–∏–∂–Ω—è—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="bottom-section">
            <div class="roster-team1" id="rosterTeam1">
                <div class="roster-coach-label">–¢—Ä–µ–Ω–µ—Ä:</div>
                <div class="roster-coach-name" id="rosterTeam1Coach"></div>
                <div class="roster-players-label">–ò–≥—Ä–æ–∫–∏:</div>
                <div class="roster-players-list" id="rosterTeam1Players"></div>
            </div>
            <div class="roster-divider" id="rosterDivider">
                <div class="roster-colon"></div>
            </div>
            <div class="roster-team2" id="rosterTeam2">
                <div class="roster-coach-label">–¢—Ä–µ–Ω–µ—Ä:</div>
                <div class="roster-coach-name" id="rosterTeam2Coach"></div>
                <div class="roster-players-label">–ò–≥—Ä–æ–∫–∏:</div>
                <div class="roster-players-list" id="rosterTeam2Players"></div>
            </div>
        </div>
    </div>

    <div id="jingleConfirmOverlay" class="jingle-confirm-overlay">
        <div class="jingle-confirm-box" id="jingleConfirmText"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ–Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∞–Ω–∏–º–∞—Ü–∏–∏
        const bgImage = new Image();
        bgImage.onload = function() {
            document.body.classList.add('background-loaded');
            setTimeout(() => {
                document.body.classList.add('content-ready');
            }, 500);
        };
        bgImage.onerror = function() {
            document.body.classList.add('background-loaded');
            setTimeout(() => {
                document.body.classList.add('content-ready');
            }, 500);
        };
        bgImage.src = '/public/img/memberspage_bg.jpg';

        const socket = io();
        let latestData = null;
        let lastRosterSignature = '';
        let lastScoreSnapshot = null;
        let lastScoreChangeAt = 0;
        let lastTimerRunningFlag = null;

        function escapeHtml(str = '') {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderRostersMode(coachEl, playersEl, staff, players, isRightSide = false, teamId = null) {
            if (coachEl) {
                if (staff && Array.isArray(staff) && staff.length > 0) {
                    const coachNames = staff
                        .map(item => {
                            if (!item) return '';
                            if (typeof item === 'string') return escapeHtml(item);
                            return escapeHtml(item.name || '');
                        })
                        .filter(Boolean);
                    if (coachNames.length > 0) {
                        coachEl.innerHTML = coachNames.join('<br>');
                    } else {
                        coachEl.innerHTML = '';
                    }
                } else {
                    coachEl.innerHTML = '';
                }
            }

            if (playersEl) {
                if (players && Array.isArray(players) && players.length > 0) {
                    const hasAltNumbers = players.some(p => {
                        if (typeof p === 'string') return false;
                        return p.number && p.number.includes('/');
                    });
                    let useAltNumbers = false;
                    if (hasAltNumbers) {
                        if (teamId) {
                            useAltNumbers = localStorage.getItem(`team-${teamId}-useAltNumbers`) === 'true';
                        } else {
                            useAltNumbers = localStorage.getItem('globalUseAltNumbers') === 'true';
                        }
                    }
                    const playerItems = players
                        .map(item => {
                            if (!item) return '';
                            let num = '';
                            let name = '';
                            if (typeof item === 'string') {
                                const parts = item.trim().split(/\s+/);
                                num = parts[0].match(/^\d+$/) ? parts[0] : '‚Äî';
                                name = num !== '‚Äî' ? parts.slice(1).join(' ') : item;
                            } else {
                                num = item.number != null && item.number !== '' ? String(item.number) : '‚Äî';
                                name = item.name || '';
                                if (num && num !== '‚Äî' && num.includes('/')) {
                                    const [num1, num2] = num.split('/');
                                    num = useAltNumbers ? (num2 || num1) : (num1 || '');
                                }
                            }
                            const numDisplay = (num === '' || num == null) ? '‚Äî' : num;
                            if (isRightSide) {
                                return `<div class="roster-player-item">
                                    <span class="roster-player-name">${escapeHtml(name)}</span>
                                    <span class="roster-player-number">${escapeHtml(numDisplay)}</span>
                                </div>`;
                            } else {
                                return `<div class="roster-player-item">
                                    <span class="roster-player-number">${escapeHtml(numDisplay)}</span>
                                    <span class="roster-player-name">${escapeHtml(name)}</span>
                                </div>`;
                            }
                        })
                        .filter(Boolean);
                    playersEl.innerHTML = `<div class="roster-players-scroll">${playerItems.join('')}</div>`;
                } else {
                    playersEl.innerHTML = '';
                }
            }
        }

        function trackScoreChangeFromData(data) {
            if (!data) return;
            let s1 = 0;
            let s2 = 0;
            if (typeof data.score1 === 'number' || typeof data.score2 === 'number') {
                s1 = Number(data.score1) || 0;
                s2 = Number(data.score2) || 0;
            } else {
                if (data.team1 && typeof data.team1.score !== 'undefined') s1 = Number(data.team1.score) || 0;
                if (data.team2 && typeof data.team2.score !== 'undefined') s2 = Number(data.team2.score) || 0;
            }
            if (!lastScoreSnapshot) {
                lastScoreSnapshot = { s1, s2 };
                lastScoreChangeAt = 0;
                return;
            }
            if (s1 !== lastScoreSnapshot.s1 || s2 !== lastScoreSnapshot.s2) {
                lastScoreSnapshot = { s1, s2 };
                lastScoreChangeAt = Date.now();
            }
        }

        function updateStripe(team, color) {
            const stripe = team === 'team1' ? team1Stripe : team2Stripe;
            const direction = team === 'team1' ? 'to right' : 'to left';
            if (color && color !== '') {
                stripe.style.background = `linear-gradient(${direction}, transparent, ${color} 70px, ${color} 130px, transparent 200px)`;
                setTimeout(() => stripe.classList.add('active'), 100);
            } else {
                stripe.classList.remove('active');
                stripe.style.background = `linear-gradient(${direction}, transparent, #2b2b2b 70px, #2b2b2b 130px, transparent 200px)`;
            }
        }

        function updateDisplay(data) {
            trackScoreChangeFromData(data);
            const nowTimerRunning = isTimerRunningFromData(data);
            if (lastTimerRunningFlag === false && nowTimerRunning === true) {
                if (window.breakMusicPlaying && typeof window.stopBreakMusicFromTimer === 'function') {
                    window.stopBreakMusicFromTimer();
                }
            }
            lastTimerRunningFlag = nowTimerRunning;
            // –ö–æ–º–∞–Ω–¥–∞ 1
            if (data.team1Logo && data.team1Logo !== '') {
                team1Logo.src = data.team1Logo;
                team1Logo.classList.add('show');
                team1NoLogo.style.display = 'none';
            } else {
                team1Logo.classList.remove('show');
                team1NoLogo.style.display = 'flex';
                if (data.kit1Color) team1NoLogo.style.backgroundColor = data.kit1Color;
            }
            team1Name.textContent = data.team1Name || '–ö–æ–º–∞–Ω–¥–∞ 1';
            team1City.textContent = data.team1City || '–ì–æ—Ä–æ–¥ 1';
            updateStripe('team1', data.kit1Color);

            const rosterSig = JSON.stringify({
                t1: data.team1Staff || data.staff1 || [],
                t2: data.team2Staff || data.staff2 || [],
                p1: data.team1Players || data.players1 || [],
                p2: data.team2Players || data.players2 || []
            });
            if (rosterSig !== lastRosterSignature && rosterTeam1Coach && rosterTeam1Players && rosterTeam2Coach && rosterTeam2Players) {
                lastRosterSignature = rosterSig;
                const team1Id = data.team1Id || null;
                const team2Id = data.team2Id || null;
                renderRostersMode(rosterTeam1Coach, rosterTeam1Players, data.team1Staff || data.staff1 || [], data.team1Players || data.players1 || [], false, team1Id);
                renderRostersMode(rosterTeam2Coach, rosterTeam2Players, data.team2Staff || data.staff2 || [], data.team2Players || data.players2 || [], true, team2Id);
            }

            // –ö–æ–º–∞–Ω–¥–∞ 2
            if (data.team2Logo && data.team2Logo !== '') {
                team2Logo.src = data.team2Logo;
                team2Logo.classList.add('show');
                team2NoLogo.style.display = 'none';
            } else {
                team2Logo.classList.remove('show');
                team2NoLogo.style.display = 'flex';
                if (data.kit2Color) team2NoLogo.style.backgroundColor = data.kit2Color;
            }
            team2Name.textContent = data.team2Name || '–ö–æ–º–∞–Ω–¥–∞ 2';
            team2City.textContent = data.team2City || '–ì–æ—Ä–æ–¥ 2';
            updateStripe('team2', data.kit2Color);

            const team1PlayersCount = (data.team1Players || data.players1 || []).length;
            const team2PlayersCount = (data.team2Players || data.players2 || []).length;
            const maxPlayersCount = Math.max(team1PlayersCount, team2PlayersCount);
            if (rosterTeam1Players && rosterTeam2Players) {
                if (maxPlayersCount > 24) {
                    const alreadyHadMany = rosterTeam1Players.classList.contains('many-players');
                    rosterTeam1Players.classList.add('many-players');
                    rosterTeam2Players.classList.add('many-players');
                    if (!alreadyHadMany) initRosterAutoScroll();
                } else {
                    rosterTeam1Players.classList.remove('many-players');
                    rosterTeam2Players.classList.remove('many-players');
                    stopRosterAutoScroll();
                }
                adjustRosterFont(rosterTeam1Players);
                adjustRosterFont(rosterTeam2Players);
            }
            if (data.tournamentTitle && tournamentTitle) {
                tournamentTitle.textContent = data.tournamentTitle;
            }
            const jinglePlay1El = document.getElementById('jinglePlay1');
            const jinglePlay2El = document.getElementById('jinglePlay2');
            const jingleSelect1El = document.getElementById('jingleSelect1');
            const jingleSelect2El = document.getElementById('jingleSelect2');
            if (jinglePlay1El) jinglePlay1El.style.backgroundColor = data.kit1Color || '#555';
            if (jinglePlay2El) jinglePlay2El.style.backgroundColor = data.kit2Color || '#555';
            if (jingleSelect1El) jingleSelect1El.dataset.fillColor = data.kit1Color || '#4a7fc7';
            if (jingleSelect2El) jingleSelect2El.dataset.fillColor = data.kit2Color || '#4a7fc7';
        }

        const team1Logo = document.getElementById('team1Logo');
        const team1NoLogo = document.getElementById('team1NoLogo');
        const team1Name = document.getElementById('team1Name');
        const team1City = document.getElementById('team1City');
        const team1Stripe = document.getElementById('team1Stripe');
        const team2Logo = document.getElementById('team2Logo');
        const team2NoLogo = document.getElementById('team2NoLogo');
        const team2Name = document.getElementById('team2Name');
        const team2City = document.getElementById('team2City');
        const team2Stripe = document.getElementById('team2Stripe');
        const rosterTeam1Coach = document.getElementById('rosterTeam1Coach');
        const rosterTeam1Players = document.getElementById('rosterTeam1Players');
        const rosterTeam2Coach = document.getElementById('rosterTeam2Coach');
        const rosterTeam2Players = document.getElementById('rosterTeam2Players');
        const tournamentTitle = document.getElementById('tournamentTitle');

        let rosterScrollAnimations = [];

        function adjustRosterFont(playersEl) {
            if (!playersEl) return;
            const content = playersEl.querySelector('.roster-players-scroll');
            if (!content) return;
            content.style.fontSize = '';
            const maxHeight = playersEl.clientHeight;
            if (!maxHeight) return;
            const baseContent = 1.6;
            const minFont = 1.1;
            let font = baseContent;
            while (font >= minFont) {
                content.style.fontSize = font + 'vw';
                const h = content.scrollHeight;
                if (h <= maxHeight) break;
                font -= 0.1;
            }
            const scale = Math.max(minFont / baseContent, Math.min(1, font / baseContent));
            const teamBlock = playersEl.closest('.roster-team1, .roster-team2');
            if (teamBlock) {
                const coachLabel = teamBlock.querySelector('.roster-coach-label');
                const coachName = teamBlock.querySelector('.roster-coach-name');
                const playersLabel = teamBlock.querySelector('.roster-players-label');
                const baseCoachLabel = 2.1;
                const baseCoachName = 2.0;
                const basePlayersLabel = 2.1;
                if (coachLabel) coachLabel.style.fontSize = (baseCoachLabel * scale) + 'vw';
                if (coachName) coachName.style.fontSize = (baseCoachName * scale) + 'vw';
                if (playersLabel) playersLabel.style.fontSize = (basePlayersLabel * scale) + 'vw';
            }
        }

        function ensureRosterOverflow(el) {
            if (!el) return false;
            const content = el.querySelector('.roster-players-scroll');
            if (!content) return false;
            let extra = content.scrollHeight - el.clientHeight;
            if (extra > 2) return true;
            let filler = content.querySelector('.roster-scroll-filler');
            if (!filler) {
                filler = document.createElement('div');
                filler.className = 'roster-scroll-filler';
                filler.style.height = '160px';
                filler.style.opacity = '0';
                filler.style.pointerEvents = 'none';
                filler.style.width = '100%';
                content.appendChild(filler);
            } else {
                filler.style.height = (parseInt(filler.style.height || '160', 10) + 80) + 'px';
            }
            return content.scrollHeight - el.clientHeight > 2;
        }

        function initRosterAutoScroll() {
            stopRosterAutoScroll();
            const lists = [rosterTeam1Players, rosterTeam2Players]
                .filter(el => el && el.classList.contains('many-players'))
                .filter(el => ensureRosterOverflow(el));
            if (lists.length === 0) return;
            const scrollSpeed = 22;
            const pauseDuration = 5000;
            lists.forEach((el) => {
                const content = el.querySelector('.roster-players-scroll');
                if (!content) return;
                content.style.transform = 'translateY(0)';
                const state = { direction: 1, lastTime: null, isPaused: true, pauseUntil: Date.now() + pauseDuration, offset: 0 };
                const anim = { type: 'raf', id: null };
                function step(timestamp) {
                    anim.id = requestAnimationFrame(step);
                    if (!el.classList.contains('many-players')) return;
                    const maxScroll = content.scrollHeight - el.clientHeight;
                    if (maxScroll <= 0) return;
                    if (state.isPaused) {
                        if (Date.now() >= state.pauseUntil) { state.isPaused = false; state.lastTime = timestamp; }
                        return;
                    }
                    if (state.lastTime === null) state.lastTime = timestamp;
                    const dt = (timestamp - state.lastTime) / 1000;
                    state.lastTime = timestamp;
                    state.offset += state.direction * scrollSpeed * dt;
                    if (state.offset <= 0) { state.offset = 0; state.direction = 1; state.isPaused = true; state.pauseUntil = Date.now() + pauseDuration; }
                    else if (state.offset >= maxScroll) { state.offset = maxScroll; state.direction = -1; state.isPaused = true; state.pauseUntil = Date.now() + pauseDuration; }
                    content.style.transform = `translateY(-${state.offset}px)`;
                }
                anim.id = requestAnimationFrame(step);
                rosterScrollAnimations.push(anim);
            });
        }

        function stopRosterAutoScroll() {
            rosterScrollAnimations.forEach(item => {
                if (!item) return;
                if (item.type === 'raf') cancelAnimationFrame(item.id);
                else if (typeof item === 'number') { clearInterval(item); clearTimeout(item); }
            });
            rosterScrollAnimations = [];
        }

        // –ü–ª–µ–µ—Ä –¥–∂–∏–Ω–≥–ª–æ–≤: –∫—ç—à –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞, –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
        const jingleCache = {};
        let jingleVolume = 0.7;
        const jingleBase = '/public/sound/';
        const jingleVolumeEl = document.getElementById('jingleVolume');
        const jinglePlay1 = document.getElementById('jinglePlay1');
        const jinglePlay2 = document.getElementById('jinglePlay2');
        const jingleSelect1 = document.getElementById('jingleSelect1');
        const jingleSelect2 = document.getElementById('jingleSelect2');
        let currentTeam1Audio = null;
        let currentTeam2Audio = null;
        let lastGoalJinglePlayedAt = 0;
        let lastGoalJingleScoreSnapshot = null;

        function setProgressFill(teamNum, percent) {
            const sel = teamNum === 1 ? jingleSelect1 : jingleSelect2;
            if (!sel) return;
            const pct = Math.min(100, Math.max(0, percent || 0));
            const fillColor = sel.dataset.fillColor || '#4a7fc7';
            if (pct <= 0) {
                sel.style.background = '#333';
            } else {
                sel.style.background = 'linear-gradient(to right, ' + fillColor + ' 0%, ' + fillColor + ' ' + pct + '%, #333 ' + pct + '%, #333 100%)';
            }
        }
        function updateProgressFromAudio(a) {
            if (!a.duration || !isFinite(a.duration)) return;
            const pct = (a.currentTime / a.duration) * 100;
            if (currentTeam1Audio === a) setProgressFill(1, pct);
            if (currentTeam2Audio === a) setProgressFill(2, pct);
        }

        function getOrCreateAudio(filename) {
            if (jingleCache[filename]) return jingleCache[filename];
            const a = new Audio(jingleBase + filename);
            jingleCache[filename] = a;
            a.addEventListener('timeupdate', () => updateProgressFromAudio(a));
            a.addEventListener('loadedmetadata', () => updateProgressFromAudio(a));
            a.addEventListener('ended', () => {
                if (currentTeam1Audio === a) { if (jinglePlay1) { jinglePlay1.textContent = '‚ñ∂'; jinglePlay1.classList.remove('playing'); } currentTeam1Audio = null; setProgressFill(1, 0); }
                if (currentTeam2Audio === a) { if (jinglePlay2) { jinglePlay2.textContent = '‚ñ∂'; jinglePlay2.classList.remove('playing'); } currentTeam2Audio = null; setProgressFill(2, 0); }
            });
            return a;
        }
        function preloadJingle(filename) {
            const a = getOrCreateAudio(filename);
            a.volume = jingleVolume;
            a.load();
        }
        const JINGLE_STORAGE_VOLUME = 'serviceJingleVolume';
        const JINGLE_STORAGE_SELECT1 = 'serviceJingleSelect1';
        const JINGLE_STORAGE_SELECT2 = 'serviceJingleSelect2';
        function applyVolumeToAll() {
            if (jingleVolumeEl) jingleVolume = parseFloat(jingleVolumeEl.value);
            Object.keys(jingleCache).forEach(f => { jingleCache[f].volume = jingleVolume; });
            if (footballAnthemAudio) footballAnthemAudio.volume = jingleVolume;
            try { localStorage.setItem(JINGLE_STORAGE_VOLUME, String(jingleVolumeEl ? jingleVolumeEl.value : jingleVolume)); } catch (e) {}
        }
        function shouldWarnGoalWithoutRecentScoreChange() {
            if (!latestData) return false;
            if (!lastScoreSnapshot || !lastScoreChangeAt) return true;
            const diffMs = Date.now() - lastScoreChangeAt;
            return diffMs > 60000;
        }

        function getCurrentScoreFromLatest() {
            if (!latestData) return { s1: 0, s2: 0 };
            let s1 = 0, s2 = 0;
            if (typeof latestData.score1 === 'number' || typeof latestData.score2 === 'number') {
                s1 = Number(latestData.score1) || 0;
                s2 = Number(latestData.score2) || 0;
            } else {
                if (latestData.team1 && typeof latestData.team1.score !== 'undefined') s1 = Number(latestData.team1.score) || 0;
                if (latestData.team2 && typeof latestData.team2.score !== 'undefined') s2 = Number(latestData.team2.score) || 0;
            }
            return { s1, s2 };
        }
        function hasActiveScoreOrTime() {
            if (!latestData) return false;
            const { s1, s2 } = getCurrentScoreFromLatest();
            const nonZeroScore = (s1 !== 0) || (s2 !== 0);
            let nonZeroTime = false;
            if (typeof latestData.timerSeconds === 'number') {
                nonZeroTime = latestData.timerSeconds > 0;
            } else if (typeof latestData.time === 'string') {
                nonZeroTime = latestData.time !== '' && latestData.time !== '00:00';
            }
            return nonZeroScore || nonZeroTime;
        }
        function hasScoreIncreasedSinceLastJingle() {
            if (!lastGoalJingleScoreSnapshot) return false;
            const cur = getCurrentScoreFromLatest();
            return cur.s1 > lastGoalJingleScoreSnapshot.s1 || cur.s2 > lastGoalJingleScoreSnapshot.s2;
        }
        function isTimerRunningFromData(data) {
            if (!data) return false;
            if (typeof data.timerRunning === 'boolean') return data.timerRunning;
            if (typeof data.timerState === 'string') {
                const s = data.timerState.toLowerCase();
                if (s === 'running' || s === 'play' || s === 'started') return true;
                return false;
            }
            return false;
        }
        function isTimerPaused() {
            return !isTimerRunningFromData(latestData);
        }

        let jingleConfirmPending = null;
        let jingleSkipConfirms = false;
        const jingleConfirmOverlay = document.getElementById('jingleConfirmOverlay');
        const jingleConfirmText = document.getElementById('jingleConfirmText');

        function showJingleConfirm(message) {
            if (!jingleConfirmOverlay || !jingleConfirmText) return;
            jingleConfirmText.textContent = message;
            jingleConfirmOverlay.style.display = 'flex';
        }
        function hideJingleConfirm() {
            if (!jingleConfirmOverlay) return;
            jingleConfirmOverlay.style.display = 'none';
        }

        function playJingle(teamNum) {
            const select = teamNum === 1 ? jingleSelect1 : jingleSelect2;
            const btn = teamNum === 1 ? jinglePlay1 : jinglePlay2;
            const currentAudio = teamNum === 1 ? currentTeam1Audio : currentTeam2Audio;
            if (btn && btn.classList.contains('playing') && currentAudio) {
                currentAudio.pause();
                if (teamNum === 1) { currentTeam1Audio = null; setProgressFill(1, 0); }
                else { currentTeam2Audio = null; setProgressFill(2, 0); }
                btn.textContent = '‚ñ∂';
                btn.classList.remove('playing');
                return;
            }
            const filename = select && select.value ? select.value : '';
            if (!filename) return;
            if (window.breakMusicPlaying) {
                alert('–î–∂–∏–Ω–≥–ª –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –º—É–∑—ã–∫–∞ –ø–µ—Ä–µ—Ä—ã–≤–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º—É–∑—ã–∫–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ —Å–Ω–æ–≤–∞.');
                return;
            }
            if (!jingleSkipConfirms && shouldWarnGoalWithoutRecentScoreChange()) {
                if (!confirm('–ù–∞ —Ç–∞–±–ª–æ –¥–∞–≤–Ω–æ –Ω–µ –º–µ–Ω—è–ª—Å—è —Å—á—ë—Ç. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—á—ë—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –≥–æ–ª–µ–≤–æ–≥–æ –¥–∂–∏–Ω–≥–ª–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ?')) {
                    return;
                }
            }
            if (!jingleSkipConfirms && lastGoalJinglePlayedAt && !hasScoreIncreasedSinceLastJingle()) {
                if (!confirm('–í—ã —É–∂–µ –∑–∞–ø—É—Å–∫–∞–ª–∏ –≥–æ–ª–µ–≤–æ–π –¥–∂–∏–Ω–≥–ª. –ó–∞–ø—É—Å—Ç–∏—Ç—å –µ–≥–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ?')) {
                    return;
                }
            }
            const a = getOrCreateAudio(filename);
            a.volume = jingleVolume;
            if (currentTeam1Audio) { currentTeam1Audio.pause(); currentTeam1Audio.currentTime = 0; if (jinglePlay1) { jinglePlay1.textContent = '‚ñ∂'; jinglePlay1.classList.remove('playing'); } currentTeam1Audio = null; setProgressFill(1, 0); }
            if (currentTeam2Audio) { currentTeam2Audio.pause(); currentTeam2Audio.currentTime = 0; if (jinglePlay2) { jinglePlay2.textContent = '‚ñ∂'; jinglePlay2.classList.remove('playing'); } currentTeam2Audio = null; setProgressFill(2, 0); }
            if (teamNum === 1) currentTeam1Audio = a; else currentTeam2Audio = a;
            setProgressFill(teamNum, 0);
            btn.textContent = '‚ùö‚ùö';
            btn.classList.add('playing');
            a.currentTime = 0;
            a.play();
            lastGoalJinglePlayedAt = Date.now();
            lastGoalJingleScoreSnapshot = getCurrentScoreFromLatest();
        }
        function onJingleSelect(teamNum) {
            const select = teamNum === 1 ? jingleSelect1 : jingleSelect2;
            const filename = select && select.value ? select.value : '';
            if (filename) preloadJingle(filename);
            try {
                if (teamNum === 1 && select) localStorage.setItem(JINGLE_STORAGE_SELECT1, select.value || '');
                if (teamNum === 2 && select) localStorage.setItem(JINGLE_STORAGE_SELECT2, select.value || '');
            } catch (e) {}
        }
        const FOOTBALL_ANTHEM_PATH = 'special/football.mp3';
        let footballAnthemAudio = null;
        const footballAnthemBtn = document.getElementById('footballAnthemBtn');
        function toggleFootballAnthem() {
            if (!footballAnthemAudio) {
                footballAnthemAudio = new Audio(jingleBase + FOOTBALL_ANTHEM_PATH);
                footballAnthemAudio.addEventListener('ended', function() {
                    if (footballAnthemBtn) { footballAnthemBtn.classList.remove('playing'); footballAnthemBtn.textContent = '–§—É—Ç–±–æ–ª—å–Ω—ã–π –≥–∏–º–Ω'; }
                });
            }
            footballAnthemAudio.volume = jingleVolumeEl ? parseFloat(jingleVolumeEl.value) : 0.7;
            if (footballAnthemAudio.paused) {
                if (window.breakMusicPlaying) {
                    alert('–ì–∏–º–Ω –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –º—É–∑—ã–∫–∞ –ø–µ—Ä–µ—Ä—ã–≤–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º—É–∑—ã–∫–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ —Å–Ω–æ–≤–∞.');
                    return;
                }
                if (hasActiveScoreOrTime()) {
                    if (!confirm('–ù–∞ —Ç–∞–±–ª–æ —É–∂–µ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—á—ë—Ç –∏–ª–∏ –≤—Ä–µ–º—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≥–∏–º–Ω –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≥–∏–º–Ω–∞?')) {
                        return;
                    }
                }
                footballAnthemAudio.currentTime = 0;
                footballAnthemAudio.play();
                if (footballAnthemBtn) { footballAnthemBtn.classList.add('playing'); }
            } else {
                footballAnthemAudio.pause();
                if (footballAnthemBtn) { footballAnthemBtn.classList.remove('playing'); footballAnthemBtn.textContent = '–§—É—Ç–±–æ–ª—å–Ω—ã–π –≥–∏–º–Ω'; }
            }
        }
        if (footballAnthemBtn) footballAnthemBtn.addEventListener('click', toggleFootballAnthem);

        function handleJingleKey(teamNum) {
            const select = teamNum === 1 ? jingleSelect1 : jingleSelect2;
            const btn = teamNum === 1 ? jinglePlay1 : jinglePlay2;
            const currentAudio = teamNum === 1 ? currentTeam1Audio : currentTeam2Audio;

            // –ï—Å–ª–∏ —É–∂–µ –∏–≥—Ä–∞–µ—Ç –¥–∂–∏–Ω–≥–ª —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã ‚Äì –≤—Ç–æ—Ä—ã–º –Ω–∞–∂–∞—Ç–∏–µ–º –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–∏–º
            if (btn && btn.classList.contains('playing') && currentAudio) {
                jingleConfirmPending = null;
                hideJingleConfirm();
                playJingle(teamNum);
                return;
            }

            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤—Ç–æ—Ä—ã–º –Ω–∞–∂–∞—Ç–∏–µ–º
            if (jingleConfirmPending && jingleConfirmPending.teamNum === teamNum) {
                jingleConfirmPending = null;
                hideJingleConfirm();
                jingleSkipConfirms = true;
                playJingle(teamNum);
                jingleSkipConfirms = false;
                return;
            }

            // –°–±—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è –¥—Ä—É–≥–æ–π –∫–æ–º–∞–Ω–¥—ã
            if (jingleConfirmPending && jingleConfirmPending.teamNum !== teamNum) {
                jingleConfirmPending = null;
                hideJingleConfirm();
            }

            if (!select || !select.value) {
                playJingle(teamNum);
                return;
            }

            if (window.breakMusicPlaying) {
                playJingle(teamNum);
                return;
            }

            const needsScoreWarn = shouldWarnGoalWithoutRecentScoreChange();
            const needsRepeatWarn = lastGoalJinglePlayedAt && !hasScoreIncreasedSinceLastJingle();
            if (needsScoreWarn || needsRepeatWarn) {
                let msg = '';
                if (needsScoreWarn) {
                    msg += '–ù–∞ —Ç–∞–±–ª–æ –¥–∞–≤–Ω–æ –Ω–µ –º–µ–Ω—è–ª—Å—è —Å—á—ë—Ç. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—á—ë—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –≥–æ–ª–µ–≤–æ–≥–æ –¥–∂–∏–Ω–≥–ª–∞.';
                }
                if (needsRepeatWarn) {
                    msg += (msg ? '\n\n' : '') + '–í—ã —É–∂–µ –∑–∞–ø—É—Å–∫–∞–ª–∏ –≥–æ–ª–µ–≤–æ–π –¥–∂–∏–Ω–≥–ª. –ó–∞–ø—É—Å—Ç–∏—Ç—å –µ–≥–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ?';
                }
                msg += '\n\n–ù–∞–∂–º–∏—Ç–µ –µ—â—ë —Ä–∞–∑ —Å—Ç—Ä–µ–ª–∫—É ' + (teamNum === 1 ? '–≤–ª–µ–≤–æ' : '–≤–ø—Ä–∞–≤–æ') + ' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.';
                jingleConfirmPending = { teamNum: teamNum };
                showJingleConfirm(msg);
                return;
            }

            playJingle(teamNum);
        }

        (function initJinglePlayer() {
            try {
                const savedVol = localStorage.getItem(JINGLE_STORAGE_VOLUME);
                if (savedVol !== null && savedVol !== '' && jingleVolumeEl) {
                    const v = parseFloat(savedVol);
                    if (!isNaN(v) && v >= 0 && v <= 1) { jingleVolumeEl.value = savedVol; jingleVolume = v; }
                }
            } catch (e) {}
            fetch('/api/jingles').then(r => r.json()).then(data => {
                const list = (data.jingles || []).filter(f => {
                    const base = f.split('/').pop();
                    return base !== 'football.mp3';
                });
                const opt = (v, label) => { const o = document.createElement('option'); o.value = v; o.textContent = label || v.replace(/\.(mp3|ogg|m4a|wav)$/i, ''); return o; };
                [jingleSelect1, jingleSelect2].forEach((sel, idx) => {
                    if (!sel) return;
                    sel.innerHTML = '';
                    sel.appendChild(opt('', '‚Äî'));
                    list.forEach(f => sel.appendChild(opt(f, f.replace(/\.(mp3|ogg|m4a|wav)$/i, ''))));
                    try {
                        const key = idx === 0 ? JINGLE_STORAGE_SELECT1 : JINGLE_STORAGE_SELECT2;
                        const saved = localStorage.getItem(key);
                        if (saved && list.indexOf(saved) !== -1) { sel.value = saved; preloadJingle(saved); }
                    } catch (e) {}
                });
            }).catch(() => {});
            if (jingleVolumeEl) jingleVolumeEl.addEventListener('input', applyVolumeToAll);
            if (jinglePlay1) jinglePlay1.addEventListener('click', () => { jingleConfirmPending = null; hideJingleConfirm(); playJingle(1); });
            if (jinglePlay2) jinglePlay2.addEventListener('click', () => { jingleConfirmPending = null; hideJingleConfirm(); playJingle(2); });
            if (jingleSelect1) jingleSelect1.addEventListener('change', () => onJingleSelect(1));
            if (jingleSelect2) jingleSelect2.addEventListener('change', () => onJingleSelect(2));
        })();

        (function initBreakMusic() {
            const DB_NAME = 'fscoreboard-break-music';
            const STORE_KEY = 'list';
            const QUEUE_SIZE = 5;
            const btn = document.getElementById('breakMusicPlayBtn');
            const prevBtn = document.getElementById('breakMusicPrevBtn');
            const nextBtn = document.getElementById('breakMusicNextBtn');
            const fileInput = document.getElementById('breakMusicFileInput');
            const nowRow = document.getElementById('breakMusicNowRow');
            const nowInner = document.getElementById('breakMusicNowInner');
            const queueListEl = document.getElementById('breakMusicQueueList');
            const trackWrap = document.getElementById('breakMusicTrackWrap');
            const progressWrap = document.getElementById('breakMusicProgressWrap');
            const progressThumb = document.getElementById('breakMusicProgressThumb');
            const progressTrack = progressWrap ? progressWrap.querySelector('.break-music-progress-track') : null;
            const progressTimeRemainingEl = document.getElementById('breakMusicProgressTime');
            const progressTimeElapsedEl = document.getElementById('breakMusicElapsedTime');
            if (!btn || !fileInput) return;
            window.breakMusicPlaying = false;

            let breakMusicList = [];
            let playingNow = null;
            let queueNext5 = [];
            let currentBlobUrl = null;
            const breakMusicAudio = new Audio();
            const getVolume = () => (jingleVolumeEl ? parseFloat(jingleVolumeEl.value) : 0.7);
            const SECRET_CLICK_WINDOW_MS = 1500;
            let secretClicks = [];
            let isSeeking = false;
            const BREAK_MUSIC_FADE_MS = 700;
            let breakMusicFadeTimer = null;

            function clearBreakMusicFade() {
                if (breakMusicFadeTimer) {
                    clearInterval(breakMusicFadeTimer);
                    breakMusicFadeTimer = null;
                }
            }
            function fadeBreakMusicTo(targetVolume, durationMs, onDone) {
                clearBreakMusicFade();
                const start = breakMusicAudio.volume;
                const clampedTarget = Math.max(0, Math.min(1, targetVolume));
                if (!durationMs || durationMs <= 0) {
                    breakMusicAudio.volume = clampedTarget;
                    if (onDone) onDone();
                    return;
                }
                const startTime = Date.now();
                breakMusicFadeTimer = setInterval(function() {
                    const elapsed = Date.now() - startTime;
                    let t = elapsed / durationMs;
                    if (t >= 1) t = 1;
                    const v = start + (clampedTarget - start) * t;
                    breakMusicAudio.volume = v;
                    if (t === 1) {
                        clearBreakMusicFade();
                        if (onDone) onDone();
                    }
                }, 40);
            }

            function openDB() {
                return new Promise((resolve, reject) => {
                    const r = indexedDB.open(DB_NAME, 1);
                    r.onerror = () => reject(r.error);
                    r.onsuccess = () => resolve(r.result);
                    r.onupgradeneeded = function(e) {
                        if (!e.target.result.objectStoreNames.contains('tracks')) e.target.result.createObjectStore('tracks');
                    };
                });
            }
            function loadFromDB() {
                return openDB().then(db => {
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction('tracks', 'readonly');
                        const store = tx.objectStore('tracks');
                        const req = store.get(STORE_KEY);
                        req.onsuccess = () => resolve(req.result || []);
                        req.onerror = () => reject(req.error);
                    });
                }).catch(() => []);
            }
            function saveToDB(list) {
                return openDB().then(db => {
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction('tracks', 'readwrite');
                        tx.objectStore('tracks').put(list, STORE_KEY);
                        tx.oncomplete = () => resolve();
                        tx.onerror = () => reject(tx.error);
                    });
                });
            }
            function getRandomTrack(excludeTrack) {
                if (breakMusicList.length === 0) return null;
                if (breakMusicList.length === 1) return breakMusicList[0];
                if (breakMusicList.length === 2) return breakMusicList[Math.floor(Math.random() * 2)];
                var excludeName = excludeTrack && excludeTrack.name;
                var t;
                var tries = 0;
                do {
                    t = breakMusicList[Math.floor(Math.random() * breakMusicList.length)];
                    tries++;
                } while (tries < 20 && excludeName && t && t.name === excludeName);
                return t;
            }
            function fillQueueToFive(excludeForNew) {
                const maxUnique = Math.min(QUEUE_SIZE, breakMusicList.length);
                while (queueNext5.length < maxUnique) {
                    const usedNames = new Set(queueNext5.filter(Boolean).map(function(it) { return it && it.name; }));
                    const excludeName = excludeForNew && excludeForNew.name;
                    const available = breakMusicList.filter(function(it) {
                        return it && (!usedNames.has(it.name)) && (!excludeName || it.name !== excludeName);
                    });
                    if (available.length === 0) break;
                    const t = available[Math.floor(Math.random() * available.length)];
                    queueNext5.push(t);
                }
            }
            const LABEL_IDLE = '–ú–£–ó–´–ö–ê –ü–ï–†–ï–†–´–í–ê';
            function setNowPlayingDisplay(text, isPlaying) {
                if (!nowRow || !nowInner) return;
                nowInner.textContent = isPlaying ? (text || '') : LABEL_IDLE;
                nowRow.classList.toggle('playing', !!isPlaying);
                nowRow.classList.toggle('empty', false);
                nowRow.classList.remove('scroll');
                nowRow.style.removeProperty('--track-scroll-dx');
                if (isPlaying && text && nowInner.offsetWidth > nowRow.clientWidth) {
                    nowRow.classList.add('scroll');
                    nowRow.style.setProperty('--track-scroll-dx', (nowRow.clientWidth - nowInner.offsetWidth) + 'px');
                }
            }
            function renderQueueRows() {
                if (!queueListEl) return;
                queueListEl.innerHTML = '';
                for (let i = 0; i < QUEUE_SIZE; i++) {
                    const item = queueNext5[i];
                    const name = item ? (item.name || '').replace(/\.(mp3|MP3)$/i, '') : '';
                    const row = document.createElement('div');
                    row.className = 'break-music-queue-row';
                    row.setAttribute('data-index', String(i));
                    row.innerHTML = '<span class="queue-row-name">' + (name || '‚Äî') + '</span>' +
                        '<button type="button" class="queue-row-move" data-dir="up" title="–í—ã—à–µ" aria-label="Up">‚ñ≤</button>' +
                        '<button type="button" class="queue-row-move" data-dir="down" title="–ù–∏–∂–µ" aria-label="Down">‚ñº</button>';
                    var upBtn = row.querySelector('[data-dir="up"]');
                    var downBtn = row.querySelector('[data-dir="down"]');
                    if (upBtn) upBtn.disabled = i === 0;
                    if (downBtn) downBtn.disabled = i === QUEUE_SIZE - 1;
                    queueListEl.appendChild(row);
                }
            }
            function setupQueueListDelegation() {
                if (!queueListEl) return;
                queueListEl.removeEventListener('click', handleQueueListClick);
                queueListEl.addEventListener('click', handleQueueListClick);
            }
            function handleQueueListClick(e) {
                var btn = e.target.closest('.queue-row-move');
                if (!btn || btn.disabled) return;
                e.preventDefault();
                e.stopPropagation();
                var row = btn.closest('.break-music-queue-row');
                if (!row || row.parentNode !== queueListEl) return;
                var idx = parseInt(row.getAttribute('data-index'), 10);
                if (isNaN(idx) || idx < 0 || idx >= QUEUE_SIZE) return;
                var dir = btn.getAttribute('data-dir');
                if (dir === 'up') {
                    if (idx <= 0) return;
                    var a = queueNext5[idx - 1], b = queueNext5[idx];
                    queueNext5[idx - 1] = b;
                    queueNext5[idx] = a;
                } else if (dir === 'down') {
                    if (idx >= QUEUE_SIZE - 1) return;
                    var a = queueNext5[idx], b = queueNext5[idx + 1];
                    queueNext5[idx] = b;
                    queueNext5[idx + 1] = a;
                }
                renderQueueRows();
            }
            function setState() {
                if (trackWrap) trackWrap.classList.toggle('break-music-queue-ready', breakMusicList.length > 0);
                if (breakMusicList.length === 0) {
                    setNowPlayingDisplay('', false);
                    queueNext5 = [];
                    renderQueueRows();
                }
                btn.disabled = false;
                const playing = btn.classList.contains('playing');
                if (prevBtn) prevBtn.disabled = !playing || breakMusicList.length === 0;
                if (nextBtn) nextBtn.disabled = !playing || breakMusicList.length === 0;
            }
            window.breakMusicPlaying = false;
            function formatRemaining(seconds) {
                if (!isFinite(seconds) || seconds < 0) return '0:00';
                var m = Math.floor(seconds / 60);
                var s = Math.floor(seconds % 60);
                return '-' + m + ':' + (s < 10 ? '0' : '') + s;
            }
            function formatElapsed(seconds) {
                if (!isFinite(seconds) || seconds < 0) return '0:00';
                var m = Math.floor(seconds / 60);
                var s = Math.floor(seconds % 60);
                return m + ':' + (s < 10 ? '0' : '') + s;
            }
            function updateProgress() {
                var ct = breakMusicAudio.currentTime;
                var d = breakMusicAudio.duration;
                if (progressWrap && progressWrap.classList.contains('visible')) {
                    if (progressThumb) {
                        var pct = (d && isFinite(d) && d > 0) ? Math.min(100, (ct / d) * 100) : 0;
                        progressThumb.style.left = pct + '%';
                    }
                    if (progressTimeRemainingEl) {
                        progressTimeRemainingEl.textContent = (d && isFinite(d)) ? formatRemaining(d - ct) : '0:00';
                    }
                    if (progressTimeElapsedEl) {
                        progressTimeElapsedEl.textContent = formatElapsed(ct);
                    }
                }
            }
            function seekFromEvent(ev) {
                if (!progressTrack) return;
                var d = breakMusicAudio.duration;
                if (!d || !isFinite(d) || d <= 0) return;
                var rect = progressTrack.getBoundingClientRect();
                if (!rect || !rect.width) return;
                var x = ev.clientX;
                var pct = (x - rect.left) / rect.width;
                if (!isFinite(pct)) return;
                if (pct < 0) pct = 0;
                if (pct > 1) pct = 1;
                breakMusicAudio.currentTime = d * pct;
                updateProgress();
            }
            function showProgress() {
                if (progressWrap) progressWrap.classList.add('visible');
                if (progressTimeRemainingEl) progressTimeRemainingEl.classList.add('visible');
                if (progressTimeElapsedEl) progressTimeElapsedEl.classList.add('visible');
                updateProgress();
            }
            function hideProgress() {
                if (progressWrap) progressWrap.classList.remove('visible');
                if (progressTimeRemainingEl) {
                    progressTimeRemainingEl.classList.remove('visible');
                    progressTimeRemainingEl.textContent = '';
                }
                if (progressTimeElapsedEl) {
                    progressTimeElapsedEl.classList.remove('visible');
                    progressTimeElapsedEl.textContent = '';
                }
                if (progressThumb) progressThumb.style.left = '0%';
            }
            function handleNowRowSecretClick() {
                if (!nowRow || window.breakMusicPlaying) return;
                const nowTs = Date.now();
                secretClicks = secretClicks.filter(ts => nowTs - ts <= SECRET_CLICK_WINDOW_MS);
                secretClicks.push(nowTs);
                if (secretClicks.length >= 5) {
                    secretClicks = [];
                    if (fileInput) {
                        fileInput.click();
                    }
                }
            }
            function playTrack(item) {
                if (!item) return;
                if (currentBlobUrl) { URL.revokeObjectURL(currentBlobUrl); currentBlobUrl = null; }
                playingNow = item;
                window.breakMusicPlaying = true;
                setNowPlayingDisplay((item.name || '').replace(/\.(mp3|MP3)$/i, ''), true);
                showProgress();
                const blob = new Blob([item.data], { type: 'audio/mpeg' });
                currentBlobUrl = URL.createObjectURL(blob);
                breakMusicAudio.src = currentBlobUrl;
                clearBreakMusicFade();
                const targetVol = getVolume();
                breakMusicAudio.volume = 0;
                breakMusicAudio.play().catch(() => {});
                fadeBreakMusicTo(targetVol, BREAK_MUSIC_FADE_MS);
            }
            function advanceToNext() {
                while (queueNext5.length && !queueNext5[0]) queueNext5.shift();
                if (queueNext5.length === 0) return;
                var next = queueNext5.shift();
                fillQueueToFive(next);
                renderQueueRows();
                playTrack(next);
            }
            function stopBreakMusic() {
                const finishStop = function() {
                    if (currentBlobUrl) { URL.revokeObjectURL(currentBlobUrl); currentBlobUrl = null; }
                    breakMusicAudio.pause();
                    breakMusicAudio.currentTime = 0;
                    breakMusicAudio.removeAttribute('src');
                    playingNow = null;
                    window.breakMusicPlaying = false;
                    hideProgress();
                    btn.classList.remove('playing');
                    btn.textContent = '‚ñ∂';
                    setNowPlayingDisplay('', false);
                    setState();
                };
                clearBreakMusicFade();
                const currentVol = breakMusicAudio.volume;
                if (currentVol && currentVol > 0) {
                    fadeBreakMusicTo(0, BREAK_MUSIC_FADE_MS, finishStop);
                } else {
                    finishStop();
                }
            }

            breakMusicAudio.addEventListener('timeupdate', updateProgress);
            breakMusicAudio.addEventListener('loadedmetadata', updateProgress);
            breakMusicAudio.addEventListener('ended', function() {
                if (btn.classList.contains('playing')) advanceToNext();
            });
            if (jingleVolumeEl) jingleVolumeEl.addEventListener('input', function() {
                breakMusicAudio.volume = getVolume();
            });

            loadFromDB().then(list => {
                breakMusicList = list;
                setState();
                renderQueueRows();
            });

            fileInput.addEventListener('change', function() {
                const files = this.files;
                if (!files || files.length === 0) return;
                const promises = [];
                for (let i = 0; i < files.length; i++) {
                    const f = files[i];
                    if (!/\.mp3$/i.test(f.name)) continue;
                    promises.push(new Promise((resolve, reject) => {
                        const r = new FileReader();
                        r.onload = () => resolve({ name: f.name, data: r.result });
                        r.onerror = () => reject();
                        r.readAsArrayBuffer(f);
                    }));
                }
                Promise.all(promises).then(items => {
                    breakMusicList = items;
                    saveToDB(breakMusicList).then(function() {
                        setState();
                        renderQueueRows();
                    });
                }).catch(() => {});
                fileInput.value = '';
            });

            if (progressTrack) {
                progressTrack.addEventListener('pointerdown', function(ev) {
                    if (ev.button !== 0) return;
                    isSeeking = true;
                    ev.preventDefault();
                    seekFromEvent(ev);
                    try { progressTrack.setPointerCapture(ev.pointerId); } catch (e) {}
                });
                progressTrack.addEventListener('pointermove', function(ev) {
                    if (!isSeeking) return;
                    ev.preventDefault();
                    seekFromEvent(ev);
                });
                ['pointerup', 'pointercancel', 'pointerleave'].forEach(function(type) {
                    progressTrack.addEventListener(type, function(ev) {
                        if (!isSeeking) return;
                        isSeeking = false;
                        try { progressTrack.releasePointerCapture(ev.pointerId); } catch (e) {}
                    });
                });
            }

            if (nowRow) {
                nowRow.addEventListener('click', handleNowRowSecretClick);
            }

            btn.addEventListener('click', function() {
                if (breakMusicList.length === 0) {
                    fileInput.click();
                    return;
                }
                if (!btn.classList.contains('playing') && isTimerRunningFromData(latestData)) {
                    alert('–ú—É–∑—ã–∫–∞ –ø–µ—Ä–µ—Ä—ã–≤–∞ –º–æ–∂–µ—Ç –∏–≥—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Ç–∞–π–º–µ—Ä –Ω–∞ –ø–∞—É–∑–µ.');
                    return;
                }
                if (btn.classList.contains('playing')) {
                    stopBreakMusic();
                    return;
                }
                playingNow = null;
                queueNext5 = [];
                fillQueueToFive();
                renderQueueRows();
                btn.classList.add('playing');
                btn.textContent = '‚ùö‚ùö';
                setState();
                var first = queueNext5.length > 0 ? getRandomTrack(queueNext5[0]) : getRandomTrack();
                playTrack(first);
            });
            if (prevBtn) prevBtn.addEventListener('click', function() {
                if (breakMusicList.length === 0 || !btn.classList.contains('playing')) return;
                if (playingNow) playTrack(playingNow);
            });
            if (nextBtn) nextBtn.addEventListener('click', function() {
                if (breakMusicList.length === 0 || !btn.classList.contains('playing')) return;
                advanceToNext();
            });
            setupQueueListDelegation();
            window.stopBreakMusicFromTimer = function() {
                stopBreakMusic();
            };
        })();

        (function initKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.repeat) return;
                const target = e.target;
                if (target && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.tagName === 'SELECT' || target.isContentEditable)) {
                    return;
                }
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    handleJingleKey(1);
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    handleJingleKey(2);
                } else if (e.key === ' ' || e.key === 'Spacebar') {
                    e.preventDefault();
                    if (isTimerPaused()) {
                        const breakBtn = document.getElementById('breakMusicPlayBtn');
                        if (breakBtn) breakBtn.click();
                    }
                } else if (e.key === 'Escape') {
                    if (jingleConfirmPending) {
                        jingleConfirmPending = null;
                        hideJingleConfirm();
                    }
                }
            });
        })();

        socket.on('connect', () => socket.emit('getCurrentState'));
        socket.on('reconnect', () => socket.emit('getCurrentState'));
        socket.on('scoreboardUpdate', (data) => { latestData = data; updateDisplay(data); });
        socket.on('currentState', (data) => { latestData = data; updateDisplay(data); });
        socket.on('teamUseAltNumbersUpdated', (data) => {
            const { teamId, useAltNumbers } = data;
            localStorage.setItem(`team-${teamId}-useAltNumbers`, useAltNumbers.toString());
            if (latestData && ((latestData.team1Id && String(latestData.team1Id) === String(teamId)) || (latestData.team2Id && String(latestData.team2Id) === String(teamId)))) {
                const team1Id = latestData.team1Id || null;
                const team2Id = latestData.team2Id || null;
                if (rosterTeam1Coach && rosterTeam1Players && team1Id && String(team1Id) === String(teamId)) {
                    renderRostersMode(rosterTeam1Coach, rosterTeam1Players, latestData.team1Staff || latestData.staff1 || [], latestData.team1Players || latestData.players1 || [], false, team1Id);
                }
                if (rosterTeam2Coach && rosterTeam2Players && team2Id && String(team2Id) === String(teamId)) {
                    renderRostersMode(rosterTeam2Coach, rosterTeam2Players, latestData.team2Staff || latestData.staff2 || [], latestData.team2Players || latestData.players2 || [], true, team2Id);
                }
            }
        });
    </script>
</body>
</html>
