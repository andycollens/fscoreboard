<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service ‚Äî –°–æ—Å—Ç–∞–≤—ã –∫–æ–º–∞–Ω–¥</title>
    <style>
        @font-face {
            font-family: 'RPL';
            src: url('/public/fonts/RPL.ttf') format('truetype');
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background: transparent;
            font-family: 'RPL', Arial, sans-serif;
            overflow: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url('/public/img/memberspage_bg.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            opacity: 0.9375;
            z-index: -2;
            clip-path: inset(0 0 100% 0);
            animation: none;
        }

        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: -1;
            clip-path: inset(0 0 100% 0);
            animation: none;
        }

        body.background-loaded::before,
        body.background-loaded::after {
            animation: slideDownBackground 0.5s ease-out forwards;
        }

        @keyframes slideDownBackground {
            from {
                clip-path: inset(0 0 100% 0);
            }
            to {
                clip-path: inset(0 0 0 0);
            }
        }

        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: -1;
        }

        body.rosters-mode,
        body.rosters-mode #scoreboardMode {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .stadium-container {
            position: fixed;
            inset: 0;
            display: grid !important;
            grid-template-rows: 30px 230px 1fr;
            height: 100vh;
            width: 100vw;
            background: transparent;
            opacity: 0;
            animation: none;
        }

        body.content-ready .stadium-container {
            animation: fadeInContent 0.4s ease-in 0.5s forwards;
        }

        @keyframes fadeInContent {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .top-section {
            display: block !important;
            height: 30px;
            width: 100%;
            background: transparent;
        }

        .tournament-title {
            display: none !important;
        }

        .rosters-subtitle {
            display: none !important;
        }

        .middle-section {
            display: grid !important;
            grid-template-columns: 1fr 1fr;
            height: 230px;
            width: 100%;
            background: transparent;
            gap: 0;
        }

        .middle-content {
            display: grid !important;
            grid-template-columns: 1fr auto 1fr;
            width: 100%;
            height: 100%;
            padding: 0;
            box-sizing: border-box;
            gap: 0;
            grid-column: 1 / -1;
        }

        .team-penalty-track {
            display: none !important;
        }

        .score1-section,
        .score2-section {
            display: none !important;
        }

        .team1-score,
        .team2-score {
            display: none !important;
        }

        .team1-section {
            display: flex !important;
            flex-direction: row;
            align-items: center;
            justify-content: flex-end;
            gap: clamp(12px, 2vw, 28px);
            padding: 0 2vw;
            padding-left: 80px;
            box-sizing: border-box;
        }

        .team2-section {
            display: flex !important;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: clamp(12px, 2vw, 28px);
            padding: 0 2vw;
            padding-right: 80px;
            box-sizing: border-box;
        }

        .team1-logo,
        .team1-no-logo {
            order: 2;
        }

        .team1-meta {
            order: 1;
        }

        .team2-logo,
        .team2-no-logo {
            order: 1;
        }

        .team2-meta {
            order: 2;
        }

        .team1-logo,
        .team2-logo,
        .team1-no-logo,
        .team2-no-logo {
            width: 200px;
            height: 200px;
            flex-shrink: 0;
        }

        .team1-logo,
        .team2-logo {
            object-fit: contain;
            display: none;
        }

        .team1-logo.show,
        .team2-logo.show {
            display: block;
        }

        .team1-no-logo,
        .team2-no-logo {
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4vw;
            color: #fff;
            font-weight: bold;
        }

        .team1-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0;
            min-width: 0;
            text-align: right;
        }

        .team1-meta .team1-name {
            margin-bottom: 1vh;
        }

        .team1-meta .team1-city {
            margin-top: 0;
            align-self: flex-end;
        }

        .team2-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0;
            min-width: 0;
            text-align: left;
        }

        .team2-meta .team2-name {
            margin-bottom: 1vh;
        }

        .team2-meta .team2-city {
            margin-top: 0;
            align-self: flex-start;
        }

        .team1-name,
        .team2-name {
            font-size: 3vw;
            margin: 0;
            margin-top: 40px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #fff;
        }

        .team1-stripe,
        .team2-stripe {
            width: clamp(60px, 8vw, 140px);
            height: clamp(8px, 0.6vw, 14px);
            margin: 0;
            opacity: 1 !important;
            display: none !important;
        }

        .team1-city,
        .team2-city {
            font-size: 2.5vw;
            margin: 0;
            margin-top: 40px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #fff;
        }

        .bottom-section {
            display: grid !important;
            grid-template-columns: 1fr auto 1fr;
            width: 100%;
            height: 100%;
            background: transparent;
            overflow: hidden;
            gap: 0;
        }

        .roster-team1,
        .roster-team2 {
            display: flex !important;
            position: relative !important;
            visibility: visible !important;
            pointer-events: auto !important;
            flex-direction: column;
            width: 100%;
            height: 100%;
            min-width: 0;
            min-height: 0;
            padding: 2vh 2vw;
            box-sizing: border-box;
            overflow: hidden;
        }

        .roster-team1 {
            grid-column: 1;
            align-items: flex-start;
            padding-left: 80px;
        }

        .roster-divider {
            grid-column: 2;
            display: flex !important;
            position: relative !important;
            visibility: visible !important;
            pointer-events: auto !important;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 100%;
            z-index: 10;
        }

        .roster-colon {
            width: 8px;
            height: 80%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0) 0%, #ffffff 50%, rgba(255, 255, 255, 0) 100%);
            border-radius: 8px;
            opacity: 1;
        }

        .roster-team2 {
            grid-column: 3;
            align-items: flex-end;
            padding-right: 80px;
        }

        .roster-coach-label,
        .roster-players-label {
            font-weight: 700;
            font-size: 2.1vw;
            margin: 0 0 0.5vh 0;
            display: block;
            color: #b0b0b0;
        }

        .roster-coach-name {
            font-size: 2.0vw;
            font-weight: 500;
            margin: 0 0 2vh 0;
            display: block;
            color: #fff;
        }

        .roster-players-list {
            font-weight: 500;
            line-height: 1.5;
            display: block;
            width: 100%;
            color: #fff;
            flex: 1;
            min-height: 0;
            overflow: hidden;
            position: relative;
        }

        .roster-players-scroll {
            font-size: 1.6vw;
            column-count: 2;
            column-gap: 2vw;
            width: 100%;
            will-change: transform;
        }

        .roster-players-list.many-players {
            padding-bottom: 60px;
            padding-top: 30px;
            box-sizing: border-box;
            -webkit-mask-image: linear-gradient(to bottom, transparent 0, black 40px, black calc(100% - 50px), transparent 100%);
            mask-image: linear-gradient(to bottom, transparent 0, black 40px, black calc(100% - 50px), transparent 100%);
        }

        .roster-players-list.many-players .roster-players-scroll {
            font-size: 1.6vw;
        }

        .roster-player-item {
            display: flex;
            align-items: baseline;
            gap: 0.5vw;
        }

        .roster-player-number {
            text-align: right;
            min-width: 2.5vw;
            flex-shrink: 0;
            font-size: 1.5vw;
            color: #b0b0b0;
        }

        .roster-player-name {
            flex: 1;
        }

        .roster-team1 .roster-coach-label,
        .roster-team1 .roster-coach-name,
        .roster-team1 .roster-players-label,
        .roster-team1 .roster-players-list {
            text-align: left;
        }

        .roster-team2 .roster-coach-label,
        .roster-team2 .roster-coach-name,
        .roster-team2 .roster-players-label,
        .roster-team2 .roster-players-list {
            text-align: right;
        }

        .roster-team2 .roster-player-item {
            flex-direction: row;
            gap: 0.5vw;
            justify-content: flex-end;
        }

        .roster-team2 .roster-player-number {
            text-align: left;
            min-width: 2.0vw;
            flex-shrink: 0;
        }

        .roster-team2 .roster-player-name {
            text-align: right;
            flex: 1;
        }

        .divider-section,
        .timer {
            display: none !important;
        }

        .match-score-label,
        .penalty-label,
        .penalty-overlay {
            display: none !important;
        }

        /* –ü–ª–µ–µ—Ä –¥–∂–∏–Ω–≥–ª–æ–≤ ‚Äî –¥–≤–µ —Å—Ç—Ä–æ–∫–∏: –Ω–∞–∑–≤–∞–Ω–∏–µ | —Ü–≤–µ—Ç —Ñ–æ—Ä–º—ã | Play | –¥–∂–∏–Ω–≥–ª; –≥—Ä–æ–º–∫–æ—Å—Ç—å —Å –∏–∫–æ–Ω–∫–∞–º–∏ */
        .jingle-player-block {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: center;
            gap: 12px;
            padding: 14px 16px;
            min-width: 200px;
            background: linear-gradient(165deg, rgba(255,255,255,0.18) 0%, rgba(255,255,255,0.06) 50%, rgba(0,0,0,0.08) 100%);
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.25);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), inset 0 -1px 0 rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.25);
        }
        .jingle-team-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .jingle-team-name {
            font-size: 11px;
            font-weight: 600;
            color: rgba(255,255,255,0.95);
            min-width: 52px;
            max-width: 70px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 1px 1px rgba(0,0,0,0.4);
        }
        .jingle-team-color-bar {
            width: 3px;
            height: 22px;
            border-radius: 2px;
            flex-shrink: 0;
            background: #2b2b2b;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.2);
        }
        .jingle-team-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 0;
        }
        .jingle-play-btn {
            width: 30px;
            height: 30px;
            border: 1px solid rgba(0,0,0,0.25);
            border-radius: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.15) 50%, rgba(0,0,0,0.1) 100%);
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            padding: 0;
            flex-shrink: 0;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.6), 0 2px 4px rgba(0,0,0,0.25);
            transition: all 0.15s ease;
        }
        .jingle-play-btn:hover {
            background: linear-gradient(180deg, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.22) 50%, rgba(0,0,0,0.08) 100%);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.7), 0 2px 6px rgba(0,0,0,0.3);
        }
        .jingle-play-btn:active {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        .jingle-play-btn.playing {
            background: linear-gradient(180deg, rgba(180,220,255,0.6) 0%, rgba(120,180,240,0.4) 50%, rgba(60,120,200,0.3) 100%);
            border-color: rgba(80,140,220,0.5);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.5), 0 2px 6px rgba(0,80,180,0.25);
        }
        .jingle-select {
            font-size: 10px;
            padding: 4px 6px;
            flex: 1;
            min-width: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.06) 100%);
            border: 1px solid rgba(0,0,0,0.25);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            outline: none;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.15), 0 1px 2px rgba(0,0,0,0.2);
            text-shadow: 0 1px 1px rgba(0,0,0,0.4);
        }
        .jingle-select option {
            background: #2a2a2a;
            color: #fff;
        }
        .jingle-progress-wrap {
            width: 100%;
            height: 4px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.25) 100%);
            border-radius: 2px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.4);
            border: 1px solid rgba(0,0,0,0.2);
            margin-top: 4px;
        }
        .jingle-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, rgba(100,160,255,0.9) 0%, rgba(140,200,255,0.95) 50%, rgba(180,220,255,0.9) 100%);
            border-radius: 2px;
            transition: width 0.12s linear;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.35);
        }
        .jingle-volume-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }
        .jingle-volume-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.85);
            font-size: 14px;
            flex-shrink: 0;
        }
        .jingle-volume-track-wrap {
            position: relative;
            flex: 1;
            height: 6px;
            min-width: 80px;
        }
        .jingle-volume-fill {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0%;
            background: linear-gradient(to bottom, #5a9cf5 0%, #7eb8ff 50%, #5a9cf5 100%);
            border-radius: 3px 0 0 3px;
            pointer-events: none;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3);
            transition: width 0.1s ease;
        }
        .jingle-volume-row input[type="range"] {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            outline: none;
        }
        .jingle-volume-row input[type="range"]::-webkit-slider-runnable-track {
            height: 6px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.35) 0%, rgba(0,0,0,0.2) 100%);
            border-radius: 3px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.4);
        }
        .jingle-volume-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(145deg, #fff 0%, #e8e8e8 100%);
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.35);
            border: 1px solid rgba(0,0,0,0.15);
            margin-top: -4px;
        }
        .jingle-volume-row input[type="range"]::-moz-range-track {
            height: 6px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.35) 0%, rgba(0,0,0,0.2) 100%);
            border-radius: 3px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.4);
        }
        .jingle-volume-row input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(145deg, #fff 0%, #e8e8e8 100%);
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.35);
            border: 1px solid rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="rosters-mode">
    <div class="stadium-container" id="scoreboardMode">
        <!-- –í–µ—Ä—Ö–Ω—è—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="top-section">
            <div class="tournament-title" id="tournamentTitle">ISKRA CUP 2025</div>
            <div class="rosters-subtitle" id="rostersSubtitle">–°–æ—Å—Ç–∞–≤—ã –∫–æ–º–∞–Ω–¥</div>
        </div>

        <!-- –°—Ä–µ–¥–Ω—è—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="middle-section">
            <div class="middle-content">
                <!-- –ö–æ–º–∞–Ω–¥–∞ 1 -->
                <div class="team1-section">
                    <img id="team1Logo" class="team1-logo" alt="–õ–æ–≥–æ—Ç–∏–ø –∫–æ–º–∞–Ω–¥—ã 1">
                    <div id="team1NoLogo" class="team1-no-logo" style="background-color: #2b2b2b;"></div>
                    <div class="team1-meta">
                        <div class="team1-name" id="team1Name">–ö–æ–º–∞–Ω–¥–∞ 1</div>
                        <div id="team1Stripe" class="team1-stripe"></div>
                        <div class="team1-city" id="team1City">–ì–æ—Ä–æ–¥ 1</div>
                    </div>
                </div>

                <!-- –ü–ª–µ–µ—Ä –¥–∂–∏–Ω–≥–ª–æ–≤: —Å—Ç—Ä–æ–∫–∞ 1 ‚Äî –∫–æ–º–∞–Ω–¥–∞ 1, —Å—Ç—Ä–æ–∫–∞ 2 ‚Äî –∫–æ–º–∞–Ω–¥–∞ 2, –≤–Ω–∏–∑—É –≥—Ä–æ–º–∫–æ—Å—Ç—å -->
                <div class="jingle-player-block">
                    <div class="jingle-team-row">
                        <span class="jingle-team-name" id="jingleTeam1Name">–ö–æ–º–∞–Ω–¥–∞ 1</span>
                        <div class="jingle-team-color-bar" id="jingleTeam1ColorBar"></div>
                        <div class="jingle-team-controls">
                            <button type="button" class="jingle-play-btn" id="jinglePlay1" title="Play">‚ñ∂</button>
                            <select class="jingle-select" id="jingleSelect1" title="–î–∂–∏–Ω–≥–ª –∫–æ–º–∞–Ω–¥—ã 1"></select>
                        </div>
                    </div>
                    <div class="jingle-progress-wrap" id="jingleProgressWrap1"><div class="jingle-progress-fill" id="jingleProgressFill1"></div></div>
                    <div class="jingle-team-row">
                        <span class="jingle-team-name" id="jingleTeam2Name">–ö–æ–º–∞–Ω–¥–∞ 2</span>
                        <div class="jingle-team-color-bar" id="jingleTeam2ColorBar"></div>
                        <div class="jingle-team-controls">
                            <button type="button" class="jingle-play-btn" id="jinglePlay2" title="Play">‚ñ∂</button>
                            <select class="jingle-select" id="jingleSelect2" title="–î–∂–∏–Ω–≥–ª –∫–æ–º–∞–Ω–¥—ã 2"></select>
                        </div>
                    </div>
                    <div class="jingle-progress-wrap" id="jingleProgressWrap2"><div class="jingle-progress-fill" id="jingleProgressFill2"></div></div>
                    <div class="jingle-volume-row">
                        <span class="jingle-volume-icon" aria-hidden="true">üîà</span>
                        <div class="jingle-volume-track-wrap">
                            <div class="jingle-volume-fill" id="jingleVolumeFill"></div>
                            <input type="range" id="jingleVolume" min="0" max="1" step="0.01" value="0.7" title="–ì—Ä–æ–º–∫–æ—Å—Ç—å">
                        </div>
                        <span class="jingle-volume-icon" aria-hidden="true">üîä</span>
                    </div>
                </div>

                <!-- –ö–æ–º–∞–Ω–¥–∞ 2 -->
                <div class="team2-section">
                    <img id="team2Logo" class="team2-logo" alt="–õ–æ–≥–æ—Ç–∏–ø –∫–æ–º–∞–Ω–¥—ã 2">
                    <div id="team2NoLogo" class="team2-no-logo" style="background-color: #2b2b2b;"></div>
                    <div class="team2-meta">
                        <div class="team2-name" id="team2Name">–ö–æ–º–∞–Ω–¥–∞ 2</div>
                        <div id="team2Stripe" class="team2-stripe"></div>
                        <div class="team2-city" id="team2City">–ì–æ—Ä–æ–¥ 2</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ù–∏–∂–Ω—è—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="bottom-section">
            <div class="roster-team1" id="rosterTeam1">
                <div class="roster-coach-label">–¢—Ä–µ–Ω–µ—Ä:</div>
                <div class="roster-coach-name" id="rosterTeam1Coach"></div>
                <div class="roster-players-label">–ò–≥—Ä–æ–∫–∏:</div>
                <div class="roster-players-list" id="rosterTeam1Players"></div>
            </div>
            <div class="roster-divider" id="rosterDivider">
                <div class="roster-colon"></div>
            </div>
            <div class="roster-team2" id="rosterTeam2">
                <div class="roster-coach-label">–¢—Ä–µ–Ω–µ—Ä:</div>
                <div class="roster-coach-name" id="rosterTeam2Coach"></div>
                <div class="roster-players-label">–ò–≥—Ä–æ–∫–∏:</div>
                <div class="roster-players-list" id="rosterTeam2Players"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ–Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∞–Ω–∏–º–∞—Ü–∏–∏
        const bgImage = new Image();
        bgImage.onload = function() {
            document.body.classList.add('background-loaded');
            setTimeout(() => {
                document.body.classList.add('content-ready');
            }, 500);
        };
        bgImage.onerror = function() {
            document.body.classList.add('background-loaded');
            setTimeout(() => {
                document.body.classList.add('content-ready');
            }, 500);
        };
        bgImage.src = '/public/img/memberspage_bg.jpg';

        const socket = io();
        let latestData = null;
        let lastRosterSignature = '';

        function escapeHtml(str = '') {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderRostersMode(coachEl, playersEl, staff, players, isRightSide = false, teamId = null) {
            if (coachEl) {
                if (staff && Array.isArray(staff) && staff.length > 0) {
                    const coachNames = staff
                        .map(item => {
                            if (!item) return '';
                            if (typeof item === 'string') return escapeHtml(item);
                            return escapeHtml(item.name || '');
                        })
                        .filter(Boolean);
                    if (coachNames.length > 0) {
                        coachEl.innerHTML = coachNames.join('<br>');
                    } else {
                        coachEl.innerHTML = '';
                    }
                } else {
                    coachEl.innerHTML = '';
                }
            }

            if (playersEl) {
                if (players && Array.isArray(players) && players.length > 0) {
                    const hasAltNumbers = players.some(p => {
                        if (typeof p === 'string') return false;
                        return p.number && p.number.includes('/');
                    });
                    let useAltNumbers = false;
                    if (hasAltNumbers) {
                        if (teamId) {
                            useAltNumbers = localStorage.getItem(`team-${teamId}-useAltNumbers`) === 'true';
                        } else {
                            useAltNumbers = localStorage.getItem('globalUseAltNumbers') === 'true';
                        }
                    }
                    const playerItems = players
                        .map(item => {
                            if (!item) return '';
                            let num = '';
                            let name = '';
                            if (typeof item === 'string') {
                                const parts = item.trim().split(/\s+/);
                                num = parts[0].match(/^\d+$/) ? parts[0] : '‚Äî';
                                name = num !== '‚Äî' ? parts.slice(1).join(' ') : item;
                            } else {
                                num = item.number != null && item.number !== '' ? String(item.number) : '‚Äî';
                                name = item.name || '';
                                if (num && num !== '‚Äî' && num.includes('/')) {
                                    const [num1, num2] = num.split('/');
                                    num = useAltNumbers ? (num2 || num1) : (num1 || '');
                                }
                            }
                            const numDisplay = (num === '' || num == null) ? '‚Äî' : num;
                            if (isRightSide) {
                                return `<div class="roster-player-item">
                                    <span class="roster-player-name">${escapeHtml(name)}</span>
                                    <span class="roster-player-number">${escapeHtml(numDisplay)}</span>
                                </div>`;
                            } else {
                                return `<div class="roster-player-item">
                                    <span class="roster-player-number">${escapeHtml(numDisplay)}</span>
                                    <span class="roster-player-name">${escapeHtml(name)}</span>
                                </div>`;
                            }
                        })
                        .filter(Boolean);
                    playersEl.innerHTML = `<div class="roster-players-scroll">${playerItems.join('')}</div>`;
                } else {
                    playersEl.innerHTML = '';
                }
            }
        }

        function updateStripe(team, color) {
            const stripe = team === 'team1' ? team1Stripe : team2Stripe;
            const direction = team === 'team1' ? 'to right' : 'to left';
            if (color && color !== '') {
                stripe.style.background = `linear-gradient(${direction}, transparent, ${color} 70px, ${color} 130px, transparent 200px)`;
                setTimeout(() => stripe.classList.add('active'), 100);
            } else {
                stripe.classList.remove('active');
                stripe.style.background = `linear-gradient(${direction}, transparent, #2b2b2b 70px, #2b2b2b 130px, transparent 200px)`;
            }
        }

        function updateDisplay(data) {
            // –ö–æ–º–∞–Ω–¥–∞ 1
            if (data.team1Logo && data.team1Logo !== '') {
                team1Logo.src = data.team1Logo;
                team1Logo.classList.add('show');
                team1NoLogo.style.display = 'none';
            } else {
                team1Logo.classList.remove('show');
                team1NoLogo.style.display = 'flex';
                if (data.kit1Color) team1NoLogo.style.backgroundColor = data.kit1Color;
            }
            team1Name.textContent = data.team1Name || '–ö–æ–º–∞–Ω–¥–∞ 1';
            team1City.textContent = data.team1City || '–ì–æ—Ä–æ–¥ 1';
            updateStripe('team1', data.kit1Color);

            const rosterSig = JSON.stringify({
                t1: data.team1Staff || data.staff1 || [],
                t2: data.team2Staff || data.staff2 || [],
                p1: data.team1Players || data.players1 || [],
                p2: data.team2Players || data.players2 || []
            });
            if (rosterSig !== lastRosterSignature && rosterTeam1Coach && rosterTeam1Players && rosterTeam2Coach && rosterTeam2Players) {
                lastRosterSignature = rosterSig;
                const team1Id = data.team1Id || null;
                const team2Id = data.team2Id || null;
                renderRostersMode(rosterTeam1Coach, rosterTeam1Players, data.team1Staff || data.staff1 || [], data.team1Players || data.players1 || [], false, team1Id);
                renderRostersMode(rosterTeam2Coach, rosterTeam2Players, data.team2Staff || data.staff2 || [], data.team2Players || data.players2 || [], true, team2Id);
            }

            // –ö–æ–º–∞–Ω–¥–∞ 2
            if (data.team2Logo && data.team2Logo !== '') {
                team2Logo.src = data.team2Logo;
                team2Logo.classList.add('show');
                team2NoLogo.style.display = 'none';
            } else {
                team2Logo.classList.remove('show');
                team2NoLogo.style.display = 'flex';
                if (data.kit2Color) team2NoLogo.style.backgroundColor = data.kit2Color;
            }
            team2Name.textContent = data.team2Name || '–ö–æ–º–∞–Ω–¥–∞ 2';
            team2City.textContent = data.team2City || '–ì–æ—Ä–æ–¥ 2';
            updateStripe('team2', data.kit2Color);

            const team1PlayersCount = (data.team1Players || data.players1 || []).length;
            const team2PlayersCount = (data.team2Players || data.players2 || []).length;
            const maxPlayersCount = Math.max(team1PlayersCount, team2PlayersCount);
            if (rosterTeam1Players && rosterTeam2Players) {
                if (maxPlayersCount > 24) {
                    const alreadyHadMany = rosterTeam1Players.classList.contains('many-players');
                    rosterTeam1Players.classList.add('many-players');
                    rosterTeam2Players.classList.add('many-players');
                    if (!alreadyHadMany) initRosterAutoScroll();
                } else {
                    rosterTeam1Players.classList.remove('many-players');
                    rosterTeam2Players.classList.remove('many-players');
                    stopRosterAutoScroll();
                }
            }
            if (data.tournamentTitle && tournamentTitle) {
                tournamentTitle.textContent = data.tournamentTitle;
            }
            const jingleTeam1NameEl = document.getElementById('jingleTeam1Name');
            const jingleTeam2NameEl = document.getElementById('jingleTeam2Name');
            const jingleTeam1ColorBarEl = document.getElementById('jingleTeam1ColorBar');
            const jingleTeam2ColorBarEl = document.getElementById('jingleTeam2ColorBar');
            if (jingleTeam1NameEl) jingleTeam1NameEl.textContent = data.team1Name || '–ö–æ–º–∞–Ω–¥–∞ 1';
            if (jingleTeam2NameEl) jingleTeam2NameEl.textContent = data.team2Name || '–ö–æ–º–∞–Ω–¥–∞ 2';
            if (jingleTeam1ColorBarEl) jingleTeam1ColorBarEl.style.backgroundColor = data.kit1Color || '#2b2b2b';
            if (jingleTeam2ColorBarEl) jingleTeam2ColorBarEl.style.backgroundColor = data.kit2Color || '#2b2b2b';
        }

        const team1Logo = document.getElementById('team1Logo');
        const team1NoLogo = document.getElementById('team1NoLogo');
        const team1Name = document.getElementById('team1Name');
        const team1City = document.getElementById('team1City');
        const team1Stripe = document.getElementById('team1Stripe');
        const team2Logo = document.getElementById('team2Logo');
        const team2NoLogo = document.getElementById('team2NoLogo');
        const team2Name = document.getElementById('team2Name');
        const team2City = document.getElementById('team2City');
        const team2Stripe = document.getElementById('team2Stripe');
        const rosterTeam1Coach = document.getElementById('rosterTeam1Coach');
        const rosterTeam1Players = document.getElementById('rosterTeam1Players');
        const rosterTeam2Coach = document.getElementById('rosterTeam2Coach');
        const rosterTeam2Players = document.getElementById('rosterTeam2Players');
        const tournamentTitle = document.getElementById('tournamentTitle');

        let rosterScrollAnimations = [];

        function ensureRosterOverflow(el) {
            if (!el) return false;
            const content = el.querySelector('.roster-players-scroll');
            if (!content) return false;
            let extra = content.scrollHeight - el.clientHeight;
            if (extra > 2) return true;
            let filler = content.querySelector('.roster-scroll-filler');
            if (!filler) {
                filler = document.createElement('div');
                filler.className = 'roster-scroll-filler';
                filler.style.height = '160px';
                filler.style.opacity = '0';
                filler.style.pointerEvents = 'none';
                filler.style.width = '100%';
                content.appendChild(filler);
            } else {
                filler.style.height = (parseInt(filler.style.height || '160', 10) + 80) + 'px';
            }
            return content.scrollHeight - el.clientHeight > 2;
        }

        function initRosterAutoScroll() {
            stopRosterAutoScroll();
            const lists = [rosterTeam1Players, rosterTeam2Players]
                .filter(el => el && el.classList.contains('many-players'))
                .filter(el => ensureRosterOverflow(el));
            if (lists.length === 0) return;
            const scrollSpeed = 22;
            const pauseDuration = 5000;
            lists.forEach((el) => {
                const content = el.querySelector('.roster-players-scroll');
                if (!content) return;
                content.style.transform = 'translateY(0)';
                const state = { direction: 1, lastTime: null, isPaused: true, pauseUntil: Date.now() + pauseDuration, offset: 0 };
                const anim = { type: 'raf', id: null };
                function step(timestamp) {
                    anim.id = requestAnimationFrame(step);
                    if (!el.classList.contains('many-players')) return;
                    const maxScroll = content.scrollHeight - el.clientHeight;
                    if (maxScroll <= 0) return;
                    if (state.isPaused) {
                        if (Date.now() >= state.pauseUntil) { state.isPaused = false; state.lastTime = timestamp; }
                        return;
                    }
                    if (state.lastTime === null) state.lastTime = timestamp;
                    const dt = (timestamp - state.lastTime) / 1000;
                    state.lastTime = timestamp;
                    state.offset += state.direction * scrollSpeed * dt;
                    if (state.offset <= 0) { state.offset = 0; state.direction = 1; state.isPaused = true; state.pauseUntil = Date.now() + pauseDuration; }
                    else if (state.offset >= maxScroll) { state.offset = maxScroll; state.direction = -1; state.isPaused = true; state.pauseUntil = Date.now() + pauseDuration; }
                    content.style.transform = `translateY(-${state.offset}px)`;
                }
                anim.id = requestAnimationFrame(step);
                rosterScrollAnimations.push(anim);
            });
        }

        function stopRosterAutoScroll() {
            rosterScrollAnimations.forEach(item => {
                if (!item) return;
                if (item.type === 'raf') cancelAnimationFrame(item.id);
                else if (typeof item === 'number') { clearInterval(item); clearTimeout(item); }
            });
            rosterScrollAnimations = [];
        }

        // –ü–ª–µ–µ—Ä –¥–∂–∏–Ω–≥–ª–æ–≤: –∫—ç—à –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞, –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
        const jingleCache = {};
        let jingleVolume = 0.7;
        const jingleBase = '/public/sound/';
        const jingleVolumeEl = document.getElementById('jingleVolume');
        const jinglePlay1 = document.getElementById('jinglePlay1');
        const jinglePlay2 = document.getElementById('jinglePlay2');
        const jingleSelect1 = document.getElementById('jingleSelect1');
        const jingleSelect2 = document.getElementById('jingleSelect2');
        const jingleProgressFill1 = document.getElementById('jingleProgressFill1');
        const jingleProgressFill2 = document.getElementById('jingleProgressFill2');
        let currentTeam1Audio = null;
        let currentTeam2Audio = null;

        function setProgressFill(teamNum, percent) {
            const el = teamNum === 1 ? jingleProgressFill1 : jingleProgressFill2;
            if (el) el.style.width = (percent || 0) + '%';
        }
        function updateProgressFromAudio(a) {
            if (!a.duration || !isFinite(a.duration)) return;
            const pct = (a.currentTime / a.duration) * 100;
            if (currentTeam1Audio === a) setProgressFill(1, pct);
            if (currentTeam2Audio === a) setProgressFill(2, pct);
        }

        function getOrCreateAudio(filename) {
            if (jingleCache[filename]) return jingleCache[filename];
            const a = new Audio(jingleBase + filename);
            jingleCache[filename] = a;
            a.addEventListener('timeupdate', () => updateProgressFromAudio(a));
            a.addEventListener('loadedmetadata', () => updateProgressFromAudio(a));
            a.addEventListener('ended', () => {
                if (currentTeam1Audio === a) { if (jinglePlay1) { jinglePlay1.textContent = '‚ñ∂'; jinglePlay1.classList.remove('playing'); } currentTeam1Audio = null; setProgressFill(1, 0); }
                if (currentTeam2Audio === a) { if (jinglePlay2) { jinglePlay2.textContent = '‚ñ∂'; jinglePlay2.classList.remove('playing'); } currentTeam2Audio = null; setProgressFill(2, 0); }
            });
            return a;
        }
        function preloadJingle(filename) {
            const a = getOrCreateAudio(filename);
            a.volume = jingleVolume;
            a.load();
        }
        function applyVolumeToAll() {
            if (jingleVolumeEl) jingleVolume = parseFloat(jingleVolumeEl.value);
            Object.keys(jingleCache).forEach(f => { jingleCache[f].volume = jingleVolume; });
        }
        function playJingle(teamNum) {
            const select = teamNum === 1 ? jingleSelect1 : jingleSelect2;
            const btn = teamNum === 1 ? jinglePlay1 : jinglePlay2;
            const currentRef = teamNum === 1 ? 'currentTeam1Audio' : 'currentTeam2Audio';
            const otherRef = teamNum === 1 ? 'currentTeam2Audio' : 'currentTeam1Audio';
            const filename = select && select.value ? select.value : '';
            if (!filename) return;
            const a = getOrCreateAudio(filename);
            a.volume = jingleVolume;
            if (currentTeam1Audio === a || currentTeam2Audio === a) {
                a.pause();
                a.currentTime = 0;
                if (currentTeam1Audio === a) { currentTeam1Audio = null; setProgressFill(1, 0); }
                if (currentTeam2Audio === a) { currentTeam2Audio = null; setProgressFill(2, 0); }
                btn.textContent = '‚ñ∂';
                btn.classList.remove('playing');
                return;
            }
            if (currentTeam1Audio) { currentTeam1Audio.pause(); currentTeam1Audio.currentTime = 0; if (jinglePlay1) { jinglePlay1.textContent = '‚ñ∂'; jinglePlay1.classList.remove('playing'); } currentTeam1Audio = null; setProgressFill(1, 0); }
            if (currentTeam2Audio) { currentTeam2Audio.pause(); currentTeam2Audio.currentTime = 0; if (jinglePlay2) { jinglePlay2.textContent = '‚ñ∂'; jinglePlay2.classList.remove('playing'); } currentTeam2Audio = null; setProgressFill(2, 0); }
            if (teamNum === 1) currentTeam1Audio = a; else currentTeam2Audio = a;
            setProgressFill(teamNum, 0);
            btn.textContent = '‚ùö‚ùö';
            btn.classList.add('playing');
            a.currentTime = 0;
            a.play();
        }
        function onJingleSelect(teamNum) {
            const select = teamNum === 1 ? jingleSelect1 : jingleSelect2;
            const filename = select && select.value ? select.value : '';
            if (filename) preloadJingle(filename);
        }
        (function initJinglePlayer() {
            fetch('/api/jingles').then(r => r.json()).then(data => {
                const list = data.jingles || [];
                const opt = (v, label) => { const o = document.createElement('option'); o.value = v; o.textContent = label || v.replace(/\.(mp3|ogg|m4a|wav)$/i, ''); return o; };
                [jingleSelect1, jingleSelect2].forEach(sel => {
                    if (!sel) return;
                    sel.innerHTML = '';
                    sel.appendChild(opt('', '‚Äî'));
                    list.forEach(f => sel.appendChild(opt(f, f.replace(/\.(mp3|ogg|m4a|wav)$/i, ''))));
                });
            }).catch(() => {});
            const jingleVolumeFillEl = document.getElementById('jingleVolumeFill');
        function updateVolumeFill() {
            if (jingleVolumeFillEl && jingleVolumeEl) jingleVolumeFillEl.style.width = (parseFloat(jingleVolumeEl.value) * 100) + '%';
        }
        if (jingleVolumeEl) {
            jingleVolumeEl.addEventListener('input', function() { applyVolumeToAll(); updateVolumeFill(); });
            updateVolumeFill();
        }
            if (jinglePlay1) jinglePlay1.addEventListener('click', () => playJingle(1));
            if (jinglePlay2) jinglePlay2.addEventListener('click', () => playJingle(2));
            if (jingleSelect1) jingleSelect1.addEventListener('change', () => onJingleSelect(1));
            if (jingleSelect2) jingleSelect2.addEventListener('change', () => onJingleSelect(2));
        })();

        socket.on('connect', () => socket.emit('getCurrentState'));
        socket.on('reconnect', () => socket.emit('getCurrentState'));
        socket.on('scoreboardUpdate', (data) => { latestData = data; updateDisplay(data); });
        socket.on('currentState', (data) => { latestData = data; updateDisplay(data); });
        socket.on('teamUseAltNumbersUpdated', (data) => {
            const { teamId, useAltNumbers } = data;
            localStorage.setItem(`team-${teamId}-useAltNumbers`, useAltNumbers.toString());
            if (latestData && ((latestData.team1Id && String(latestData.team1Id) === String(teamId)) || (latestData.team2Id && String(latestData.team2Id) === String(teamId)))) {
                const team1Id = latestData.team1Id || null;
                const team2Id = latestData.team2Id || null;
                if (rosterTeam1Coach && rosterTeam1Players && team1Id && String(team1Id) === String(teamId)) {
                    renderRostersMode(rosterTeam1Coach, rosterTeam1Players, latestData.team1Staff || latestData.staff1 || [], latestData.team1Players || latestData.players1 || [], false, team1Id);
                }
                if (rosterTeam2Coach && rosterTeam2Players && team2Id && String(team2Id) === String(teamId)) {
                    renderRostersMode(rosterTeam2Coach, rosterTeam2Players, latestData.team2Staff || latestData.staff2 || [], latestData.team2Players || latestData.players2 || [], true, team2Id);
                }
            }
        });
    </script>
</body>
</html>
