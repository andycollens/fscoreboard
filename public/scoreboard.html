<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Scoreboard</title>
  <style>
    @font-face {
      font-family: 'RPL';
      src: url('/public/fonts/RPL.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    html, body {
      font-family: 'RPL', Arial, sans-serif;
      background: transparent !important;
      margin: 0;
      padding: 0;
      position: relative;
    }
    body {
      font-family: 'RPL', Arial, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: transparent !important;
    }
    .scoreboard-row {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      height: 40px;
      line-height: 40px;
      user-select: none;
      -webkit-user-select: none;
      background: transparent !important;
      font-size: 24px;
      gap: 0;
      position: relative;
      overflow: visible;
      opacity: 0;
      transition: opacity 0.1s ease-in;
    }

    body.elements-loaded .scoreboard-row {
      opacity: 1;
    }

    .divider-section {
      overflow: visible !important;
      z-index: 1;
    }
    .section {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 40px;
      line-height: 40px;
      box-sizing: border-box;
      font-family: 'RPL', Arial, sans-serif;
      font-weight: normal;
      border-radius: 0;
      box-shadow: none;
      background: transparent;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    .timer-section {
      width: 100px;
      background: #f6f3fc;
      color: #2b2b2b;
      font-size: 1.4em;
      letter-spacing: 2px;
    }
    .kit1-section, .kit2-section {
      width: 10px;
      background: #2b2b2b;
      transition: margin 0.3s ease;
    }
    
    /* Default style - no margins */
    .style-default .kit1-section {
      margin-right: 0;
    }
    
    .style-default .kit2-section {
      margin-left: 0;
    }
    
    /* ISKRACUP style - with margins */
    .style-iskracup .kit1-section {
      margin-right: 5px;
    }
    
    .style-iskracup .kit2-section {
      margin-left: 5px;
    }
    
    /* Winterleague style - with margins */
    .style-winterleague .kit1-section {
      margin-right: 5px;
    }
    
    .style-winterleague .kit2-section {
      margin-left: 5px;
    }
    
    .team1-section, .team2-section {
      background: #2b2b2b;
      color: #fff;
      font-size: 1.25em;
      letter-spacing: 2px;
      text-transform: uppercase;
      transition: width 0.3s ease;
    }
    
    /* Default style - team width 70px */
    .style-default .team1-section, .style-default .team2-section {
      width: 70px;
    }
    
    /* ISKRACUP style - team width 75px */
    .style-iskracup .team1-section, .style-iskracup .team2-section {
      width: 75px;
    }
    
    /* Winterleague style - team width 75px */
    .style-winterleague .team1-section, .style-winterleague .team2-section {
      width: 75px;
    }
    .score1-section, .score2-section {
      width: 40px;
      background: #2b2b2b;
      color: #fff;
      font-size: 1.6em;
      font-weight: normal;
      transition: font-size 0.2s ease;
    }
    
    .score1-section.small-score, .score2-section.small-score {
      font-size: 1.4em;
    }
    
    /* Winterleague style - background color #212536 */
    .style-winterleague .team1-section,
    .style-winterleague .team2-section,
    .style-winterleague .score1-section,
    .style-winterleague .score2-section,
    .style-winterleague .divider-section {
      background: #212536;
    }
    
    .divider-section {
      height: 40px;
      transition: width 0.3s ease, background 0.3s ease;
    }
    
    /* Default style - divider 2px */
    .style-default .divider-section {
      width: 2px;
      background: #424242;
      line-height: 40px;
      margin: 0;
      padding: 0;
      border-radius: 0;
      flex-shrink: 0;
      flex-grow: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    /* ISKRACUP style - divider 70px with logo */
    .style-iskracup .divider-section {
      width: 70px;
      background: #2b2b2b;
      line-height: 40px;
      margin: 0;
      padding: 0;
      border-radius: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      flex-grow: 0;
      position: relative;
    }
    
    /* Winterleague style - divider 70px with logo */
    .style-winterleague .divider-section {
      width: 70px;
      background: #2b2b2b;
      line-height: 40px;
      margin: 0;
      padding: 0;
      border-radius: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      flex-grow: 0;
      position: relative;
    }
    
    .divider-logo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      max-height: none;
      max-width: none;
      width: auto;
      height: auto;
      display: none;
      transition: opacity 0.3s ease;
      opacity: 0;
      filter: none;
      box-shadow: none;
    }
    
    .style-iskracup .divider-logo {
      display: block;
      opacity: 1;
    }
    
    .style-winterleague .divider-logo {
      display: block;
      opacity: 1;
    }
    
    /* Custom style with logo - show logo */
    .style-default .divider-logo[style*="display: block"] {
      display: block !important;
      opacity: 1 !important;
    }
    
    .scoreboard-row > * {
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
    }

  </style>
</head>
<body>
  <div class="scoreboard-row" id="scoreboardRow" style="position: absolute; top: 80px; left: 120px;">
    <!-- Timer section: displays the game timer -->
    <div class="section timer-section"><span id="timer" style="display: flex; align-items: flex-start; justify-content: center; height: 100%; width: 100%; font-size: inherit; transform: translateY(2px);">00:00</span></div>
    <!-- Kit 1 section: displays the color of the first team's kit -->
    <div class="section kit1-section" id="kit1"></div>
    <!-- Team 1 section: displays the short name of the first team -->
    <div class="section team1-section"><span id="team1" style="display: flex; align-items: flex-start; justify-content: center; height: 100%; width: 100%; font-size: inherit; transform: translateY(2px);">ABC</span></div>
    <!-- Score 1 section: displays the score of the first team -->
    <div class="section score1-section"><span id="score1" style="display: flex; align-items: flex-start; justify-content: center; height: 100%; width: 100%; font-size: inherit; transform: translateY(2px);">0</span></div>
    <!-- Divider section -->
    <div class="section divider-section" id="divider-logo">
      <img src="/public/img/iskracup_scoreboard_logo.png" alt="Logo" class="divider-logo" id="dividerLogoImg">
    </div>
    <!-- Score 2 section: displays the score of the second team -->
    <div class="section score2-section"><span id="score2" style="display: flex; align-items: flex-start; justify-content: center; height: 100%; width: 100%; font-size: inherit; transform: translateY(2px);">0</span></div>
    <!-- Team 2 section: displays the short name of the second team -->
    <div class="section team2-section"><span id="team2" style="display: flex; align-items: flex-start; justify-content: center; height: 100%; width: 100%; font-size: inherit; transform: translateY(2px);">XYZ</span></div>
    <!-- Kit 2 section: displays the color of the second team's kit -->
    <div class="section kit2-section" id="kit2"></div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Ждем загрузки всех изображений перед показом элементов
    function waitForElements() {
      const images = [];
      const logoImg = document.getElementById('dividerLogoImg');
      
      if (logoImg && logoImg.src) {
        const img = new Image();
        img.src = logoImg.src;
        images.push(new Promise((resolve) => {
          img.onload = resolve;
          img.onerror = resolve; // Продолжаем даже если изображение не загрузилось
        }));
      }
      
      // Также проверяем возможные логотипы из стилей
      const possibleLogos = [
        '/public/img/iskracup_scoreboard_logo.png',
        '/public/img/winterleague_scoreboard_logo.png'
      ];
      
      possibleLogos.forEach(src => {
        const img = new Image();
        img.src = src;
        images.push(new Promise((resolve) => {
          img.onload = resolve;
          img.onerror = resolve;
        }));
      });
      
      Promise.all(images).then(() => {
        // Все элементы загружены, показываем все разом
        document.body.classList.add('elements-loaded');
      });
    }

    // Default colors and team names for the scoreboard
    const defaultKitColor = "#2b2b2b";
    const defaultTeamShort = "???";
    
    // Initialize socket.io client
    const socket = io();

    // Load graphic style from config
    async function loadGraphicStyle() {
      try {
        const response = await fetch('/api/config');
        if (response.ok) {
          const config = await response.json();
          const style = config.graphicStyle || 'default';
          const customStyleData = config.customStyleData || null;
          console.log('Loaded graphic style from config:', style);
          applyGraphicStyle(style, customStyleData);
        } else {
          console.error('Failed to load config:', response.status);
          applyGraphicStyle('default', null);
        }
      } catch (error) {
        console.error('Error loading graphic style:', error);
        applyGraphicStyle('default', null);
      }
    }

    // Apply graphic style
    function applyGraphicStyle(style, customStyleData) {
      console.log('Applying graphic style:', style, customStyleData);
      const scoreboardRow = document.getElementById('scoreboardRow');
      const logoImg = document.getElementById('dividerLogoImg');
      
      if (!scoreboardRow) {
        console.error('scoreboardRow not found');
        return;
      }
      
      // Remove all style classes
      scoreboardRow.classList.remove('style-default', 'style-iskracup', 'style-winterleague');
      
      if (style === 'iskracup') {
        // Apply ISKRACUP style
        scoreboardRow.classList.add('style-iskracup');
        console.log('Added style-iskracup class');
        if (logoImg) {
          logoImg.src = '/public/img/iskracup_scoreboard_logo.png';
          // Use requestAnimationFrame to ensure CSS class is applied first
          requestAnimationFrame(() => {
            logoImg.style.display = 'block';
            requestAnimationFrame(() => {
              logoImg.style.opacity = '1';
            });
          });
          console.log('Logo should be visible now');
        } else {
          console.error('logoImg not found');
        }
      } else if (style === 'winterleague') {
        // Apply Winterleague style
        scoreboardRow.classList.add('style-winterleague');
        console.log('Added style-winterleague class');
        if (logoImg) {
          logoImg.src = '/public/img/winterleague_scoreboard_logo.png';
          // Use requestAnimationFrame to ensure CSS class is applied first
          requestAnimationFrame(() => {
            logoImg.style.display = 'block';
            requestAnimationFrame(() => {
              logoImg.style.opacity = '1';
            });
          });
          console.log('Winterleague logo should be visible now');
        } else {
          console.error('logoImg not found');
        }
      } else if (style && style.startsWith('custom:') && customStyleData) {
        // Apply custom style
        scoreboardRow.classList.add('style-default');
        console.log('Added style-default class for custom style');
        if (logoImg && customStyleData.logo) {
          // For custom style with logo, we need to make divider wider like iskracup style
          scoreboardRow.classList.add('style-iskracup');
          scoreboardRow.classList.remove('style-default');
          logoImg.src = customStyleData.logo;
          // Use requestAnimationFrame to ensure CSS class is applied first
          requestAnimationFrame(() => {
            logoImg.style.display = 'block';
            requestAnimationFrame(() => {
              logoImg.style.opacity = '1';
            });
          });
          console.log('Custom logo should be visible now');
        } else {
          // No logo in custom style, hide it
          if (logoImg) {
            logoImg.style.opacity = '0';
            setTimeout(() => {
              if (scoreboardRow.classList.contains('style-default')) {
                logoImg.style.display = 'none';
              }
            }, 300);
          }
        }
      } else {
        // Apply default style
        scoreboardRow.classList.add('style-default');
        console.log('Added style-default class');
        if (logoImg) {
          logoImg.style.opacity = '0';
          // Hide after transition
          setTimeout(() => {
            if (scoreboardRow.classList.contains('style-default')) {
              logoImg.style.display = 'none';
            }
          }, 300);
        }
      }
    }

    // Listen for 'scoreboardUpdate' events from the server
    socket.on('scoreboardUpdate', (data) => {
      // Update timer display
      document.getElementById('timer').textContent = data.time || "00:00";
      // Update kit colors
      document.getElementById('kit1').style.background = data.kit1Color || defaultKitColor;
      document.getElementById('kit2').style.background = data.kit2Color || defaultKitColor;
      // Update team names
      document.getElementById('team1').textContent = data.team1Short || defaultTeamShort;
      document.getElementById('team2').textContent = data.team2Short || defaultTeamShort;
      // Update scores, ensuring they are numbers
      const score1 = typeof data.score1 === 'number' ? data.score1 : 0;
      const score2 = typeof data.score2 === 'number' ? data.score2 : 0;
      document.getElementById('score1').textContent = score1;
      document.getElementById('score2').textContent = score2;
      
      // Уменьшаем размер шрифта если хотя бы один счет двузначный
      const score1Section = document.querySelector('.score1-section');
      const score2Section = document.querySelector('.score2-section');
      if (score1 >= 10 || score2 >= 10) {
        score1Section.classList.add('small-score');
        score2Section.classList.add('small-score');
      } else {
        score1Section.classList.remove('small-score');
        score2Section.classList.remove('small-score');
      }
    });

    // Listen for config updates
    socket.on('configUpdate', (data) => {
      console.log('Received configUpdate event:', data);
      if (data.graphicStyle) {
        console.log('Updating graphic style to:', data.graphicStyle);
        applyGraphicStyle(data.graphicStyle, data.customStyleData || null);
      }
    });

    // Load style on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        loadGraphicStyle();
        waitForElements();
      });
    } else {
      loadGraphicStyle();
      waitForElements();
    }
  </script>
</body>
</html>
