<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>ISKRA CUP Scoreboard</title>
  <style>
    @font-face {
      font-family: 'RPL';
      src: url('/public/fonts/RPL.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    html, body {
      font-family: 'RPL', Arial, sans-serif;
      background: transparent !important;
      margin: 0;
      padding: 0;
      position: relative;
    }
    body {
      font-family: 'RPL', Arial, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: transparent !important;
    }
    .scoreboard-row {
      display: flex;
      align-items: center;
      height: 72px;
      user-select: none;
      -webkit-user-select: none;
      background: transparent !important;
      font-size: 24px;
      gap: 0;
    }
    .section {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      box-sizing: border-box;
      font-family: 'RPL', Arial, sans-serif;
      font-weight: normal;
      border-radius: 0;
      box-shadow: none;
      margin: 0;
      padding: 0;
      background: #2b2b2b;
      color: #fff;
    }
    .kit-section {
      width: 12px;
      background: #2b2b2b;
    }
    .team-section {
      width: 188px;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 6px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .team-section.team-right {
      flex-direction: column;
    }
    .team-short {
      font-size: 24px;
      line-height: 24px;
    }
    .penalty-track {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      width: 100%;
    }
    .penalty-dots {
      display: flex;
      gap: 6px;
    }
    .team-section.team-right .penalty-dots {
      flex-direction: row-reverse;
    }
    .penalty-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.25);
    }
    .penalty-dot-goal {
      background: #1fb368;
    }
    .penalty-dot-miss {
      background: #d82727;
    }
    .penalty-count {
      font-size: 14px;
      letter-spacing: 2px;
      opacity: 0.85;
      display: none;
    }
    body.penalty-mode .penalty-track {
      display: flex;
    }
    body.penalty-mode .penalty-count {
      display: block;
    }
    .center-section {
      width: 220px;
      position: relative;
      flex-direction: column;
      gap: 4px;
    }
    .center-section img {
      position: absolute;
      width: 90px;
      height: auto;
      opacity: 0.22;
    }
    .main-score {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      gap: 8px;
      font-size: 1.6em;
      letter-spacing: 4px;
      z-index: 2;
      position: relative;
    }
    .score-number {
      display: block;
    }
    .score-divider {
      display: block;
      font-size: 0.9em;
      opacity: 0.85;
    }
    .scoreboard-row > * {
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
    }
  </style>
</head>
<body>
  <div class="scoreboard-row" style="position: absolute; top: 80px; left: 120px;">
    <div class="section kit-section" id="kit1"></div>
    <div class="section team-section team-left">
      <div class="team-short" id="team1">ABC</div>
      <div class="penalty-track">
        <div class="penalty-dots" id="penaltyDotsTeam1"></div>
        <div class="penalty-count" id="penaltyCountTeam1"></div>
      </div>
    </div>
    <div class="section center-section">
      <img src="/public/img/iskracup_scoreboard_logo.png" alt="ISKRA CUP">
      <div class="main-score">
        <span class="score-number" id="score1">0</span>
        <span class="score-divider">:</span>
        <span class="score-number" id="score2">0</span>
      </div>
    </div>
    <div class="section team-section team-right">
      <div class="team-short" id="team2">XYZ</div>
      <div class="penalty-track">
        <div class="penalty-dots" id="penaltyDotsTeam2"></div>
        <div class="penalty-count" id="penaltyCountTeam2"></div>
      </div>
    </div>
    <div class="section kit-section" id="kit2"></div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Default colors and team names for the scoreboard
    const defaultKitColor = "#2b2b2b";
    const defaultTeamShort = "???";
    
    // Initialize socket.io client
    const socket = io();

    // Listen for 'scoreboardUpdate' events from the server
    socket.on('scoreboardUpdate', (data) => {
      const penaltyActive = !!data.penaltyActive;
      document.body.classList.toggle('penalty-mode', penaltyActive);

      // Update kit colors
      document.getElementById('kit1').style.background = data.kit1Color || defaultKitColor;
      document.getElementById('kit2').style.background = data.kit2Color || defaultKitColor;

      // Update team names
      document.getElementById('team1').textContent = data.team1Short || defaultTeamShort;
      document.getElementById('team2').textContent = data.team2Short || defaultTeamShort;

      // Update match score
      document.getElementById('score1').textContent = typeof data.score1 === 'number' ? data.score1 : "0";
      document.getElementById('score2').textContent = typeof data.score2 === 'number' ? data.score2 : "0";

      if (penaltyActive && data.penaltySeries) {
        renderPenaltyDots('team1', data.penaltySeries, data.penaltyMode);
        renderPenaltyDots('team2', data.penaltySeries, data.penaltyMode);
      } else {
        clearPenaltyDots();
      }
    });

    function clearPenaltyDots() {
      ['penaltyDotsTeam1', 'penaltyDotsTeam2'].forEach(id => {
        const container = document.getElementById(id);
        if (container) container.innerHTML = '';
      });
      ['penaltyCountTeam1', 'penaltyCountTeam2'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '';
      });
    }

    function renderPenaltyDots(teamKey, series, modeFromState) {
      const dotsId = teamKey === 'team1' ? 'penaltyDotsTeam1' : 'penaltyDotsTeam2';
      const countId = teamKey === 'team1' ? 'penaltyCountTeam1' : 'penaltyCountTeam2';
      const dotsContainer = document.getElementById(dotsId);
      const countEl = document.getElementById(countId);
      if (!dotsContainer || !countEl) return;

      dotsContainer.innerHTML = '';

      const attempts = Array.isArray(series.attempts?.[teamKey]) ? series.attempts[teamKey] : [];
      const maxAttempts = series.maxAttempts || ((series.penaltyMode || modeFromState) === 'child' ? 3 : 5);
      const slots = new Array(maxAttempts).fill(null);
      attempts.forEach((result, index) => {
        slots[index % maxAttempts] = result;
      });

      slots.forEach(status => {
        const dot = document.createElement('div');
        dot.className = 'penalty-dot';
        if (status === 'goal') {
          dot.classList.add('penalty-dot-goal');
        } else if (status === 'miss') {
          dot.classList.add('penalty-dot-miss');
        }
        dotsContainer.appendChild(dot);
      });

      const goals = attempts.filter(result => result === 'goal').length;
      countEl.textContent = goals.toString();
    }
  </script>
</body>
</html>