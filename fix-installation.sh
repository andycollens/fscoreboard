#!/bin/bash

# =============================================================================
# FSCOREBOARD - Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸
# =============================================================================
# ĞĞ²Ñ‚Ğ¾Ñ€: FSCORE Team
# Ğ’ĞµÑ€ÑĞ¸Ñ: 1.0.0
# ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° Ğ¸ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ¹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¾Ğ¹
# =============================================================================

set -e

# Ğ¦Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
INSTALL_DIR="/opt/fscoreboard"
NGINX_SITES_AVAILABLE="/etc/nginx/sites-available"
NGINX_SITES_ENABLED="/etc/nginx/sites-enabled"

print_header() {
    echo -e "${PURPLE}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                        FSCOREBOARD DIAGNOSTIC & FIX                          â•‘"
    echo "â•‘                        Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° Ğ¸ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼                     â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

print_step() {
    echo -e "\n${BLUE}ğŸ”§ $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_info() {
    echo -e "${CYAN}â„¹ï¸  $1${NC}"
}

# Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
diagnose_system() {
    print_step "Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹..."
    
    echo -e "\n${CYAN}ğŸ“Š Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ Ğ¡Ğ•Ğ Ğ’Ğ˜Ğ¡ĞĞ’:${NC}"
    
    # PM2 ÑÑ‚Ğ°Ñ‚ÑƒÑ
    if command -v pm2 &> /dev/null; then
        echo -e "\n${YELLOW}PM2 ĞŸÑ€Ğ¾Ñ†ĞµÑÑÑ‹:${NC}"
        pm2 list
    else
        print_error "PM2 Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
    fi
    
    # Nginx ÑÑ‚Ğ°Ñ‚ÑƒÑ
    if command -v nginx &> /dev/null; then
        echo -e "\n${YELLOW}Nginx ÑÑ‚Ğ°Ñ‚ÑƒÑ:${NC}"
        systemctl status nginx --no-pager -l
    else
        print_error "Nginx Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"
    fi
    
    # ĞŸĞ¾Ñ€Ñ‚Ñ‹
    echo -e "\n${YELLOW}Ğ—Ğ°Ğ½ÑÑ‚Ñ‹Ğµ Ğ¿Ğ¾Ñ€Ñ‚Ñ‹:${NC}"
    netstat -tlnp | grep -E ":(80|443|3001|3002|3003) " || echo "ĞĞµÑ‚ Ğ·Ğ°Ğ½ÑÑ‚Ñ‹Ñ… Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ²"
    
    # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Nginx
    echo -e "\n${YELLOW}ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Nginx:${NC}"
    ls -la $NGINX_SITES_ENABLED/ 2>/dev/null || echo "ĞĞµÑ‚ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¹"
    
    # Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
    echo -e "\n${YELLOW}Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°:${NC}"
    if [ -d "$INSTALL_DIR" ]; then
        ls -la "$INSTALL_DIR/"
    else
        print_error "Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°: $INSTALL_DIR"
    fi
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° WebSocket ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¹
check_websocket() {
    print_step "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° WebSocket ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¹..."
    
    if [ -f "$INSTALL_DIR/server/app.js" ]; then
        cd "$INSTALL_DIR"
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Socket.IO
        if curl -s "http://localhost:3001/socket.io/" | grep -q "socket.io"; then
            print_success "Socket.IO Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½"
        else
            print_error "Socket.IO Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½"
        fi
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
        if curl -s -o /dev/null -w "%{http_code}" "http://localhost:3001/public/scoreboard_vmix.html" | grep -q "200"; then
            print_success "Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹"
        else
            print_error "Ğ¡Ñ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹"
        fi
    else
        print_error "Ğ¤Ğ°Ğ¹Ğ» ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
    fi
}

# Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Nginx ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
fix_nginx_config() {
    print_step "Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Nginx..."
    
    local nginx_config="$NGINX_SITES_AVAILABLE/fscoreboard"
    
    if [ ! -f "$nginx_config" ]; then
        print_error "ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Nginx Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°"
        return 1
    fi
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ¾Ğ¿Ğ¸Ğ¸
    cp "$nginx_config" "${nginx_config}.backup.$(date +%Y%m%d_%H%M%S)"
    print_info "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ½Ğ°Ñ ĞºĞ¾Ğ¿Ğ¸Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸"
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
    cat > "$nginx_config" << 'EOF'
server {
    listen 80;
    server_name _;

    # WebSocket Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° Ğ´Ğ»Ñ Socket.IO
    location /socket.io/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }

    # Ğ’ÑĞµ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ñ€Ğ¾ĞºÑĞ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ½Ğ° Express ÑĞµÑ€Ğ²ĞµÑ€
    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
    }

    # Ğ›Ğ¾Ğ³Ğ¸
    access_log /var/log/nginx/fscoreboard_access.log;
    error_log /var/log/nginx/fscoreboard_error.log;
}
EOF

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
    if nginx -t; then
        print_success "ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Nginx Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ°"
        systemctl reload nginx
        print_success "Nginx Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½"
    else
        print_error "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Nginx"
        return 1
    fi
}

# ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
restart_services() {
    print_step "ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²..."
    
    # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº PM2
    if command -v pm2 &> /dev/null; then
        pm2 restart fscoreboard 2>/dev/null || {
            print_warning "PM2 Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½, Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾"
            cd "$INSTALL_DIR"
            pm2 start server/app.js --name fscoreboard
        }
        print_success "PM2 Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½"
    fi
    
    # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº Nginx
    if command -v nginx &> /dev/null; then
        systemctl reload nginx
        print_success "Nginx Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½"
    fi
}

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ¾ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ½Ğ¾ÑÑ‚Ğ¸
verify_fix() {
    print_step "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹..."
    
    sleep 3
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° PM2
    if pm2 list | grep -q "fscoreboard.*online"; then
        print_success "PM2 Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚"
    else
        print_error "PM2 Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚"
        return 1
    fi
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° HTTP
    if curl -s -o /dev/null -w "%{http_code}" "http://localhost:3001/public/scoreboard_vmix.html" | grep -q "200"; then
        print_success "HTTP ÑĞµÑ€Ğ²ĞµÑ€ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚"
    else
        print_error "HTTP ÑĞµÑ€Ğ²ĞµÑ€ Ğ½Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚"
        return 1
    fi
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Nginx
    if systemctl is-active --quiet nginx; then
        print_success "Nginx Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½"
    else
        print_error "Nginx Ğ½Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½"
        return 1
    fi
    
    print_success "Ğ’ÑĞµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹"
}

# ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ
get_system_info() {
    print_step "Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ..."
    
    local domain=$(curl -s ifconfig.me 2>/dev/null || hostname -I | awk '{print $1}')
    local port=$(grep -o 'PORT=[0-9]*' "$INSTALL_DIR/.env" 2>/dev/null | cut -d'=' -f2 || echo "3001")
    local token=$(grep -o 'TOKEN=[^[:space:]]*' "$INSTALL_DIR/.env" 2>/dev/null | cut -d'=' -f2 || echo "MySecret111")
    
    echo -e "\n${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                           Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ Ğ ĞĞ‘ĞĞ¢ĞĞ•Ğ¢!                                 â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    
    echo -e "\n${CYAN}ğŸŒ ĞĞ”Ğ Ğ•Ğ¡Ğ Ğ¡Ğ¢Ğ ĞĞĞ˜Ğ¦:${NC}"
    echo -e "${YELLOW}ĞŸĞ°Ğ½ĞµĞ»ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ:${NC} http://$domain/private/control.html?token=$token"
    echo -e "${YELLOW}ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¾:${NC}     http://$domain/public/scoreboard_vmix.html"
    echo -e "${YELLOW}Ğ¡Ñ‚Ğ°Ğ´Ğ¸Ğ¾Ğ½:${NC}            http://$domain/public/stadium.html"
    echo -e "${YELLOW}ISKRA CUP Ñ‚Ğ°Ğ±Ğ»Ğ¾:${NC}    http://$domain/public/iskracup_scoreboard.html"
    
    echo -e "\n${CYAN}ğŸ”§ Ğ£ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ•:${NC}"
    echo -e "${YELLOW}Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:${NC}             pm2 status"
    echo -e "${YELLOW}Ğ›Ğ¾Ğ³Ğ¸:${NC}               pm2 logs fscoreboard"
    echo -e "${YELLOW}ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº:${NC}         pm2 restart fscoreboard"
}

# ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
main() {
    print_header
    
    if [[ $EUID -ne 0 ]]; then
        print_error "Ğ­Ñ‚Ğ¾Ñ‚ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸ root"
        print_info "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ: sudo $0"
        exit 1
    fi
    
    diagnose_system
    check_websocket
    fix_nginx_config
    restart_services
    verify_fix
    get_system_info
}

# Ğ—Ğ°Ğ¿ÑƒÑĞº
main "$@"
