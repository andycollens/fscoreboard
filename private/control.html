<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>FSCOREBOARD Control Panel</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 800px; 
      margin: 20px auto; 
      background: #f4f4f4; 
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .presets-section {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 1px solid #ddd;
    }
    
    .presets-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .presets-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .preset-card {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .preset-card:hover {
      border-color: #338af3;
      background: #f8f9ff;
    }
    
    .preset-name {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 10px;
      color: #333;
    }
    
    .preset-shortcodes {
      font-weight: normal;
      color: #666;
      font-size: 12px;
      margin-left: 8px;
    }
    
    .preset-teams {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .preset-team {
      text-align: center;
      flex: 1;
    }
    
    .preset-team-name {
      font-weight: bold;
      color: #338af3;
    }
    
    .preset-team-city {
      font-size: 12px;
      color: #666;
    }
    
    .preset-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .btn-primary {
      background: #338af3;
      color: white;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn:hover {
      opacity: 0.8;
    }
    
    .add-preset-form {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .form-group {
      flex: 1;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .form-group input[type="color"] {
      width: 60px;
      height: 40px;
      padding: 0;
    }
    
    .camera-content {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 1px solid #ddd;
    }
    
    .timer-row { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 16px; 
      margin: 20px 0; 
    }
    
    .playpause-btn, .set-btn {
      width: 56px; 
      height: 44px;
      background: #338af3; 
      color: #fff; 
      border: none; 
      border-radius: 8px;
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-size: 2em; 
      cursor: pointer; 
      transition: background 0.2s;
    }
    
    .playpause-btn:hover, .set-btn:hover { 
      background: #2561a7; 
    }
    
    .timer-inputs {
      display: flex; 
      align-items: center; 
      gap: 8px;
      background: #fff; 
      border-radius: 8px; 
      padding: 8px 12px;
      border: 1px solid #ccc;
    }
    
    .timer-inputs input[type="text"] {
      width: 80px; 
      font-size: 1.2em; 
      text-align: center; 
      border: none; 
      background: none; 
      outline: none;
      letter-spacing: 2px;
    }
    
    .score-row { 
      display: flex; 
      justify-content: center; 
      gap: 30px; 
      margin-top: 20px; 
    }
    
    .score-block { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      padding: 0; 
      min-width: 120px; 
    }
    
    .score-controls { 
      display: flex; 
      gap: 10px; 
      margin-bottom: 8px; 
    }
    
    .score-btn {
      background: #338af3; 
      color: #fff; 
      border: none; 
      border-radius: 8px;
      width: 44px; 
      height: 44px; 
      font-size: 1.4em; 
      font-weight: bold; 
      cursor: pointer;
      display: flex; 
      align-items: center; 
      justify-content: center;
    }
    
    .score-btn:hover { 
      background: #2561a7; 
    }
    
    .score-value { 
      font-size: 2em; 
      color: #338af3; 
      min-width: 32px; 
      text-align: center; 
    }
    
    .short-label-row { 
      margin-top: 6px; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 8px;
    }
    
    .short-label-row input[type="text"] {
      width: 50px; 
      text-align: center; 
      font-size: 1.2em; 
      border-radius: 8px; 
      border: 1px solid #ccc; 
      padding: 4px 0;
      background: #fff; 
      text-transform: uppercase; 
      font-weight: bold; 
      letter-spacing: 2px;
    }
    
    .kit-block { 
      display: flex; 
      flex-direction: row; 
      align-items: center; 
      justify-content: center; 
      gap: 8px; 
      width: auto; 
    }
    
    .kit-color {
      width: 100px; 
      height: 32px; 
      border-radius: 4px; 
      border: 1px solid #ccc;
      background: none; 
      margin: 0; 
      padding: 0; 
      cursor: pointer; 
      display: block;
    }
    
    .label-caption {
      font-size: 0.85em; 
      color: #888; 
      margin-bottom: 2px; 
      text-align: center; 
      font-weight: normal; 
      letter-spacing: 1px;
    }
    
    .team-input-row { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      width: 100%; 
      gap: 4px; 
      margin-top: 6px; 
    }
    
    .team-input-row input[type="text"] {
      width: 100%;
      text-align: center; 
      font-size: 1em; 
      border-radius: 8px; 
      border: 1px solid #ccc; 
      padding: 4px 0;
      background: #fff; 
      color: #338af3; 
      font-weight: bold; 
    }
    
    .city-input-row input[type="text"] {
      width: 100%;
      text-align: center; 
      font-size: 1em; 
      border-radius: 8px; 
      border: 1px solid #ccc; 
      padding: 4px 0;
      background: #fff; 
      color: #888; 
      font-weight: normal;
    }
    
    .divider { 
      width: 2px; 
      background: #ccc; 
      margin: 0 10px; 
    }
    
    .hidden {
      display: none;
    }
    
    .version-info {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 0.6em;
      color: #ccc;
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 6px;
      border-radius: 3px;
      opacity: 0.7;
      z-index: 1000;
    }
    
    .preset-card {
      display: block;
      background: #fff;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 8px;
      transition: all 0.2s;
      box-sizing: border-box;
      width: 100%;
      max-width: 100%;
    }
    
    .preset-card:hover {
      background: #f8f9fa;
    }
    
    .preset-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }
    
    .preset-left {
      display: flex;
      align-items: flex-start;
      min-width: 0;
      overflow: hidden;
      flex-direction: column;
      gap: 8px;
    }
    
    .preset-name {
      font-weight: bold;
      font-size: 14px;
      margin-right: 0;
      white-space: nowrap;
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 4px;
      align-self: flex-start;
    }
    
    .preset-teams {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
      align-self: flex-start;
      flex-wrap: nowrap;
    }
    
    .preset-right {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      align-self: flex-start;
    }
    
    .preset-team-name {
      font-size: 14px;
      white-space: nowrap;
    }
    
    .preset-separator {
      font-size: 14px;
      color: #666;
      margin: 0 2px;
    }
    
    .preset-kit-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      border: 1px solid #ccc;
      display: inline-block;
      flex-shrink: 0;
    }
    
    .preset-edit-link {
      color: #999;
      text-decoration: underline;
      text-decoration-style: dashed;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .preset-edit-link:hover {
      color: #666;
    }
    
    .preset-apply-symbol {
      color: #1976d2;
      cursor: pointer;
      font-size: 20px;
      white-space: nowrap;
      flex-shrink: 0;
      font-weight: bold;
      user-select: none;
      transition: all 0.2s;
      padding: 4px 8px;
      border-radius: 4px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .preset-apply-symbol:hover {
      color: #1565c0;
      background: #e3f2fd;
    }
    
    .preset-apply-symbol[style*="opacity: 0.5"] {
      pointer-events: none;
    }
    
    .preset-play-btn {
      padding: 6px 12px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    
    .preset-play-btn:hover:not(:disabled) {
      background: #1565c0;
    }
    
    .preset-play-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .confirmation-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    
    .confirmation-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      text-align: center;
    }
    
    .confirmation-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 16px;
    }
    
    .confirmation-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .confirmation-btn.confirm {
      background: #28a745;
      color: white;
    }
    
    .confirmation-btn.confirm:hover {
      background: #218838;
    }
    
    .confirmation-btn.cancel {
      background: #6c757d;
      color: white;
    }
    
    .confirmation-btn.cancel:hover {
      background: #5a6268;
    }
    
    /* Мобильная адаптивность */
    @media (max-width: 768px) {
      body {
        font-size: 16px;
        padding: 10px;
      }
      
      .camera-content {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .timer-row {
        flex-direction: row;
        gap: 12px;
        margin: 15px 0;
        justify-content: center;
        align-items: center;
      }
      
      .playpause-btn, .set-btn {
        width: 60px;
        height: 50px;
        font-size: 16px;
      }
      
      .timer-inputs input {
        font-size: 18px;
        padding: 8px 12px;
        width: 80px;
        text-align: center;
      }
      
      .score-row {
        flex-direction: row;
        gap: 20px;
        justify-content: space-between;
      }
      
      .score-block {
        width: 48%;
        max-width: none;
      }
      
      .score-controls {
        justify-content: center;
        margin-bottom: 10px;
      }
      
      .score-btn {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }
      
      .score-value {
        font-size: 28px;
        margin: 0 15px;
      }
      
      .short-label-row {
        justify-content: center;
        margin-bottom: 10px;
      }
      
      .short-label-row input {
        font-size: 16px;
        padding: 6px 10px;
        width: 70px;
        text-align: center;
      }
      
      .kit-block {
        justify-content: center;
        margin-bottom: 10px;
      }
      
      .kit-color {
        width: 35px;
        height: 35px;
      }
      
      .team-input-row {
        margin-bottom: 10px;
      }
      
      .team-input-row input {
        font-size: 14px;
        padding: 8px 10px;
      }
      
      .presets-section {
        padding: 15px;
      }
      
      .presets-header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
      }
      
      .presets-header h2 {
        text-align: center;
        margin-bottom: 0;
      }
      
      .btn {
        font-size: 16px;
        padding: 12px 20px;
        width: 100%;
      }
      
      .preset-card {
        padding: 15px;
        margin-bottom: 10px;
        flex-direction: row;
        align-items: flex-start;
        justify-content: space-between;
      }
      
      .preset-content {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
      }
      
      .preset-left {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        flex: 1;
      }
      
      .preset-name {
        font-size: 16px;
        margin-right: 0;
        padding: 4px 8px;
        align-self: flex-start;
      }
      
      .preset-teams {
        width: 100%;
        justify-content: flex-start;
        align-self: flex-start;
      }
      
      .preset-team-name {
        font-size: 16px;
      }
      
      .preset-kit-color {
        width: 16px;
        height: 16px;
      }
      
      .preset-separator {
        font-size: 16px;
        margin: 0 4px;
      }
      
      .preset-right {
        align-self: flex-start;
        margin-top: 0;
        flex-shrink: 0;
      }
      
      .preset-edit-link {
        font-size: 14px;
        margin-left: 0;
      }
      
      .preset-apply-symbol {
        font-size: 24px;
        padding: 6px 10px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 15px;
        width: 100%;
        box-sizing: border-box;
      }
      
      .form-group {
        width: 100%;
        box-sizing: border-box;
      }
      
      .form-group input {
        font-size: 16px;
        padding: 10px 12px;
        width: 100%;
        box-sizing: border-box;
        max-width: 100%;
      }
      
      .form-group label {
        font-size: 14px;
        margin-bottom: 5px;
        display: block;
        width: 100%;
        box-sizing: border-box;
      }
      
      .edit-preset-form {
        padding: 15px;
        margin: 15px 0;
        box-sizing: border-box;
        width: 100%;
        max-width: 100%;
      }
      
      .team-divider {
        margin: 15px 0;
      }
    }
    
    .timer-running-warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: bold;
    }
    
    .disabled-field {
      opacity: 0.6;
      pointer-events: none;
      background-color: #f8f9fa !important;
    }
    
    .preset-card.editable {
      cursor: pointer;
      border-style: dashed;
    }
    
    .preset-card.editable:hover {
      border-color: #007bff;
      background: #f8f9ff;
    }
    
    .tournament-preset-form {
      display: block;
      width: 100%;
      clear: both;
      margin-top: 15px;
      box-sizing: border-box;
    }
    
    .tournament-presets {
      display: block;
      width: 100%;
      margin-top: 15px;
      clear: both;
      box-sizing: border-box;
    }
    
    .tournament-presets.hidden {
      display: none;
    }
    
    .preset-edit-form-inline {
      background: #fff;
      border: 2px solid #2196f3;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      width: 100%;
      box-sizing: border-box;
      max-width: 100%;
      overflow: hidden;
    }
    
    .preset-item.edit-mode {
      background: #f8f9fa;
    }
    
    .preset-item-wrapper {
      width: 100%;
      margin-bottom: 10px;
      display: block;
    }
    
    .presets-list {
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .edit-preset-form {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .edit-preset-form .form-section {
      margin-bottom: 25px;
    }
    
    .edit-preset-form .form-group {
      margin-bottom: 15px;
    }
    
    .editable-title {
      cursor: pointer;
      border: 2px solid transparent;
      padding: 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .editable-title:hover {
      border-color: #007bff;
      background-color: #f8f9ff;
    }
    
    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      color: #1976d2;
      font-size: 16px;
      font-weight: 600;
    }
    
    .logo-mini {
      width: 25px;
      height: 25px;
      border-radius: 3px;
      border: 1px solid #ddd;
      object-fit: cover;
      display: inline-block;
      background: #f5f5f5;
    }
    
    .logo-mini img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 3px;
    }
    
    .logo-upload-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }
    
    .logo-mini-main {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      cursor: pointer;
      position: relative;
    }
    
    .logo-mini-main img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    
    .logo-delete-btn {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 16px;
      height: 16px;
      background: rgba(0, 0, 0, 0.3);
      color: rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.2s ease;
    }
    
    .logo-delete-btn:hover {
      background: rgba(220, 53, 69, 0.8);
      color: white;
      border: 1px solid white;
    }
    
    .logo-delete-btn-small {
      position: absolute;
      top: -3px;
      right: -3px;
      width: 12px;
      height: 12px;
      background: rgba(220, 53, 69, 0.8);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10;
      border: 1px solid white;
      transition: all 0.2s ease;
    }
    
    .logo-delete-btn-small:hover {
      background: #dc3545;
      transform: scale(1.1);
    }
    
    
    .preset-team-logo {
      display: inline-flex;
      align-items: center;
      flex-shrink: 0;
    }
    
    .preset-logo-mini {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      object-fit: cover;
    }
    
    .preset-team-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }
    
    .preset-kit-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      flex-shrink: 0;
    }
    
    .preset-separator {
      color: #666;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    .edit-preset-form .form-group input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .edit-preset-form .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
      font-size: 13px;
    }
    
    .logo-preview {
      margin-top: 8px;
      text-align: center;
    }
    
    .logo-preview img {
      width: 50px;
      height: 50px;
      border-radius: 4px;
      object-fit: cover;
    }
    
    .logo-preview .no-logo {
      color: #999;
      font-size: 12px;
      font-style: italic;
    }
    
    .edit-preset-form h3 {
      color: #1976d2;
      margin-top: 0;
    }
    
    .team-divider {
      height: 2px;
      background: #ddd;
      margin: 20px 0;
      border-radius: 1px;
    }
  </style>
</head>
<body>
  <!-- Версия в углу -->
  <div class="version-info">v1.0.0</div>

  <!-- Управление табло -->
  <div class="camera-content">
    <div class="timer-row">
      <button id="playPauseBtn" class="playpause-btn" title="Пуск/Пауза">
        <svg id="playPauseIcon" width="32" height="32" viewBox="0 0 32 32" fill="none">
          <polygon id="playIcon" points="8,6 26,16 8,26" fill="white"/>
        </svg>
      </button>
      <div class="timer-inputs">
        <input type="text" id="timeInput" maxlength="5" placeholder="MM:SS" pattern="^\d{2}:\d{2}$" value="00:00" autocomplete="off" />
      </div>
      <button id="setBtn" class="set-btn">Set</button>
    </div>
    <form id="controlForm" autocomplete="off" spellcheck="false">
      <div class="score-row">
        <div class="score-block">
          <div class="score-controls">
            <button type="button" class="score-btn" id="score1Dec">-</button>
            <span class="score-value" id="score1Value">0</span>
            <button type="button" class="score-btn" id="score1Inc">+</button>
          </div>
          <div class="short-label-row">
            <span id="team1LogoMini" class="logo-mini-main" onclick="document.getElementById('team1LogoUpload').click()">
              <span class="logo-delete-btn hidden" onclick="clearMainLogo('team1'); event.stopPropagation()" title="Удалить логотип">×</span>
            </span>
            <input type="text" id="team1Short" maxlength="3" placeholder="ХОЗ" />
            <input type="color" id="kit1Color" value="#2b2b2b" class="kit-color">
            <input type="file" id="team1LogoUpload" accept="image/*" onchange="uploadMainLogo('team1', this)" style="display: none;">
          </div>
          <div class="team-input-row">
            <span class="label-caption">Название команды</span>
            <input type="text" id="team1Name" maxlength="40" placeholder="Не введено" />
          </div>
          <div class="city-input-row team-input-row">
            <span class="label-caption">Город</span>
            <input type="text" id="team1City" maxlength="30" placeholder="Не введено" />
          </div>
        </div>
        <div class="divider"></div>
        <div class="score-block">
          <div class="score-controls">
            <button type="button" class="score-btn" id="score2Dec">-</button>
            <span class="score-value" id="score2Value">0</span>
            <button type="button" class="score-btn" id="score2Inc">+</button>
          </div>
          <div class="short-label-row">
            <span id="team2LogoMini" class="logo-mini-main" onclick="document.getElementById('team2LogoUpload').click()">
              <span class="logo-delete-btn hidden" onclick="clearMainLogo('team2'); event.stopPropagation()" title="Удалить логотип">×</span>
            </span>
            <input type="text" id="team2Short" maxlength="3" placeholder="ГОС" />
            <input type="color" id="kit2Color" value="#2b2b2b" class="kit-color">
            <input type="file" id="team2LogoUpload" accept="image/*" onchange="uploadMainLogo('team2', this)" style="display: none;">
          </div>
          <div class="team-input-row">
            <span class="label-caption">Название команды</span>
            <input type="text" id="team2Name" maxlength="40" placeholder="Не введено" />
          </div>
          <div class="city-input-row team-input-row">
            <span class="label-caption">Город</span>
            <input type="text" id="team2City" maxlength="30" placeholder="Не введено" />
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Секция предустановок -->
  <div class="presets-section">
    <div class="presets-header">
      <h2>Предустановки матчей</h2>
    </div>
    
    <!-- Предупреждение о работающем таймере -->
    <div id="timerWarning" class="timer-running-warning hidden">
      ⚠️ Таймер запущен! Блокированы: изменение команд, применение предустановок. Доступно: управление счетом, создание/редактирование предустановок.
    </div>
    
    <!-- Список турниров для создания пресетов -->
    <div id="tournamentsForPresets" style="margin-bottom: 30px;">
      <h3 style="margin-bottom: 15px; color: #333;">Создать пресет из турнира:</h3>
      <div id="tournamentsListForPresets" style="display: block; width: 100%;">
        <!-- Список турниров будет загружен динамически -->
      </div>
      <div id="tournamentsEmptyState" class="empty-state" style="padding: 20px; text-align: center; color: #999;">
        Нет созданных турниров. Создайте турнир в <a href="/private/settings.html?token=" id="settingsLinkInPresets" style="color: #338af3;">настройках</a>, чтобы добавить пресеты.
      </div>
    </div>
    
    <!-- Шаблон формы создания пресета (будет клонироваться в карточку турнира) -->
    <div id="addPresetFormTemplate" style="display: none;">
      <!-- Скрытый селект турнира для логики -->
      <select class="addPresetTournament" onchange="onTournamentSelectedForForm(this)" style="display: none;">
        <option value="">-- Выберите турнир --</option>
      </select>
      
      <div style="display: flex; align-items: center; gap: 10px; margin-top: 15px; margin-bottom: 15px; width: 100%; flex-wrap: nowrap;">
        <h4 style="margin: 0;">Создать пресет</h4>
        <small style="color: #999; font-size: 11px; white-space: nowrap; flex-shrink: 0; margin-left: auto;">Имя пресета будет сформировано автоматически</small>
      </div>
      
      <!-- Строка с временем и именем пресета -->
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; width: 100%; flex-wrap: nowrap;">
        <input type="time" class="addPresetMatchTime" value="19:00" step="60" onchange="updatePresetNameForForm(this)" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; -webkit-appearance: none; appearance: none; flex-shrink: 0;">
        <h3 class="addPresetTitle" style="margin: 0; color: #1976d2; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">19:00 / Команда 1 - Команда 2</h3>
      </div>
      
      <!-- Компактная строка: Команда 1 с лого, цвет формы 1 -->
      <div class="form-section" style="margin-bottom: 15px;">
        <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: nowrap; width: 100%;">
          <div class="form-group" style="flex: 1; min-width: 0; display: flex; gap: 8px; align-items: flex-end;">
            <div class="addPresetTeam1LogoPreview" style="flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
              <div style="font-size: 10px; color: #999;">Лого</div>
            </div>
            <div style="flex: 1; min-width: 0;">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Команда 1</label>
              <div style="display: flex; align-items: center; gap: 8px;">
                <select class="addPresetTeam1Select" onchange="onTeam1SelectedForForm(this)" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                  <option value="">-- Выберите команду --</option>
                </select>
                <div class="team-logo-mini-select" style="width: 32px; height: 32px; display: none; flex-shrink: 0; overflow: hidden;">
                  <img src="" alt="" style="width: 100%; height: 100%; object-fit: contain; display: none;">
                </div>
              </div>
            </div>
          </div>
          <div class="form-group" style="flex-shrink: 0;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Цвет формы</label>
            <input type="color" class="addPresetKit1Color" id="addPresetKit1Color" value="#2b2b2b" style="width: 70px; height: 38px; padding: 0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
          </div>
        </div>
      </div>
      
      <!-- Компактная строка: Команда 2 с лого, цвет формы 2 -->
      <div class="form-section" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: nowrap; width: 100%;">
          <div class="form-group" style="flex: 1; min-width: 0; display: flex; gap: 8px; align-items: flex-end;">
            <div class="addPresetTeam2LogoPreview" style="flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
              <div style="font-size: 10px; color: #999;">Лого</div>
            </div>
            <div style="flex: 1; min-width: 0;">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Команда 2</label>
              <div style="display: flex; align-items: center; gap: 8px;">
                <select class="addPresetTeam2Select" onchange="onTeam2SelectedForForm(this)" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                  <option value="">-- Выберите команду --</option>
                </select>
                <div class="team-logo-mini-select" style="width: 32px; height: 32px; display: none; flex-shrink: 0; overflow: hidden;">
                  <img src="" alt="" style="width: 100%; height: 100%; object-fit: contain; display: none;">
                </div>
              </div>
            </div>
          </div>
          <div class="form-group" style="flex-shrink: 0;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Цвет формы</label>
            <input type="color" class="addPresetKit2Color" id="addPresetKit2Color" value="#2b2b2b" style="width: 70px; height: 38px; padding: 0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
          </div>
        </div>
      </div>
      
      <!-- Скрытые поля для совместимости со старой логикой -->
      <div style="display: none;">
        <div id="addPresetTeam1Details"></div>
        <div id="addPresetTeam1ColorRow"></div>
        <div id="addPresetTeam1LogoRow">
          <div id="addPresetTeam1LogoPreview" class="logo-preview"></div>
        </div>
        <input type="text" id="addPresetTeam1Name" readonly>
        <input type="text" id="addPresetTeam1City" readonly>
        <input type="text" id="addPresetTeam1Short" readonly>
        
        <div id="addPresetTeam2Details"></div>
        <div id="addPresetTeam2ColorRow"></div>
        <div id="addPresetTeam2LogoRow">
          <div id="addPresetTeam2LogoPreview" class="logo-preview"></div>
        </div>
        <input type="text" id="addPresetTeam2Name" readonly>
        <input type="text" id="addPresetTeam2City" readonly>
        <input type="text" id="addPresetTeam2Short" readonly>
      </div>
      
      <div class="form-buttons">
        <button class="btn btn-primary" onclick="saveNewPresetFromForm(this)">Сохранить</button>
        <button class="btn btn-secondary" onclick="cancelAddPresetFromForm(this)">Отмена</button>
      </div>
    </div>

    <!-- Форма редактирования предустановки -->
    <div id="editPresetForm" class="edit-preset-form hidden">
      <h3 id="editPresetTitle" class="editable-title" onclick="startEditingTitle()">Название матча</h3>
      <input type="text" id="editPresetNameInput" class="hidden" placeholder="Например: Финал чемпионата" onblur="finishEditingTitle()" onkeypress="handleTitleKeypress(event)">
      <div class="form-section">
        <h4 class="section-title">
          <span id="editPresetTeam1LogoMini" class="logo-mini" onclick="editPresetLogo('team1')" title="Нажмите для обновления логотипа"></span>
          Команда 1
          <input type="file" id="editPresetTeam1Logo" accept="image/*" onchange="uploadLogo('team1', this)" style="display: none;">
          <button type="button" class="logo-delete-btn-small" onclick="deletePresetLogo('team1'); event.stopPropagation()" title="Удалить логотип" style="display: none;">×</button>
        </h4>
        <div class="form-group">
          <label>Название</label>
          <input type="text" id="editPresetTeam1Name" placeholder="Название команды">
      </div>
        <div class="form-group">
          <label>Город</label>
          <input type="text" id="editPresetTeam1City" placeholder="Город">
    </div>
        <div class="form-group">
          <label>Шорткод</label>
          <input type="text" id="editPresetTeam1Short" placeholder="ХОЗ" maxlength="3">
          </div>
        <div class="form-group">
          <label>Цвет формы</label>
          <input type="color" id="editPresetKit1Color" value="#2b2b2b">
          </div>
          </div>
      <div class="team-divider"></div>
      <div class="form-section">
        <h4 class="section-title">
          Команда 2
          <span id="editPresetTeam2LogoMini" class="logo-mini" onclick="editPresetLogo('team2')" title="Нажмите для обновления логотипа"></span>
          <input type="file" id="editPresetTeam2Logo" accept="image/*" onchange="uploadLogo('team2', this)" style="display: none;">
          <button type="button" class="logo-delete-btn-small" onclick="deletePresetLogo('team2'); event.stopPropagation()" title="Удалить логотип" style="display: none;">×</button>
        </h4>
        <div class="form-group">
          <label>Название</label>
          <input type="text" id="editPresetTeam2Name" placeholder="Название команды">
          </div>
        <div class="form-group">
          <label>Город</label>
          <input type="text" id="editPresetTeam2City" placeholder="Город">
        </div>
        <div class="form-group">
          <label>Шорткод</label>
          <input type="text" id="editPresetTeam2Short" placeholder="ГОС" maxlength="3">
          </div>
        <div class="form-group">
          <label>Цвет формы</label>
          <input type="color" id="editPresetKit2Color" value="#2b2b2b">
          </div>
          </div>
      <div class="form-row">
        <button class="btn btn-primary" onclick="updatePreset()">Обновить</button>
        <button class="btn btn-danger" onclick="deletePresetFromEdit()">Удалить</button>
        <button class="btn" onclick="cancelEditPreset()">Отмена</button>
          </div>
        </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let presets = [];
    let tournaments = [];
    let expandedPresets = new Set(); // Храним ID турниров с раскрытыми пресетами
    let ready = false;
    let timerRunning = false;
    let editingPresetId = null;
    let originalPresetData = null;
    let selectedTeams = {
      team1: null,
      team2: null
    };
    
    // Переменные для пятикратного нажатия SET
    let setButtonClicks = 0;
    let setButtonClickTimeout = null;
    const SET_CLICK_RESET_TIME = 2000; // 2 секунды для сброса счетчика
    let uploadedLogos = {
      team1: null,
      team2: null
    };
    let state = {
      team1Logo: '',
      team2Logo: ''
    };
    
    // Защита от случайного изменения счета
    let lastScoreChange = {
      team: null,
      timestamp: 0,
      value: 0
    };

    // Инициализация
    document.addEventListener('DOMContentLoaded', function() {
      loadTournaments();
      setupControls();
      setupEditFormHandlers();
    });
    
    // Загрузка турниров
    async function loadTournaments() {
      try {
        const response = await fetch(`/api/tournaments?token=${getToken()}`);
        if (response.ok) {
          tournaments = await response.json();
          renderTournamentsForPresets();
          // Загружаем пресеты после загрузки турниров
          if (presets.length === 0) {
            await loadPresets();
          } else {
            renderTournamentPresets();
          }
        }
      } catch (error) {
        console.error('Ошибка загрузки турниров:', error);
      }
    }
    
    // Отображение турниров для создания пресетов
    function renderTournamentsForPresets() {
      const container = document.getElementById('tournamentsListForPresets');
      const emptyState = document.getElementById('tournamentsEmptyState');
      
      if (!container) return;
      
      if (tournaments.length === 0) {
        container.style.display = 'none';
        if (emptyState) {
          const settingsLink = document.getElementById('settingsLinkInPresets');
          if (settingsLink) {
            settingsLink.href = `/private/settings.html?token=${getToken()}`;
          }
          emptyState.style.display = 'block';
        }
        return;
      }
      
      container.style.display = 'flex';
      if (emptyState) {
        emptyState.style.display = 'none';
      }
      
      container.innerHTML = '';
      
      tournaments.forEach(tournament => {
        const teamCount = tournament.teams ? tournament.teams.length : 0;
        const card = document.createElement('div');
        card.className = 'preset-card';
        card.style.cssText = 'padding: 15px; margin-bottom: 10px; cursor: default; display: block; width: 100%; box-sizing: border-box;';
        
        const startDate = tournament.startDate ? new Date(tournament.startDate).toLocaleDateString('ru-RU') : '';
        const endDate = tournament.endDate ? new Date(tournament.endDate).toLocaleDateString('ru-RU') : '';
        const dates = startDate && endDate ? `${startDate} - ${endDate}` : (startDate || endDate || 'Даты не указаны');
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;" onclick="toggleTournamentPresets('${tournament.id}')" style="cursor: pointer;">
            <div style="flex: 1; min-width: 200px;">
              <div style="font-weight: bold; font-size: 16px; color: #333; margin-bottom: 5px;">${tournament.name}</div>
              <div style="font-size: 12px; color: #666;">${dates}</div>
              <div style="font-size: 12px; color: #999; margin-top: 3px;">Команд: ${teamCount} | Пресетов: <span id="presetCount-${tournament.id}">0</span></div>
            </div>
            <button class="btn btn-primary" onclick="openAddPresetFromTournament('${tournament.id}'); event.stopPropagation();" id="addPresetBtn_${tournament.id}" ${teamCount < 2 ? 'disabled title="Нужно минимум 2 команды в турнире"' : ''} style="flex-shrink: 0;">
              + Добавить пресет
            </button>
          </div>
          <div id="presetForm_${tournament.id}" class="tournament-preset-form hidden" style="width: 100%; margin-top: 15px; clear: both; display: block;"></div>
          <div id="presets-${tournament.id}" class="tournament-presets" style="width: 100%; margin-top: 15px; clear: both; display: block;">
            <div id="presets-list-${tournament.id}" class="presets-list" style="width: 100%; display: flex; flex-direction: column;">
              <!-- Пресеты будут загружены динамически -->
            </div>
          </div>
        `;
        
        container.appendChild(card);
      });
    }
    
    // Открытие формы создания пресета из турнира
    async function openAddPresetFromTournament(tournamentId) {
      // Убеждаемся что турниры загружены
      if (tournaments.length === 0) {
        await loadTournaments();
      }
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament) {
        alert('Турнир не найден');
        return;
      }
      
      if (!tournament.teams || tournament.teams.length < 2) {
        alert('В турнире должно быть минимум 2 команды для создания пресета');
        return;
      }
      
      // Находим контейнер формы для этого турнира
      const formContainer = document.getElementById(`presetForm_${tournamentId}`);
      if (!formContainer) return;
      
      // Если форма уже открыта, закрываем её
      if (!formContainer.classList.contains('hidden')) {
        formContainer.classList.add('hidden');
        formContainer.innerHTML = '';
        return;
      }
      
      // Клонируем шаблон формы
      const template = document.getElementById('addPresetFormTemplate');
      if (!template) return;
      
      const form = template.cloneNode(true);
      form.id = `presetFormContent_${tournamentId}`;
      form.classList.remove('hidden');
      form.style.display = 'block';
      form.style.marginTop = '15px';
      form.style.padding = '20px';
      form.style.background = '#e3f2fd';
      form.style.border = '2px solid #2196f3';
      form.style.borderRadius = '8px';
      
      // Очищаем контейнер и добавляем форму
      formContainer.innerHTML = '';
      formContainer.appendChild(form);
      formContainer.classList.remove('hidden');
      
      // Устанавливаем выбранный турнир в форме
      const select = form.querySelector('.addPresetTournament');
      if (select) {
        select.value = tournamentId;
        // Также сохраняем в data-атрибут формы для надежности
        form.dataset.tournamentId = tournamentId;
        localStorage.setItem('lastSelectedTournament', tournamentId);
        console.log('Set tournament ID:', tournamentId, 'in form:', form.id);
      }
      
      // Заполняем команды турнира в этой форме
      fillTeamsFromTournamentForForm(tournament, form);
      
      // Обновляем имя пресета
      updatePresetNameForForm(form.querySelector('.addPresetMatchTime'));
      
      // Прокручиваем к форме
      setTimeout(() => {
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    }
    
    // Заполнение команд из турнира (для старой формы, если ещё используется)
    function fillTeamsFromTournament(tournament) {
      if (!tournament || !tournament.teams) return;
      
      // Заполняем селекты команд
      const team1Select = document.getElementById('addPresetTeam1Select');
      const team2Select = document.getElementById('addPresetTeam2Select');
      
      if (!team1Select || !team2Select) return;
      
      team1Select.innerHTML = '<option value="">-- Выберите команду --</option>';
      team2Select.innerHTML = '<option value="">-- Выберите команду --</option>';
      
      tournament.teams.forEach(team => {
        const option1 = document.createElement('option');
        option1.value = team.id;
        option1.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        team1Select.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = team.id;
        option2.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        team2Select.appendChild(option2);
      });
    }
    
    // Заполнение команд из турнира для конкретной формы
    function fillTeamsFromTournamentForForm(tournament, formContainer) {
      if (!tournament || !tournament.teams || !formContainer) return;
      
      // Заполняем селекты команд
      const team1Select = formContainer.querySelector('.addPresetTeam1Select');
      const team2Select = formContainer.querySelector('.addPresetTeam2Select');
      
      if (!team1Select || !team2Select) return;
      
      team1Select.innerHTML = '<option value="">-- Выберите команду --</option>';
      team2Select.innerHTML = '<option value="">-- Выберите команду --</option>';
      
      tournament.teams.forEach(team => {
        const option1 = document.createElement('option');
        option1.value = team.id;
        option1.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        option1.dataset.logo = team.logo || '';
        team1Select.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = team.id;
        option2.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        option2.dataset.logo = team.logo || '';
        team2Select.appendChild(option2);
      });
    }
    
    // Обработка выбора турнира
    function onTournamentSelected() {
      const tournamentId = document.getElementById('addPresetTournament').value;
      
      if (!tournamentId) {
        // Очищаем селекты команд
        document.getElementById('addPresetTeam1Select').innerHTML = '<option value="">-- Выберите команду --</option>';
        document.getElementById('addPresetTeam2Select').innerHTML = '<option value="">-- Выберите команду --</option>';
        return;
      }
      
      // Сохраняем выбор в localStorage
      localStorage.setItem('lastSelectedTournament', tournamentId);
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) {
        return;
      }
      
      // Заполняем селекты команд
      const team1Select = document.getElementById('addPresetTeam1Select');
      const team2Select = document.getElementById('addPresetTeam2Select');
      
      team1Select.innerHTML = '<option value="">-- Выберите команду --</option>';
      team2Select.innerHTML = '<option value="">-- Выберите команду --</option>';
      
      tournament.teams.forEach(team => {
        const option1 = document.createElement('option');
        option1.value = team.id;
        option1.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        team1Select.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = team.id;
        option2.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        team2Select.appendChild(option2);
      });
    }
    
    // Обработка выбора команды 1
    function onTeam1Selected() {
      const tournamentId = document.getElementById('addPresetTournament').value;
      const teamId = document.getElementById('addPresetTeam1Select').value;
      
      if (!tournamentId || !teamId) {
        hideTeam1Details();
        updatePresetName();
        return;
      }
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) return;
      
      const team = tournament.teams.find(t => t.id === teamId);
      if (!team) return;
      
      selectedTeams.team1 = team;
      fillTeam1Fields(team);
      showTeam1Details();
      updatePresetName(); // Обновляем имя сразу при выборе команды
    }
    
    // Обработка выбора команды 2
    function onTeam2Selected() {
      const tournamentId = document.getElementById('addPresetTournament').value;
      const teamId = document.getElementById('addPresetTeam2Select').value;
      
      if (!tournamentId || !teamId) {
        hideTeam2Details();
        updatePresetName();
        return;
      }
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) return;
      
      const team = tournament.teams.find(t => t.id === teamId);
      if (!team) return;
      
      selectedTeams.team2 = team;
      fillTeam2Fields(team);
      showTeam2Details();
      updatePresetName(); // Обновляем имя сразу при выборе команды
    }
    
    // Обновление имени пресета автоматически (для старой формы)
    function updatePresetName() {
      const timeInput = document.getElementById('addPresetMatchTime');
      const titleElement = document.getElementById('addPresetTitle');
      
      if (!timeInput || !titleElement) return;
      
      const matchTime = timeInput.value || '19:00';
      const team1Name = selectedTeams.team1 ? selectedTeams.team1.name : 'Команда 1';
      const team2Name = selectedTeams.team2 ? selectedTeams.team2.name : 'Команда 2';
      
      titleElement.textContent = `${matchTime} / ${team1Name} - ${team2Name}`;
    }
    
    // Обновление имени пресета для конкретной формы
    function updatePresetNameForForm(timeInputOrSelect) {
      if (!timeInputOrSelect) return;
      
      // Получаем контейнер формы - может быть передан timeInput или select элемент
      let formContainer = timeInputOrSelect.closest('[id^="presetFormContent_"]');
      
      // Если не нашли через closest (элемент может быть в другом контексте)
      if (!formContainer) {
        // Пробуем найти через родителя select элемента
        if (timeInputOrSelect.tagName === 'SELECT') {
          const parent = timeInputOrSelect.parentElement;
          if (parent) {
            formContainer = parent.closest('[id^="presetFormContent_"]');
          }
        }
      }
      
      // Если все еще не нашли, ищем открытую форму на странице
      if (!formContainer) {
        formContainer = document.querySelector('[id^="presetFormContent_"]');
      }
      
      if (!formContainer) {
        console.warn('Preset form container not found');
        return;
      }
      
      const titleElement = formContainer.querySelector('.addPresetTitle');
      if (!titleElement) {
        console.warn('Preset title element not found');
        return;
      }
      
      // Получаем время матча
      const timeInput = formContainer.querySelector('.addPresetMatchTime');
      const matchTime = timeInput?.value || '19:00';
      
      const team1Select = formContainer.querySelector('.addPresetTeam1Select');
      const team2Select = formContainer.querySelector('.addPresetTeam2Select');
      
      // Получаем tournamentId из разных источников (для надежности)
      let tournamentId = formContainer.querySelector('.addPresetTournament')?.value;
      
      // Если tournamentId не найден в селекте, пытаемся получить из data-атрибута формы или из ID формы
      if (!tournamentId || tournamentId.trim() === '') {
        tournamentId = formContainer.dataset.tournamentId;
      }
      
      // Если все еще не найдено, пытаемся извлечь из ID формы (presetFormContent_TOURNAMENT_ID)
      if (!tournamentId || tournamentId.trim() === '') {
        const formId = formContainer.id;
        const match = formId.match(/presetFormContent_(.+)/);
        if (match && match[1]) {
          tournamentId = match[1];
        }
      }
      
      let team1Name = 'Команда 1';
      let team2Name = 'Команда 2';
      
      if (team1Select && team1Select.value && tournamentId) {
        const tournament = tournaments.find(t => t.id === tournamentId);
        if (tournament && tournament.teams) {
          const team = tournament.teams.find(t => t.id === team1Select.value);
          if (team) team1Name = team.name;
        }
      }
      
      if (team2Select && team2Select.value && tournamentId) {
        const tournament = tournaments.find(t => t.id === tournamentId);
        if (tournament && tournament.teams) {
          const team = tournament.teams.find(t => t.id === team2Select.value);
          if (team) team2Name = team.name;
        }
      }
      
      titleElement.textContent = `${matchTime} / ${team1Name} - ${team2Name}`;
    }
    
    // Обработка выбора команды для формы (новая версия) - точно как в редактировании
    function onTeam1SelectedForForm(selectElement) {
      // Находим форму - она клонируется и имеет ID presetFormContent_*
      // Используем closest для поиска формы по ID, как в редактировании по классу
      let formContainer = selectElement.closest('[id^="presetFormContent_"]');
      
      // Если не нашли, ищем вверх по DOM дереву
      if (!formContainer) {
        let parent = selectElement.parentElement;
        while (parent && !formContainer) {
          if (parent.id && parent.id.startsWith('presetFormContent_')) {
            formContainer = parent;
            break;
          }
          parent = parent.parentElement;
        }
      }
      
      if (!formContainer) {
        console.error('Form container not found for team1');
        return;
      }
      
      // Получаем tournamentId из формы или из data-атрибута
      let tournamentId = formContainer.querySelector('.addPresetTournament')?.value;
      if (!tournamentId) {
        tournamentId = formContainer.dataset.tournamentId;
      }
      if (!tournamentId && formContainer.id) {
        // Извлекаем из ID формы: presetFormContent_TOURNAMENT_ID
        const match = formContainer.id.match(/presetFormContent_(.+)/);
        if (match && match[1]) {
          tournamentId = match[1];
        }
      }
      
      const teamId = selectElement.value;
      
      console.log('Team1 selected:', { tournamentId, teamId, formId: formContainer.id });
      
      if (!teamId || !tournamentId) {
        // Очищаем логотип и цвет при сбросе выбора (как в форме редактирования)
        const logoPreview = formContainer.querySelector('.addPresetTeam1LogoPreview');
        if (logoPreview) {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
        const colorInput = formContainer.querySelector('.addPresetKit1Color');
        if (colorInput) {
          colorInput.value = '#2b2b2b';
        }
        // Обновляем имя пресета после очистки выбора
        setTimeout(() => updatePresetNameForForm(selectElement), 0);
        return;
      }
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) {
        console.error('Tournament not found:', tournamentId);
        return;
      }
      
      const team = tournament.teams.find(t => t.id === teamId);
      if (!team) {
        console.error('Team not found:', teamId);
        return;
      }
      
      console.log('Team found:', { name: team.name, logo: team.logo, kitColor: team.kitColor });
      
      // Обновляем логотип команды - ищем относительно selectElement в структуре формы
      // Структура: form-section -> form-group -> addPresetTeam1LogoPreview
      const formSection = selectElement.closest('.form-section');
      let logoPreview = null;
      if (formSection) {
        logoPreview = formSection.querySelector('.addPresetTeam1LogoPreview');
      }
      // Если не нашли, пробуем через formContainer
      if (!logoPreview && formContainer) {
        logoPreview = formContainer.querySelector('.addPresetTeam1LogoPreview');
      }
      
      console.log('Logo preview element found:', !!logoPreview);
      if (logoPreview) {
        if (team.logo) {
          logoPreview.innerHTML = `<img src="${team.logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
          console.log('Logo updated:', team.logo);
        } else {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
      } else {
        console.error('Logo preview element not found!');
      }
      
      // Обновляем цвет формы из команды - ищем в той же form-section
      let colorInput = null;
      if (formSection) {
        colorInput = formSection.querySelector('.addPresetKit1Color');
      }
      // Если не нашли, пробуем через formContainer
      if (!colorInput && formContainer) {
        colorInput = formContainer.querySelector('.addPresetKit1Color');
      }
      
      console.log('Color input element found:', !!colorInput);
      if (colorInput) {
        // Всегда берем цвет из выбранной команды и обновляем
        const teamColor = team.kitColor || '#2b2b2b';
        // Устанавливаем значение
        colorInput.value = teamColor;
        console.log('Color value set:', teamColor, 'Current value:', colorInput.value);
        // Для input type="color" нужно явно обновить стиль
        colorInput.style.backgroundColor = teamColor;
        // Также триггерим события для гарантии обновления
        colorInput.dispatchEvent(new Event('input', { bubbles: true }));
        colorInput.dispatchEvent(new Event('change', { bubbles: true }));
        // Дополнительное обновление через setTimeout
        setTimeout(() => {
          if (colorInput) {
            colorInput.value = teamColor;
            colorInput.style.backgroundColor = teamColor;
            console.log('Color background updated:', colorInput.style.backgroundColor);
          }
        }, 10);
      } else {
        console.error('Color input element not found!');
      }
      
      // Заполняем скрытые поля команды (для совместимости)
      const nameInput = formContainer.querySelector('#addPresetTeam1Name') || formContainer.querySelector('[id*="Team1Name"]');
      const cityInput = formContainer.querySelector('#addPresetTeam1City') || formContainer.querySelector('[id*="Team1City"]');
      const shortInput = formContainer.querySelector('#addPresetTeam1Short') || formContainer.querySelector('[id*="Team1Short"]');
      
      if (nameInput) nameInput.value = team.name || '';
      if (cityInput) cityInput.value = team.city || '';
      if (shortInput) shortInput.value = team.short || '';
      
      // Обновляем имя пресета после выбора команды
      updatePresetNameForForm(selectElement);
    }
    
    function onTeam2SelectedForForm(selectElement) {
      // Находим форму - она клонируется и имеет ID presetFormContent_*
      // Используем closest для поиска формы по ID, как в редактировании по классу
      let formContainer = selectElement.closest('[id^="presetFormContent_"]');
      
      // Если не нашли, ищем вверх по DOM дереву
      if (!formContainer) {
        let parent = selectElement.parentElement;
        while (parent && !formContainer) {
          if (parent.id && parent.id.startsWith('presetFormContent_')) {
            formContainer = parent;
            break;
          }
          parent = parent.parentElement;
        }
      }
      
      if (!formContainer) {
        console.error('Form container not found for team2');
        return;
      }
      
      // Получаем tournamentId из формы или из data-атрибута
      let tournamentId = formContainer.querySelector('.addPresetTournament')?.value;
      if (!tournamentId) {
        tournamentId = formContainer.dataset.tournamentId;
      }
      if (!tournamentId && formContainer.id) {
        // Извлекаем из ID формы: presetFormContent_TOURNAMENT_ID
        const match = formContainer.id.match(/presetFormContent_(.+)/);
        if (match && match[1]) {
          tournamentId = match[1];
        }
      }
      
      const teamId = selectElement.value;
      
      console.log('Team2 selected:', { tournamentId, teamId, formId: formContainer.id });
      
      if (!teamId || !tournamentId) {
        // Очищаем логотип и цвет при сбросе выбора (как в форме редактирования)
        const logoPreview = formContainer.querySelector('.addPresetTeam2LogoPreview');
        if (logoPreview) {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
        const colorInput = formContainer.querySelector('.addPresetKit2Color');
        if (colorInput) {
          colorInput.value = '#2b2b2b';
        }
        // Обновляем имя пресета после очистки выбора
        updatePresetNameForForm(selectElement);
        return;
      }
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) {
        console.error('Tournament not found:', tournamentId);
        return;
      }
      
      const team = tournament.teams.find(t => t.id === teamId);
      if (!team) {
        console.error('Team not found:', teamId);
        return;
      }
      
      console.log('Team found:', { name: team.name, logo: team.logo, kitColor: team.kitColor });
      
      // Обновляем логотип команды - ищем относительно selectElement в структуре формы
      // Структура: form-section -> form-group -> addPresetTeam2LogoPreview
      const formSection = selectElement.closest('.form-section');
      let logoPreview = null;
      if (formSection) {
        logoPreview = formSection.querySelector('.addPresetTeam2LogoPreview');
      }
      // Если не нашли, пробуем через formContainer
      if (!logoPreview && formContainer) {
        logoPreview = formContainer.querySelector('.addPresetTeam2LogoPreview');
      }
      
      console.log('Logo preview element found:', !!logoPreview);
      if (logoPreview) {
        if (team.logo) {
          logoPreview.innerHTML = `<img src="${team.logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
          console.log('Logo updated:', team.logo);
        } else {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
      } else {
        console.error('Logo preview element not found!');
      }
      
      // Обновляем цвет формы из команды - ищем в той же form-section
      let colorInput = null;
      if (formSection) {
        colorInput = formSection.querySelector('.addPresetKit2Color');
      }
      // Если не нашли, пробуем через formContainer
      if (!colorInput && formContainer) {
        colorInput = formContainer.querySelector('.addPresetKit2Color');
      }
      
      console.log('Color input element found:', !!colorInput);
      if (colorInput) {
        // Всегда берем цвет из выбранной команды и обновляем
        const teamColor = team.kitColor || '#2b2b2b';
        // Устанавливаем значение
        colorInput.value = teamColor;
        console.log('Color value set:', teamColor, 'Current value:', colorInput.value);
        // Для input type="color" нужно явно обновить стиль
        colorInput.style.backgroundColor = teamColor;
        // Также триггерим события для гарантии обновления
        colorInput.dispatchEvent(new Event('input', { bubbles: true }));
        colorInput.dispatchEvent(new Event('change', { bubbles: true }));
        // Дополнительное обновление через setTimeout
        setTimeout(() => {
          if (colorInput) {
            colorInput.value = teamColor;
            colorInput.style.backgroundColor = teamColor;
            console.log('Color background updated:', colorInput.style.backgroundColor);
          }
        }, 10);
      } else {
        console.error('Color input element not found!');
      }
      
      // Заполняем скрытые поля команды (для совместимости)
      const nameInput = formContainer.querySelector('#addPresetTeam2Name') || formContainer.querySelector('[id*="Team2Name"]');
      const cityInput = formContainer.querySelector('#addPresetTeam2City') || formContainer.querySelector('[id*="Team2City"]');
      const shortInput = formContainer.querySelector('#addPresetTeam2Short') || formContainer.querySelector('[id*="Team2Short"]');
      
      if (nameInput) nameInput.value = team.name || '';
      if (cityInput) cityInput.value = team.city || '';
      if (shortInput) shortInput.value = team.short || '';
      
      // Обновляем имя пресета после выбора команды
      updatePresetNameForForm(selectElement);
    }
    
    function onTournamentSelectedForForm(selectElement) {
      // Эта функция не нужна в новой логике, так как турнир уже выбран при открытии формы
    }
    
    // Заполнение полей команды 1
    function fillTeam1Fields(team) {
      document.getElementById('addPresetTeam1Name').value = team.name || '';
      document.getElementById('addPresetTeam1City').value = team.city || '';
      document.getElementById('addPresetTeam1Short').value = team.short || '';
      document.getElementById('addPresetKit1Color').value = team.kitColor || '#2b2b2b';
      
      if (team.logo) {
        document.getElementById('addPresetTeam1LogoPreview').innerHTML = `<img src="${team.logo}" alt="${team.name}">`;
      } else {
        document.getElementById('addPresetTeam1LogoPreview').innerHTML = '<div class="no-logo">Нет логотипа</div>';
      }
      
      uploadedLogos.team1 = team.logo || null;
    }
    
    // Заполнение полей команды 2
    function fillTeam2Fields(team) {
      document.getElementById('addPresetTeam2Name').value = team.name || '';
      document.getElementById('addPresetTeam2City').value = team.city || '';
      document.getElementById('addPresetTeam2Short').value = team.short || '';
      document.getElementById('addPresetKit2Color').value = team.kitColor || '#2b2b2b';
      
      if (team.logo) {
        document.getElementById('addPresetTeam2LogoPreview').innerHTML = `<img src="${team.logo}" alt="${team.name}">`;
      } else {
        document.getElementById('addPresetTeam2LogoPreview').innerHTML = '<div class="no-logo">Нет логотипа</div>';
      }
      
      uploadedLogos.team2 = team.logo || null;
    }
    
    // Показать детали команды 1
    function showTeam1Details() {
      document.getElementById('addPresetTeam1Details').style.display = 'flex';
      document.getElementById('addPresetTeam1ColorRow').style.display = 'flex';
      document.getElementById('addPresetTeam1LogoRow').style.display = 'flex';
    }
    
    // Скрыть детали команды 1
    function hideTeam1Details() {
      document.getElementById('addPresetTeam1Details').style.display = 'none';
      document.getElementById('addPresetTeam1ColorRow').style.display = 'none';
      document.getElementById('addPresetTeam1LogoRow').style.display = 'none';
    }
    
    // Показать детали команды 2
    function showTeam2Details() {
      document.getElementById('addPresetTeam2Details').style.display = 'flex';
      document.getElementById('addPresetTeam2ColorRow').style.display = 'flex';
      document.getElementById('addPresetTeam2LogoRow').style.display = 'flex';
    }
    
    // Скрыть детали команды 2
    function hideTeam2Details() {
      document.getElementById('addPresetTeam2Details').style.display = 'none';
      document.getElementById('addPresetTeam2ColorRow').style.display = 'none';
      document.getElementById('addPresetTeam2LogoRow').style.display = 'none';
    }
    
    // Настройка обработчиков для формы редактирования
    function setupEditFormHandlers() {
      // Обработчик клика вне формы редактирования
      document.addEventListener('click', function(event) {
        const editForm = document.getElementById('editPresetForm');
        const editLinks = document.querySelectorAll('.preset-edit-link');
        const isEditLink = Array.from(editLinks).some(link => link.contains(event.target));
        
        if (editForm && !editForm.classList.contains('hidden') && 
            !editForm.contains(event.target) && !isEditLink) {
          handleEditFormClose();
        }
      });
      
      // Обработчики изменений в полях формы
      const formFields = [
        'editPresetName', 'editPresetTeam1Name', 'editPresetTeam1City', 
        'editPresetTeam1Short', 'editPresetKit1Color', 'editPresetTeam2Name', 
        'editPresetTeam2City', 'editPresetTeam2Short', 'editPresetKit2Color'
      ];
      
      formFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', function() {
            // Поле изменено, можно отслеживать изменения
          });
        }
      });
    }
    
    // Проверка наличия изменений в форме
    function hasFormChanges() {
      if (!originalPresetData) return false;
      
      const currentData = {
        name: document.getElementById('editPresetName').value.trim(),
        team1Name: document.getElementById('editPresetTeam1Name').value.trim(),
        team1City: document.getElementById('editPresetTeam1City').value.trim(),
        team1Short: document.getElementById('editPresetTeam1Short').value.trim(),
        kit1Color: document.getElementById('editPresetKit1Color').value,
        team2Name: document.getElementById('editPresetTeam2Name').value.trim(),
        team2City: document.getElementById('editPresetTeam2City').value.trim(),
        team2Short: document.getElementById('editPresetTeam2Short').value.trim(),
        kit2Color: document.getElementById('editPresetKit2Color').value
      };
      
      return JSON.stringify(currentData) !== JSON.stringify(originalPresetData);
    }
    
    // Обработка закрытия формы редактирования
    function handleEditFormClose() {
      if (hasFormChanges()) {
        if (confirm('У вас есть несохраненные изменения. Сохранить перед закрытием?')) {
          updatePreset();
        }
      }
      cancelEditPreset();
    }
    
    // Загрузка логотипа
    async function uploadLogo(team, fileInput) {
      if (!fileInput.files[0]) return;
      
      const formData = new FormData();
      formData.append('logo', fileInput.files[0]);
      
      try {
        const response = await fetch(`/api/upload-logo?token=${getToken()}`, {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          const result = await response.json();
          uploadedLogos[team] = result.url; // Сохраняем полный URL
          showLogoPreview(team, result.url);
          updateLogoMini(team, result.url);
          showNotification('Логотип загружен успешно', 'success');
        } else {
          const error = await response.json();
          showNotification('Ошибка загрузки: ' + error.error, 'error');
        }
      } catch (error) {
        showNotification('Ошибка загрузки логотипа', 'error');
        console.error('Upload error:', error);
      }
    }
    
    // Показ превью логотипа
    function showLogoPreview(team, url) {
      // Для формы редактирования
      const editPreview = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}LogoPreview`);
      if (editPreview) {
        editPreview.innerHTML = `<img src="${url}" alt="Логотип ${team}">`;
      }
      
      // Для формы добавления
      const addPreview = document.getElementById(`addPresetTeam${team === 'team1' ? '1' : '2'}LogoPreview`);
      if (addPreview) {
        addPreview.innerHTML = `<img src="${url}" alt="Логотип ${team}">`;
      }
    }
    
    // Очистка логотипа
    function clearLogo(team) {
      uploadedLogos[team] = null;
      
      // Для формы редактирования
      const editPreview = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}LogoPreview`);
      if (editPreview) {
        editPreview.innerHTML = '<div class="no-logo">Нет логотипа</div>';
      }
      
      // Для формы добавления
      const addPreview = document.getElementById(`addPresetTeam${team === 'team1' ? '1' : '2'}LogoPreview`);
      if (addPreview) {
        addPreview.innerHTML = '<div class="no-logo">Нет логотипа</div>';
      }
      
      // Очищаем поле выбора файла в форме редактирования
      const editFileInput = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}Logo`);
      if (editFileInput) {
        editFileInput.value = '';
      }
      
      // Очищаем поле выбора файла в форме добавления
      const addFileInput = document.getElementById(`addPresetTeam${team === 'team1' ? '1' : '2'}Logo`);
      if (addFileInput) {
        addFileInput.value = '';
      }
    }
    
    // Редактирование заголовка (только для формы редактирования)
    function startEditingTitle() {
      // Проверяем только форму редактирования
      const editTitle = document.getElementById('editPresetTitle');
      const editInput = document.getElementById('editPresetNameInput');
      
      if (editTitle && !editTitle.classList.contains('hidden')) {
        // Форма редактирования
        editTitle.classList.add('hidden');
        editInput.classList.remove('hidden');
        editInput.value = editTitle.textContent;
        editInput.focus();
        editInput.select();
      }
    }
    
    function finishEditingTitle() {
      // Проверяем только форму редактирования
      const editTitle = document.getElementById('editPresetTitle');
      const editInput = document.getElementById('editPresetNameInput');
      
      if (editInput && !editInput.classList.contains('hidden')) {
        // Форма редактирования
        editTitle.textContent = editInput.value.trim() || 'Название матча';
        editTitle.classList.remove('hidden');
        editInput.classList.add('hidden');
      }
    }
    
    function handleTitleKeypress(event) {
      if (event.key === 'Enter') {
        finishEditingTitle();
      }
    }
    
    // Обновление миниатюр логотипов
    function updateLogoMini(team, logoUrl) {
      // Для формы редактирования
      const editMini = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}LogoMini`);
      if (editMini) {
        if (logoUrl) {
          editMini.innerHTML = `<img src="${logoUrl}" alt="Логотип ${team}">`;
          // Показываем кнопку удаления
          const deleteBtn = editMini.parentElement.querySelector('.logo-delete-btn-small');
          if (deleteBtn) deleteBtn.style.display = 'flex';
        } else {
          editMini.innerHTML = '';
          // Скрываем кнопку удаления
          const deleteBtn = editMini.parentElement.querySelector('.logo-delete-btn-small');
          if (deleteBtn) deleteBtn.style.display = 'none';
        }
      }
      
      // Для формы добавления (если есть миниатюры)
      const addMini = document.getElementById(`addPresetTeam${team === 'team1' ? '1' : '2'}LogoMini`);
      if (addMini) {
        if (logoUrl) {
          addMini.innerHTML = `<img src="${logoUrl}" alt="Логотип ${team}">`;
        } else {
          addMini.innerHTML = '';
        }
      }
    }
    
    // Обновление логотипа в форме редактирования
    function editPresetLogo(team) {
      const fileInput = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}Logo`);
      fileInput.click();
    }
    
    // Удаление логотипа из формы редактирования
    async function deletePresetLogo(team) {
      if (!confirm('Удалить логотип этой команды?')) return;
      
      // Очищаем логотип
      uploadedLogos[team] = null;
      
      // Обновляем миниатюру
      updateLogoMini(team, null);
      
      // Очищаем поле выбора файла
      const fileInput = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}Logo`);
      if (fileInput) fileInput.value = '';
      
      showNotification('Логотип удален', 'success');
    }
    
    // Загрузка логотипа в основную форму
    async function uploadMainLogo(team, fileInput) {
      if (!fileInput.files[0]) return;
      
      const formData = new FormData();
      formData.append('logo', fileInput.files[0]);
      
      try {
        const response = await fetch(`/api/upload-logo?token=${getToken()}`, {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          const result = await response.json();
          updateMainLogoMini(team, result.url);
          updateMainLogoState(team, result.url);
          showNotification('Логотип загружен успешно', 'success');
        } else {
          const error = await response.json();
          showNotification('Ошибка загрузки: ' + error.error, 'error');
        }
      } catch (error) {
        showNotification('Ошибка загрузки логотипа', 'error');
        console.error('Upload error:', error);
      }
    }
    
    // Обновление миниатюры в основной форме
    function updateMainLogoMini(team, logoUrl) {
      const mini = document.getElementById(`${team}LogoMini`);
      const deleteBtn = mini.querySelector('.logo-delete-btn');
      
      if (logoUrl) {
        mini.innerHTML = `<img src="${logoUrl}" alt="Логотип ${team}">
          <span class="logo-delete-btn" onclick="clearMainLogo('${team}'); event.stopPropagation()" title="Удалить логотип">×</span>`;
      } else {
        mini.innerHTML = '';
      }
    }
    
    // Обновление состояния логотипа в основной форме
    function updateMainLogoState(team, logoUrl) {
      state[`${team}Logo`] = logoUrl;
      socket.emit('updateScoreboard', {
        [`${team}Logo`]: logoUrl
      });
    }
    
    // Показ серого круга цвета формы
    function showKitColorCircle(team) {
      const mini = document.getElementById(`${team}LogoMini`);
      const kitColor = document.getElementById(`kit${team === 'team1' ? '1' : '2'}Color`).value;
      mini.innerHTML = `<div style="width: 100%; height: 100%; background-color: ${kitColor}; border-radius: 50%;"></div>`;
    }
    
    // Удаление логотипа из основной панели
    async function clearMainLogo(team) {
      const currentLogoUrl = state[`${team}Logo`];
      
      if (!currentLogoUrl) return;
      
      // Очищаем состояние
      state[`${team}Logo`] = '';
      
      // Обновляем сервер
      sendState();
      
      // Показываем цветной круг
      showKitColorCircle(team);
      
      // Пытаемся удалить файл с сервера
      try {
        const filename = currentLogoUrl.split('/').pop();
        const response = await fetch(`/api/logo/${filename}?token=${getToken()}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showNotification('Логотип удален', 'success');
        } else if (response.status === 403) {
          const result = await response.json();
          if (result.protected) {
            showNotification('Логотип защищен от удаления (используется в пресете)', 'info');
          }
        }
      } catch (error) {
        console.error('Ошибка удаления логотипа:', error);
        showNotification('Ошибка удаления логотипа', 'error');
      }
    }

    // Настройка контролов
    function setupControls() {
      // Таймер
      document.getElementById('playPauseBtn').onclick = function() {
        const isRunning = document.getElementById('playPauseIcon').innerHTML.includes('rect');
        socket.emit('updateScoreboard', { 
          timerRunning: !isRunning 
        });
      };
      
      document.getElementById('setBtn').onclick = function() {
        // Увеличиваем счетчик нажатий
        setButtonClicks++;
        
        // Сбрасываем предыдущий таймаут
        if (setButtonClickTimeout) {
          clearTimeout(setButtonClickTimeout);
        }
        
        // Если достигли 5 нажатий
        if (setButtonClicks >= 5) {
          // Сбрасываем счетчик
          setButtonClicks = 0;
          
          // Показываем подтверждение
          if (confirm('Вы уверены, что хотите сбросить таймер и счет? Это действие нельзя отменить.')) {
            // Сбрасываем таймер и счет
            socket.emit('updateScoreboard', { 
              timerSeconds: 0,
              score1: 0,
              score2: 0
            });
            
            // Обновляем отображение
            document.getElementById('timeInput').value = '00:00';
            document.getElementById('score1Value').textContent = '0';
            document.getElementById('score2Value').textContent = '0';
            
            console.log('Таймер и счет сброшены после пятикратного нажатия SET');
          }
        } else {
          // Обычная функциональность SET
          const seconds = getSecondsFromTimeInput('timeInput');
          socket.emit('updateScoreboard', { 
            timerSeconds: seconds 
          });
          
          // Устанавливаем таймаут для сброса счетчика
          setButtonClickTimeout = setTimeout(() => {
            setButtonClicks = 0;
            console.log('Счетчик нажатий SET сброшен');
          }, SET_CLICK_RESET_TIME);
        }
      };

      // Счет с защитой от случайных изменений
      document.getElementById('score1Inc').onclick = () => {
        const score1ValueEl = document.getElementById('score1Value');
        const current = parseInt(score1ValueEl.textContent) || 0;
        const newValue = current + 1;
        
        if (timerRunning && lastScoreChange.team === 'score1' && 
            (Date.now() - lastScoreChange.timestamp) < 60000) {
          if (!confirm('Похоже, вы уже прибавили счет совсем недавно. Подтвердите, что сейчас вы не случайно нажали второй раз?')) {
            return;
          }
        }
        
        lastScoreChange = { team: 'score1', timestamp: Date.now(), value: newValue };
        // Обновляем визуально сразу, до получения ответа от сервера
        score1ValueEl.textContent = newValue;
        // Отправляем на сервер для синхронизации
        socket.emit('updateScoreboard', { score1: newValue });
      };
      
      document.getElementById('score1Dec').onclick = () => {
        const score1ValueEl = document.getElementById('score1Value');
        const current = parseInt(score1ValueEl.textContent) || 0;
        if (current > 0) {
          if (timerRunning) {
            if (!confirm('Подтвердите уменьшение счета во время игры?')) {
              return;
            }
          }
          const newValue = current - 1;
          // Обновляем визуально сразу, до получения ответа от сервера
          score1ValueEl.textContent = newValue;
          // Отправляем на сервер для синхронизации
          socket.emit('updateScoreboard', { score1: newValue });
        }
      };
      
      document.getElementById('score2Inc').onclick = () => {
        const score2ValueEl = document.getElementById('score2Value');
        const current = parseInt(score2ValueEl.textContent) || 0;
        const newValue = current + 1;
        
        if (timerRunning && lastScoreChange.team === 'score2' && 
            (Date.now() - lastScoreChange.timestamp) < 60000) {
          if (!confirm('Похоже, вы уже прибавили счет совсем недавно. Подтвердите, что сейчас вы не случайно нажали второй раз?')) {
            return;
          }
        }
        
        lastScoreChange = { team: 'score2', timestamp: Date.now(), value: newValue };
        // Обновляем визуально сразу, до получения ответа от сервера
        score2ValueEl.textContent = newValue;
        // Отправляем на сервер для синхронизации
        socket.emit('updateScoreboard', { score2: newValue });
      };
      
      document.getElementById('score2Dec').onclick = () => {
        const score2ValueEl = document.getElementById('score2Value');
        const current = parseInt(score2ValueEl.textContent) || 0;
        if (current > 0) {
          if (timerRunning) {
            if (!confirm('Подтвердите уменьшение счета во время игры?')) {
              return;
            }
          }
          const newValue = current - 1;
          // Обновляем визуально сразу, до получения ответа от сервера
          score2ValueEl.textContent = newValue;
          // Отправляем на сервер для синхронизации
          socket.emit('updateScoreboard', { score2: newValue });
        }
      };

      // Автогенерация шорткодов
      autoShortName('team1Name', 'team1Short', 'ХОЗ');
      autoShortName('team2Name', 'team2Short', 'ГОС');

      // Обработчики изменений для всех полей команд - синхронизация с сервером
      const fields = [
        'team1Name', 'team2Name', 'team1City', 'team2City',
        'team1Short', 'team2Short', 'kit1Color', 'kit2Color'
      ];
      
      fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          // Используем 'input' для текстовых полей и 'change' для color
          const eventType = fieldId.includes('Color') ? 'change' : 'input';
          field.addEventListener(eventType, () => {
            if (ready) { // Отправляем только если готовы, чтобы избежать циклов
              sendState();
            }
          });
        }
      });

      // Обработка ввода времени
      document.getElementById('timeInput').addEventListener('input', function(e) {
        let v = this.value.replace(/[^\d:]/g, '');
        if (v.length === 2 && !v.includes(':')) v = v + ':';
        if (v.length > 5) v = v.slice(0,5);
        if (v.length === 3 && v[2] !== ':') v = v.slice(0,2) + ':' + v[2];
        if (!/^\d{0,2}:?\d{0,2}$/.test(v)) v = v.slice(0,-1);
        this.value = v;
      });
    }

    // Отправка состояния на сервер для сохранения (железобетонное сохранение)
    function sendState() {
      // Получаем текущие логотипы из состояния
      const team1Logo = state.team1Logo || '';
      const team2Logo = state.team2Logo || '';
      
      // Получаем все значения из формы
      const team1NameEl = document.getElementById('team1Name');
      const team1CityEl = document.getElementById('team1City');
      const team1ShortEl = document.getElementById('team1Short');
      const team2NameEl = document.getElementById('team2Name');
      const team2CityEl = document.getElementById('team2City');
      const team2ShortEl = document.getElementById('team2Short');
      const kit1ColorEl = document.getElementById('kit1Color');
      const kit2ColorEl = document.getElementById('kit2Color');
      
      // Формируем объект состояния для отправки на сервер
      // ВАЖНО: отправляем все поля, чтобы сервер сохранил полное состояние
      const stateUpdate = {};
      
      if (team1NameEl) stateUpdate.team1Name = team1NameEl.value || '';
      if (team1CityEl) stateUpdate.team1City = team1CityEl.value || '';
      if (team1ShortEl) stateUpdate.team1Short = team1ShortEl.value || '';
      if (team2NameEl) stateUpdate.team2Name = team2NameEl.value || '';
      if (team2CityEl) stateUpdate.team2City = team2CityEl.value || '';
      if (team2ShortEl) stateUpdate.team2Short = team2ShortEl.value || '';
      if (kit1ColorEl) stateUpdate.kit1Color = kit1ColorEl.value || '#2b2b2b';
      if (kit2ColorEl) stateUpdate.kit2Color = kit2ColorEl.value || '#2b2b2b';
      
      // Логотипы всегда отправляем из состояния
      stateUpdate.team1Logo = team1Logo;
      stateUpdate.team2Logo = team2Logo;
      
      // ОТПРАВЛЯЕМ НА СЕРВЕР - это сохранит состояние в state.json
      // Сервер автоматически сохранит все данные и разошлет всем клиентам
      socket.emit('updateScoreboard', stateUpdate);
    }

    // Загрузка предустановок
    async function loadPresets() {
      try {
        const response = await fetch(`/api/presets?token=${getToken()}`);
        presets = await response.json();
        console.log('Loaded presets:', presets);
        // Обновляем отображение пресетов для каждого турнира
        renderTournamentPresets();
      } catch (error) {
        console.error('Ошибка загрузки предустановок:', error);
      }
    }
    
    // Переключение отображения пресетов турнира
    function toggleTournamentPresets(tournamentId) {
      const presetsDiv = document.getElementById(`presets-${tournamentId}`);
      if (presetsDiv) {
        const isHidden = presetsDiv.classList.contains('hidden');
        if (isHidden) {
          // Показываем пресеты
          presetsDiv.classList.remove('hidden');
          expandedPresets.add(tournamentId);
          // Загружаем пресеты если еще не загружены
          renderTournamentPresets();
        } else {
          // Скрываем пресеты
          presetsDiv.classList.add('hidden');
          expandedPresets.delete(tournamentId);
        }
      }
    }
    
    // Отображение пресетов для турниров
    function renderTournamentPresets() {
      if (!tournaments || tournaments.length === 0) return;
      
      tournaments.forEach(tournament => {
        const presetsContainer = document.getElementById(`presets-list-${tournament.id}`);
        if (!presetsContainer) return;
        
        // Фильтруем пресеты этого турнира
        const tournamentPresets = presets.filter(p => p && p.tournamentId === tournament.id);
        
        // Обновляем счетчик пресетов (всегда, даже если секция не раскрыта)
        const presetCountEl = document.getElementById(`presetCount-${tournament.id}`);
        if (presetCountEl) {
          presetCountEl.textContent = tournamentPresets.length;
        }
        
        // Показываем пресеты только если секция не скрыта
        const presetsDiv = document.getElementById(`presets-${tournament.id}`);
        if (presetsDiv && presetsDiv.classList.contains('hidden')) {
          return;
        }
        
        // Добавляем в expandedPresets если еще не добавлен (для сохранения состояния)
        expandedPresets.add(tournament.id);
        
        if (tournamentPresets.length === 0) {
          presetsContainer.innerHTML = '<div style="padding: 10px; color: #999; font-size: 12px;">Пресетов пока нет</div>';
          return;
        }
        
        presetsContainer.innerHTML = '';
        
        tournamentPresets.forEach(preset => {
          // Находим команды из турнира для получения актуальных логотипов
          let team1 = null;
          let team2 = null;
          if (preset.team1Id && tournament.teams) {
            team1 = tournament.teams.find(t => t.id === preset.team1Id);
          }
          if (preset.team2Id && tournament.teams) {
            team2 = tournament.teams.find(t => t.id === preset.team2Id);
          }
          
          // Используем актуальные логотипы из команд турнира, если команды найдены
          const team1Logo = (team1 && team1.logo) ? team1.logo : (preset.team1Logo || '');
          const team2Logo = (team2 && team2.logo) ? team2.logo : (preset.team2Logo || '');
          
          // Создаем контейнер для пресета (блок на всю ширину)
          const presetWrapper = document.createElement('div');
          presetWrapper.className = 'preset-item-wrapper';
          presetWrapper.style.cssText = 'width: 100%; margin-bottom: 10px;';
          presetWrapper.setAttribute('data-preset-id', preset.id);
          presetWrapper.setAttribute('data-tournament-id', tournament.id);
          
          // Элемент пресета (информация и кнопки)
          const presetItem = document.createElement('div');
          presetItem.className = 'preset-item';
          presetItem.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 6px; border: 1px solid #ddd; width: 100%; box-sizing: border-box;';
          presetItem.setAttribute('data-preset-id', preset.id);
          presetItem.setAttribute('data-tournament-id', tournament.id);
          
          presetItem.innerHTML = `
            <div class="preset-content" style="flex: 1; display: flex; align-items: center; justify-content: space-between; width: 100%;">
              <div class="preset-left" style="display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 0;">
                <div class="preset-name" style="font-weight: bold; color: #333; font-size: 15px;">${preset.name}</div>
                <div class="preset-teams" style="display: flex; align-items: center; gap: 6px;">
                  <span class="preset-team-logo">
                    ${team1Logo ? `<img src="${team1Logo}" alt="Логотип ${preset.team1Name}" class="preset-logo-mini">` : ''}
                  </span>
                  <span class="preset-team-name" style="font-size: 12px; color: #666;">${preset.team1Short ? preset.team1Short.toUpperCase() : ''}</span>
                  <span class="preset-kit-color" style="background-color: ${preset.kit1Color || '#2b2b2b'}; width: 12px; height: 12px; border-radius: 2px; border: 1px solid #ccc; display: inline-block;"></span>
                  <span class="preset-separator" style="color: #666; font-weight: bold; margin: 0 2px;">:</span>
                  <span class="preset-kit-color" style="background-color: ${preset.kit2Color || '#2b2b2b'}; width: 12px; height: 12px; border-radius: 2px; border: 1px solid #ccc; display: inline-block;"></span>
                  <span class="preset-team-name" style="font-size: 12px; color: #666;">${preset.team2Short ? preset.team2Short.toUpperCase() : ''}</span>
                  <span class="preset-team-logo">
                    ${team2Logo ? `<img src="${team2Logo}" alt="Логотип ${preset.team2Name}" class="preset-logo-mini">` : ''}
                  </span>
                </div>
              </div>
              <div class="preset-right" style="display: flex; align-items: center; gap: 12px; flex-shrink: 0;">
                <span class="preset-edit-link" onclick="editPresetInline('${tournament.id}', '${preset.id}')">edit</span>
                <span class="preset-apply-symbol" onclick="if (!window.timerRunning) applyPreset('${preset.id}')" ${timerRunning ? 'style="opacity: 0.5; cursor: not-allowed; pointer-events: none;"' : ''} title="Применить предустановку">▶</span>
              </div>
            </div>
          `;
          
          // Форма редактирования (отдельный элемент, вставляется после presetItem)
          const editForm = document.createElement('div');
          editForm.id = `preset-edit-form-${tournament.id}-${preset.id}`;
          editForm.className = 'preset-edit-form-inline hidden';
          
          presetWrapper.appendChild(presetItem);
          presetWrapper.appendChild(editForm);
          
          presetsContainer.appendChild(presetWrapper);
        });
      });
    }
    
    // Удаление пресета из турнира
    async function deletePresetFromTournament(tournamentId, presetId) {
      if (!confirm('Удалить этот пресет?')) return;
      
      try {
        const response = await fetch(`/api/presets/${presetId}?token=${getToken()}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          // Сохраняем состояние видимости пресетов
          const presetsDiv = document.getElementById(`presets-${tournamentId}`);
          const wasHidden = presetsDiv ? presetsDiv.classList.contains('hidden') : false;
          
          await loadPresets();
          await loadTournaments(); // Обновляем счетчик
          
          // Восстанавливаем состояние видимости
          if (presetsDiv) {
            if (wasHidden) {
              presetsDiv.classList.add('hidden');
              expandedPresets.delete(tournamentId);
            } else {
              presetsDiv.classList.remove('hidden');
              expandedPresets.add(tournamentId);
              renderTournamentPresets(); // Рендерим если видим
            }
          }
          
          showNotification('Пресет удален!', 'success');
        } else {
          throw new Error('Ошибка удаления пресета');
        }
      } catch (error) {
        console.error('Ошибка удаления пресета:', error);
        showNotification('Ошибка удаления пресета', 'error');
      }
    }
    
    // Inline редактирование пресета
    function editPresetInline(tournamentId, presetId) {
      const preset = presets.find(p => p.id === presetId);
      if (!preset) {
        alert('Пресет не найден');
        return;
      }
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) {
        alert('Турнир не найден');
        return;
      }
      
      // Восстанавливаем видимость всех пресетов, которые были в режиме редактирования
      document.querySelectorAll('.preset-item').forEach(item => {
        if (item.style.display === 'none' || item.classList.contains('edit-mode')) {
          item.style.display = '';
          item.classList.remove('edit-mode');
        }
      });
      
      // Скрываем все формы редактирования и очищаем их содержимое
      document.querySelectorAll('.preset-edit-form-inline').forEach(form => {
        form.classList.add('hidden');
        form.innerHTML = '';
      });
      
      // Скрываем форму создания пресета если открыта
      const addForm = document.getElementById(`presetForm_${tournamentId}`);
      if (addForm) {
        addForm.classList.add('hidden');
      }
      
      // Убеждаемся что пресеты раскрыты
      const presetsDiv = document.getElementById(`presets-${tournamentId}`);
      if (presetsDiv) {
        presetsDiv.classList.remove('hidden');
        expandedPresets.add(tournamentId);
      }
      
      // Находим wrapper пресета
      const presetWrapper = document.querySelector(`.preset-item-wrapper[data-preset-id="${presetId}"][data-tournament-id="${tournamentId}"]`);
      if (!presetWrapper) {
        alert('Элемент пресета не найден');
        return;
      }
      
      // Находим элемент пресета внутри wrapper
      const presetItem = presetWrapper.querySelector('.preset-item');
      if (!presetItem) {
        alert('Элемент пресета не найден');
        return;
      }
      
      // Показываем форму редактирования на месте пресета
      const editForm = presetWrapper.querySelector(`#preset-edit-form-${tournamentId}-${presetId}`);
      if (!editForm) {
        alert('Форма редактирования не найдена');
        return;
      }
      
      // Определяем текущие ID команд или находим их по именам
      let currentTeam1Id = preset.team1Id;
      let currentTeam2Id = preset.team2Id;
      
      // Если ID не сохранены, пытаемся найти по имени
      if (!currentTeam1Id && preset.team1Name) {
        const team = tournament.teams.find(t => t.name === preset.team1Name);
        if (team) currentTeam1Id = team.id;
      }
      
      if (!currentTeam2Id && preset.team2Name) {
        const team = tournament.teams.find(t => t.name === preset.team2Name);
        if (team) currentTeam2Id = team.id;
      }
      
      // Извлекаем время из имени пресета (формат: "19:00 / Команда 1 - Команда 2")
      let matchTime = '19:00';
      if (preset.name && preset.name.includes(' / ')) {
        const timeMatch = preset.name.match(/^(\d{2}:\d{2})\s*\/\s*/);
        if (timeMatch) {
          matchTime = timeMatch[1];
        }
      }
      
      // Заполняем форму содержимым ПЕРЕД показом
      editForm.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px; margin-top: 0; margin-bottom: 15px; width: 100%; flex-wrap: nowrap;">
            <h4 style="margin: 0;">Редактировать пресет</h4>
            <small style="color: #999; font-size: 11px; white-space: nowrap; flex-shrink: 0; margin-left: auto;">Имя пресета будет сформировано автоматически</small>
          </div>
          
          <!-- Строка с временем и именем пресета -->
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; width: 100%; flex-wrap: nowrap;">
            <input type="time" class="editPresetMatchTimeInline" value="${matchTime}" onchange="updateEditPresetNameInline('${tournamentId}', '${presetId}')" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; -webkit-appearance: none; appearance: none; flex-shrink: 0;">
            <h3 class="editPresetTitleInline" style="margin: 0; color: #1976d2; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${preset.name}</h3>
          </div>
          
          <!-- Компактная строка: Команда 1 с лого, цвет формы 1 -->
          <div class="form-section" style="margin-bottom: 15px;">
            <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: nowrap; width: 100%;">
              <div class="form-group" style="flex: 1; min-width: 0; display: flex; gap: 8px; align-items: flex-end;">
                <div class="editPresetTeam1LogoPreview" style="flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  ${preset.team1Logo ? `<img src="${preset.team1Logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">` : '<div style="font-size: 10px; color: #999;">Лого</div>'}
                </div>
                <div style="flex: 1; min-width: 0;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Команда 1</label>
                  <select class="editPresetTeam1SelectInline" onchange="onEditTeam1SelectedInline('${tournamentId}', '${presetId}', this)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="">-- Выберите команду --</option>
                  </select>
                </div>
              </div>
              <div class="form-group" style="flex-shrink: 0;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Цвет формы</label>
                <input type="color" class="editPresetKit1ColorInline" value="${preset.kit1Color || '#2b2b2b'}" onchange="this.dataset.manualEdit = 'true'; this.dataset.userEdited = 'true'" style="width: 70px; height: 38px; padding: 0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
              </div>
            </div>
          </div>
          
          <!-- Компактная строка: Команда 2 с лого, цвет формы 2 -->
          <div class="form-section" style="margin-bottom: 20px;">
            <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: nowrap; width: 100%;">
              <div class="form-group" style="flex: 1; min-width: 0; display: flex; gap: 8px; align-items: flex-end;">
                <div class="editPresetTeam2LogoPreview" style="flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  ${preset.team2Logo ? `<img src="${preset.team2Logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">` : '<div style="font-size: 10px; color: #999;">Лого</div>'}
                </div>
                <div style="flex: 1; min-width: 0;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Команда 2</label>
                  <select class="editPresetTeam2SelectInline" onchange="onEditTeam2SelectedInline('${tournamentId}', '${presetId}', this)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="">-- Выберите команду --</option>
                  </select>
                </div>
              </div>
              <div class="form-group" style="flex-shrink: 0;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Цвет формы</label>
                <input type="color" class="editPresetKit2ColorInline" value="${preset.kit2Color || '#2b2b2b'}" onchange="this.dataset.manualEdit = 'true'; this.dataset.userEdited = 'true'" style="width: 70px; height: 38px; padding: 0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
              </div>
            </div>
          </div>
          
          <div class="form-buttons">
            <button class="btn btn-primary" onclick="saveEditPresetInline('${tournamentId}', '${presetId}')">Сохранить</button>
            <button class="btn btn-secondary" onclick="cancelEditPresetInline('${tournamentId}', '${presetId}')">Отмена</button>
          </div>
        `;
      
      // Заполняем селекты команд
      const team1Select = editForm.querySelector('.editPresetTeam1SelectInline');
      const team2Select = editForm.querySelector('.editPresetTeam2SelectInline');
      const team1LogoPreview = editForm.querySelector('.editPresetTeam1LogoPreview');
      const team2LogoPreview = editForm.querySelector('.editPresetTeam2LogoPreview');
      const kit1ColorInput = editForm.querySelector('.editPresetKit1ColorInline');
      const kit2ColorInput = editForm.querySelector('.editPresetKit2ColorInline');
      
      let selectedTeam1 = null;
      let selectedTeam2 = null;
      
      tournament.teams.forEach(team => {
        const option1 = document.createElement('option');
        option1.value = team.id;
        option1.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        if (currentTeam1Id && team.id === currentTeam1Id) {
          option1.selected = true;
          selectedTeam1 = team;
          // Обновляем логотип для выбранной команды 1
          if (team1LogoPreview && team.logo) {
            team1LogoPreview.innerHTML = `<img src="${team.logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
          }
        }
        team1Select.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = team.id;
        option2.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        if (currentTeam2Id && team.id === currentTeam2Id) {
          option2.selected = true;
          selectedTeam2 = team;
          // Обновляем логотип для выбранной команды 2
          if (team2LogoPreview && team.logo) {
            team2LogoPreview.innerHTML = `<img src="${team.logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
          }
        }
        team2Select.appendChild(option2);
      });
      
      // Проверяем, был ли цвет изменен пользователем вручную в пресете
      // Если цвет пресета отличается от цвета команды - значит пользователь менял его
      if (selectedTeam1 && kit1ColorInput) {
        const presetColor = preset.kit1Color || '#2b2b2b';
        const teamColor = selectedTeam1.kitColor || '#2b2b2b';
        if (presetColor !== teamColor) {
          // Цвет был изменен вручную, помечаем как manualEdit (но не userEdited, так как это из пресета)
          kit1ColorInput.dataset.manualEdit = 'true';
          kit1ColorInput.dataset.userEdited = undefined;
          // Устанавливаем цвет из пресета
          kit1ColorInput.value = presetColor;
        } else {
          // Цвет совпадает с командой, оставляем возможность автоматического обновления
          kit1ColorInput.dataset.manualEdit = undefined;
          kit1ColorInput.dataset.userEdited = undefined;
          // Устанавливаем цвет из команды
          kit1ColorInput.value = teamColor;
        }
      } else if (!selectedTeam1 && kit1ColorInput) {
        // Если команда не выбрана, устанавливаем цвет из пресета если есть
        kit1ColorInput.value = preset.kit1Color || '#2b2b2b';
      }
      
      if (selectedTeam2 && kit2ColorInput) {
        const presetColor = preset.kit2Color || '#2b2b2b';
        const teamColor = selectedTeam2.kitColor || '#2b2b2b';
        if (presetColor !== teamColor) {
          // Цвет был изменен вручную, помечаем как manualEdit (но не userEdited, так как это из пресета)
          kit2ColorInput.dataset.manualEdit = 'true';
          kit2ColorInput.dataset.userEdited = undefined;
          // Устанавливаем цвет из пресета
          kit2ColorInput.value = presetColor;
        } else {
          // Цвет совпадает с командой, оставляем возможность автоматического обновления
          kit2ColorInput.dataset.manualEdit = undefined;
          kit2ColorInput.dataset.userEdited = undefined;
          // Устанавливаем цвет из команды
          kit2ColorInput.value = teamColor;
        }
      } else if (!selectedTeam2 && kit2ColorInput) {
        // Если команда не выбрана, устанавливаем цвет из пресета если есть
        kit2ColorInput.value = preset.kit2Color || '#2b2b2b';
      }
      
      // Обновляем имя пресета
      updateEditPresetNameInline(tournamentId, presetId);
      
      // Теперь скрываем presetItem и показываем форму редактирования
      presetItem.style.display = 'none';
      editForm.classList.remove('hidden');
      presetItem.classList.add('edit-mode');
    }
    
    // Обновление имени пресета при редактировании
    function updateEditPresetNameInline(tournamentId, presetId) {
      const editForm = document.getElementById(`preset-edit-form-${tournamentId}-${presetId}`);
      if (!editForm) return;
      
      const timeInput = editForm.querySelector('.editPresetMatchTimeInline');
      const titleElement = editForm.querySelector('.editPresetTitleInline');
      const team1Select = editForm.querySelector('.editPresetTeam1SelectInline');
      const team2Select = editForm.querySelector('.editPresetTeam2SelectInline');
      
      if (!timeInput || !titleElement || !team1Select || !team2Select) return;
      
      const matchTime = timeInput.value || '19:00';
      
      let team1Name = 'Команда 1';
      let team2Name = 'Команда 2';
      
      if (team1Select.value) {
        const tournament = tournaments.find(t => t.id === tournamentId);
        if (tournament && tournament.teams) {
          const team = tournament.teams.find(t => t.id === team1Select.value);
          if (team) team1Name = team.name;
        }
      }
      
      if (team2Select.value) {
        const tournament = tournaments.find(t => t.id === tournamentId);
        if (tournament && tournament.teams) {
          const team = tournament.teams.find(t => t.id === team2Select.value);
          if (team) team2Name = team.name;
        }
      }
      
      titleElement.textContent = `${matchTime} / ${team1Name} - ${team2Name}`;
    }
    
    // Обработка выбора команды 1 при редактировании
    function onEditTeam1SelectedInline(tournamentId, presetId, selectElement) {
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) return;
      
      const teamId = selectElement.value;
      const editForm = selectElement.closest('.preset-edit-form-inline');
      
      if (!teamId) {
        // Очищаем логотип и цвет при сбросе выбора
        const logoPreview = editForm?.querySelector('.editPresetTeam1LogoPreview');
        if (logoPreview) {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
        // Сбрасываем флаг manualEdit при сбросе команды
        const colorInput = editForm?.querySelector('.editPresetKit1ColorInline');
        if (colorInput) {
          colorInput.dataset.manualEdit = undefined;
        }
        updateEditPresetNameInline(tournamentId, presetId);
        return;
      }
      
      const team = tournament.teams.find(t => t.id === teamId);
      if (!team) return;
      
      // Обновляем логотип команды
      const logoPreview = editForm?.querySelector('.editPresetTeam1LogoPreview');
      if (logoPreview) {
        if (team.logo) {
          logoPreview.innerHTML = `<img src="${team.logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
        } else {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
      }
      
      // Обновляем цвет формы из команды
      const colorInput = editForm?.querySelector('.editPresetKit1ColorInline');
      if (colorInput) {
        // Проверяем, был ли цвет изменен вручную пользователем в текущей сессии редактирования
        // Если флаг manualEdit установлен, значит пользователь явно менял цвет - не обновляем
        // Если флага нет, или он был установлен при инициализации (не вручную), обновляем из команды
        const wasManuallyEdited = colorInput.dataset.manualEdit === 'true' && 
                                  colorInput.dataset.userEdited === 'true';
        
        if (!wasManuallyEdited) {
          // Берем цвет из выбранной команды и обновляем
          colorInput.value = team.kitColor || '#2b2b2b';
          // Сбрасываем флаг manualEdit, так как цвет взят из команды
          colorInput.dataset.manualEdit = undefined;
          colorInput.dataset.userEdited = undefined;
          // Принудительно обновляем визуальное отображение
          setTimeout(() => {
            colorInput.style.backgroundColor = colorInput.value;
          }, 0);
        }
      }
      
      updateEditPresetNameInline(tournamentId, presetId);
    }
    
    // Обработка выбора команды 2 при редактировании
    function onEditTeam2SelectedInline(tournamentId, presetId, selectElement) {
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) return;
      
      const teamId = selectElement.value;
      const editForm = selectElement.closest('.preset-edit-form-inline');
      
      if (!teamId) {
        // Очищаем логотип и цвет при сбросе выбора
        const logoPreview = editForm?.querySelector('.editPresetTeam2LogoPreview');
        if (logoPreview) {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
        // Сбрасываем флаг manualEdit при сбросе команды
        const colorInput = editForm?.querySelector('.editPresetKit2ColorInline');
        if (colorInput) {
          colorInput.dataset.manualEdit = undefined;
        }
        updateEditPresetNameInline(tournamentId, presetId);
        return;
      }
      
      const team = tournament.teams.find(t => t.id === teamId);
      if (!team) return;
      
      // Обновляем логотип команды
      const logoPreview = editForm?.querySelector('.editPresetTeam2LogoPreview');
      if (logoPreview) {
        if (team.logo) {
          logoPreview.innerHTML = `<img src="${team.logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
        } else {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
      }
      
      // Обновляем цвет формы из команды
      const colorInput = editForm?.querySelector('.editPresetKit2ColorInline');
      if (colorInput) {
        // Проверяем, был ли цвет изменен вручную пользователем в текущей сессии редактирования
        // Если флаг manualEdit установлен, значит пользователь явно менял цвет - не обновляем
        // Если флага нет, или он был установлен при инициализации (не вручную), обновляем из команды
        const wasManuallyEdited = colorInput.dataset.manualEdit === 'true' && 
                                  colorInput.dataset.userEdited === 'true';
        
        if (!wasManuallyEdited) {
          // Берем цвет из выбранной команды и обновляем
          colorInput.value = team.kitColor || '#2b2b2b';
          // Сбрасываем флаг manualEdit, так как цвет взят из команды
          colorInput.dataset.manualEdit = undefined;
          colorInput.dataset.userEdited = undefined;
          // Принудительно обновляем визуальное отображение
          setTimeout(() => {
            colorInput.style.backgroundColor = colorInput.value;
          }, 0);
        }
      }
      
      updateEditPresetNameInline(tournamentId, presetId);
    }
    
    // Сохранение редактируемого пресета inline
    async function saveEditPresetInline(tournamentId, presetId) {
      const editForm = document.getElementById(`preset-edit-form-${tournamentId}-${presetId}`);
      if (!editForm) return;
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) {
        alert('Турнир не найден');
        return;
      }
      
      const team1Select = editForm.querySelector('.editPresetTeam1SelectInline');
      const team2Select = editForm.querySelector('.editPresetTeam2SelectInline');
      const timeInput = editForm.querySelector('.editPresetMatchTimeInline');
      const kit1ColorInput = editForm.querySelector('.editPresetKit1ColorInline');
      const kit2ColorInput = editForm.querySelector('.editPresetKit2ColorInline');
      
      if (!team1Select || !team2Select || !team1Select.value || !team2Select.value) {
        alert('Выберите обе команды');
        return;
      }
      
      const team1Id = team1Select.value;
      const team2Id = team2Select.value;
      
      const team1 = tournament.teams.find(t => t.id === team1Id);
      const team2 = tournament.teams.find(t => t.id === team2Id);
      
      if (!team1 || !team2) {
        alert('Команды не найдены');
        return;
      }
      
      // Формируем имя пресета автоматически
      const matchTime = timeInput.value || '19:00';
      const presetName = `${matchTime} / ${team1.name} - ${team2.name}`;
      
      // Определяем логотипы: если был загружен новый логотип для пресета, используем его,
      // иначе берем из команды. Это НЕ изменяет логотип команды - только сохраняет в пресет.
      const team1Logo = uploadedLogos.team1 || team1.logo || '';
      const team2Logo = uploadedLogos.team2 || team2.logo || '';
      
      const preset = {
        name: presetName,
        tournamentId: tournamentId,
        team1Id: team1Id,
        team2Id: team2Id,
        team1Name: team1.name,
        team1City: team1.city || '',
        team1Short: team1.short || '',
        team2Name: team2.name,
        team2City: team2.city || '',
        team2Short: team2.short || '',
        kit1Color: kit1ColorInput.value || '#2b2b2b',
        kit2Color: kit2ColorInput.value || '#2b2b2b',
        team1Logo: team1Logo,
        team2Logo: team2Logo
      };
      
      try {
        const response = await fetch(`/api/presets/${presetId}?token=${getToken()}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });
        
        if (response.ok) {
          // Сохраняем состояние видимости пресетов
          const presetsDiv = document.getElementById(`presets-${tournamentId}`);
          const wasHidden = presetsDiv ? presetsDiv.classList.contains('hidden') : false;
          
          await loadPresets();
          await loadTournaments(); // Обновляем только счетчик пресетов, НЕ изменяем команды
          
          // Очищаем uploadedLogos после сохранения, чтобы не влиять на следующее редактирование
          uploadedLogos.team1 = null;
          uploadedLogos.team2 = null;
          
          // Восстанавливаем состояние видимости
          if (presetsDiv) {
            if (wasHidden) {
              presetsDiv.classList.add('hidden');
              expandedPresets.delete(tournamentId);
            } else {
              presetsDiv.classList.remove('hidden');
              expandedPresets.add(tournamentId);
              renderTournamentPresets(); // Рендерим если видим
            }
          }
          
          showNotification('Пресет обновлен!', 'success');
        } else {
          throw new Error('Ошибка обновления пресета');
        }
      } catch (error) {
        console.error('Ошибка обновления пресета:', error);
        showNotification('Ошибка обновления пресета', 'error');
      }
    }
    
    // Отмена редактирования пресета inline
    function cancelEditPresetInline(tournamentId, presetId) {
      const presetWrapper = document.querySelector(`.preset-item-wrapper[data-preset-id="${presetId}"][data-tournament-id="${tournamentId}"]`);
      if (!presetWrapper) return;
      
      const presetItem = presetWrapper.querySelector('.preset-item');
      const editForm = presetWrapper.querySelector(`#preset-edit-form-${tournamentId}-${presetId}`);
      
      // Скрываем форму редактирования
      if (editForm) {
        editForm.classList.add('hidden');
        editForm.innerHTML = '';
      }
      
      // Показываем presetItem обратно
      if (presetItem) {
        presetItem.style.display = '';
        presetItem.classList.remove('edit-mode');
      }
    }

    // Подтверждение применения предустановки
    function confirmApplyPreset(presetId) {
      const preset = presets.find(p => p.id === presetId);
      if (!preset) return;
      
      // Создание модального окна подтверждения
      const modal = document.createElement('div');
      modal.className = 'confirmation-modal';
      modal.innerHTML = `
        <div class="confirmation-content">
          <h3>Применить предустановку?</h3>
          <p>Вы уверены, что хотите применить предустановку "<strong>${preset.name}</strong>"?</p>
          <p><small>Это заменит текущие данные команд.</small></p>
          <div class="confirmation-buttons">
            <button class="confirmation-btn confirm" onclick="applyPreset('${presetId}'); closeConfirmation()">Да, применить</button>
            <button class="confirmation-btn cancel" onclick="closeConfirmation()">Отмена</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    // Закрытие модального окна
    function closeConfirmation() {
      const modal = document.querySelector('.confirmation-modal');
      if (modal) {
        modal.remove();
      }
    }

    // Применение предустановки
    // Копирование логотипа из пресета в основную панель
    async function copyLogoFromPreset(team, presetLogoUrl) {
      if (!presetLogoUrl) return '';
      
      try {
        // Создаем уникальное имя файла с timestamp
        const timestamp = Date.now();
        const extension = presetLogoUrl.split('.').pop();
        const newFilename = `main_${team}_${timestamp}.${extension}`;
        
        // Копируем файл на сервере
        const response = await fetch(`/api/copy-logo?token=${getToken()}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceUrl: presetLogoUrl,
            newFilename: newFilename
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          return result.url;
        } else {
          console.error('Ошибка копирования логотипа:', await response.text());
          return presetLogoUrl; // Fallback к оригинальному URL
        }
      } catch (error) {
        console.error('Ошибка копирования логотипа:', error);
        return presetLogoUrl; // Fallback к оригинальному URL
      }
    }

    async function applyPreset(presetId) {
      const preset = presets.find(p => p.id === presetId);
      if (!preset) return;
      
      // Находим турнир и команды для получения актуальных логотипов
      let team1Logo = '';
      let team2Logo = '';
      
      if (preset.tournamentId) {
        const tournament = tournaments.find(t => t.id === preset.tournamentId);
        if (tournament && tournament.teams) {
          if (preset.team1Id) {
            const team1 = tournament.teams.find(t => t.id === preset.team1Id);
            if (team1 && team1.logo) {
              team1Logo = team1.logo;
            }
          }
          if (preset.team2Id) {
            const team2 = tournament.teams.find(t => t.id === preset.team2Id);
            if (team2 && team2.logo) {
              team2Logo = team2.logo;
            }
          }
        }
      }
      
      // Если не нашли в турнире, используем значения из пресета (для обратной совместимости)
      if (!team1Logo && preset.team1Logo) {
        team1Logo = preset.team1Logo;
      }
      if (!team2Logo && preset.team2Logo) {
        team2Logo = preset.team2Logo;
      }
      
      // Применение данных предустановки к основным полям
      document.getElementById('team1Name').value = preset.team1Name;
      document.getElementById('team1City').value = preset.team1City;
      document.getElementById('team1Short').value = preset.team1Short;
      document.getElementById('kit1Color').value = preset.kit1Color;
      
      document.getElementById('team2Name').value = preset.team2Name;
      document.getElementById('team2City').value = preset.team2City;
      document.getElementById('team2Short').value = preset.team2Short;
      document.getElementById('kit2Color').value = preset.kit2Color;
      
      // Копирование логотипов из турнира (создание уникальных копий для основной панели)
      // Это НЕ изменяет логотипы команд в турнире, только применяет их к панели
      if (team1Logo) {
        const copiedLogoUrl = await copyLogoFromPreset('team1', team1Logo);
        updateMainLogoMini('team1', copiedLogoUrl);
        state.team1Logo = copiedLogoUrl;
      } else {
        showKitColorCircle('team1');
        state.team1Logo = '';
      }
      
      if (team2Logo) {
        const copiedLogoUrl = await copyLogoFromPreset('team2', team2Logo);
        updateMainLogoMini('team2', copiedLogoUrl);
        state.team2Logo = copiedLogoUrl;
      } else {
        showKitColorCircle('team2');
        state.team2Logo = '';
      }
      
      // СРАЗУ отправляем полное состояние на сервер для сохранения
      // Это критично для сохранения данных при перезагрузке
      socket.emit('updateScoreboard', {
        team1Name: preset.team1Name || '',
        team1City: preset.team1City || '',
        team1Short: preset.team1Short || '',
        team2Name: preset.team2Name || '',
        team2City: preset.team2City || '',
        team2Short: preset.team2Short || '',
        kit1Color: preset.kit1Color || '#2b2b2b',
        kit2Color: preset.kit2Color || '#2b2b2b',
        team1Logo: state.team1Logo || '',
        team2Logo: state.team2Logo || ''
      });
      
      // Показ уведомления
      showNotification(`Применена предустановка: ${preset.name}`, 'success');
    }

    // Удаление предустановки
    async function deletePreset(presetId) {
      if (!confirm('Удалить эту предустановку?')) return;
      
      try {
        await fetch(`/api/presets/${presetId}?token=${getToken()}`, {
          method: 'DELETE'
        });
        // Пресеты привязаны к турнирам, не нужно перезагружать список
      } catch (error) {
        console.error('Ошибка удаления предустановки:', error);
      }
    }

    // Сохранение предустановки из формы внутри турнира
    async function saveNewPresetFromForm(buttonElement) {
      // Ищем форму - кнопка находится внутри form-buttons, который внутри формы
      let formContainer = buttonElement.closest('[id^="presetFormContent_"]');
      
      // Если не нашли через closest (кнопка может быть вне формы), ищем через родителя
      if (!formContainer) {
        const formButtons = buttonElement.closest('.form-buttons');
        if (formButtons) {
          formContainer = formButtons.closest('[id^="presetFormContent_"]');
        }
      }
      
      // Если все еще не нашли, ищем последнюю открытую форму
      if (!formContainer) {
        formContainer = document.querySelector('[id^="presetFormContent_"]:not(.hidden)');
      }
      
      if (!formContainer) {
        console.error('Form container not found', buttonElement);
        alert('Ошибка: форма не найдена');
        return;
      }
      
      console.log('Form container found:', formContainer.id, formContainer);
      
      // Ищем элементы формы - используем более точные селекторы
      const tournamentSelect = formContainer.querySelector('select.addPresetTournament');
      
      // Получаем tournamentId из селекта, data-атрибута или из ID формы
      let tournamentId = tournamentSelect?.value;
      
      // Если tournamentId пустой, пытаемся получить из data-атрибута формы
      if (!tournamentId || tournamentId.trim() === '') {
        tournamentId = formContainer.dataset.tournamentId;
      }
      
      // Если все еще пустой, пытаемся извлечь его из ID формы (presetFormContent_TOURNAMENT_ID)
      if (!tournamentId || tournamentId.trim() === '') {
        const formId = formContainer.id;
        const match = formId.match(/presetFormContent_(.+)/);
        if (match && match[1]) {
          tournamentId = match[1];
          console.log('Extracted tournament ID from form ID:', tournamentId);
        }
      }
      
      const team1Select = formContainer.querySelector('select.addPresetTeam1Select');
      const team2Select = formContainer.querySelector('select.addPresetTeam2Select');
      
      console.log('Found elements:', {
        tournamentSelect: !!tournamentSelect,
        tournamentId: tournamentId,
        formId: formContainer.id,
        team1Select: !!team1Select,
        team2Select: !!team2Select
      });
      
      // Проверяем наличие элементов
      if (!team1Select) {
        console.error('Team1 select not found', formContainer.innerHTML.substring(0, 500));
        alert('Ошибка: не найден селект команды 1');
        return;
      }
      
      if (!team2Select) {
        console.error('Team2 select not found', formContainer.innerHTML.substring(0, 500));
        alert('Ошибка: не найден селект команды 2');
        return;
      }
      
      if (!tournamentId || tournamentId.trim() === '') {
        console.error('Tournament ID is empty', { tournamentSelect, formId: formContainer.id });
        alert('Ошибка: не удалось определить турнир. Пожалуйста, закройте и откройте форму создания пресета заново.');
        return;
      }
      
      const team1Id = team1Select.value;
      const team2Id = team2Select.value;
      
      if (!team1Id || !team2Id) {
        alert('Выберите обе команды из турнира');
        return;
      }
      
      // Получаем данные команд из турнира
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) {
        alert('Турнир не найден');
        return;
      }
      
      const team1 = tournament.teams.find(t => t.id === team1Id);
      const team2 = tournament.teams.find(t => t.id === team2Id);
      
      if (!team1 || !team2) {
        alert('Команды не найдены');
        return;
      }
      
      // Формируем имя пресета автоматически
      const matchTime = formContainer.querySelector('.addPresetMatchTime')?.value || '19:00';
      const presetName = `${matchTime} / ${team1.name} - ${team2.name}`;
      
      // Получаем поля формы (если они заполнены, используем их, иначе данные команды)
      const team1NameInput = formContainer.querySelector('[id*="Team1Name"]');
      const team1CityInput = formContainer.querySelector('[id*="Team1City"]');
      const team1ShortInput = formContainer.querySelector('[id*="Team1Short"]');
      // Ищем поле цвета по классу (как в форме редактирования)
      const team1KitColorInput = formContainer.querySelector('.addPresetKit1Color');
      
      const team2NameInput = formContainer.querySelector('[id*="Team2Name"]');
      const team2CityInput = formContainer.querySelector('[id*="Team2City"]');
      const team2ShortInput = formContainer.querySelector('[id*="Team2Short"]');
      // Ищем поле цвета по классу (как в форме редактирования)
      const team2KitColorInput = formContainer.querySelector('.addPresetKit2Color');
      
      // Берем цвет из input или из команды (как в форме редактирования)
      const kit1Color = team1KitColorInput?.value || team1.kitColor || '#2b2b2b';
      const kit2Color = team2KitColorInput?.value || team2.kitColor || '#2b2b2b';
      
      const preset = {
        name: presetName,
        tournamentId: tournamentId,
        team1Id: team1Id,
        team2Id: team2Id,
        team1Name: (team1NameInput?.value.trim()) || team1.name,
        team1City: (team1CityInput?.value.trim()) || team1.city || '',
        team1Short: (team1ShortInput?.value.trim().toUpperCase()) || team1.short || '',
        team2Name: (team2NameInput?.value.trim()) || team2.name,
        team2City: (team2CityInput?.value.trim()) || team2.city || '',
        team2Short: (team2ShortInput?.value.trim().toUpperCase()) || team2.short || '',
        kit1Color: kit1Color,
        kit2Color: kit2Color,
        team1Logo: team1.logo || '',
        team2Logo: team2.logo || ''
      };
      
      // Валидация
      if (!preset.team1Name || !preset.team2Name) {
        alert('Названия команд обязательны');
        return;
      }
      
      try {
        const response = await fetch(`/api/presets?token=${getToken()}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });
        
        if (response.ok) {
          // Закрываем форму
          const formWrapper = formContainer.closest('[id^="presetForm_"]');
          if (formWrapper) {
            formWrapper.classList.add('hidden');
            formWrapper.innerHTML = '';
          }
          
          // Сохраняем состояние видимости пресетов
          const presetsDiv = document.getElementById(`presets-${tournamentId}`);
          const wasHidden = presetsDiv ? presetsDiv.classList.contains('hidden') : false;
          
          // Перезагружаем пресеты и турниры
          await loadPresets();
          await loadTournaments();
          
          // Восстанавливаем состояние видимости (по умолчанию пресеты видны)
          if (presetsDiv) {
            if (wasHidden) {
              presetsDiv.classList.add('hidden');
              expandedPresets.delete(tournamentId);
            } else {
              presetsDiv.classList.remove('hidden');
              expandedPresets.add(tournamentId);
              renderTournamentPresets(); // Рендерим если видим
            }
          }
          
          showNotification('Предустановка создана!', 'success');
        } else {
          throw new Error('Ошибка сохранения предустановки');
        }
      } catch (error) {
        console.error('Ошибка сохранения предустановки:', error);
        showNotification('Ошибка сохранения предустановки', 'error');
      }
    }
    
    // Отмена создания пресета из формы
    function cancelAddPresetFromForm(buttonElement) {
      const formContainer = buttonElement.closest('[id^="presetFormContent_"]');
      if (!formContainer) return;
      
      const formWrapper = formContainer.closest('[id^="presetForm_"]');
      if (formWrapper) {
        formWrapper.classList.add('hidden');
        formWrapper.innerHTML = '';
      }
    }
    
    // Сохранение предустановки (старая версия для совместимости)
    async function saveNewPreset() {
      if (!selectedTeams.team1 || !selectedTeams.team2) {
        alert('Выберите обе команды из турнира');
        return;
      }
      
      // Формируем имя пресета автоматически из времени и названий команд
      const matchTime = document.getElementById('addPresetMatchTime').value || '19:00';
      const presetName = `${matchTime} / ${selectedTeams.team1.name} - ${selectedTeams.team2.name}`;
      
      const preset = {
        name: presetName,
        team1Name: document.getElementById('addPresetTeam1Name').value.trim(),
        team1City: document.getElementById('addPresetTeam1City').value.trim(),
        team1Short: document.getElementById('addPresetTeam1Short').value.trim().toUpperCase(),
        team2Name: document.getElementById('addPresetTeam2Name').value.trim(),
        team2City: document.getElementById('addPresetTeam2City').value.trim(),
        team2Short: document.getElementById('addPresetTeam2Short').value.trim().toUpperCase(),
        kit1Color: document.getElementById('addPresetKit1Color').value,
        kit2Color: document.getElementById('addPresetKit2Color').value,
        team1Logo: uploadedLogos.team1 || '',
        team2Logo: uploadedLogos.team2 || ''
      };

      // Валидация
      if (!preset.team1Name || !preset.team2Name) {
        alert('Названия команд обязательны');
        return;
      }

      try {
        const response = await fetch(`/api/presets?token=${getToken()}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });

        if (!response.ok) {
          throw new Error('Ошибка сохранения предустановки');
        }

        // Очистка формы
        document.getElementById('addPresetForm').querySelectorAll('input').forEach(input => {
          if (input.type === 'text') input.value = '';
          if (input.type === 'color') {
            if (input.id.includes('Kit1')) input.value = '#2b2b2b';
            if (input.id.includes('Kit2')) input.value = '#2b2b2b';
          }
        });
        
        // Очистка логотипов
        uploadedLogos = { team1: null, team2: null };
        document.getElementById('addPresetTeam1LogoPreview').innerHTML = '';
        document.getElementById('addPresetTeam2LogoPreview').innerHTML = '';
        
        // Скрытие формы
        document.getElementById('addPresetForm').classList.add('hidden');
        
        // Перезагрузка предустановок
        // Пресеты привязаны к турнирам, не нужно перезагружать список
        // Но загружаем для редактирования если нужно
        await loadPresets();
        
        // Показ уведомления об успехе
        showNotification('Предустановка создана!', 'success');
        
      } catch (error) {
        console.error('Ошибка сохранения предустановки:', error);
        showNotification('Ошибка сохранения предустановки', 'error');
      }
    }

    async function savePreset() {
      const preset = {
        name: document.getElementById('presetName').value.trim(),
        team1Name: document.getElementById('presetTeam1Name').value.trim(),
        team1City: document.getElementById('presetTeam1City').value.trim(),
        team1Short: document.getElementById('presetTeam1Short').value.trim().toUpperCase(),
        team2Name: document.getElementById('presetTeam2Name').value.trim(),
        team2City: document.getElementById('presetTeam2City').value.trim(),
        team2Short: document.getElementById('presetTeam2Short').value.trim().toUpperCase(),
        kit1Color: document.getElementById('presetKit1Color').value,
        kit2Color: document.getElementById('presetKit2Color').value
      };

      // Валидация
      if (!preset.name) {
        alert('Введите название матча');
        return;
      }
      
      if (!preset.team1Name || !preset.team2Name) {
        alert('Введите названия обеих команд');
        return;
      }

      try {
        const response = await fetch(`/api/presets?token=${getToken()}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });
        
        if (!response.ok) {
          throw new Error('Ошибка сохранения предустановки');
        }
        
        // Очистка формы
        document.getElementById('addPresetForm').querySelectorAll('input').forEach(input => {
          if (input.type === 'text') input.value = '';
          if (input.type === 'color') {
            if (input.id.includes('Kit1')) input.value = '#2b2b2b';
            if (input.id.includes('Kit2')) input.value = '#2b2b2b';
          }
        });
        
        // Скрытие формы
        toggleAddPresetForm();
        
        // Перезагрузка предустановок
        // Пресеты привязаны к турнирам, не нужно перезагружать список
        // Но загружаем для редактирования если нужно
        await loadPresets();
        
        // Показ уведомления об успехе
        showNotification('Предустановка сохранена!', 'success');
        
      } catch (error) {
        console.error('Ошибка сохранения предустановки:', error);
        showNotification('Ошибка сохранения предустановки', 'error');
      }
    }

    
    function cancelAddPreset() {
      // Очистка формы
      document.getElementById('addPresetForm').querySelectorAll('input').forEach(input => {
        if (input.type === 'text') input.value = '';
        if (input.type === 'color') {
          if (input.id.includes('Kit1')) input.value = '#2b2b2b';
          if (input.id.includes('Kit2')) input.value = '#2b2b2b';
        }
      });
      
      // Очистка селектов
      const select = document.getElementById('addPresetTournament');
      if (select) {
        select.value = '';
      }
      
      // Сброс времени и имени
      document.getElementById('addPresetMatchTime').value = '19:00';
      selectedTeams = { team1: null, team2: null };
      document.getElementById('addPresetTitle').textContent = '19:00 / Команда 1 - Команда 2';
      
      document.getElementById('addPresetTeam1Select').innerHTML = '<option value="">-- Выберите команду --</option>';
      document.getElementById('addPresetTeam2Select').innerHTML = '<option value="">-- Выберите команду --</option>';
      
      // Очистка логотипов
      uploadedLogos = { team1: null, team2: null };
      selectedTeams = { team1: null, team2: null };
      document.getElementById('addPresetTeam1LogoPreview').innerHTML = '';
      document.getElementById('addPresetTeam2LogoPreview').innerHTML = '';
      
      // Скрытие деталей команд
      hideTeam1Details();
      hideTeam2Details();
      
      // Скрытие формы
      document.getElementById('addPresetForm').classList.add('hidden');
    }
    
    // Редактирование предустановки
    function editPreset(presetId) {
      const preset = presets.find(p => p.id === presetId);
      if (!preset) return;
      
      editingPresetId = presetId;
      
      // Сохраняем исходные данные для сравнения
      originalPresetData = {
        name: preset.name,
        team1Name: preset.team1Name,
        team1City: preset.team1City,
        team1Short: preset.team1Short,
        kit1Color: preset.kit1Color,
        team2Name: preset.team2Name,
        team2City: preset.team2City,
        team2Short: preset.team2Short,
        kit2Color: preset.kit2Color
      };
      
      // Заполняем форму редактирования
      document.getElementById('editPresetTitle').textContent = preset.name;
      document.getElementById('editPresetTeam1Name').value = preset.team1Name;
      document.getElementById('editPresetTeam1City').value = preset.team1City;
      document.getElementById('editPresetTeam1Short').value = preset.team1Short;
      document.getElementById('editPresetKit1Color').value = preset.kit1Color;
      document.getElementById('editPresetTeam2Name').value = preset.team2Name;
      document.getElementById('editPresetTeam2City').value = preset.team2City;
      document.getElementById('editPresetTeam2Short').value = preset.team2Short;
      document.getElementById('editPresetKit2Color').value = preset.kit2Color;
      
      // Загружаем логотипы если есть
      if (preset.team1Logo) {
        showLogoPreview('team1', preset.team1Logo);
        updateLogoMini('team1', preset.team1Logo);
        uploadedLogos.team1 = preset.team1Logo;
        console.log('Loaded team1 logo:', preset.team1Logo);
      } else {
        clearLogo('team1');
        updateLogoMini('team1', null);
        uploadedLogos.team1 = null;
      }
      
      if (preset.team2Logo) {
        showLogoPreview('team2', preset.team2Logo);
        updateLogoMini('team2', preset.team2Logo);
        uploadedLogos.team2 = preset.team2Logo;
        console.log('Loaded team2 logo:', preset.team2Logo);
      } else {
        clearLogo('team2');
        updateLogoMini('team2', null);
        uploadedLogos.team2 = null;
      }
      
      // Скрываем карточку пресета и показываем форму редактирования на ее месте
      const presetCard = document.querySelector(`[data-preset-id="${presetId}"]`);
      if (presetCard) {
        presetCard.style.display = 'none';
        const editForm = document.getElementById('editPresetForm');
        
        // Полностью сбрасываем форму перед перемещением
        const presetsSection = document.querySelector('.presets-section');
        
        // Если форма не в правильном месте, принудительно перемещаем
        if (editForm.parentNode && editForm.parentNode !== presetsSection) {
          editForm.parentNode.removeChild(editForm);
          presetsSection.appendChild(editForm);
        }
        
        // Сбрасываем все стили формы
        editForm.style.position = '';
        editForm.style.top = '';
        editForm.style.left = '';
        editForm.style.display = 'block';
        editForm.classList.remove('hidden');
        
        // Вставляем форму после карточки пресета
        presetCard.parentNode.insertBefore(editForm, presetCard.nextSibling);
      }
    }
    
    // Обновление предустановки
    async function updatePreset() {
      if (!editingPresetId) return;
      
      const preset = {
        name: document.getElementById('editPresetTitle').textContent.trim(),
        team1Name: document.getElementById('editPresetTeam1Name').value.trim(),
        team1City: document.getElementById('editPresetTeam1City').value.trim(),
        team1Short: document.getElementById('editPresetTeam1Short').value.trim().toUpperCase(),
        team2Name: document.getElementById('editPresetTeam2Name').value.trim(),
        team2City: document.getElementById('editPresetTeam2City').value.trim(),
        team2Short: document.getElementById('editPresetTeam2Short').value.trim().toUpperCase(),
        kit1Color: document.getElementById('editPresetKit1Color').value,
        kit2Color: document.getElementById('editPresetKit2Color').value,
        team1Logo: uploadedLogos.team1 || '',
        team2Logo: uploadedLogos.team2 || ''
      };
      
      console.log('Saving preset with logos:', {
        team1Logo: preset.team1Logo,
        team2Logo: preset.team2Logo,
        uploadedLogos: uploadedLogos
      });

      // Валидация
      if (!preset.name) {
        alert('Введите название матча');
        return;
      }
      
      if (!preset.team1Name || !preset.team2Name) {
        alert('Введите названия обеих команд');
        return;
      }

      try {
        const response = await fetch(`/api/presets/${editingPresetId}?token=${getToken()}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });
        
        if (!response.ok) {
          throw new Error('Ошибка обновления предустановки');
        }
        
        // Скрытие формы
        cancelEditPreset();
        
        // Перезагрузка предустановок
        // Пресеты привязаны к турнирам, не нужно перезагружать список
        // Но загружаем для редактирования если нужно
        await loadPresets();
        
        // Показ уведомления об успехе
        showNotification('Предустановка обновлена!', 'success');
        
      } catch (error) {
        console.error('Ошибка обновления предустановки:', error);
        showNotification('Ошибка обновления предустановки', 'error');
      }
    }
    
    // Отмена редактирования
    function cancelEditPreset() {
      console.log('Отмена редактирования пресета:', editingPresetId);
      editingPresetId = null;
      originalPresetData = null;
      
      // Восстанавливаем все карточки пресетов
      const presetCards = document.querySelectorAll('.preset-card');
      presetCards.forEach(card => {
        card.style.display = '';
      });
      
      // Полностью сбрасываем форму редактирования
      const editForm = document.getElementById('editPresetForm');
      const presetsSection = document.querySelector('.presets-section');
      
      // Принудительно перемещаем форму в конец секции пресетов
      if (editForm.parentNode) {
        editForm.parentNode.removeChild(editForm);
      }
      presetsSection.appendChild(editForm);
      
      // Скрываем форму
      editForm.classList.add('hidden');
      editForm.style.display = 'none';
      
      // Сбрасываем все состояния формы
      editForm.style.position = '';
      editForm.style.top = '';
      editForm.style.left = '';
    }
    
    // Удаление предустановки из формы редактирования
    async function deletePresetFromEdit() {
      if (!editingPresetId) return;
      
      if (!confirm('Удалить эту предустановку? Это действие нельзя отменить.')) return;
      
      try {
        const response = await fetch(`/api/presets/${editingPresetId}?token=${getToken()}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          throw new Error('Ошибка удаления предустановки');
        }
        
        // Скрытие формы
        cancelEditPreset();
        
        // Перезагрузка предустановок
        // Пресеты привязаны к турнирам, не нужно перезагружать список
        // Но загружаем для редактирования если нужно
        await loadPresets();
        
        // Показ уведомления об успехе
        showNotification('Предустановка удалена! Логотипы, используемые в активной секции, защищены от удаления.', 'success');
        
      } catch (error) {
        console.error('Ошибка удаления предустановки:', error);
        showNotification('Ошибка удаления предустановки', 'error');
      }
    }

    // Автогенерация шорткодов
    function autoShortName(fullId, shortId, def) {
      const fullInput = document.getElementById(fullId);
      const shortInput = document.getElementById(shortId);
      let manual = false;

      function updateShort() {
        if (!manual) {
          shortInput.value = (fullInput.value || def).toUpperCase().slice(0,3);
        }
      }
      fullInput.addEventListener('input', updateShort);
      shortInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/[^A-ZА-ЯЁ0-9]/gi, '').slice(0,3);
        manual = true;
      });
      updateShort();
    }

    // Обновление UI при получении данных (синхронизация с сервером)
    // Срабатывает при подключении (загрузка состояния) и при изменениях от других клиентов
    socket.on('scoreboardUpdate', (data) => {
      console.log('Received scoreboardUpdate from server:', data);
      ready = false;
      
      // Обновление таймера (работает корректно, используем как эталон)
      const isRunning = !!data.timerRunning;
      timerRunning = isRunning;
      window.timerRunning = isRunning; // Сохраняем в window для доступа из onclick
      setPlayPauseIcon('playPauseIcon', isRunning);
      setTimeInputFromSeconds('timeInput', data.timerSeconds || 0);
      document.getElementById('timeInput').disabled = isRunning;
      
      // Показ/скрытие предупреждения о таймере
      const warning = document.getElementById('timerWarning');
      if (isRunning) {
        warning.classList.remove('hidden');
      } else {
        warning.classList.add('hidden');
      }
      
      // Блокировка только основных полей ввода команд во время работы таймера
      // (не блокируем поля в форме редактирования пресетов и кнопки счета)
      const fieldsToDisable = [
        'team1Name', 'team1City', 'team1Short', 'kit1Color',
        'team2Name', 'team2City', 'team2Short', 'kit2Color'
      ];
      
      fieldsToDisable.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && !field.closest('.edit-preset-form')) { // Исключаем поля в форме редактирования
          if (isRunning) {
            field.classList.add('disabled-field');
            field.disabled = true; // Дополнительная блокировка
          } else {
            field.classList.remove('disabled-field');
            field.disabled = false;
          }
        }
      });
      
      // КНОПКИ СЧЕТА НЕ БЛОКИРУЕМ - они всегда доступны (только с подтверждением при таймере)
      const scoreButtons = ['score1Inc', 'score1Dec', 'score2Inc', 'score2Dec'];
      scoreButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.classList.remove('disabled-field');
          btn.disabled = false;
          btn.style.pointerEvents = 'auto';
          btn.style.cursor = 'pointer';
          btn.style.opacity = '1';
        }
      });
      
      // Кнопка добавления предустановки всегда доступна
      const addBtn = document.getElementById('addPresetBtn');
      addBtn.disabled = false;
      addBtn.textContent = '+ Добавить предустановку';
      
      // Убеждаемся, что форма редактирования остается доступной
      const editForm = document.getElementById('editPresetForm');
      if (editForm) {
        // Проверяем, была ли форма редактирования открыта
        const wasEditFormOpen = !editForm.classList.contains('hidden') && editForm.style.display !== 'none';
        
        console.log('Состояние формы редактирования:', {
          wasOpen: wasEditFormOpen,
          editingPresetId: editingPresetId,
          isRunning: isRunning,
          formHidden: editForm.classList.contains('hidden'),
          formDisplay: editForm.style.display
        });
        
        if (wasEditFormOpen && editingPresetId) {
          // Восстанавливаем форму редактирования
          editForm.style.display = 'block';
          editForm.classList.remove('hidden');
          
          // Убеждаемся, что карточка пресета скрыта
          const presetCard = document.querySelector(`[data-preset-id="${editingPresetId}"]`);
          if (presetCard) {
            presetCard.style.display = 'none';
          }
          
          console.log('Восстановлена форма редактирования для пресета:', editingPresetId);
        }
      }
      
      // Блокировка символов применения предустановок
      const applySymbols = document.querySelectorAll('.preset-apply-symbol');
      applySymbols.forEach(symbol => {
        if (isRunning) {
          symbol.style.opacity = '0.5';
          symbol.style.cursor = 'not-allowed';
          symbol.style.pointerEvents = 'none';
          symbol.title = 'Нельзя применять предустановки во время работы таймера';
        } else {
          symbol.style.opacity = '';
          symbol.style.cursor = '';
          symbol.style.pointerEvents = '';
          symbol.title = 'Применить предустановку';
        }
      });
      
      // Обновление счета (ВСЕГДА из сервера, как таймер)
      // Счет должен сохраняться и синхронизироваться между устройствами
      const score1ValueEl = document.getElementById('score1Value');
      const score2ValueEl = document.getElementById('score2Value');
      if (score1ValueEl) {
        score1ValueEl.textContent = (data.score1 !== undefined && data.score1 !== null) ? data.score1 : 0;
      }
      if (score2ValueEl) {
        score2ValueEl.textContent = (data.score2 !== undefined && data.score2 !== null) ? data.score2 : 0;
      }
      
      // Обновление команд (ВСЕГДА из сервера, как таймер)
      // Все поля должны сохраняться и синхронизироваться между устройствами
      const team1NameEl = document.getElementById('team1Name');
      const team1CityEl = document.getElementById('team1City');
      const team1ShortEl = document.getElementById('team1Short');
      const team2NameEl = document.getElementById('team2Name');
      const team2CityEl = document.getElementById('team2City');
      const team2ShortEl = document.getElementById('team2Short');
      const kit1ColorEl = document.getElementById('kit1Color');
      const kit2ColorEl = document.getElementById('kit2Color');
      
      // Обновляем ВСЕ поля из данных сервера (даже если пустые строки)
      // Это гарантирует синхронизацию между устройствами и восстановление при перезагрузке
      if (team1NameEl) {
        team1NameEl.value = (data.team1Name !== undefined) ? (data.team1Name || "") : "";
      }
      if (team2NameEl) {
        team2NameEl.value = (data.team2Name !== undefined) ? (data.team2Name || "") : "";
      }
      if (team1CityEl) {
        team1CityEl.value = (data.team1City !== undefined) ? (data.team1City || "") : "";
      }
      if (team2CityEl) {
        team2CityEl.value = (data.team2City !== undefined) ? (data.team2City || "") : "";
      }
      if (team1ShortEl) {
        team1ShortEl.value = (data.team1Short !== undefined) ? (data.team1Short || "") : "";
      }
      if (team2ShortEl) {
        team2ShortEl.value = (data.team2Short !== undefined) ? (data.team2Short || "") : "";
      }
      if (kit1ColorEl) {
        kit1ColorEl.value = (data.kit1Color !== undefined) ? (data.kit1Color || "#2b2b2b") : "#2b2b2b";
      }
      if (kit2ColorEl) {
        kit2ColorEl.value = (data.kit2Color !== undefined) ? (data.kit2Color || "#2b2b2b") : "#2b2b2b";
      }
      
      // Обновление логотипов (ВСЕГДА из сервера, как таймер)
      // Логотипы должны сохраняться и синхронизироваться между устройствами
      if (data.team1Logo !== undefined) {
        state.team1Logo = data.team1Logo || '';
        if (data.team1Logo && data.team1Logo.trim() !== '') {
          updateMainLogoMini('team1', data.team1Logo);
        } else {
          showKitColorCircle('team1');
        }
      }
      
      if (data.team2Logo !== undefined) {
        state.team2Logo = data.team2Logo || '';
        if (data.team2Logo && data.team2Logo.trim() !== '') {
          updateMainLogoMini('team2', data.team2Logo);
        } else {
          showKitColorCircle('team2');
        }
      }
      
      // Перерисовка предустановок с учетом состояния таймера
      // НЕ перерендериваем если открыта форма редактирования
      if (!editingPresetId) {
        renderTournamentPresets();
      } else {
        console.log('Пропускаем перерендеринг пресетов - открыта форма редактирования');
      }
      
      // Восстанавливаем ready для возможности дальнейших изменений
      // Важно: делаем это после всех обновлений UI
      setTimeout(() => { 
        ready = true;
        console.log('State loaded and ready for user input. Current state:', {
          score1: data.score1,
          score2: data.score2,
          team1Name: data.team1Name,
          team2Name: data.team2Name,
          team1Logo: data.team1Logo ? 'has logo' : 'no logo',
          team2Logo: data.team2Logo ? 'has logo' : 'no logo'
        });
      }, 100);
    });

    // Вспомогательные функции
    function setPlayPauseIcon(iconId, isPlaying) {
      const icon = document.getElementById(iconId);
      icon.innerHTML = isPlaying
        ? `<rect x="8" y="6" width="5" height="20" fill="white"/><rect x="19" y="6" width="5" height="20" fill="white"/>`
        : `<polygon points="8,6 26,16 8,26" fill="white"/>`;
    }

    function setTimeInputFromSeconds(inputId, sec) {
      const input = document.getElementById(inputId);
      const mm = Math.floor(sec/60).toString().padStart(2, '0');
      const ss = (sec%60).toString().padStart(2, '0');
      input.value = `${mm}:${ss}`;
    }

    function getSecondsFromTimeInput(inputId) {
      const val = document.getElementById(inputId).value;
      if (/^\d{2}:\d{2}$/.test(val)) {
        const [mm, ss] = val.split(':').map(Number);
        return mm*60 + ss;
      }
      return 0;
    }

    function getToken() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token') || 'MySecret111';
    }
    
    // Функция показа уведомлений
    function showNotification(message, type = 'info') {
      // Создание элемента уведомления
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
        color: white;
        padding: 12px 20px;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 10000;
        font-size: 14px;
        max-width: 300px;
        animation: slideIn 0.3s ease-out;
      `;
      notification.textContent = message;
      
      // Добавление стилей анимации
      if (!document.getElementById('notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
          @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(notification);
      
      // Автоматическое удаление через 3 секунды
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }
  </script>
  
  <!-- Ссылка на настройки -->
  <div style="text-align: center; margin-top: 40px; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <a id="settingsLink" href="#" style="color: #338af3; text-decoration: none; font-size: 16px; font-weight: bold;">
      ⚙️ Настройки турниров
    </a>
  </div>
  
  <script>
    // Устанавливаем ссылку на настройки с токеном
    document.addEventListener('DOMContentLoaded', function() {
      const settingsLink = document.getElementById('settingsLink');
      if (settingsLink) {
        settingsLink.href = `/private/settings.html?token=${getToken()}`;
      }
    });
  </script>
</body>
</html>
</html>