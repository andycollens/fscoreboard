<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>FSCOREBOARD Control Panel</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 800px; 
      margin: 20px auto; 
      background: #f4f4f4; 
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .presets-section {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 1px solid #ddd;
    }
    
    .presets-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .presets-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .preset-card {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .preset-card:hover {
      border-color: #338af3;
      background: #f8f9ff;
    }
    
    .preset-name {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 10px;
      color: #333;
    }
    
    .preset-teams {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .preset-team {
      text-align: center;
      flex: 1;
    }
    
    .preset-team-name {
      font-weight: bold;
      color: #338af3;
    }
    
    .preset-team-city {
      font-size: 12px;
      color: #666;
    }
    
    .preset-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .btn-primary {
      background: #338af3;
      color: white;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn:hover {
      opacity: 0.8;
    }
    
    .add-preset-form {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .form-group {
      flex: 1;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .form-group input[type="color"] {
      width: 60px;
      height: 40px;
      padding: 0;
    }
    
    .camera-content {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 1px solid #ddd;
    }
    
    .timer-row { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 16px; 
      margin: 20px 0; 
    }
    
    .playpause-btn, .set-btn {
      width: 56px; 
      height: 44px;
      background: #338af3; 
      color: #fff; 
      border: none; 
      border-radius: 8px;
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-size: 2em; 
      cursor: pointer; 
      transition: background 0.2s;
    }
    
    .playpause-btn:hover, .set-btn:hover { 
      background: #2561a7; 
    }
    
    .timer-inputs {
      display: flex; 
      align-items: center; 
      gap: 8px;
      background: #fff; 
      border-radius: 8px; 
      padding: 8px 12px;
      border: 1px solid #ccc;
    }
    
    .timer-inputs input[type="text"] {
      width: 80px; 
      font-size: 1.2em; 
      text-align: center; 
      border: none; 
      background: none; 
      outline: none;
      letter-spacing: 2px;
    }
    
    .score-row { 
      display: flex; 
      justify-content: center; 
      gap: 30px; 
      margin-top: 20px; 
    }
    
    .score-block { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      padding: 0; 
      min-width: 120px; 
    }
    
    .score-controls { 
      display: flex; 
      gap: 10px; 
      margin-bottom: 8px; 
    }
    
    .score-btn {
      background: #338af3; 
      color: #fff; 
      border: none; 
      border-radius: 8px;
      width: 44px; 
      height: 44px; 
      font-size: 1.4em; 
      font-weight: bold; 
      cursor: pointer;
      display: flex; 
      align-items: center; 
      justify-content: center;
    }
    
    .score-btn:hover { 
      background: #2561a7; 
    }
    
    .score-value { 
      font-size: 2em; 
      color: #338af3; 
      min-width: 32px; 
      text-align: center; 
    }
    
    .short-label-row { 
      margin-top: 6px; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
    }
    
    .short-label-row input[type="text"] {
      width: 50px; 
      text-align: center; 
      font-size: 1.2em; 
      border-radius: 8px; 
      border: 1px solid #ccc; 
      padding: 4px 0;
      background: #fff; 
      text-transform: uppercase; 
      font-weight: bold; 
      letter-spacing: 2px;
    }
    
    .kit-block { 
      display: flex; 
      flex-direction: row; 
      align-items: center; 
      justify-content: center; 
      gap: 0; 
      width: 120px; 
    }
    
    .kit-color {
      width: 100px; 
      height: 32px; 
      border-radius: 4px; 
      border: 1px solid #ccc;
      background: none; 
      margin: 0; 
      padding: 0; 
      cursor: pointer; 
      display: block;
    }
    
    .label-caption {
      font-size: 0.85em; 
      color: #888; 
      margin-bottom: 2px; 
      text-align: center; 
      font-weight: normal; 
      letter-spacing: 1px;
    }
    
    .team-input-row { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      width: 100%; 
      gap: 4px; 
      margin-top: 6px; 
    }
    
    .team-input-row input[type="text"] {
      width: 100%;
      text-align: center; 
      font-size: 1em; 
      border-radius: 8px; 
      border: 1px solid #ccc; 
      padding: 4px 0;
      background: #fff; 
      color: #338af3; 
      font-weight: bold; 
    }
    
    .city-input-row input[type="text"] {
      width: 100%;
      text-align: center; 
      font-size: 1em; 
      border-radius: 8px; 
      border: 1px solid #ccc; 
      padding: 4px 0;
      background: #fff; 
      color: #888; 
      font-weight: normal;
    }
    
    .divider { 
      width: 2px; 
      background: #ccc; 
      margin: 0 10px; 
    }
    
    .hidden {
      display: none;
    }
    
    .version-info {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 0.6em;
      color: #ccc;
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 6px;
      border-radius: 3px;
      opacity: 0.7;
      z-index: 1000;
    }
    
    .preset-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 8px;
      transition: all 0.2s;
      box-sizing: border-box;
      width: 100%;
      max-width: 100%;
    }
    
    .preset-card:hover {
      background: #f8f9fa;
    }
    
    .preset-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }
    
    .preset-left {
      display: flex;
      align-items: flex-start;
      min-width: 0;
      overflow: hidden;
      flex-direction: column;
      gap: 8px;
    }
    
    .preset-name {
      font-weight: bold;
      font-size: 14px;
      margin-right: 0;
      white-space: nowrap;
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 4px;
      align-self: flex-start;
    }
    
    .preset-teams {
      display: flex;
      align-items: center;
      gap: 4px;
      min-width: 0;
      align-self: flex-start;
    }
    
    .preset-right {
      display: flex;
      align-items: flex-start;
      gap: 24px;
      flex-shrink: 0;
      align-self: flex-start;
    }
    
    .preset-team-name {
      font-size: 14px;
      white-space: nowrap;
    }
    
    .preset-separator {
      font-size: 14px;
      color: #666;
      margin: 0 2px;
    }
    
    .preset-kit-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      border: 1px solid #ccc;
      display: inline-block;
      flex-shrink: 0;
    }
    
    .preset-edit-link {
      color: #999;
      text-decoration: underline;
      text-decoration-style: dashed;
      cursor: pointer;
      font-size: 12px;
      margin-left: 16px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .preset-edit-link:hover {
      color: #666;
    }
    
    .preset-play-btn {
      background: none;
      border: none;
      color: #28a745;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      padding: 4px 8px;
      flex-shrink: 0;
    }
    
    .preset-play-btn:hover {
      color: #218838;
    }
    
    .preset-play-btn:disabled {
      color: #ccc;
      cursor: not-allowed;
    }
    
    .confirmation-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    
    .confirmation-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      text-align: center;
    }
    
    .confirmation-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 16px;
    }
    
    .confirmation-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .confirmation-btn.confirm {
      background: #28a745;
      color: white;
    }
    
    .confirmation-btn.confirm:hover {
      background: #218838;
    }
    
    .confirmation-btn.cancel {
      background: #6c757d;
      color: white;
    }
    
    .confirmation-btn.cancel:hover {
      background: #5a6268;
    }
    
    /* Мобильная адаптивность */
    @media (max-width: 768px) {
      body {
        font-size: 16px;
        padding: 10px;
      }
      
      .camera-content {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .timer-row {
        flex-direction: row;
        gap: 12px;
        margin: 15px 0;
        justify-content: center;
        align-items: center;
      }
      
      .playpause-btn, .set-btn {
        width: 60px;
        height: 50px;
        font-size: 16px;
      }
      
      .timer-inputs input {
        font-size: 18px;
        padding: 8px 12px;
        width: 80px;
        text-align: center;
      }
      
      .score-row {
        flex-direction: row;
        gap: 20px;
        justify-content: space-between;
      }
      
      .score-block {
        width: 48%;
        max-width: none;
      }
      
      .score-controls {
        justify-content: center;
        margin-bottom: 10px;
      }
      
      .score-btn {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }
      
      .score-value {
        font-size: 28px;
        margin: 0 15px;
      }
      
      .short-label-row {
        justify-content: center;
        margin-bottom: 10px;
      }
      
      .short-label-row input {
        font-size: 16px;
        padding: 6px 10px;
        width: 70px;
        text-align: center;
      }
      
      .kit-block {
        justify-content: center;
        margin-bottom: 10px;
      }
      
      .kit-color {
        width: 35px;
        height: 35px;
      }
      
      .team-input-row {
        margin-bottom: 10px;
      }
      
      .team-input-row input {
        font-size: 14px;
        padding: 8px 10px;
      }
      
      .presets-section {
        padding: 15px;
      }
      
      .presets-header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
      }
      
      .presets-header h2 {
        text-align: center;
        margin-bottom: 0;
      }
      
      .btn {
        font-size: 16px;
        padding: 12px 20px;
        width: 100%;
      }
      
      .preset-card {
        padding: 15px;
        margin-bottom: 10px;
        flex-direction: row;
        align-items: flex-start;
        justify-content: space-between;
      }
      
      .preset-content {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
      }
      
      .preset-left {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        flex: 1;
      }
      
      .preset-name {
        font-size: 16px;
        margin-right: 0;
        padding: 4px 8px;
        align-self: flex-start;
      }
      
      .preset-teams {
        width: 100%;
        justify-content: flex-start;
        align-self: flex-start;
      }
      
      .preset-team-name {
        font-size: 16px;
      }
      
      .preset-kit-color {
        width: 16px;
        height: 16px;
      }
      
      .preset-separator {
        font-size: 16px;
        margin: 0 4px;
      }
      
      .preset-right {
        align-self: flex-start;
        margin-top: 0;
        flex-shrink: 0;
      }
      
      .preset-edit-link {
        font-size: 14px;
        margin-left: 0;
      }
      
      .preset-play-btn {
        font-size: 18px;
        padding: 6px 10px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 15px;
        width: 100%;
        box-sizing: border-box;
      }
      
      .form-group {
        width: 100%;
        box-sizing: border-box;
      }
      
      .form-group input {
        font-size: 16px;
        padding: 10px 12px;
        width: 100%;
        box-sizing: border-box;
        max-width: 100%;
      }
      
      .form-group label {
        font-size: 14px;
        margin-bottom: 5px;
        display: block;
        width: 100%;
        box-sizing: border-box;
      }
      
      .edit-preset-form {
        padding: 15px;
        margin: 15px 0;
        box-sizing: border-box;
        width: 100%;
        max-width: 100%;
      }
      
      .team-divider {
        margin: 15px 0;
      }
    }
    
    .timer-running-warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: bold;
    }
    
    .disabled-field {
      opacity: 0.6;
      pointer-events: none;
      background-color: #f8f9fa !important;
    }
    
    .preset-card.editable {
      cursor: pointer;
      border-style: dashed;
    }
    
    .preset-card.editable:hover {
      border-color: #007bff;
      background: #f8f9ff;
    }
    
    .edit-preset-form {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .edit-preset-form .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .edit-preset-form .form-group {
      flex: 1;
      min-width: 200px;
    }
    
    .edit-preset-form .form-group input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .edit-preset-form .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
      font-size: 13px;
    }
    
    .edit-preset-form h3 {
      color: #1976d2;
      margin-top: 0;
    }
    
    .team-divider {
      height: 2px;
      background: #ddd;
      margin: 20px 0;
      border-radius: 1px;
    }
  </style>
</head>
<body>
  <!-- Версия в углу -->
  <div class="version-info">v1.0.0</div>

  <!-- Управление табло -->
  <div class="camera-content">
    <div class="timer-row">
      <button id="playPauseBtn" class="playpause-btn" title="Пуск/Пауза">
        <svg id="playPauseIcon" width="32" height="32" viewBox="0 0 32 32" fill="none">
          <polygon id="playIcon" points="8,6 26,16 8,26" fill="white"/>
        </svg>
      </button>
      <div class="timer-inputs">
        <input type="text" id="timeInput" maxlength="5" placeholder="MM:SS" pattern="^\d{2}:\d{2}$" value="00:00" autocomplete="off" />
      </div>
      <button id="setBtn" class="set-btn">Set</button>
    </div>
    <form id="controlForm" autocomplete="off" spellcheck="false">
      <div class="score-row">
        <div class="score-block">
          <div class="score-controls">
            <button type="button" class="score-btn" id="score1Dec">-</button>
            <span class="score-value" id="score1Value">0</span>
            <button type="button" class="score-btn" id="score1Inc">+</button>
          </div>
          <div class="short-label-row">
            <input type="text" id="team1Short" maxlength="3" placeholder="ХОЗ" />
          </div>
          <div class="kit-block">
            <input type="color" id="kit1Color" value="#2b2b2b" class="kit-color">
          </div>
          <div class="team-input-row">
            <span class="label-caption">Название команды</span>
            <input type="text" id="team1Name" maxlength="40" placeholder="Не введено" />
          </div>
          <div class="city-input-row team-input-row">
            <span class="label-caption">Город</span>
            <input type="text" id="team1City" maxlength="30" placeholder="Не введено" />
          </div>
        </div>
        <div class="divider"></div>
        <div class="score-block">
          <div class="score-controls">
            <button type="button" class="score-btn" id="score2Dec">-</button>
            <span class="score-value" id="score2Value">0</span>
            <button type="button" class="score-btn" id="score2Inc">+</button>
          </div>
          <div class="short-label-row">
            <input type="text" id="team2Short" maxlength="3" placeholder="ГОС" />
          </div>
          <div class="kit-block">
            <input type="color" id="kit2Color" value="#2b2b2b" class="kit-color">
          </div>
          <div class="team-input-row">
            <span class="label-caption">Название команды</span>
            <input type="text" id="team2Name" maxlength="40" placeholder="Не введено" />
          </div>
          <div class="city-input-row team-input-row">
            <span class="label-caption">Город</span>
            <input type="text" id="team2City" maxlength="30" placeholder="Не введено" />
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Секция предустановок -->
  <div class="presets-section">
    <div class="presets-header">
      <h2>Предустановки матчей</h2>
      <button class="btn btn-primary" onclick="toggleAddPresetForm()" id="addPresetBtn">+ Добавить предустановку</button>
    </div>
    
    <!-- Предупреждение о работающем таймере -->
    <div id="timerWarning" class="timer-running-warning hidden">
      ⚠️ Таймер запущен! Блокированы: изменение команд, применение предустановок. Доступно: управление счетом, создание/редактирование предустановок.
    </div>
    
    <div id="presetsGrid" class="presets-grid">
      <!-- Предустановки будут загружены динамически -->
    </div>
    
    <div id="addPresetForm" class="add-preset-form hidden">
      <h3>Новая предустановка</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Название матча</label>
          <input type="text" id="presetName" placeholder="Например: Финал чемпионата">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Команда 1 - Название</label>
          <input type="text" id="presetTeam1Name" placeholder="Название команды">
        </div>
        <div class="form-group">
          <label>Команда 1 - Город</label>
          <input type="text" id="presetTeam1City" placeholder="Город">
        </div>
        <div class="form-group">
          <label>Команда 1 - Шорткод</label>
          <input type="text" id="presetTeam1Short" placeholder="ХОЗ" maxlength="3">
        </div>
        <div class="form-group">
          <label>Цвет формы 1</label>
          <input type="color" id="presetKit1Color" value="#2b2b2b">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Команда 2 - Название</label>
          <input type="text" id="presetTeam2Name" placeholder="Название команды">
        </div>
        <div class="form-group">
          <label>Команда 2 - Город</label>
          <input type="text" id="presetTeam2City" placeholder="Город">
        </div>
        <div class="form-group">
          <label>Команда 2 - Шорткод</label>
          <input type="text" id="presetTeam2Short" placeholder="ГОС" maxlength="3">
        </div>
        <div class="form-group">
          <label>Цвет формы 2</label>
          <input type="color" id="presetKit2Color" value="#2b2b2b">
        </div>
      </div>
      <div class="form-row">
        <button class="btn btn-primary" onclick="savePreset()">Сохранить</button>
        <button class="btn" onclick="toggleAddPresetForm()">Отмена</button>
      </div>
    </div>
    
    <!-- Форма редактирования предустановки -->
    <div id="editPresetForm" class="edit-preset-form hidden">
      <h3>Редактирование предустановки</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Название матча</label>
          <input type="text" id="editPresetName" placeholder="Например: Финал чемпионата">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Команда 1</label>
          <input type="text" id="editPresetTeam1Name" placeholder="Название команды">
        </div>
        <div class="form-group">
          <label>Город 1</label>
          <input type="text" id="editPresetTeam1City" placeholder="Город">
        </div>
        <div class="form-group">
          <label>Шорткод 1</label>
          <input type="text" id="editPresetTeam1Short" placeholder="ХОЗ" maxlength="3">
        </div>
        <div class="form-group">
          <label>Форма 1</label>
          <input type="color" id="editPresetKit1Color" value="#2b2b2b">
        </div>
      </div>
      <div class="team-divider"></div>
      <div class="form-row">
        <div class="form-group">
          <label>Команда 2</label>
          <input type="text" id="editPresetTeam2Name" placeholder="Название команды">
        </div>
        <div class="form-group">
          <label>Город 2</label>
          <input type="text" id="editPresetTeam2City" placeholder="Город">
        </div>
        <div class="form-group">
          <label>Шорткод 2</label>
          <input type="text" id="editPresetTeam2Short" placeholder="ГОС" maxlength="3">
        </div>
        <div class="form-group">
          <label>Форма 2</label>
          <input type="color" id="editPresetKit2Color" value="#2b2b2b">
        </div>
      </div>
      <div class="form-row">
        <button class="btn btn-primary" onclick="updatePreset()">Обновить</button>
        <button class="btn btn-danger" onclick="deletePresetFromEdit()">Удалить</button>
        <button class="btn" onclick="cancelEditPreset()">Отмена</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let presets = [];
    let ready = false;
    let timerRunning = false;
    let editingPresetId = null;
    let originalPresetData = null;

    // Инициализация
    document.addEventListener('DOMContentLoaded', function() {
      loadPresets();
      setupControls();
      setupEditFormHandlers();
    });
    
    // Настройка обработчиков для формы редактирования
    function setupEditFormHandlers() {
      // Обработчик клика вне формы редактирования
      document.addEventListener('click', function(event) {
        const editForm = document.getElementById('editPresetForm');
        const editLinks = document.querySelectorAll('.preset-edit-link');
        const isEditLink = Array.from(editLinks).some(link => link.contains(event.target));
        
        if (editForm && !editForm.classList.contains('hidden') && 
            !editForm.contains(event.target) && !isEditLink) {
          handleEditFormClose();
        }
      });
      
      // Обработчики изменений в полях формы
      const formFields = [
        'editPresetName', 'editPresetTeam1Name', 'editPresetTeam1City', 
        'editPresetTeam1Short', 'editPresetKit1Color', 'editPresetTeam2Name', 
        'editPresetTeam2City', 'editPresetTeam2Short', 'editPresetKit2Color'
      ];
      
      formFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', function() {
            // Поле изменено, можно отслеживать изменения
          });
        }
      });
    }
    
    // Проверка наличия изменений в форме
    function hasFormChanges() {
      if (!originalPresetData) return false;
      
      const currentData = {
        name: document.getElementById('editPresetName').value.trim(),
        team1Name: document.getElementById('editPresetTeam1Name').value.trim(),
        team1City: document.getElementById('editPresetTeam1City').value.trim(),
        team1Short: document.getElementById('editPresetTeam1Short').value.trim(),
        kit1Color: document.getElementById('editPresetKit1Color').value,
        team2Name: document.getElementById('editPresetTeam2Name').value.trim(),
        team2City: document.getElementById('editPresetTeam2City').value.trim(),
        team2Short: document.getElementById('editPresetTeam2Short').value.trim(),
        kit2Color: document.getElementById('editPresetKit2Color').value
      };
      
      return JSON.stringify(currentData) !== JSON.stringify(originalPresetData);
    }
    
    // Обработка закрытия формы редактирования
    function handleEditFormClose() {
      if (hasFormChanges()) {
        if (confirm('У вас есть несохраненные изменения. Сохранить перед закрытием?')) {
          updatePreset();
        }
      }
      cancelEditPreset();
    }

    // Настройка контролов
    function setupControls() {
      // Таймер
      document.getElementById('playPauseBtn').onclick = function() {
        const isRunning = document.getElementById('playPauseIcon').innerHTML.includes('rect');
        socket.emit('updateScoreboard', { 
          timerRunning: !isRunning 
        });
      };
      
      document.getElementById('setBtn').onclick = function() {
        const seconds = getSecondsFromTimeInput('timeInput');
        socket.emit('updateScoreboard', { 
          timerSeconds: seconds 
        });
      };

      // Счет
      document.getElementById('score1Inc').onclick = () => {
        const current = parseInt(document.getElementById('score1Value').textContent);
        socket.emit('updateScoreboard', { 
          score1: current + 1 
        });
      };
      
      document.getElementById('score1Dec').onclick = () => {
        const current = parseInt(document.getElementById('score1Value').textContent);
        if (current > 0) {
          socket.emit('updateScoreboard', { 
            score1: current - 1 
          });
        }
      };
      
      document.getElementById('score2Inc').onclick = () => {
        const current = parseInt(document.getElementById('score2Value').textContent);
        socket.emit('updateScoreboard', { 
          score2: current + 1 
        });
      };
      
      document.getElementById('score2Dec').onclick = () => {
        const current = parseInt(document.getElementById('score2Value').textContent);
        if (current > 0) {
          socket.emit('updateScoreboard', { 
            score2: current - 1 
          });
        }
      };

      // Автогенерация шорткодов
      autoShortName('team1Name', 'team1Short', 'ХОЗ');
      autoShortName('team2Name', 'team2Short', 'ГОС');

      // Обработчики изменений
      const fields = [
        'team1Name', 'team2Name', 'team1City', 'team2City',
        'kit1Color', 'kit2Color'
      ];
      
      fields.forEach(fieldId => {
        document.getElementById(fieldId).addEventListener('input', () => {
          sendState();
        });
      });

      // Обработка ввода времени
      document.getElementById('timeInput').addEventListener('input', function(e) {
        let v = this.value.replace(/[^\d:]/g, '');
        if (v.length === 2 && !v.includes(':')) v = v + ':';
        if (v.length > 5) v = v.slice(0,5);
        if (v.length === 3 && v[2] !== ':') v = v.slice(0,2) + ':' + v[2];
        if (!/^\d{0,2}:?\d{0,2}$/.test(v)) v = v.slice(0,-1);
        this.value = v;
      });
    }

    // Отправка состояния
    function sendState() {
      if (!ready) return;
      socket.emit('updateScoreboard', {
        team1Name: document.getElementById('team1Name').value,
        team1City: document.getElementById('team1City').value,
        team1Short: document.getElementById('team1Short').value,
        team2Name: document.getElementById('team2Name').value,
        team2City: document.getElementById('team2City').value,
        team2Short: document.getElementById('team2Short').value,
        kit1Color: document.getElementById('kit1Color').value,
        kit2Color: document.getElementById('kit2Color').value
      });
    }

    // Загрузка предустановок
    async function loadPresets() {
      try {
        const response = await fetch(`/api/presets?token=${getToken()}`);
        presets = await response.json();
        renderPresets();
      } catch (error) {
        console.error('Ошибка загрузки предустановок:', error);
      }
    }

    // Отображение предустановок
    function renderPresets() {
      const grid = document.getElementById('presetsGrid');
      grid.innerHTML = '';
      
      presets.forEach(preset => {
        const card = document.createElement('div');
        card.className = 'preset-card';
        card.innerHTML = `
          <div class="preset-content">
            <div class="preset-left">
              <div class="preset-name">${preset.name}</div>
              <div class="preset-teams">
                <span class="preset-team-name">${preset.team1Name}</span>
                <span class="preset-kit-color" style="background-color: ${preset.kit1Color}"></span>
                <span class="preset-separator">:</span>
                <span class="preset-kit-color" style="background-color: ${preset.kit2Color}"></span>
                <span class="preset-team-name">${preset.team2Name}</span>
              </div>
            </div>
            <div class="preset-right">
              <span class="preset-edit-link" onclick="editPreset('${preset.id}')">edit</span>
              <button class="preset-play-btn" onclick="confirmApplyPreset('${preset.id}')" ${timerRunning ? 'disabled' : ''} title="Применить предустановку">
                ▶
              </button>
            </div>
          </div>
        `;
        
        grid.appendChild(card);
      });
    }

    // Подтверждение применения предустановки
    function confirmApplyPreset(presetId) {
      const preset = presets.find(p => p.id === presetId);
      if (!preset) return;
      
      // Создание модального окна подтверждения
      const modal = document.createElement('div');
      modal.className = 'confirmation-modal';
      modal.innerHTML = `
        <div class="confirmation-content">
          <h3>Применить предустановку?</h3>
          <p>Вы уверены, что хотите применить предустановку "<strong>${preset.name}</strong>"?</p>
          <p><small>Это заменит текущие данные команд.</small></p>
          <div class="confirmation-buttons">
            <button class="confirmation-btn confirm" onclick="applyPreset('${presetId}'); closeConfirmation()">Да, применить</button>
            <button class="confirmation-btn cancel" onclick="closeConfirmation()">Отмена</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    // Закрытие модального окна
    function closeConfirmation() {
      const modal = document.querySelector('.confirmation-modal');
      if (modal) {
        modal.remove();
      }
    }
    
    // Применение предустановки
    function applyPreset(presetId) {
      const preset = presets.find(p => p.id === presetId);
      if (!preset) return;
      
      // Применение данных предустановки к основным полям
      document.getElementById('team1Name').value = preset.team1Name;
      document.getElementById('team1City').value = preset.team1City;
      document.getElementById('team1Short').value = preset.team1Short;
      document.getElementById('kit1Color').value = preset.kit1Color;
      
      document.getElementById('team2Name').value = preset.team2Name;
      document.getElementById('team2City').value = preset.team2City;
      document.getElementById('team2Short').value = preset.team2Short;
      document.getElementById('kit2Color').value = preset.kit2Color;
      
      // Отправка обновленного состояния
      sendState();
      
      // Показ уведомления
      showNotification(`Применена предустановка: ${preset.name}`, 'success');
    }

    // Удаление предустановки
    async function deletePreset(presetId) {
      if (!confirm('Удалить эту предустановку?')) return;
      
      try {
        await fetch(`/api/presets/${presetId}?token=${getToken()}`, {
          method: 'DELETE'
        });
        loadPresets();
      } catch (error) {
        console.error('Ошибка удаления предустановки:', error);
      }
    }

    // Сохранение предустановки
    async function savePreset() {
      const preset = {
        name: document.getElementById('presetName').value.trim(),
        team1Name: document.getElementById('presetTeam1Name').value.trim(),
        team1City: document.getElementById('presetTeam1City').value.trim(),
        team1Short: document.getElementById('presetTeam1Short').value.trim().toUpperCase(),
        team2Name: document.getElementById('presetTeam2Name').value.trim(),
        team2City: document.getElementById('presetTeam2City').value.trim(),
        team2Short: document.getElementById('presetTeam2Short').value.trim().toUpperCase(),
        kit1Color: document.getElementById('presetKit1Color').value,
        kit2Color: document.getElementById('presetKit2Color').value
      };

      // Валидация
      if (!preset.name) {
        alert('Введите название матча');
        return;
      }
      
      if (!preset.team1Name || !preset.team2Name) {
        alert('Введите названия обеих команд');
        return;
      }

      try {
        const response = await fetch(`/api/presets?token=${getToken()}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });
        
        if (!response.ok) {
          throw new Error('Ошибка сохранения предустановки');
        }
        
        // Очистка формы
        document.getElementById('addPresetForm').querySelectorAll('input').forEach(input => {
          if (input.type === 'text') input.value = '';
          if (input.type === 'color') {
            if (input.id.includes('Kit1')) input.value = '#2b2b2b';
            if (input.id.includes('Kit2')) input.value = '#2b2b2b';
          }
        });
        
        // Скрытие формы
        toggleAddPresetForm();
        
        // Перезагрузка предустановок
        await loadPresets();
        
        // Показ уведомления об успехе
        showNotification('Предустановка сохранена!', 'success');
        
      } catch (error) {
        console.error('Ошибка сохранения предустановки:', error);
        showNotification('Ошибка сохранения предустановки', 'error');
      }
    }

    // Переключение формы добавления предустановки
    function toggleAddPresetForm() {
      const form = document.getElementById('addPresetForm');
      form.classList.toggle('hidden');
    }
    
    // Редактирование предустановки
    function editPreset(presetId) {
      const preset = presets.find(p => p.id === presetId);
      if (!preset) return;
      
      editingPresetId = presetId;
      
      // Сохраняем исходные данные для сравнения
      originalPresetData = {
        name: preset.name,
        team1Name: preset.team1Name,
        team1City: preset.team1City,
        team1Short: preset.team1Short,
        kit1Color: preset.kit1Color,
        team2Name: preset.team2Name,
        team2City: preset.team2City,
        team2Short: preset.team2Short,
        kit2Color: preset.kit2Color
      };
      
      // Заполняем форму редактирования
      document.getElementById('editPresetName').value = preset.name;
      document.getElementById('editPresetTeam1Name').value = preset.team1Name;
      document.getElementById('editPresetTeam1City').value = preset.team1City;
      document.getElementById('editPresetTeam1Short').value = preset.team1Short;
      document.getElementById('editPresetKit1Color').value = preset.kit1Color;
      document.getElementById('editPresetTeam2Name').value = preset.team2Name;
      document.getElementById('editPresetTeam2City').value = preset.team2City;
      document.getElementById('editPresetTeam2Short').value = preset.team2Short;
      document.getElementById('editPresetKit2Color').value = preset.kit2Color;
      
      // Показываем форму редактирования
      document.getElementById('editPresetForm').classList.remove('hidden');
    }
    
    // Обновление предустановки
    async function updatePreset() {
      if (!editingPresetId) return;
      
      const preset = {
        name: document.getElementById('editPresetName').value.trim(),
        team1Name: document.getElementById('editPresetTeam1Name').value.trim(),
        team1City: document.getElementById('editPresetTeam1City').value.trim(),
        team1Short: document.getElementById('editPresetTeam1Short').value.trim().toUpperCase(),
        team2Name: document.getElementById('editPresetTeam2Name').value.trim(),
        team2City: document.getElementById('editPresetTeam2City').value.trim(),
        team2Short: document.getElementById('editPresetTeam2Short').value.trim().toUpperCase(),
        kit1Color: document.getElementById('editPresetKit1Color').value,
        kit2Color: document.getElementById('editPresetKit2Color').value
      };

      // Валидация
      if (!preset.name) {
        alert('Введите название матча');
        return;
      }
      
      if (!preset.team1Name || !preset.team2Name) {
        alert('Введите названия обеих команд');
        return;
      }

      try {
        const response = await fetch(`/api/presets/${editingPresetId}?token=${getToken()}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });
        
        if (!response.ok) {
          throw new Error('Ошибка обновления предустановки');
        }
        
        // Скрытие формы
        cancelEditPreset();
        
        // Перезагрузка предустановок
        await loadPresets();
        
        // Показ уведомления об успехе
        showNotification('Предустановка обновлена!', 'success');
        
      } catch (error) {
        console.error('Ошибка обновления предустановки:', error);
        showNotification('Ошибка обновления предустановки', 'error');
      }
    }
    
    // Отмена редактирования
    function cancelEditPreset() {
      editingPresetId = null;
      originalPresetData = null;
      document.getElementById('editPresetForm').classList.add('hidden');
    }
    
    // Удаление предустановки из формы редактирования
    async function deletePresetFromEdit() {
      if (!editingPresetId) return;
      
      if (!confirm('Удалить эту предустановку? Это действие нельзя отменить.')) return;
      
      try {
        const response = await fetch(`/api/presets/${editingPresetId}?token=${getToken()}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          throw new Error('Ошибка удаления предустановки');
        }
        
        // Скрытие формы
        cancelEditPreset();
        
        // Перезагрузка предустановок
        await loadPresets();
        
        // Показ уведомления об успехе
        showNotification('Предустановка удалена!', 'success');
        
      } catch (error) {
        console.error('Ошибка удаления предустановки:', error);
        showNotification('Ошибка удаления предустановки', 'error');
      }
    }

    // Автогенерация шорткодов
    function autoShortName(fullId, shortId, def) {
      const fullInput = document.getElementById(fullId);
      const shortInput = document.getElementById(shortId);
      let manual = false;

      function updateShort() {
        if (!manual) {
          shortInput.value = (fullInput.value || def).toUpperCase().slice(0,3);
        }
      }
      fullInput.addEventListener('input', updateShort);
      shortInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/[^A-ZА-ЯЁ0-9]/gi, '').slice(0,3);
        manual = true;
      });
      updateShort();
    }

    // Обновление UI при получении данных
    socket.on('scoreboardUpdate', (data) => {
      ready = false;
      
      // Обновление таймера
      const isRunning = !!data.timerRunning;
      timerRunning = isRunning;
      setPlayPauseIcon('playPauseIcon', isRunning);
      setTimeInputFromSeconds('timeInput', data.timerSeconds || 0);
      document.getElementById('timeInput').disabled = isRunning;
      
      // Показ/скрытие предупреждения о таймере
      const warning = document.getElementById('timerWarning');
      if (isRunning) {
        warning.classList.remove('hidden');
      } else {
        warning.classList.add('hidden');
      }
      
      // Блокировка/разблокировка полей при работе таймера
      const fieldsToDisable = [
        'team1Name', 'team1City', 'team1Short', 'kit1Color',
        'team2Name', 'team2City', 'team2Short', 'kit2Color'
      ];
      
      fieldsToDisable.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (isRunning) {
          field.classList.add('disabled-field');
        } else {
          field.classList.remove('disabled-field');
        }
      });
      
      // Кнопка добавления предустановки всегда доступна
      const addBtn = document.getElementById('addPresetBtn');
      addBtn.disabled = false;
      addBtn.textContent = '+ Добавить предустановку';
      
      // Блокировка только кнопок применения предустановок
      const playButtons = document.querySelectorAll('.preset-play-btn');
      playButtons.forEach(btn => {
        if (isRunning) {
          btn.disabled = true;
          btn.title = 'Нельзя применять предустановки во время работы таймера';
        } else {
          btn.disabled = false;
          btn.title = 'Применить предустановку';
        }
      });
      
      // Обновление счета
      document.getElementById('score1Value').textContent = data.score1 ?? 0;
      document.getElementById('score2Value').textContent = data.score2 ?? 0;
      
      // Обновление команд
      document.getElementById('team1Short').value = data.team1Short ?? "";
      document.getElementById('team2Short').value = data.team2Short ?? "";
      document.getElementById('kit1Color').value = data.kit1Color ?? "#2b2b2b";
      document.getElementById('kit2Color').value = data.kit2Color ?? "#2b2b2b";
      document.getElementById('team1Name').value = data.team1Name ?? "";
      document.getElementById('team2Name').value = data.team2Name ?? "";
      document.getElementById('team1City').value = data.team1City ?? "";
      document.getElementById('team2City').value = data.team2City ?? "";
      
      // Перерисовка предустановок с учетом состояния таймера
      renderPresets();
      
      setTimeout(() => { ready = true; }, 50);
    });

    // Вспомогательные функции
    function setPlayPauseIcon(iconId, isPlaying) {
      const icon = document.getElementById(iconId);
      icon.innerHTML = isPlaying
        ? `<rect x="8" y="6" width="5" height="20" fill="white"/><rect x="19" y="6" width="5" height="20" fill="white"/>`
        : `<polygon points="8,6 26,16 8,26" fill="white"/>`;
    }

    function setTimeInputFromSeconds(inputId, sec) {
      const input = document.getElementById(inputId);
      const mm = Math.floor(sec/60).toString().padStart(2, '0');
      const ss = (sec%60).toString().padStart(2, '0');
      input.value = `${mm}:${ss}`;
    }

    function getSecondsFromTimeInput(inputId) {
      const val = document.getElementById(inputId).value;
      if (/^\d{2}:\d{2}$/.test(val)) {
        const [mm, ss] = val.split(':').map(Number);
        return mm*60 + ss;
      }
      return 0;
    }

    function getToken() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token') || 'MySecret111';
    }
    
    // Функция показа уведомлений
    function showNotification(message, type = 'info') {
      // Создание элемента уведомления
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
        color: white;
        padding: 12px 20px;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 10000;
        font-size: 14px;
        max-width: 300px;
        animation: slideIn 0.3s ease-out;
      `;
      notification.textContent = message;
      
      // Добавление стилей анимации
      if (!document.getElementById('notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
          @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(notification);
      
      // Автоматическое удаление через 3 секунды
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }
  </script>
</body>
</html>