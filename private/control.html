<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>FSCOREBOARD Control Panel</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 800px; 
      margin: 20px auto; 
      background: #f4f4f4; 
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .presets-section {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 1px solid #ddd;
    }
    
    .presets-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .presets-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .preset-card {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .preset-card:hover {
      border-color: #338af3;
      background: #f8f9ff;
    }
    
    .preset-name {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 10px;
      color: #333;
    }
    
    .preset-shortcodes {
      font-weight: normal;
      color: #666;
      font-size: 12px;
      margin-left: 8px;
    }
    
    .preset-teams {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .preset-team {
      text-align: center;
      flex: 1;
    }
    
    .preset-team-name {
      font-weight: bold;
      color: #338af3;
    }
    
    .preset-team-city {
      font-size: 12px;
      color: #666;
    }
    
    .preset-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .btn-primary {
      background: #338af3;
      color: white;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn:hover {
      opacity: 0.8;
    }
    
    .add-preset-form {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .form-group {
      flex: 1;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .form-group input[type="color"] {
      width: 60px;
      height: 40px;
      padding: 0;
    }
    
    .camera-content {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 1px solid #ddd;
    }
    
    .timer-row { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 16px; 
      margin: 20px 0; 
    }
    
    .playpause-btn, .set-btn {
      width: 56px; 
      height: 44px;
      background: #338af3; 
      color: #fff; 
      border: none; 
      border-radius: 8px;
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-size: 2em; 
      cursor: pointer; 
      transition: background 0.2s;
    }
    
    .playpause-btn:hover, .set-btn:hover { 
      background: #2561a7; 
    }
    
    .timer-inputs {
      display: flex; 
      align-items: center; 
      gap: 8px;
      background: #fff; 
      border-radius: 8px; 
      padding: 8px 12px;
      border: 1px solid #ccc;
    }
    
    .timer-inputs input[type="text"] {
      width: 80px; 
      font-size: 1.2em; 
      text-align: center; 
      border: none; 
      background: none; 
      outline: none;
      letter-spacing: 2px;
    }
    
    .score-row { 
      display: flex; 
      justify-content: center; 
      gap: 30px; 
      margin-top: 20px; 
    }
    
    .score-block { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      padding: 0; 
      min-width: 120px; 
    }
    
    .score-controls { 
      display: flex; 
      gap: 10px; 
      margin-bottom: 8px; 
    }
    
    .score-btn {
      background: #338af3; 
      color: #fff; 
      border: none; 
      border-radius: 8px;
      width: 44px; 
      height: 44px; 
      font-size: 1.4em; 
      font-weight: bold; 
      cursor: pointer;
      display: flex; 
      align-items: center; 
      justify-content: center;
    }
    
    .score-btn:hover { 
      background: #2561a7; 
    }
    
    .score-value { 
      font-size: 2em; 
      color: #338af3; 
      min-width: 32px; 
      text-align: center; 
    }
    
    .short-label-row { 
      margin-top: 6px; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 8px;
    }
    
    .short-label-row input[type="text"] {
      width: 50px; 
      text-align: center; 
      font-size: 1.2em; 
      border-radius: 8px; 
      border: 1px solid #ccc; 
      padding: 4px 0;
      background: #fff; 
      text-transform: uppercase; 
      font-weight: bold; 
      letter-spacing: 2px;
    }
    
    .kit-block { 
      display: flex; 
      flex-direction: row; 
      align-items: center; 
      justify-content: center; 
      gap: 8px; 
      width: auto; 
    }
    
    .kit-color {
      width: 100px; 
      height: 32px; 
      border-radius: 4px; 
      border: 1px solid #ccc;
      background: none; 
      margin: 0; 
      padding: 0; 
      cursor: pointer; 
      display: block;
    }
    
    .label-caption {
      font-size: 0.85em; 
      color: #888; 
      margin-bottom: 2px; 
      text-align: center; 
      font-weight: normal; 
      letter-spacing: 1px;
    }
    
    .team-input-row { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      width: 100%; 
      gap: 4px; 
      margin-top: 6px; 
    }
    
    .team-input-row input[type="text"] {
      width: 100%;
      text-align: center; 
      font-size: 1em; 
      border-radius: 8px; 
      border: 1px solid #ccc; 
      padding: 4px 0;
      background: #fff; 
      color: #338af3; 
      font-weight: bold; 
    }
    
    .city-input-row input[type="text"] {
      width: 100%;
      text-align: center; 
      font-size: 1em; 
      border-radius: 8px; 
      border: 1px solid #ccc; 
      padding: 4px 0;
      background: #fff; 
      color: #888; 
      font-weight: normal;
    }
    
    .divider { 
      width: 2px; 
      background: #ccc; 
      margin: 0 10px; 
    }
    
    .hidden {
      display: none;
    }
    
    .version-info {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 0.6em;
      color: #ccc;
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 6px;
      border-radius: 3px;
      opacity: 0.7;
      z-index: 1000;
    }
    
    .preset-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 8px;
      transition: all 0.2s;
      box-sizing: border-box;
      width: 100%;
      max-width: 100%;
    }
    
    .preset-card:hover {
      background: #f8f9fa;
    }
    
    .preset-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }
    
    .preset-left {
      display: flex;
      align-items: flex-start;
      min-width: 0;
      overflow: hidden;
      flex-direction: column;
      gap: 8px;
    }
    
    .preset-name {
      font-weight: bold;
      font-size: 14px;
      margin-right: 0;
      white-space: nowrap;
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 4px;
      align-self: flex-start;
    }
    
    .preset-teams {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
      align-self: flex-start;
      flex-wrap: nowrap;
    }
    
    .preset-right {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      align-self: flex-start;
    }
    
    .preset-team-name {
      font-size: 14px;
      white-space: nowrap;
    }
    
    .preset-separator {
      font-size: 14px;
      color: #666;
      margin: 0 2px;
    }
    
    .preset-kit-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      border: 1px solid #ccc;
      display: inline-block;
      flex-shrink: 0;
    }
    
    .preset-edit-link {
      color: #999;
      text-decoration: underline;
      text-decoration-style: dashed;
      cursor: pointer;
      font-size: 12px;
      margin-left: 16px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .preset-edit-link:hover {
      color: #666;
    }
    
    .preset-play-btn {
      background: none;
      border: none;
      color: #28a745;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      padding: 4px 8px;
      flex-shrink: 0;
    }
    
    .preset-play-btn:hover {
      color: #218838;
    }
    
    .preset-play-btn:disabled {
      color: #ccc;
      cursor: not-allowed;
    }
    
    .confirmation-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    
    .confirmation-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      text-align: center;
    }
    
    .confirmation-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 16px;
    }
    
    .confirmation-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .confirmation-btn.confirm {
      background: #28a745;
      color: white;
    }
    
    .confirmation-btn.confirm:hover {
      background: #218838;
    }
    
    .confirmation-btn.cancel {
      background: #6c757d;
      color: white;
    }
    
    .confirmation-btn.cancel:hover {
      background: #5a6268;
    }
    
    /* Мобильная адаптивность */
    @media (max-width: 768px) {
      body {
        font-size: 16px;
        padding: 10px;
      }
      
      .camera-content {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .timer-row {
        flex-direction: row;
        gap: 12px;
        margin: 15px 0;
        justify-content: center;
        align-items: center;
      }
      
      .playpause-btn, .set-btn {
        width: 60px;
        height: 50px;
        font-size: 16px;
      }
      
      .timer-inputs input {
        font-size: 18px;
        padding: 8px 12px;
        width: 80px;
        text-align: center;
      }
      
      .score-row {
        flex-direction: row;
        gap: 20px;
        justify-content: space-between;
      }
      
      .score-block {
        width: 48%;
        max-width: none;
      }
      
      .score-controls {
        justify-content: center;
        margin-bottom: 10px;
      }
      
      .score-btn {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }
      
      .score-value {
        font-size: 28px;
        margin: 0 15px;
      }
      
      .short-label-row {
        justify-content: center;
        margin-bottom: 10px;
      }
      
      .short-label-row input {
        font-size: 16px;
        padding: 6px 10px;
        width: 70px;
        text-align: center;
      }
      
      .kit-block {
        justify-content: center;
        margin-bottom: 10px;
      }
      
      .kit-color {
        width: 35px;
        height: 35px;
      }
      
      .team-input-row {
        margin-bottom: 10px;
      }
      
      .team-input-row input {
        font-size: 14px;
        padding: 8px 10px;
      }
      
      .presets-section {
        padding: 15px;
      }
      
      .presets-header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
      }
      
      .presets-header h2 {
        text-align: center;
        margin-bottom: 0;
      }
      
      .btn {
        font-size: 16px;
        padding: 12px 20px;
        width: 100%;
      }
      
      .preset-card {
        padding: 15px;
        margin-bottom: 10px;
        flex-direction: row;
        align-items: flex-start;
        justify-content: space-between;
      }
      
      .preset-content {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
      }
      
      .preset-left {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        flex: 1;
      }
      
      .preset-name {
        font-size: 16px;
        margin-right: 0;
        padding: 4px 8px;
        align-self: flex-start;
      }
      
      .preset-teams {
        width: 100%;
        justify-content: flex-start;
        align-self: flex-start;
      }
      
      .preset-team-name {
        font-size: 16px;
      }
      
      .preset-kit-color {
        width: 16px;
        height: 16px;
      }
      
      .preset-separator {
        font-size: 16px;
        margin: 0 4px;
      }
      
      .preset-right {
        align-self: flex-start;
        margin-top: 0;
        flex-shrink: 0;
      }
      
      .preset-edit-link {
        font-size: 14px;
        margin-left: 0;
      }
      
      .preset-play-btn {
        font-size: 18px;
        padding: 6px 10px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 15px;
        width: 100%;
        box-sizing: border-box;
      }
      
      .form-group {
        width: 100%;
        box-sizing: border-box;
      }
      
      .form-group input {
        font-size: 16px;
        padding: 10px 12px;
        width: 100%;
        box-sizing: border-box;
        max-width: 100%;
      }
      
      .form-group label {
        font-size: 14px;
        margin-bottom: 5px;
        display: block;
        width: 100%;
        box-sizing: border-box;
      }
      
      .edit-preset-form {
        padding: 15px;
        margin: 15px 0;
        box-sizing: border-box;
        width: 100%;
        max-width: 100%;
      }
      
      .team-divider {
        margin: 15px 0;
      }
    }
    
    .timer-running-warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: bold;
    }
    
    .disabled-field {
      opacity: 0.6;
      pointer-events: none;
      background-color: #f8f9fa !important;
    }
    
    .preset-card.editable {
      cursor: pointer;
      border-style: dashed;
    }
    
    .preset-card.editable:hover {
      border-color: #007bff;
      background: #f8f9ff;
    }
    
    .edit-preset-form {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .edit-preset-form .form-section {
      margin-bottom: 25px;
    }
    
    .edit-preset-form .form-group {
      margin-bottom: 15px;
    }
    
    .editable-title {
      cursor: pointer;
      border: 2px solid transparent;
      padding: 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .editable-title:hover {
      border-color: #007bff;
      background-color: #f8f9ff;
    }
    
    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      color: #1976d2;
      font-size: 16px;
      font-weight: 600;
    }
    
    .logo-mini {
      width: 25px;
      height: 25px;
      border-radius: 3px;
      border: 1px solid #ddd;
      object-fit: cover;
      display: inline-block;
      background: #f5f5f5;
    }
    
    .logo-mini img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 3px;
    }
    
    .logo-upload-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }
    
    .logo-mini-main {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      cursor: pointer;
      position: relative;
    }
    
    .logo-mini-main img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    
    .logo-delete-btn {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 16px;
      height: 16px;
      background: rgba(0, 0, 0, 0.3);
      color: rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.2s ease;
    }
    
    .logo-delete-btn:hover {
      background: rgba(220, 53, 69, 0.8);
      color: white;
      border: 1px solid white;
    }
    
    .logo-delete-btn-small {
      position: absolute;
      top: -3px;
      right: -3px;
      width: 12px;
      height: 12px;
      background: rgba(220, 53, 69, 0.8);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10;
      border: 1px solid white;
      transition: all 0.2s ease;
    }
    
    .logo-delete-btn-small:hover {
      background: #dc3545;
      transform: scale(1.1);
    }
    
    
    .preset-team-logo {
      display: inline-flex;
      align-items: center;
      flex-shrink: 0;
    }
    
    .preset-logo-mini {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      object-fit: cover;
    }
    
    .preset-team-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }
    
    .preset-kit-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      flex-shrink: 0;
    }
    
    .preset-separator {
      color: #666;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    .edit-preset-form .form-group input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .edit-preset-form .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
      font-size: 13px;
    }
    
    .logo-preview {
      margin-top: 8px;
      text-align: center;
    }
    
    .logo-preview img {
      width: 50px;
      height: 50px;
      border-radius: 4px;
      object-fit: cover;
    }
    
    .logo-preview .no-logo {
      color: #999;
      font-size: 12px;
      font-style: italic;
    }
    
    .edit-preset-form h3 {
      color: #1976d2;
      margin-top: 0;
    }
    
    .team-divider {
      height: 2px;
      background: #ddd;
      margin: 20px 0;
      border-radius: 1px;
    }
  </style>
</head>
<body>
  <!-- Версия в углу -->
  <div class="version-info">v1.0.0</div>

  <!-- Управление табло -->
  <div class="camera-content">
    <div class="timer-row">
      <button id="playPauseBtn" class="playpause-btn" title="Пуск/Пауза">
        <svg id="playPauseIcon" width="32" height="32" viewBox="0 0 32 32" fill="none">
          <polygon id="playIcon" points="8,6 26,16 8,26" fill="white"/>
        </svg>
      </button>
      <div class="timer-inputs">
        <input type="text" id="timeInput" maxlength="5" placeholder="MM:SS" pattern="^\d{2}:\d{2}$" value="00:00" autocomplete="off" />
      </div>
      <button id="setBtn" class="set-btn">Set</button>
    </div>
    <form id="controlForm" autocomplete="off" spellcheck="false">
      <div class="score-row">
        <div class="score-block">
          <div class="score-controls">
            <button type="button" class="score-btn" id="score1Dec">-</button>
            <span class="score-value" id="score1Value">0</span>
            <button type="button" class="score-btn" id="score1Inc">+</button>
          </div>
          <div class="short-label-row">
            <span id="team1LogoMini" class="logo-mini-main" onclick="document.getElementById('team1LogoUpload').click()">
              <span class="logo-delete-btn hidden" onclick="clearMainLogo('team1'); event.stopPropagation()" title="Удалить логотип">×</span>
            </span>
            <input type="text" id="team1Short" maxlength="3" placeholder="ХОЗ" />
            <input type="color" id="kit1Color" value="#2b2b2b" class="kit-color">
            <input type="file" id="team1LogoUpload" accept="image/*" onchange="uploadMainLogo('team1', this)" style="display: none;">
          </div>
          <div class="team-input-row">
            <span class="label-caption">Название команды</span>
            <input type="text" id="team1Name" maxlength="40" placeholder="Не введено" />
          </div>
          <div class="city-input-row team-input-row">
            <span class="label-caption">Город</span>
            <input type="text" id="team1City" maxlength="30" placeholder="Не введено" />
          </div>
        </div>
        <div class="divider"></div>
        <div class="score-block">
          <div class="score-controls">
            <button type="button" class="score-btn" id="score2Dec">-</button>
            <span class="score-value" id="score2Value">0</span>
            <button type="button" class="score-btn" id="score2Inc">+</button>
          </div>
          <div class="short-label-row">
            <span id="team2LogoMini" class="logo-mini-main" onclick="document.getElementById('team2LogoUpload').click()">
              <span class="logo-delete-btn hidden" onclick="clearMainLogo('team2'); event.stopPropagation()" title="Удалить логотип">×</span>
            </span>
            <input type="text" id="team2Short" maxlength="3" placeholder="ГОС" />
            <input type="color" id="kit2Color" value="#2b2b2b" class="kit-color">
            <input type="file" id="team2LogoUpload" accept="image/*" onchange="uploadMainLogo('team2', this)" style="display: none;">
          </div>
          <div class="team-input-row">
            <span class="label-caption">Название команды</span>
            <input type="text" id="team2Name" maxlength="40" placeholder="Не введено" />
          </div>
          <div class="city-input-row team-input-row">
            <span class="label-caption">Город</span>
            <input type="text" id="team2City" maxlength="30" placeholder="Не введено" />
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Секция предустановок -->
  <div class="presets-section">
    <div class="presets-header">
      <h2>Предустановки матчей</h2>
      <button class="btn btn-primary" onclick="toggleAddPresetForm()" id="addPresetBtn">+ Добавить предустановку</button>
    </div>
    
    <!-- Предупреждение о работающем таймере -->
    <div id="timerWarning" class="timer-running-warning hidden">
      ⚠️ Таймер запущен! Блокированы: изменение команд, применение предустановок. Доступно: управление счетом, создание/редактирование предустановок.
    </div>
    
    <div id="presetsGrid" class="presets-grid">
      <!-- Предустановки будут загружены динамически -->
    </div>
    
    <div id="addPresetForm" class="edit-preset-form hidden">
      <h3 id="addPresetTitle" class="editable-title" onclick="startEditingTitle()">Новая предустановка</h3>
      <input type="text" id="addPresetNameInput" class="hidden" onblur="finishEditingTitle()" onkeypress="handleTitleKeypress(event)">
      
      <div class="form-section">
        <div class="form-row">
          <div class="form-group">
            <label>Команда 1</label>
            <input type="text" id="addPresetTeam1Name" placeholder="Название команды">
          </div>
          <div class="form-group">
            <label>Город 1</label>
            <input type="text" id="addPresetTeam1City" placeholder="Город">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Шорткод 1</label>
            <input type="text" id="addPresetTeam1Short" maxlength="3" placeholder="АБВ">
          </div>
          <div class="form-group">
            <label>Форма 1</label>
            <input type="color" id="addPresetKit1Color" value="#2b2b2b">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Логотип 1</label>
            <input type="file" id="addPresetTeam1Logo" accept="image/*" onchange="uploadLogo('team1', this)">
            <div id="addPresetTeam1LogoPreview" class="logo-preview"></div>
          </div>
        </div>
      </div>
      
      <div class="team-divider"></div>
      
      <div class="form-section">
        <div class="form-row">
          <div class="form-group">
            <label>Команда 2</label>
            <input type="text" id="addPresetTeam2Name" placeholder="Название команды">
          </div>
          <div class="form-group">
            <label>Город 2</label>
            <input type="text" id="addPresetTeam2City" placeholder="Город">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Шорткод 2</label>
            <input type="text" id="addPresetTeam2Short" maxlength="3" placeholder="ГДЕ">
          </div>
          <div class="form-group">
            <label>Форма 2</label>
            <input type="color" id="addPresetKit2Color" value="#2b2b2b">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Логотип 2</label>
            <input type="file" id="addPresetTeam2Logo" accept="image/*" onchange="uploadLogo('team2', this)">
            <div id="addPresetTeam2LogoPreview" class="logo-preview"></div>
          </div>
        </div>
      </div>
      
      <div class="form-buttons">
        <button class="btn btn-primary" onclick="saveNewPreset()">Сохранить</button>
        <button class="btn btn-secondary" onclick="cancelAddPreset()">Отмена</button>
      </div>
    </div>

    <!-- Форма редактирования предустановки -->
    <div id="editPresetForm" class="edit-preset-form hidden">
      <h3 id="editPresetTitle" class="editable-title" onclick="startEditingTitle()">Название матча</h3>
      <input type="text" id="editPresetNameInput" class="hidden" placeholder="Например: Финал чемпионата" onblur="finishEditingTitle()" onkeypress="handleTitleKeypress(event)">
      <div class="form-section">
        <h4 class="section-title">
          <span id="editPresetTeam1LogoMini" class="logo-mini" onclick="editPresetLogo('team1')" title="Нажмите для обновления логотипа"></span>
          Команда 1
          <input type="file" id="editPresetTeam1Logo" accept="image/*" onchange="uploadLogo('team1', this)" style="display: none;">
          <button type="button" class="logo-delete-btn-small" onclick="deletePresetLogo('team1'); event.stopPropagation()" title="Удалить логотип" style="display: none;">×</button>
        </h4>
        <div class="form-group">
          <label>Название</label>
          <input type="text" id="editPresetTeam1Name" placeholder="Название команды">
      </div>
        <div class="form-group">
          <label>Город</label>
          <input type="text" id="editPresetTeam1City" placeholder="Город">
    </div>
        <div class="form-group">
          <label>Шорткод</label>
          <input type="text" id="editPresetTeam1Short" placeholder="ХОЗ" maxlength="3">
          </div>
        <div class="form-group">
          <label>Цвет формы</label>
          <input type="color" id="editPresetKit1Color" value="#2b2b2b">
          </div>
          </div>
      <div class="team-divider"></div>
      <div class="form-section">
        <h4 class="section-title">
          Команда 2
          <span id="editPresetTeam2LogoMini" class="logo-mini" onclick="editPresetLogo('team2')" title="Нажмите для обновления логотипа"></span>
          <input type="file" id="editPresetTeam2Logo" accept="image/*" onchange="uploadLogo('team2', this)" style="display: none;">
          <button type="button" class="logo-delete-btn-small" onclick="deletePresetLogo('team2'); event.stopPropagation()" title="Удалить логотип" style="display: none;">×</button>
        </h4>
        <div class="form-group">
          <label>Название</label>
          <input type="text" id="editPresetTeam2Name" placeholder="Название команды">
          </div>
        <div class="form-group">
          <label>Город</label>
          <input type="text" id="editPresetTeam2City" placeholder="Город">
        </div>
        <div class="form-group">
          <label>Шорткод</label>
          <input type="text" id="editPresetTeam2Short" placeholder="ГОС" maxlength="3">
          </div>
        <div class="form-group">
          <label>Цвет формы</label>
          <input type="color" id="editPresetKit2Color" value="#2b2b2b">
          </div>
          </div>
      <div class="form-row">
        <button class="btn btn-primary" onclick="updatePreset()">Обновить</button>
        <button class="btn btn-danger" onclick="deletePresetFromEdit()">Удалить</button>
        <button class="btn" onclick="cancelEditPreset()">Отмена</button>
          </div>
        </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let presets = [];
    let ready = false;
    let timerRunning = false;
    let editingPresetId = null;
    let originalPresetData = null;
    let uploadedLogos = {
      team1: null,
      team2: null
    };
    let state = {
      team1Logo: '',
      team2Logo: ''
    };
    
    // Защита от случайного изменения счета
    let lastScoreChange = {
      team: null,
      timestamp: 0,
      value: 0
    };

    // Инициализация
    document.addEventListener('DOMContentLoaded', function() {
      loadPresets();
      setupControls();
      setupEditFormHandlers();
    });
    
    // Настройка обработчиков для формы редактирования
    function setupEditFormHandlers() {
      // Обработчик клика вне формы редактирования
      document.addEventListener('click', function(event) {
        const editForm = document.getElementById('editPresetForm');
        const editLinks = document.querySelectorAll('.preset-edit-link');
        const isEditLink = Array.from(editLinks).some(link => link.contains(event.target));
        
        if (editForm && !editForm.classList.contains('hidden') && 
            !editForm.contains(event.target) && !isEditLink) {
          handleEditFormClose();
        }
      });
      
      // Обработчики изменений в полях формы
      const formFields = [
        'editPresetName', 'editPresetTeam1Name', 'editPresetTeam1City', 
        'editPresetTeam1Short', 'editPresetKit1Color', 'editPresetTeam2Name', 
        'editPresetTeam2City', 'editPresetTeam2Short', 'editPresetKit2Color'
      ];
      
      formFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', function() {
            // Поле изменено, можно отслеживать изменения
          });
        }
      });
    }
    
    // Проверка наличия изменений в форме
    function hasFormChanges() {
      if (!originalPresetData) return false;
      
      const currentData = {
        name: document.getElementById('editPresetName').value.trim(),
        team1Name: document.getElementById('editPresetTeam1Name').value.trim(),
        team1City: document.getElementById('editPresetTeam1City').value.trim(),
        team1Short: document.getElementById('editPresetTeam1Short').value.trim(),
        kit1Color: document.getElementById('editPresetKit1Color').value,
        team2Name: document.getElementById('editPresetTeam2Name').value.trim(),
        team2City: document.getElementById('editPresetTeam2City').value.trim(),
        team2Short: document.getElementById('editPresetTeam2Short').value.trim(),
        kit2Color: document.getElementById('editPresetKit2Color').value
      };
      
      return JSON.stringify(currentData) !== JSON.stringify(originalPresetData);
    }
    
    // Обработка закрытия формы редактирования
    function handleEditFormClose() {
      if (hasFormChanges()) {
        if (confirm('У вас есть несохраненные изменения. Сохранить перед закрытием?')) {
          updatePreset();
        }
      }
      cancelEditPreset();
    }
    
    // Загрузка логотипа
    async function uploadLogo(team, fileInput) {
      if (!fileInput.files[0]) return;
      
      const formData = new FormData();
      formData.append('logo', fileInput.files[0]);
      
      try {
        const response = await fetch(`/api/upload-logo?token=${getToken()}`, {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          const result = await response.json();
          uploadedLogos[team] = result.url; // Сохраняем полный URL
          showLogoPreview(team, result.url);
          updateLogoMini(team, result.url);
          showNotification('Логотип загружен успешно', 'success');
        } else {
          const error = await response.json();
          showNotification('Ошибка загрузки: ' + error.error, 'error');
        }
      } catch (error) {
        showNotification('Ошибка загрузки логотипа', 'error');
        console.error('Upload error:', error);
      }
    }
    
    // Показ превью логотипа
    function showLogoPreview(team, url) {
      // Для формы редактирования
      const editPreview = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}LogoPreview`);
      if (editPreview) {
        editPreview.innerHTML = `<img src="${url}" alt="Логотип ${team}">`;
      }
      
      // Для формы добавления
      const addPreview = document.getElementById(`addPresetTeam${team === 'team1' ? '1' : '2'}LogoPreview`);
      if (addPreview) {
        addPreview.innerHTML = `<img src="${url}" alt="Логотип ${team}">`;
      }
    }
    
    // Очистка логотипа
    function clearLogo(team) {
      uploadedLogos[team] = null;
      
      // Для формы редактирования
      const editPreview = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}LogoPreview`);
      if (editPreview) {
        editPreview.innerHTML = '<div class="no-logo">Нет логотипа</div>';
      }
      
      // Для формы добавления
      const addPreview = document.getElementById(`addPresetTeam${team === 'team1' ? '1' : '2'}LogoPreview`);
      if (addPreview) {
        addPreview.innerHTML = '<div class="no-logo">Нет логотипа</div>';
      }
      
      // Очищаем поле выбора файла в форме редактирования
      const editFileInput = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}Logo`);
      if (editFileInput) {
        editFileInput.value = '';
      }
      
      // Очищаем поле выбора файла в форме добавления
      const addFileInput = document.getElementById(`addPresetTeam${team === 'team1' ? '1' : '2'}Logo`);
      if (addFileInput) {
        addFileInput.value = '';
      }
    }
    
    // Редактирование заголовка
    function startEditingTitle() {
      // Проверяем какая форма активна
      const editTitle = document.getElementById('editPresetTitle');
      const editInput = document.getElementById('editPresetNameInput');
      const addTitle = document.getElementById('addPresetTitle');
      const addInput = document.getElementById('addPresetNameInput');
      
      if (editTitle && !editTitle.classList.contains('hidden')) {
        // Форма редактирования
        editTitle.classList.add('hidden');
        editInput.classList.remove('hidden');
        editInput.value = editTitle.textContent;
        editInput.focus();
        editInput.select();
      } else if (addTitle && !addTitle.classList.contains('hidden')) {
        // Форма добавления
        addTitle.classList.add('hidden');
        addInput.classList.remove('hidden');
        addInput.value = addTitle.textContent;
        addInput.focus();
        addInput.select();
      }
    }
    
    function finishEditingTitle() {
      // Проверяем какая форма активна
      const editTitle = document.getElementById('editPresetTitle');
      const editInput = document.getElementById('editPresetNameInput');
      const addTitle = document.getElementById('addPresetTitle');
      const addInput = document.getElementById('addPresetNameInput');
      
      if (editInput && !editInput.classList.contains('hidden')) {
        // Форма редактирования
        editTitle.textContent = editInput.value.trim() || 'Название матча';
        editTitle.classList.remove('hidden');
        editInput.classList.add('hidden');
      } else if (addInput && !addInput.classList.contains('hidden')) {
        // Форма добавления
        addTitle.textContent = addInput.value.trim() || 'Новая предустановка';
        addTitle.classList.remove('hidden');
        addInput.classList.add('hidden');
      }
    }
    
    function handleTitleKeypress(event) {
      if (event.key === 'Enter') {
        finishEditingTitle();
      }
    }
    
    // Обновление миниатюр логотипов
    function updateLogoMini(team, logoUrl) {
      // Для формы редактирования
      const editMini = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}LogoMini`);
      if (editMini) {
        if (logoUrl) {
          editMini.innerHTML = `<img src="${logoUrl}" alt="Логотип ${team}">`;
          // Показываем кнопку удаления
          const deleteBtn = editMini.parentElement.querySelector('.logo-delete-btn-small');
          if (deleteBtn) deleteBtn.style.display = 'flex';
        } else {
          editMini.innerHTML = '';
          // Скрываем кнопку удаления
          const deleteBtn = editMini.parentElement.querySelector('.logo-delete-btn-small');
          if (deleteBtn) deleteBtn.style.display = 'none';
        }
      }
      
      // Для формы добавления (если есть миниатюры)
      const addMini = document.getElementById(`addPresetTeam${team === 'team1' ? '1' : '2'}LogoMini`);
      if (addMini) {
        if (logoUrl) {
          addMini.innerHTML = `<img src="${logoUrl}" alt="Логотип ${team}">`;
        } else {
          addMini.innerHTML = '';
        }
      }
    }
    
    // Обновление логотипа в форме редактирования
    function editPresetLogo(team) {
      const fileInput = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}Logo`);
      fileInput.click();
    }
    
    // Удаление логотипа из формы редактирования
    async function deletePresetLogo(team) {
      if (!confirm('Удалить логотип этой команды?')) return;
      
      // Очищаем логотип
      uploadedLogos[team] = null;
      
      // Обновляем миниатюру
      updateLogoMini(team, null);
      
      // Очищаем поле выбора файла
      const fileInput = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}Logo`);
      if (fileInput) fileInput.value = '';
      
      showNotification('Логотип удален', 'success');
    }
    
    // Загрузка логотипа в основную форму
    async function uploadMainLogo(team, fileInput) {
      if (!fileInput.files[0]) return;
      
      const formData = new FormData();
      formData.append('logo', fileInput.files[0]);
      
      try {
        const response = await fetch(`/api/upload-logo?token=${getToken()}`, {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          const result = await response.json();
          updateMainLogoMini(team, result.url);
          updateMainLogoState(team, result.url);
          showNotification('Логотип загружен успешно', 'success');
        } else {
          const error = await response.json();
          showNotification('Ошибка загрузки: ' + error.error, 'error');
        }
      } catch (error) {
        showNotification('Ошибка загрузки логотипа', 'error');
        console.error('Upload error:', error);
      }
    }
    
    // Обновление миниатюры в основной форме
    function updateMainLogoMini(team, logoUrl) {
      const mini = document.getElementById(`${team}LogoMini`);
      const deleteBtn = mini.querySelector('.logo-delete-btn');
      
      if (logoUrl) {
        mini.innerHTML = `<img src="${logoUrl}" alt="Логотип ${team}">
          <span class="logo-delete-btn" onclick="clearMainLogo('${team}'); event.stopPropagation()" title="Удалить логотип">×</span>`;
      } else {
        mini.innerHTML = '';
      }
    }
    
    // Обновление состояния логотипа в основной форме
    function updateMainLogoState(team, logoUrl) {
      state[`${team}Logo`] = logoUrl;
      socket.emit('updateScoreboard', {
        [`${team}Logo`]: logoUrl
      });
    }
    
    // Показ серого круга цвета формы
    function showKitColorCircle(team) {
      const mini = document.getElementById(`${team}LogoMini`);
      const kitColor = document.getElementById(`kit${team === 'team1' ? '1' : '2'}Color`).value;
      mini.innerHTML = `<div style="width: 100%; height: 100%; background-color: ${kitColor}; border-radius: 50%;"></div>`;
    }
    
    // Удаление логотипа из основной панели
    async function clearMainLogo(team) {
      const currentLogoUrl = state[`${team}Logo`];
      
      if (!currentLogoUrl) return;
      
      // Очищаем состояние
      state[`${team}Logo`] = '';
      
      // Обновляем сервер
      sendState();
      
      // Показываем цветной круг
      showKitColorCircle(team);
      
      // Пытаемся удалить файл с сервера
      try {
        const filename = currentLogoUrl.split('/').pop();
        const response = await fetch(`/api/logo/${filename}?token=${getToken()}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showNotification('Логотип удален', 'success');
        } else if (response.status === 403) {
          const result = await response.json();
          if (result.protected) {
            showNotification('Логотип защищен от удаления (используется в пресете)', 'info');
          }
        }
      } catch (error) {
        console.error('Ошибка удаления логотипа:', error);
        showNotification('Ошибка удаления логотипа', 'error');
      }
    }

    // Настройка контролов
    function setupControls() {
      // Таймер
      document.getElementById('playPauseBtn').onclick = function() {
        const isRunning = document.getElementById('playPauseIcon').innerHTML.includes('rect');
        socket.emit('updateScoreboard', { 
          timerRunning: !isRunning 
        });
      };
      
      document.getElementById('setBtn').onclick = function() {
        const seconds = getSecondsFromTimeInput('timeInput');
        socket.emit('updateScoreboard', { 
          timerSeconds: seconds 
        });
      };

      // Счет с защитой от случайных изменений
      document.getElementById('score1Inc').onclick = () => {
        const current = parseInt(document.getElementById('score1Value').textContent);
        const newValue = current + 1;
        
        if (timerRunning && lastScoreChange.team === 'score1' && 
            (Date.now() - lastScoreChange.timestamp) < 60000) {
          if (!confirm('Похоже, вы уже прибавили счет совсем недавно. Подтвердите, что сейчас вы не случайно нажали второй раз?')) {
            return;
          }
        }
        
        lastScoreChange = { team: 'score1', timestamp: Date.now(), value: newValue };
        socket.emit('updateScoreboard', { score1: newValue });
      };
      
      document.getElementById('score1Dec').onclick = () => {
        const current = parseInt(document.getElementById('score1Value').textContent);
        if (current > 0) {
          if (timerRunning) {
            if (!confirm('Подтвердите уменьшение счета во время игры?')) {
              return;
            }
          }
          socket.emit('updateScoreboard', { score1: current - 1 });
        }
      };
      
      document.getElementById('score2Inc').onclick = () => {
        const current = parseInt(document.getElementById('score2Value').textContent);
        const newValue = current + 1;
        
        if (timerRunning && lastScoreChange.team === 'score2' && 
            (Date.now() - lastScoreChange.timestamp) < 60000) {
          if (!confirm('Похоже, вы уже прибавили счет совсем недавно. Подтвердите, что сейчас вы не случайно нажали второй раз?')) {
            return;
          }
        }
        
        lastScoreChange = { team: 'score2', timestamp: Date.now(), value: newValue };
        socket.emit('updateScoreboard', { score2: newValue });
      };
      
      document.getElementById('score2Dec').onclick = () => {
        const current = parseInt(document.getElementById('score2Value').textContent);
        if (current > 0) {
          if (timerRunning) {
            if (!confirm('Подтвердите уменьшение счета во время игры?')) {
              return;
            }
          }
          socket.emit('updateScoreboard', { score2: current - 1 });
        }
      };

      // Автогенерация шорткодов
      autoShortName('team1Name', 'team1Short', 'ХОЗ');
      autoShortName('team2Name', 'team2Short', 'ГОС');

      // Обработчики изменений
      const fields = [
        'team1Name', 'team2Name', 'team1City', 'team2City',
        'kit1Color', 'kit2Color'
      ];
      
      fields.forEach(fieldId => {
        document.getElementById(fieldId).addEventListener('input', () => {
          sendState();
        });
      });

      // Обработка ввода времени
      document.getElementById('timeInput').addEventListener('input', function(e) {
        let v = this.value.replace(/[^\d:]/g, '');
        if (v.length === 2 && !v.includes(':')) v = v + ':';
        if (v.length > 5) v = v.slice(0,5);
        if (v.length === 3 && v[2] !== ':') v = v.slice(0,2) + ':' + v[2];
        if (!/^\d{0,2}:?\d{0,2}$/.test(v)) v = v.slice(0,-1);
        this.value = v;
      });
    }

    // Отправка состояния
    function sendState() {
      if (!ready) return;
      
      // Получаем текущие логотипы из состояния
      const team1Logo = state.team1Logo || '';
      const team2Logo = state.team2Logo || '';
      
      socket.emit('updateScoreboard', {
        team1Name: document.getElementById('team1Name').value,
        team1City: document.getElementById('team1City').value,
        team1Short: document.getElementById('team1Short').value,
        team2Name: document.getElementById('team2Name').value,
        team2City: document.getElementById('team2City').value,
        team2Short: document.getElementById('team2Short').value,
        kit1Color: document.getElementById('kit1Color').value,
        kit2Color: document.getElementById('kit2Color').value,
        team1Logo: team1Logo,
        team2Logo: team2Logo
      });
    }

    // Загрузка предустановок
    async function loadPresets() {
      try {
        const response = await fetch(`/api/presets?token=${getToken()}`);
        presets = await response.json();
        console.log('Loaded presets:', presets);
        renderPresets();
      } catch (error) {
        console.error('Ошибка загрузки предустановок:', error);
      }
    }

    // Отображение предустановок
    function renderPresets() {
      const grid = document.getElementById('presetsGrid');
      grid.innerHTML = '';
      
      presets.forEach(preset => {
        const card = document.createElement('div');
        card.className = 'preset-card';
        card.setAttribute('data-preset-id', preset.id);
        card.innerHTML = `
          <div class="preset-content">
            <div class="preset-left">
              <div class="preset-name">${preset.name}</div>
              <div class="preset-teams">
                <span class="preset-team-logo">${preset.team1Logo ? `<img src="${preset.team1Logo}" alt="Логотип ${preset.team1Name}" class="preset-logo-mini">` : ''}</span>
                <span class="preset-team-name">${preset.team1Short.toUpperCase()}</span>
                <span class="preset-kit-color" style="background-color: ${preset.kit1Color}"></span>
                <span class="preset-separator">:</span>
                <span class="preset-kit-color" style="background-color: ${preset.kit2Color}"></span>
                <span class="preset-team-name">${preset.team2Short.toUpperCase()}</span>
                <span class="preset-team-logo">${preset.team2Logo ? `<img src="${preset.team2Logo}" alt="Логотип ${preset.team2Name}" class="preset-logo-mini">` : ''}</span>
              </div>
            </div>
            <div class="preset-right">
              <span class="preset-edit-link" onclick="editPreset('${preset.id}')">edit</span>
              <button class="preset-play-btn" onclick="confirmApplyPreset('${preset.id}')" ${timerRunning ? 'disabled' : ''} title="Применить предустановку">
                ▶
              </button>
            </div>
          </div>
        `;
        
        grid.appendChild(card);
      });
    }

    // Подтверждение применения предустановки
    function confirmApplyPreset(presetId) {
      const preset = presets.find(p => p.id === presetId);
      if (!preset) return;
      
      // Создание модального окна подтверждения
      const modal = document.createElement('div');
      modal.className = 'confirmation-modal';
      modal.innerHTML = `
        <div class="confirmation-content">
          <h3>Применить предустановку?</h3>
          <p>Вы уверены, что хотите применить предустановку "<strong>${preset.name}</strong>"?</p>
          <p><small>Это заменит текущие данные команд.</small></p>
          <div class="confirmation-buttons">
            <button class="confirmation-btn confirm" onclick="applyPreset('${presetId}'); closeConfirmation()">Да, применить</button>
            <button class="confirmation-btn cancel" onclick="closeConfirmation()">Отмена</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    // Закрытие модального окна
    function closeConfirmation() {
      const modal = document.querySelector('.confirmation-modal');
      if (modal) {
        modal.remove();
      }
    }

    // Применение предустановки
    // Копирование логотипа из пресета в основную панель
    async function copyLogoFromPreset(team, presetLogoUrl) {
      if (!presetLogoUrl) return '';
      
      try {
        // Создаем уникальное имя файла с timestamp
        const timestamp = Date.now();
        const extension = presetLogoUrl.split('.').pop();
        const newFilename = `main_${team}_${timestamp}.${extension}`;
        
        // Копируем файл на сервере
        const response = await fetch(`/api/copy-logo?token=${getToken()}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceUrl: presetLogoUrl,
            newFilename: newFilename
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          return result.url;
        } else {
          console.error('Ошибка копирования логотипа:', await response.text());
          return presetLogoUrl; // Fallback к оригинальному URL
        }
      } catch (error) {
        console.error('Ошибка копирования логотипа:', error);
        return presetLogoUrl; // Fallback к оригинальному URL
      }
    }

    async function applyPreset(presetId) {
      const preset = presets.find(p => p.id === presetId);
      if (!preset) return;
      
      // Применение данных предустановки к основным полям
      document.getElementById('team1Name').value = preset.team1Name;
      document.getElementById('team1City').value = preset.team1City;
      document.getElementById('team1Short').value = preset.team1Short;
      document.getElementById('kit1Color').value = preset.kit1Color;
      
      document.getElementById('team2Name').value = preset.team2Name;
      document.getElementById('team2City').value = preset.team2City;
      document.getElementById('team2Short').value = preset.team2Short;
      document.getElementById('kit2Color').value = preset.kit2Color;
      
      // Копирование логотипов (создание уникальных копий)
      if (preset.team1Logo) {
        const copiedLogoUrl = await copyLogoFromPreset('team1', preset.team1Logo);
        updateMainLogoMini('team1', copiedLogoUrl);
        state.team1Logo = copiedLogoUrl;
      } else {
        showKitColorCircle('team1');
        state.team1Logo = '';
      }
      
      if (preset.team2Logo) {
        const copiedLogoUrl = await copyLogoFromPreset('team2', preset.team2Logo);
        updateMainLogoMini('team2', copiedLogoUrl);
        state.team2Logo = copiedLogoUrl;
      } else {
        showKitColorCircle('team2');
        state.team2Logo = '';
      }
      
      // Отправка обновленного состояния
      sendState();
      
      // Показ уведомления
      showNotification(`Применена предустановка: ${preset.name}`, 'success');
    }

    // Удаление предустановки
    async function deletePreset(presetId) {
      if (!confirm('Удалить эту предустановку?')) return;
      
      try {
        await fetch(`/api/presets/${presetId}?token=${getToken()}`, {
          method: 'DELETE'
        });
        loadPresets();
      } catch (error) {
        console.error('Ошибка удаления предустановки:', error);
      }
    }

    // Сохранение предустановки
    async function saveNewPreset() {
      const preset = {
        name: document.getElementById('addPresetTitle').textContent.trim(),
        team1Name: document.getElementById('addPresetTeam1Name').value.trim(),
        team1City: document.getElementById('addPresetTeam1City').value.trim(),
        team1Short: document.getElementById('addPresetTeam1Short').value.trim().toUpperCase(),
        team2Name: document.getElementById('addPresetTeam2Name').value.trim(),
        team2City: document.getElementById('addPresetTeam2City').value.trim(),
        team2Short: document.getElementById('addPresetTeam2Short').value.trim().toUpperCase(),
        kit1Color: document.getElementById('addPresetKit1Color').value,
        kit2Color: document.getElementById('addPresetKit2Color').value,
        team1Logo: uploadedLogos.team1 || '',
        team2Logo: uploadedLogos.team2 || ''
      };

      // Валидация
      if (!preset.name || preset.name === 'Новая предустановка') {
        alert('Введите название матча');
        return;
      }
      
      if (!preset.team1Name || !preset.team2Name) {
        alert('Введите названия обеих команд');
        return;
      }

      try {
        const response = await fetch(`/api/presets?token=${getToken()}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });

        if (!response.ok) {
          throw new Error('Ошибка сохранения предустановки');
        }

        // Очистка формы
        document.getElementById('addPresetForm').querySelectorAll('input').forEach(input => {
          if (input.type === 'text') input.value = '';
          if (input.type === 'color') {
            if (input.id.includes('Kit1')) input.value = '#2b2b2b';
            if (input.id.includes('Kit2')) input.value = '#2b2b2b';
          }
        });
        
        // Очистка логотипов
        uploadedLogos = { team1: null, team2: null };
        document.getElementById('addPresetTeam1LogoPreview').innerHTML = '';
        document.getElementById('addPresetTeam2LogoPreview').innerHTML = '';
        
        // Скрытие формы
        document.getElementById('addPresetForm').classList.add('hidden');
        
        // Перезагрузка предустановок
        await loadPresets();
        
        // Показ уведомления об успехе
        showNotification('Предустановка создана!', 'success');
        
      } catch (error) {
        console.error('Ошибка сохранения предустановки:', error);
        showNotification('Ошибка сохранения предустановки', 'error');
      }
    }

    async function savePreset() {
      const preset = {
        name: document.getElementById('presetName').value.trim(),
        team1Name: document.getElementById('presetTeam1Name').value.trim(),
        team1City: document.getElementById('presetTeam1City').value.trim(),
        team1Short: document.getElementById('presetTeam1Short').value.trim().toUpperCase(),
        team2Name: document.getElementById('presetTeam2Name').value.trim(),
        team2City: document.getElementById('presetTeam2City').value.trim(),
        team2Short: document.getElementById('presetTeam2Short').value.trim().toUpperCase(),
        kit1Color: document.getElementById('presetKit1Color').value,
        kit2Color: document.getElementById('presetKit2Color').value
      };

      // Валидация
      if (!preset.name) {
        alert('Введите название матча');
        return;
      }
      
      if (!preset.team1Name || !preset.team2Name) {
        alert('Введите названия обеих команд');
        return;
      }

      try {
        const response = await fetch(`/api/presets?token=${getToken()}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });
        
        if (!response.ok) {
          throw new Error('Ошибка сохранения предустановки');
        }
        
        // Очистка формы
        document.getElementById('addPresetForm').querySelectorAll('input').forEach(input => {
          if (input.type === 'text') input.value = '';
          if (input.type === 'color') {
            if (input.id.includes('Kit1')) input.value = '#2b2b2b';
            if (input.id.includes('Kit2')) input.value = '#2b2b2b';
          }
        });
        
        // Скрытие формы
        toggleAddPresetForm();
        
        // Перезагрузка предустановок
        await loadPresets();
        
        // Показ уведомления об успехе
        showNotification('Предустановка сохранена!', 'success');
        
      } catch (error) {
        console.error('Ошибка сохранения предустановки:', error);
        showNotification('Ошибка сохранения предустановки', 'error');
      }
    }

    // Переключение формы добавления предустановки
    function toggleAddPresetForm() {
      const form = document.getElementById('addPresetForm');
      form.classList.toggle('hidden');
    }
    
    function cancelAddPreset() {
      // Очистка формы
      document.getElementById('addPresetForm').querySelectorAll('input').forEach(input => {
        if (input.type === 'text') input.value = '';
        if (input.type === 'color') {
          if (input.id.includes('Kit1')) input.value = '#2b2b2b';
          if (input.id.includes('Kit2')) input.value = '#2b2b2b';
        }
      });
      
      // Очистка логотипов
      uploadedLogos = { team1: null, team2: null };
      document.getElementById('addPresetTeam1LogoPreview').innerHTML = '';
      document.getElementById('addPresetTeam2LogoPreview').innerHTML = '';
      
      // Скрытие формы
      document.getElementById('addPresetForm').classList.add('hidden');
    }
    
    // Редактирование предустановки
    function editPreset(presetId) {
      const preset = presets.find(p => p.id === presetId);
      if (!preset) return;
      
      editingPresetId = presetId;
      
      // Сохраняем исходные данные для сравнения
      originalPresetData = {
        name: preset.name,
        team1Name: preset.team1Name,
        team1City: preset.team1City,
        team1Short: preset.team1Short,
        kit1Color: preset.kit1Color,
        team2Name: preset.team2Name,
        team2City: preset.team2City,
        team2Short: preset.team2Short,
        kit2Color: preset.kit2Color
      };
      
      // Заполняем форму редактирования
      document.getElementById('editPresetTitle').textContent = preset.name;
      document.getElementById('editPresetTeam1Name').value = preset.team1Name;
      document.getElementById('editPresetTeam1City').value = preset.team1City;
      document.getElementById('editPresetTeam1Short').value = preset.team1Short;
      document.getElementById('editPresetKit1Color').value = preset.kit1Color;
      document.getElementById('editPresetTeam2Name').value = preset.team2Name;
      document.getElementById('editPresetTeam2City').value = preset.team2City;
      document.getElementById('editPresetTeam2Short').value = preset.team2Short;
      document.getElementById('editPresetKit2Color').value = preset.kit2Color;
      
      // Загружаем логотипы если есть
      if (preset.team1Logo) {
        showLogoPreview('team1', preset.team1Logo);
        updateLogoMini('team1', preset.team1Logo);
        uploadedLogos.team1 = preset.team1Logo;
        console.log('Loaded team1 logo:', preset.team1Logo);
      } else {
        clearLogo('team1');
        updateLogoMini('team1', null);
        uploadedLogos.team1 = null;
      }
      
      if (preset.team2Logo) {
        showLogoPreview('team2', preset.team2Logo);
        updateLogoMini('team2', preset.team2Logo);
        uploadedLogos.team2 = preset.team2Logo;
        console.log('Loaded team2 logo:', preset.team2Logo);
      } else {
        clearLogo('team2');
        updateLogoMini('team2', null);
        uploadedLogos.team2 = null;
      }
      
      // Скрываем карточку пресета и показываем форму редактирования на ее месте
      const presetCard = document.querySelector(`[data-preset-id="${presetId}"]`);
      if (presetCard) {
        presetCard.style.display = 'none';
        const editForm = document.getElementById('editPresetForm');
        
        // Полностью сбрасываем форму перед перемещением
        const presetsSection = document.querySelector('.presets-section');
        
        // Если форма не в правильном месте, принудительно перемещаем
        if (editForm.parentNode && editForm.parentNode !== presetsSection) {
          editForm.parentNode.removeChild(editForm);
          presetsSection.appendChild(editForm);
        }
        
        // Сбрасываем все стили формы
        editForm.style.position = '';
        editForm.style.top = '';
        editForm.style.left = '';
        editForm.style.display = 'block';
        editForm.classList.remove('hidden');
        
        // Вставляем форму после карточки пресета
        presetCard.parentNode.insertBefore(editForm, presetCard.nextSibling);
      }
    }
    
    // Обновление предустановки
    async function updatePreset() {
      if (!editingPresetId) return;
      
      const preset = {
        name: document.getElementById('editPresetTitle').textContent.trim(),
        team1Name: document.getElementById('editPresetTeam1Name').value.trim(),
        team1City: document.getElementById('editPresetTeam1City').value.trim(),
        team1Short: document.getElementById('editPresetTeam1Short').value.trim().toUpperCase(),
        team2Name: document.getElementById('editPresetTeam2Name').value.trim(),
        team2City: document.getElementById('editPresetTeam2City').value.trim(),
        team2Short: document.getElementById('editPresetTeam2Short').value.trim().toUpperCase(),
        kit1Color: document.getElementById('editPresetKit1Color').value,
        kit2Color: document.getElementById('editPresetKit2Color').value,
        team1Logo: uploadedLogos.team1 || '',
        team2Logo: uploadedLogos.team2 || ''
      };
      
      console.log('Saving preset with logos:', {
        team1Logo: preset.team1Logo,
        team2Logo: preset.team2Logo,
        uploadedLogos: uploadedLogos
      });

      // Валидация
      if (!preset.name) {
        alert('Введите название матча');
        return;
      }
      
      if (!preset.team1Name || !preset.team2Name) {
        alert('Введите названия обеих команд');
        return;
      }

      try {
        const response = await fetch(`/api/presets/${editingPresetId}?token=${getToken()}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });
        
        if (!response.ok) {
          throw new Error('Ошибка обновления предустановки');
        }
        
        // Скрытие формы
        cancelEditPreset();
        
        // Перезагрузка предустановок
        await loadPresets();
        
        // Показ уведомления об успехе
        showNotification('Предустановка обновлена!', 'success');
        
      } catch (error) {
        console.error('Ошибка обновления предустановки:', error);
        showNotification('Ошибка обновления предустановки', 'error');
      }
    }
    
    // Отмена редактирования
    function cancelEditPreset() {
      editingPresetId = null;
      originalPresetData = null;
      
      // Восстанавливаем все карточки пресетов
      const presetCards = document.querySelectorAll('.preset-card');
      presetCards.forEach(card => {
        card.style.display = '';
      });
      
      // Полностью сбрасываем форму редактирования
      const editForm = document.getElementById('editPresetForm');
      const presetsSection = document.querySelector('.presets-section');
      
      // Принудительно перемещаем форму в конец секции пресетов
      if (editForm.parentNode) {
        editForm.parentNode.removeChild(editForm);
      }
      presetsSection.appendChild(editForm);
      
      // Скрываем форму
      editForm.classList.add('hidden');
      editForm.style.display = 'none';
      
      // Сбрасываем все состояния формы
      editForm.style.position = '';
      editForm.style.top = '';
      editForm.style.left = '';
    }
    
    // Удаление предустановки из формы редактирования
    async function deletePresetFromEdit() {
      if (!editingPresetId) return;
      
      if (!confirm('Удалить эту предустановку? Это действие нельзя отменить.')) return;
      
      try {
        const response = await fetch(`/api/presets/${editingPresetId}?token=${getToken()}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          throw new Error('Ошибка удаления предустановки');
        }
        
        // Скрытие формы
        cancelEditPreset();
        
        // Перезагрузка предустановок
        await loadPresets();
        
        // Показ уведомления об успехе
        showNotification('Предустановка удалена! Логотипы, используемые в активной секции, защищены от удаления.', 'success');
        
      } catch (error) {
        console.error('Ошибка удаления предустановки:', error);
        showNotification('Ошибка удаления предустановки', 'error');
      }
    }

    // Автогенерация шорткодов
    function autoShortName(fullId, shortId, def) {
      const fullInput = document.getElementById(fullId);
      const shortInput = document.getElementById(shortId);
      let manual = false;

      function updateShort() {
        if (!manual) {
          shortInput.value = (fullInput.value || def).toUpperCase().slice(0,3);
        }
      }
      fullInput.addEventListener('input', updateShort);
      shortInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/[^A-ZА-ЯЁ0-9]/gi, '').slice(0,3);
        manual = true;
      });
      updateShort();
    }

    // Обновление UI при получении данных
    socket.on('scoreboardUpdate', (data) => {
      ready = false;
      
      // Обновление таймера
      const isRunning = !!data.timerRunning;
      timerRunning = isRunning;
      setPlayPauseIcon('playPauseIcon', isRunning);
      setTimeInputFromSeconds('timeInput', data.timerSeconds || 0);
      document.getElementById('timeInput').disabled = isRunning;
      
      // Показ/скрытие предупреждения о таймере
      const warning = document.getElementById('timerWarning');
      if (isRunning) {
        warning.classList.remove('hidden');
      } else {
        warning.classList.add('hidden');
      }
      
      // Блокировка полей ввода команд во время работы таймера
      const fieldsToDisable = [
        'team1Name', 'team1City', 'team1Short', 'kit1Color',
        'team2Name', 'team2City', 'team2Short', 'kit2Color'
      ];
      
      fieldsToDisable.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (isRunning) {
          field.classList.add('disabled-field');
        } else {
          field.classList.remove('disabled-field');
        }
      });
      
      // Кнопка добавления предустановки всегда доступна
      const addBtn = document.getElementById('addPresetBtn');
      addBtn.disabled = false;
      addBtn.textContent = '+ Добавить предустановку';
      
      // Блокировка только кнопок применения предустановок
      const playButtons = document.querySelectorAll('.preset-play-btn');
      playButtons.forEach(btn => {
        if (isRunning) {
          btn.disabled = true;
          btn.title = 'Нельзя применять предустановки во время работы таймера';
        } else {
          btn.disabled = false;
          btn.title = 'Применить предустановку';
        }
      });
      
      // Обновление счета
      document.getElementById('score1Value').textContent = data.score1 ?? 0;
      document.getElementById('score2Value').textContent = data.score2 ?? 0;
      
      // Обновление команд
      document.getElementById('team1Short').value = data.team1Short ?? "";
      document.getElementById('team2Short').value = data.team2Short ?? "";
      document.getElementById('kit1Color').value = data.kit1Color ?? "#2b2b2b";
      document.getElementById('kit2Color').value = data.kit2Color ?? "#2b2b2b";
      document.getElementById('team1Name').value = data.team1Name ?? "";
      document.getElementById('team2Name').value = data.team2Name ?? "";
      document.getElementById('team1City').value = data.team1City ?? "";
      document.getElementById('team2City').value = data.team2City ?? "";
      
      // Обновление логотипов
      state.team1Logo = data.team1Logo || '';
      state.team2Logo = data.team2Logo || '';
      
      if (data.team1Logo) {
        updateMainLogoMini('team1', data.team1Logo);
      } else {
        showKitColorCircle('team1');
      }
      
      if (data.team2Logo) {
        updateMainLogoMini('team2', data.team2Logo);
      } else {
        showKitColorCircle('team2');
      }
      
      // Перерисовка предустановок с учетом состояния таймера
      renderPresets();
      
      setTimeout(() => { ready = true; }, 50);
    });

    // Вспомогательные функции
    function setPlayPauseIcon(iconId, isPlaying) {
      const icon = document.getElementById(iconId);
      icon.innerHTML = isPlaying
        ? `<rect x="8" y="6" width="5" height="20" fill="white"/><rect x="19" y="6" width="5" height="20" fill="white"/>`
        : `<polygon points="8,6 26,16 8,26" fill="white"/>`;
    }

    function setTimeInputFromSeconds(inputId, sec) {
      const input = document.getElementById(inputId);
      const mm = Math.floor(sec/60).toString().padStart(2, '0');
      const ss = (sec%60).toString().padStart(2, '0');
      input.value = `${mm}:${ss}`;
    }

    function getSecondsFromTimeInput(inputId) {
      const val = document.getElementById(inputId).value;
      if (/^\d{2}:\d{2}$/.test(val)) {
        const [mm, ss] = val.split(':').map(Number);
        return mm*60 + ss;
      }
      return 0;
    }

    function getToken() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token') || 'MySecret111';
    }
    
    // Функция показа уведомлений
    function showNotification(message, type = 'info') {
      // Создание элемента уведомления
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
        color: white;
        padding: 12px 20px;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 10000;
        font-size: 14px;
        max-width: 300px;
        animation: slideIn 0.3s ease-out;
      `;
      notification.textContent = message;
      
      // Добавление стилей анимации
      if (!document.getElementById('notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
          @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(notification);
      
      // Автоматическое удаление через 3 секунды
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }
  </script>
</body>
</html>