<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>FSCOREBOARD Control Panel</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 800px; 
      margin: 20px auto; 
      background: #f4f4f4; 
      padding: 30px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .presets-section {
      background: #fff;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(22, 61, 116, 0.08);
      border: 1px solid #c5d9ff;
    }
    
    .presets-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding: 0 4px;
    }
    
    .presets-header h2 {
      color: #163d74;
      font-weight: 600;
      margin: 0;
    }
    
    .presets-grid {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }
    
    .preset-card {
      background: #ffffff;
      border: 1px solid #c5d9ff;
      border-radius: 12px;
      padding: 9px 10px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(22, 61, 116, 0.08);
    }
    
    .preset-card:hover {
      border-color: #338af3;
      background: #f8fbff;
      box-shadow: 0 4px 12px rgba(51, 138, 243, 0.15);
      transform: translateY(-1px);
    }
    
    .preset-name {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 6px;
      color: #1f2d3d;
    }
    
    .preset-shortcodes {
      font-weight: normal;
      color: #61708a;
      font-size: 13px;
      margin-left: 8px;
    }
    
    .preset-teams {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    
    .preset-team {
      text-align: center;
      flex: 1;
    }
    
    .preset-team-name {
      font-weight: 600;
      color: #163d74;
    }
    
    .preset-team-city {
      font-size: 13px;
      color: #61708a;
    }
    
    .preset-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      box-shadow: 0 2px 6px rgba(51, 138, 243, 0.25);
    }
    
    .btn-primary {
      background: #338af3;
      color: white;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
      box-shadow: 0 2px 6px rgba(220, 53, 69, 0.25);
    }
    
    .btn:hover {
      opacity: 0.9;
      box-shadow: 0 4px 10px rgba(51, 138, 243, 0.35);
      transform: translateY(-1px);
    }
    
    .btn-danger:hover {
      box-shadow: 0 4px 10px rgba(220, 53, 69, 0.35);
    }
    
    .add-preset-form {
      background: #ffffff;
      border-radius: 12px;
      padding: 9px 10px;
      margin-top: 12px;
      border: 1px solid #c5d9ff;
      box-shadow: 0 2px 8px rgba(22, 61, 116, 0.08);
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .form-group {
      flex: 1;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .form-group input[type="color"] {
      width: 60px;
      height: 40px;
      padding: 0;
    }
    
    .camera-content {
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: 0 2px 8px rgba(22, 61, 116, 0.08);
      border: 1px solid #c5d9ff;
    }

    .penalty-toggle-row {
      margin-top: 12px;
      padding: 8px;
      border-top: 1px dashed #d8e3f6;
      background: #f8fbff;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .penalty-toggle-info {
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: #2f3a4c;
    }

    .penalty-toggle-info h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #1f2d3d;
    }

    .penalty-toggle-info span {
      font-size: 13px;
      color: #61708a;
      line-height: 1.4;
    }

    .penalty-switch {
      position: relative;
      display: inline-block;
      width: 58px;
      height: 30px;
      flex-shrink: 0;
    }

    .penalty-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .penalty-switch-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e1;
      transition: 0.3s;
      border-radius: 30px;
    }

    .penalty-switch-slider:before {
      position: absolute;
      content: "";
      height: 24px;
      width: 24px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .penalty-switch input:checked + .penalty-switch-slider {
      background-color: #338af3;
    }

    .penalty-switch input:checked + .penalty-switch-slider:before {
      transform: translateX(28px);
    }

    .penalty-controls {
      margin-top: 8px;
      padding: 9px 10px;
      border: 1px solid #c5d9ff;
      border-radius: 12px;
      background: #eef4ff;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .penalty-controls-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      color: #163d74;
      font-weight: 600;
    }
    
    .penalty-controls-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .penalty-stadium-mode-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    .penalty-stadium-mode-label {
      font-size: 12px;
      color: #61708a;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .penalty-stadium-mode-buttons {
      display: inline-flex;
      gap: 0;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #d8e3f6;
      background: #f8fbff;
      visibility: visible;
    }
    
    .penalty-controls.hidden .penalty-stadium-mode-wrapper {
      opacity: 0.3;
    }
    
    .penalty-controls.hidden .penalty-stadium-mode-buttons {
      display: inline-flex !important;
      visibility: visible !important;
    }
    
    .penalty-stadium-mode-btn {
      border: none;
      border-radius: 0;
      background: #f8fbff;
      color: #61708a;
      font-weight: 400;
      font-size: 11px;
      padding: 5px 12px;
      cursor: pointer;
      box-shadow: none;
      transition: all 0.15s;
      position: relative;
      white-space: nowrap;
    }
    
    .penalty-stadium-mode-btn:first-child {
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
      border-right: 1px solid #d8e3f6;
    }
    
    .penalty-stadium-mode-btn:last-child {
      border-top-right-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    
    .penalty-stadium-mode-btn.active {
      background: #338af3;
      color: #fff;
      font-weight: 600;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
    }
    
    .penalty-stadium-mode-btn:not(.active):not(:disabled):hover {
      background: #eef4ff;
      color: #4c5d7a;
    }
    
    .penalty-stadium-mode-btn:disabled {
      background: #f8fbff;
      color: #c5d0e0;
      cursor: default;
      opacity: 0.4;
    }
    
    .penalty-stadium-mode-buttons.disabled {
      opacity: 0.3;
      pointer-events: none;
    }

    .penalty-controls-note {
      font-size: 13px;
      color: #4c5d7a;
      line-height: 1.5;
    }

    .penalty-mode-wrapper {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    .penalty-mode-label {
      font-size: 12px;
      color: #61708a;
      font-weight: 500;
      white-space: nowrap;
    }
    
    .penalty-mode-buttons {
      display: inline-flex;
      gap: 0;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #d8e3f6;
      background: #f8fbff;
      visibility: visible;
    }
    
    .penalty-controls.hidden .penalty-mode-wrapper {
      opacity: 0.3;
    }
    
    .penalty-controls.hidden .penalty-mode-buttons {
      display: inline-flex !important;
      visibility: visible !important;
    }
    
    .penalty-mode-btn {
      border: none;
      border-radius: 0;
      background: #f8fbff;
      color: #61708a;
      font-weight: 400;
      font-size: 11px;
      padding: 5px 12px;
      cursor: pointer;
      box-shadow: none;
      transition: all 0.15s;
      position: relative;
      white-space: nowrap;
    }
    
    .penalty-mode-btn:first-child {
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
      border-right: 1px solid #d8e3f6;
    }
    
    .penalty-mode-btn:last-child {
      border-top-right-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    
    .penalty-mode-btn.active {
      background: #338af3;
      color: #fff;
      font-weight: 600;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
    }
    
    .penalty-mode-btn:not(.active):hover {
      background: #eef4ff;
      color: #4c5d7a;
    }
    
    .penalty-mode-btn:disabled {
      background: #f8fbff;
      color: #a3a9b8;
      cursor: default;
      opacity: 0.6;
    }

    .penalty-series-board {
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-top: 1px dashed #c5d9ff;
      padding-top: 8px;
    }

    .penalty-teams-container {
      display: flex;
      align-items: stretch;
      gap: 12px;
      width: 100%;
    }
    
    .penalty-team-block {
      flex: 1;
      background: #ffffff;
      border-radius: 14px;
      padding: 9px 10px;
      display: flex;
      flex-direction: column;
      gap: 9px;
      box-shadow: 0 2px 8px rgba(22, 61, 116, 0.08);
      position: relative;
      transition: box-shadow 0.2s, border 0.2s;
      border: 3px solid transparent;
      box-sizing: border-box;
    }

    .penalty-team-block.active {
      border-color: rgba(142, 153, 174, 0.32);
      box-shadow: 0 2px 8px rgba(22, 61, 116, 0.08);
    }

    .penalty-team-block:not(:first-child)::before {
      content: "";
      position: absolute;
      left: -12px;
      top: 24px;
      bottom: 24px;
      width: 1px;
      background: linear-gradient(to bottom, rgba(103, 132, 189, 0), rgba(103, 132, 189, 0.35), rgba(103, 132, 189, 0));
    }

    .penalty-team-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .penalty-team-info-wrapper {
      display: flex;
      align-items: center;
      gap: 14px;
      flex: 1;
      min-width: 0;
    }

    .penalty-team-logo {
      width: 52px;
      height: 52px;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      flex-shrink: 0;
    }

    .penalty-team-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .penalty-team-logo span {
      font-size: 24px;
      font-weight: 700;
      color: #2f3a4c;
    }

    .penalty-team-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .penalty-team-name {
      font-size: 16px;
      font-weight: 600;
      color: #1f2d3d;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .penalty-team-meta {
      font-size: 12px;
      color: #61708a;
    }

    .penalty-team-score {
      font-size: 28px;
      font-weight: 700;
      color: #163d74;
      min-width: 32px;
    }

    .penalty-team-block.team-left .penalty-team-score {
      text-align: right;
      margin-left: auto;
    }

    .penalty-team-block.team-right .penalty-team-score {
      text-align: left;
      margin-right: auto;
    }

    .penalty-team-block.team-right .penalty-team-info-wrapper {
      justify-content: flex-end;
    }

    .penalty-team-block.team-right .penalty-team-info {
      text-align: right;
    }

    .penalty-attempts-track {
      display: flex;
      justify-content: center;
      gap: 14px;
      flex-wrap: wrap;
    }

    .penalty-attempt-wrapper {
      display: grid;
      grid-template-rows: 32px 40px 32px;
      justify-items: center;
      align-items: center;
      gap: 6px;
      min-width: 48px;
      transition: transform 0.2s, opacity 0.2s, width 0.2s;
    }

    .penalty-attempt-wrapper .penalty-action-button.goal-btn {
      grid-row: 1;
    }

    .penalty-attempt-wrapper .penalty-attempt {
      grid-row: 2;
    }

    .penalty-attempt-wrapper .penalty-action-button.miss-btn {
      grid-row: 3;
    }

    .penalty-attempt-wrapper-history {
      opacity: 0.85;
    }

    .penalty-attempt {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: transform 0.2s;
    }

    .penalty-attempt.goal {
      background: #1fb368;
    }

    .penalty-attempt.miss {
      background: #d82727;
    }

    .penalty-attempt.pending {
      width: 20px;
      height: 20px;
      background: #dce2f0;
      opacity: 0.8;
    }

    .penalty-attempt-wrapper-history .penalty-attempt.pending {
      width: 16px;
      height: 16px;
      opacity: 0.6;
    }

    .penalty-attempt {
      box-sizing: border-box;
      border: 2px solid transparent;
    }
    
    .penalty-attempt.active {
      background: #d9deea;
      box-shadow: 0 2px 6px rgba(171, 181, 199, 0.35);
      border-color: rgba(171, 181, 199, 0.35);
    }

    .penalty-attempt.goal::after,
    .penalty-attempt.miss::after {
      content: "";
      position: absolute;
      inset: 4px;
      border-radius: 50%;
      background: rgba(255,255,255,0.15);
    }

    .penalty-action-button {
      border: none;
      border-radius: 10px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.18);
      transition: transform 0.2s, filter 0.2s;
      min-width: 48px;
    }

    .penalty-action-button.goal-btn {
      background: #1fb368;
    }

    .penalty-action-button.miss-btn {
      background: #d82727;
    }

    .penalty-action-button:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    .penalty-header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .penalty-undo-btn {
      border: none;
      border-radius: 999px;
      background: #e4e7ef;
      color: #1f2d3d;
      font-weight: 600;
      font-size: 12px;
      padding: 6px 16px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(130, 141, 162, 0.25);
      transition: transform 0.15s, filter 0.15s;
    }

    .penalty-undo-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    .penalty-undo-btn:disabled {
      background: #ebedf3;
      color: #a3a9b8;
      box-shadow: none;
      cursor: default;
      transform: none;
    }

    @media (max-width: 880px) {
      .penalty-teams-container {
        flex-direction: column;
      }

      .penalty-attempts-track {
        gap: 25px;
        flex-wrap: nowrap;
      }

      .penalty-attempt-wrapper {
        min-width: 0;
        flex: 0 0 auto;
        width: auto;
        grid-template-rows: 26px 32px 26px;
        gap: 3px;
      }

      .penalty-attempt {
        width: 24px;
        height: 24px;
      }
      
      .penalty-action-button {
        border-radius: 6px;
        padding: 3px 6px;
        font-size: 10px;
        min-width: 36px;
      }

      .penalty-attempt.pending {
        width: 16px;
        height: 16px;
      }

      .penalty-team-block {
        padding: 16px;
      }

      .penalty-team-block:not(:first-child)::before {
        content: "";
        position: absolute;
        top: 0;
        left: 16px;
        right: 16px;
        height: 1px;
        background: rgba(103, 132, 189, 0.3);
      }

      .penalty-team-block:not(:first-child) {
        margin-top: 12px;
      }

      .penalty-team-header {
        align-items: flex-start;
      }
    }

    .penalty-series-summary {
      font-size: 13px;
      color: #3d4f6b;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }

    .penalty-series-summary span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .penalty-series-summary strong {
      color: #163d74;
      font-size: 15px;
    }
    
    .timer-row { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 16px; 
      margin: 0 0 12px 0;
      padding: 9px 10px;
      background: #f8fbff;
      border: 1px solid #d8e3f6;
      border-radius: 12px;
    }
    
    .playpause-btn, .set-btn {
      width: 56px; 
      height: 44px;
      background: #338af3; 
      color: #fff; 
      border: none; 
      border-radius: 10px;
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 2em; 
      cursor: pointer; 
      transition: background 0.2s, box-shadow 0.2s, transform 0.2s;
      box-shadow: 0 2px 6px rgba(51, 138, 243, 0.25);
    }
    
    .playpause-btn:hover, .set-btn:hover { 
      background: #2561a7;
      box-shadow: 0 4px 12px rgba(51, 138, 243, 0.35);
      transform: translateY(-1px);
    }
    
    .timer-inputs {
      display: flex; 
      align-items: center; 
      gap: 8px;
      background: #fff; 
      border-radius: 10px; 
      padding: 8px 12px;
      border: 1px solid #c5d9ff;
      box-shadow: 0 1px 3px rgba(22, 61, 116, 0.1);
    }
    
    .timer-inputs input[type="text"] {
      width: 80px; 
      font-size: 1.2em; 
      text-align: center; 
      border: none; 
      background: none; 
      outline: none;
      letter-spacing: 2px;
      color: #163d74;
      font-weight: 600;
    }
    
    .score-row { 
      display: flex; 
      flex-direction: column;
      justify-content: center; 
      align-items: stretch;
      gap: 12px; 
      margin-top: 0;
      padding: 10px;
      background: #f8fbff;
      border: 1px solid #d8e3f6;
      border-radius: 12px;
    }
    
    .score-upper-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      width: 100%;
    }
    
    .score-upper-section {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      flex: 1;
      padding: 6px 0;
      gap: 8px;
    }
    
    .team-logo-section-upper {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }
    
    .team-short-display-upper {
      font-size: 1.2em;
      font-weight: 600;
      color: #163d74;
      text-transform: uppercase;
      letter-spacing: 2px;
      min-width: 50px;
      text-align: center;
      margin-top: 4px;
    }
    
    .score-blocks-container {
      display: flex;
      justify-content: center;
      align-items: stretch;
      gap: 12px;
    }
    
    .divider-upper {
      width: 1px;
      background: linear-gradient(to bottom, rgba(103, 132, 189, 0), rgba(103, 132, 189, 0.35), rgba(103, 132, 189, 0));
      margin: 0;
      flex-shrink: 0;
    }
    
    .score-block { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      padding: 9px 10px;
      min-width: 120px;
      flex: 1;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(22, 61, 116, 0.08);
      gap: 9px;
    }
    
    .score-controls { 
      display: flex; 
      gap: 6px; 
      margin-bottom: 0;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    .score-divider {
      width: 1px;
      height: 30px;
      background: linear-gradient(to bottom, rgba(103, 132, 189, 0), rgba(103, 132, 189, 0.35), rgba(103, 132, 189, 0));
      flex-shrink: 0;
    }
    
    .score-btn {
      background: #338af3; 
      color: #fff; 
      border: none; 
      border-radius: 10px;
      width: 34px; 
      height: 48px; 
      font-size: 1.3em; 
      font-weight: bold; 
      cursor: pointer;
      display: flex; 
      align-items: center; 
      justify-content: center;
      transition: background 0.2s, box-shadow 0.2s, transform 0.2s;
      box-shadow: 0 2px 5px rgba(51, 138, 243, 0.25);
      flex-shrink: 0;
    }
    
    .score-btn:hover { 
      background: #2561a7;
      box-shadow: 0 4px 10px rgba(51, 138, 243, 0.35);
      transform: translateY(-1px);
    }
    
    .score-value { 
      font-size: 2em; 
      color: #163d74;
      font-weight: 700;
      min-width: 32px; 
      text-align: center;
      flex-shrink: 0;
      margin: 0 2px;
    }
    
    .team-logo-section {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .short-label-row { 
      margin-top: 0; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 10px;
      margin-bottom: 6px;
    }
    
    .short-label-row input[type="text"] {
      width: 50px; 
      text-align: center; 
      font-size: 1.2em; 
      border-radius: 10px; 
      border: 1px solid #c5d9ff; 
      padding: 6px 0;
      background: #fff; 
      text-transform: uppercase; 
      font-weight: 600; 
      letter-spacing: 2px;
      color: #163d74;
      box-shadow: 0 1px 3px rgba(22, 61, 116, 0.1);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .short-label-row input[type="text"]:focus {
      outline: none;
      border-color: #338af3;
      box-shadow: 0 0 0 3px rgba(51, 138, 243, 0.1);
    }
    
    .kit-block { 
      display: flex; 
      flex-direction: row; 
      align-items: center; 
      justify-content: center; 
      gap: 8px; 
      width: auto; 
    }
    
    .kit-color {
      width: 100px; 
      height: 32px; 
      border-radius: 10px; 
      border: 1px solid #c5d9ff;
      background: none; 
      margin: 0; 
      padding: 0; 
      cursor: pointer; 
      display: block;
      box-shadow: 0 1px 3px rgba(22, 61, 116, 0.1);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .kit-color:disabled {
      opacity: 1 !important;
      filter: none !important;
      -webkit-filter: none !important;
    }
    
    .kit-color:hover {
      border-color: #338af3;
      box-shadow: 0 2px 6px rgba(51, 138, 243, 0.2);
    }
    
    .label-caption {
      font-size: 0.85em; 
      color: #61708a; 
      margin-bottom: 6px; 
      text-align: center; 
      font-weight: 500; 
      letter-spacing: 0.5px;
    }
    
    .team-input-row { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      width: 100%; 
      gap: 6px; 
      margin-top: 0; 
    }
    .team-input-row input[type="text"] {
      width: 100%;
      text-align: center; 
      font-size: 1em; 
      border-radius: 10px; 
      border: 1px solid #c5d9ff; 
      padding: 8px 12px;
      background: #fff; 
      color: #1f2d3d; 
      font-weight: 600;
      box-shadow: 0 1px 3px rgba(22, 61, 116, 0.1);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .team-input-row input[type="text"]:focus {
      outline: none;
      border-color: #338af3;
      box-shadow: 0 0 0 3px rgba(51, 138, 243, 0.1);
    }
    .city-input-row input[type="text"] {
      width: 100%;
      text-align: center; 
      font-size: 1em; 
      border-radius: 10px; 
      border: 1px solid #c5d9ff; 
      padding: 8px 12px;
      background: #fff; 
      color: #61708a; 
      font-weight: normal;
      box-shadow: 0 1px 3px rgba(22, 61, 116, 0.1);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .city-input-row input[type="text"]:focus {
      outline: none;
      border-color: #338af3;
      box-shadow: 0 0 0 3px rgba(51, 138, 243, 0.1);
    }
    
    .divider { 
      width: 1px; 
      background: linear-gradient(to bottom, rgba(103, 132, 189, 0), rgba(103, 132, 189, 0.35), rgba(103, 132, 189, 0));
      margin: 24px 0;
      flex-shrink: 0;
    }
    
    .hidden {
      display: none;
    }
    
    .version-info {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 0.6em;
      color: #ccc;
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 6px;
      border-radius: 3px;
      opacity: 0.7;
      z-index: 1000;
    }
    
    .preset-card {
      display: block;
      background: #fff;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 8px;
      box-sizing: border-box;
      width: 100%;
      max-width: 100%;
    }
    
    .preset-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }
    
    .preset-left {
      display: flex;
      align-items: flex-start;
      min-width: 0;
      overflow: hidden;
      flex-direction: column;
      gap: 8px;
    }
    
    .preset-name {
      font-weight: bold;
      font-size: 14px;
      margin-right: 0;
      white-space: nowrap;
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 4px;
      align-self: flex-start;
    }
    
    .preset-teams {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
      align-self: flex-start;
      flex-wrap: nowrap;
    }
    
    .preset-right {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      align-self: flex-start;
    }
    
    .preset-team-name {
      font-size: 14px;
      white-space: nowrap;
    }
    
    .preset-separator {
      font-size: 14px;
      color: #666;
      margin: 0 2px;
    }
    
    .preset-kit-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      border: 1px solid #ccc;
      display: inline-block;
      flex-shrink: 0;
    }
    
    .preset-edit-link {
      color: #999;
      text-decoration: underline;
      text-decoration-style: dashed;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .preset-edit-link:hover {
      color: #666;
    }
    
    /* Убрали transition для day-header чтобы не было движения при наведении */
    
    /* Убрали hover эффект для day-header - только клик меняет состояние */
    
    .tournament-day-section {
      display: flex;
      flex-direction: column;
      width: 100%;
      box-sizing: border-box;
    }
    
    .day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: nowrap;
      width: 100%;
      box-sizing: border-box;
      cursor: pointer;
      padding-left: 0;
    }
    
    .day-header > div:first-child {
      display: flex;
      align-items: center;
      flex-wrap: nowrap;
      flex: 1;
      min-width: 0;
      padding-left: 0;
      margin-left: 0;
    }
    
    .day-toggle-arrow {
      cursor: pointer;
      user-select: none;
      padding: 0;
      display: inline-block;
      font-size: 14px;
      font-weight: normal;
      color: #999;
      vertical-align: middle;
      transition: color 0.2s;
      flex-shrink: 0;
      width: 14px;
      text-align: center;
      line-height: 1;
      margin-left: 0;
      margin-right: 4px;
    }
    
    .day-toggle-arrow::before {
      content: '-';
      color: #999;
      font-weight: normal;
      font-size: 14px;
    }
    
    .day-toggle-arrow.expanded {
      color: #000;
      font-weight: normal;
    }
    
    .day-toggle-arrow.expanded::before {
      content: '+';
      color: #000;
      font-weight: normal;
      font-size: 14px;
    }
    
    /* Убрали hover эффект для day-toggle-arrow - только клик */
    
    .preset-apply-symbol {
      cursor: pointer;
      user-select: none;
      padding: 0;
      display: inline-block;
      width: 0;
      height: 0;
      border-style: solid;
      border-width: 5px 0 5px 7px;
      border-color: transparent transparent transparent #1976d2;
      vertical-align: middle;
      transition: border-color 0.2s;
      flex-shrink: 0;
    }
    
    .preset-apply-symbol:hover {
      border-color: transparent transparent transparent #1565c0;
    }
    
    .preset-apply-symbol[style*="opacity: 0.5"] {
      pointer-events: none;
      border-color: transparent transparent transparent #999;
    }
    
    .preset-play-btn {
      padding: 6px 12px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    
    .preset-play-btn:hover:not(:disabled) {
      background: #1565c0;
    }
    
    .preset-play-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .confirmation-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    
    .confirmation-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      text-align: center;
    }
    
    .confirmation-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 16px;
    }
    
    .confirmation-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .confirmation-btn.confirm {
      background: #28a745;
      color: white;
    }
    
    .confirmation-btn.confirm:hover {
      background: #218838;
    }
    
    .confirmation-btn.cancel {
      background: #6c757d;
      color: white;
    }
    
    .confirmation-btn.cancel:hover {
      background: #5a6268;
    }
    /* Мобильная адаптивность */
    @media (max-width: 768px) {
      body {
        font-size: 16px;
        padding: 5px;
      }
      
      /* Стили для карточки турнира в мобильной версии */
      .tournament-card {
        box-sizing: border-box;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
      }
      
      .tournament-card {
        padding: 0 !important;
        margin: 0 !important;
      }
      
      .tournament-card > div:first-child {
        display: flex !important;
        justify-content: flex-start !important;
        align-items: center !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        padding: 5px 8px !important;
        flex-wrap: nowrap !important;
        gap: 4px !important;
        margin: 0 !important;
      }
      
      .tournament-card > div:first-child > div:first-child {
        flex: 1 !important;
        min-width: 0 !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow: hidden !important;
        padding: 0 !important;
        margin: 0 !important;
      }
      
      /* Стиль для ссылки +add в блоке пресетов */
      .tournament-presets {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        padding: 0 !important;
        overflow-x: hidden !important;
      }
      
      .tournament-presets > * {
        padding-left: 2px !important;
        padding-right: 2px !important;
        box-sizing: border-box !important;
      }
      
      .tournament-presets > div:first-child {
        display: flex !important;
        justify-content: flex-end !important;
        align-items: flex-start !important;
        width: 100% !important;
        margin-bottom: 4px !important;
        padding: 0 5px !important;
        box-sizing: border-box !important;
      }
      
      .tournament-presets .preset-edit-link {
        text-align: right !important;
      }
      
      /* Стили для формы создания пресета в мобильной версии - точно как форма редактирования */
      /* Специфичные стили для Safari на iPhone */
      [id^="presetFormContent_"] {
        box-sizing: border-box !important;
        width: 100% !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
        -webkit-overflow-scrolling: touch !important;
        padding: 5px !important;
        -webkit-box-sizing: border-box !important;
      }
      
      [id^="presetFormContent_"] > div:first-child {
        display: -webkit-flex !important;
        display: flex !important;
        -webkit-flex-direction: column !important;
        flex-direction: column !important;
        -webkit-align-items: flex-start !important;
        align-items: flex-start !important;
        gap: 3px !important;
        margin-bottom: 8px !important;
        margin-top: 0 !important;
      }
      
      [id^="presetFormContent_"] > div:first-child h4 {
        margin: 0 !important;
        padding: 0 !important;
      }
      
      [id^="presetFormContent_"] > div:first-child small {
        margin-left: 0 !important;
        margin-top: 0 !important;
        margin-bottom: 0 !important;
        width: 100% !important;
        text-align: left !important;
        white-space: normal !important;
        -webkit-hyphens: auto !important;
        hyphens: auto !important;
        padding: 0 !important;
      }
      
      [id^="presetFormContent_"] > div:nth-child(2) {
        display: -webkit-flex !important;
        display: flex !important;
        -webkit-flex-direction: column !important;
        flex-direction: column !important;
        -webkit-align-items: stretch !important;
        align-items: stretch !important;
        gap: 5px !important;
        width: 100% !important;
        margin-bottom: 8px !important;
        margin-top: 0 !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
      }
      
      [id^="presetFormContent_"] .addPresetMatchTime {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        padding: 6px !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
        -webkit-appearance: none !important;
        appearance: none !important;
        border-radius: 4px !important;
        -webkit-border-radius: 4px !important;
        color-scheme: light !important;
      }
      
      [id^="presetFormContent_"] .addPresetMatchTime::-webkit-calendar-picker-indicator {
        opacity: 1 !important;
        cursor: pointer !important;
      }
      
      .preset-edit-form-inline .editPresetMatchTimeInline {
        color-scheme: light !important;
      }
      
      .preset-edit-form-inline .editPresetMatchTimeInline::-webkit-calendar-picker-indicator {
        opacity: 1 !important;
        cursor: pointer !important;
      }
      
      [id^="presetFormContent_"] .addPresetTitle {
        width: 100% !important;
        white-space: normal !important;
        word-break: break-word !important;
        -webkit-word-break: break-word !important;
        margin: 0 !important;
        padding: 4px 0 !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        color: #1976d2 !important;
        font-size: 14px !important;
        font-weight: 600 !important;
        line-height: 1.4 !important;
        -webkit-text-size-adjust: 100% !important;
        overflow: visible !important;
        text-overflow: clip !important;
      }
      
      /* Секции с командами - компактные как в редактировании */
      [id^="presetFormContent_"] .form-section {
        width: 100% !important;
        box-sizing: border-box !important;
        margin-bottom: 8px !important;
        margin-top: 0 !important;
      }
      
      [id^="presetFormContent_"] .form-section > div {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 10px !important;
        width: 100% !important;
        box-sizing: border-box !important;
      }
      
      [id^="presetFormContent_"] .form-group {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        flex-shrink: 1 !important;
        margin: 0 !important;
      }
      
      [id^="presetFormContent_"] .form-group[style*="flex-shrink: 0"] {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* Группа с логотипом и селектом команды */
      [id^="presetFormContent_"] .form-group[style*="flex: 1"] {
        width: 100% !important;
        max-width: 100% !important;
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 8px !important;
      }
      
      [id^="presetFormContent_"] .addPresetTeam1LogoPreview,
      [id^="presetFormContent_"] .addPresetTeam2LogoPreview {
        align-self: flex-start !important;
        margin-bottom: 5px !important;
        margin-top: 0 !important;
      }
      
      [id^="presetFormContent_"] .form-group > div[style*="flex: 1"] {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      [id^="presetFormContent_"] select.addPresetTeam1Select,
      [id^="presetFormContent_"] select.addPresetTeam2Select {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        padding-right: 30px !important;
      }
      
      /* Цветовая палитра */
      [id^="presetFormContent_"] input[type="color"] {
        width: 100% !important;
        max-width: 100% !important;
        height: 45px !important;
        box-sizing: border-box !important;
      }
      
      /* Кнопки формы */
      [id^="presetFormContent_"] .form-buttons {
        margin-top: 10px !important;
        margin-bottom: 0 !important;
        padding: 0 !important;
      }
      
      /* Карточки пресетов */
      /* Секции дней в турнире */
      .tournament-day-section {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        margin-bottom: 4px !important;
        padding: 0 !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        overflow-x: hidden !important;
      }
      
      .tournament-day-section:first-child {
        margin-top: 0 !important;
        padding-top: 0 !important;
      }
      
      .day-header {
        margin: 2px 0 !important;
        padding: 3px 4px 3px 0 !important;
        box-sizing: border-box !important;
        width: 100% !important;
        max-width: 100% !important;
        cursor: pointer !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        flex-wrap: nowrap !important;
      }
      
      .day-header > div:first-child {
        display: flex !important;
        align-items: center !important;
        flex-wrap: nowrap !important;
        flex: 1 !important;
        min-width: 0 !important;
        padding-left: 0 !important;
        margin-left: 0 !important;
      }
      
      .day-toggle-arrow {
        cursor: pointer !important;
        padding: 0 !important;
        display: inline-block !important;
        font-size: 14px !important;
        font-weight: normal !important;
        color: #999 !important;
        vertical-align: middle !important;
        flex-shrink: 0 !important;
        width: 14px !important;
        text-align: center !important;
        line-height: 1 !important;
        margin-left: 0 !important;
        margin-right: 4px !important;
        position: relative !important;
        left: 0 !important;
      }
      
      .tournament-day-section {
        padding-left: 0 !important;
        padding-right: 0 !important;
      }
      
      .day-toggle-arrow::before {
        content: '-' !important;
        color: #999 !important;
        font-weight: normal !important;
        font-size: 14px !important;
      }
      
      .day-toggle-arrow.expanded {
        color: #000 !important;
        font-weight: normal !important;
      }
      
      .day-toggle-arrow.expanded::before {
        content: '+' !important;
        color: #000 !important;
        font-weight: normal !important;
        font-size: 14px !important;
      }
      
      /* Убрали hover эффект для day-toggle-arrow - только клик */
      
      .presets-list {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        gap: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      .preset-item-wrapper {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow-x: hidden !important;
        margin-bottom: 4px !important;
      }
      
      .preset-item {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        padding: 5px !important;
        overflow-x: hidden !important;
      }
      
      .preset-content {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        gap: 8px !important;
      }
      
      .preset-left {
        flex: 1 !important;
        min-width: 0 !important;
        max-width: calc(100% - 80px) !important;
        overflow: hidden !important;
      }
      
      .preset-right {
        flex-shrink: 0 !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        min-width: 70px !important;
      }
      
      .preset-edit-link {
        white-space: nowrap !important;
        font-size: 12px !important;
      }
      
      .preset-apply-symbol {
        width: 0 !important;
        height: 0 !important;
        border-style: solid !important;
        border-width: 5px 0 5px 7px !important;
        border-color: transparent transparent transparent #1976d2 !important;
        vertical-align: middle !important;
        padding: 0 !important;
        flex-shrink: 0 !important;
        display: inline-block !important;
      }
      
      .preset-apply-symbol:hover {
        border-color: transparent transparent transparent #1565c0 !important;
      }
      
      .preset-apply-symbol[style*="opacity: 0.5"] {
        border-color: transparent transparent transparent #999 !important;
      }
      
      /* Элементы команд в карточке пресета */
      .preset-teams {
        align-items: center !important;
        gap: 4px !important;
        flex-wrap: wrap !important;
      }
      
      .preset-team-logo {
        display: flex !important;
        align-items: center !important;
        flex-shrink: 0 !important;
      }
      
      .preset-team-logo img {
        max-width: 24px !important;
        max-height: 24px !important;
      }
      
      .preset-team-name {
        display: inline-flex !important;
        align-items: center !important;
        vertical-align: middle !important;
      }
      
      .preset-kit-color {
        display: inline-flex !important;
        vertical-align: middle !important;
        flex-shrink: 0 !important;
      }
      
      .preset-separator {
        display: inline-flex !important;
        align-items: center !important;
        vertical-align: middle !important;
        margin: 0 2px !important;
      }
      
      /* Стили для формы редактирования пресета в мобильной версии */
      .preset-edit-form-inline {
        box-sizing: border-box !important;
        width: 100% !important;
        max-width: 100% !important;
        overflow-x: hidden !important;
        padding: 15px !important;
      }
      
      .preset-edit-form-inline > div:first-child {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 5px !important;
      }
      
      .preset-edit-form-inline > div:first-child small {
        margin-left: 0 !important;
        width: 100% !important;
        text-align: left !important;
        white-space: normal !important;
      }
      
      .preset-edit-form-inline > div:nth-child(2) {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 8px !important;
        width: 100% !important;
      }
      
      .preset-edit-form-inline .editPresetMatchTimeInline {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      .preset-edit-form-inline .editPresetTitleInline {
        width: 100% !important;
        white-space: normal !important;
        word-break: break-word !important;
      }
      
      .preset-edit-form-inline .form-section > div {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 10px !important;
        width: 100% !important;
      }
      
      .preset-edit-form-inline .form-group {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      .preset-edit-form-inline .form-group[style*="flex: 1"] {
        width: 100% !important;
        flex-direction: column !important;
        gap: 8px !important;
      }
      
      .preset-edit-form-inline .editPresetTeam1LogoPreview,
      .preset-edit-form-inline .editPresetTeam2LogoPreview {
        align-self: flex-start !important;
        margin-bottom: 5px !important;
      }
      
      .preset-edit-form-inline select.editPresetTeam1SelectInline,
      .preset-edit-form-inline select.editPresetTeam2SelectInline {
        width: 100% !important;
        max-width: 100% !important;
        padding-right: 30px !important;
      }
      
      .preset-edit-form-inline input[type="color"].editPresetKit1ColorInline,
      .preset-edit-form-inline input[type="color"].editPresetKit2ColorInline {
        width: 100% !important;
        max-width: 100% !important;
        height: 45px !important;
      }
      .camera-content {
        padding: 16px;
        margin-bottom: 15px;
      }
      
      .timer-row {
        flex-direction: row;
        gap: 12px;
        margin: 0 0 20px 0;
        padding: 16px;
        justify-content: center;
        align-items: center;
      }
      
      .playpause-btn, .set-btn {
        width: 60px;
        height: 50px;
        font-size: 16px;
      }
      
      .timer-inputs input {
        font-size: 18px;
        padding: 8px 12px;
        width: 80px;
        text-align: center;
      }
      
      .score-row {
        flex-direction: column;
        gap: 6px;
        padding: 6px;
      }
      
      .score-upper-row {
        flex-direction: row;
        gap: 6px;
      }
      
      .score-upper-section {
        padding: 4px 0;
      }
      
      .score-blocks-container {
        flex-direction: row;
        gap: 6px;
        justify-content: space-between;
      }
      
      .score-block {
        width: calc(50% - 3px);
        max-width: none;
        padding: 6px;
        gap: 7px;
        box-sizing: border-box;
      }
      
      body {
        padding: 20px;
      }
      
      .score-controls {
        justify-content: center;
        margin-bottom: 0;
        gap: 4px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
      }
      
      .score-btn {
        width: 32px;
        height: 44px;
        font-size: 16px;
      }
      
      .score-value {
        font-size: 24px;
        margin: 0 4px;
      }
      
      .short-label-row {
        justify-content: center;
        margin-bottom: 0;
        gap: 4px;
      }
      
      .short-label-row input {
        font-size: 16px;
        padding: 6px 10px;
        width: 70px;
        text-align: center;
      }
      
      .team-logo-section-upper {
        gap: 4px;
      }
      
      .kit-block {
        justify-content: center;
        margin-bottom: 0;
      }
      
      .kit-color {
        width: 35px;
        height: 35px;
      }
      
      .team-input-row {
        margin-bottom: 0;
      }
      
      .team-input-row input {
        font-size: 14px;
        padding: 8px 10px;
      }
      
      .presets-section {
        padding: 15px;
      }
      
      /* Дополнительные стили для формы создания пресета в мобильной версии */
      [id^="presetFormContent_"] > div:first-child {
        flex-wrap: wrap !important;
        gap: 8px !important;
      }
      
      [id^="presetFormContent_"] > div:first-child h4 {
        font-size: 14px !important;
        margin: 0 !important;
      }
      
      [id^="presetFormContent_"] > div:first-child small {
        font-size: 10px !important;
        white-space: normal !important;
        width: 100% !important;
        margin-left: 0 !important;
        margin-top: 4px !important;
      }
      
      [id^="presetFormContent_"] > div:nth-child(2) {
        flex-wrap: wrap !important;
        gap: 8px !important;
      }
      
      [id^="presetFormContent_"] .addPresetMatchTime {
        width: 100% !important;
        max-width: 120px !important;
        flex-shrink: 0 !important;
      }
      
      [id^="presetFormContent_"] .addPresetTitle {
        width: 100% !important;
        font-size: 13px !important;
        white-space: normal !important;
        word-break: break-word !important;
        margin-top: 8px !important;
      }
      
      [id^="presetFormContent_"] input[type="color"].addPresetKit1Color,
      [id^="presetFormContent_"] input[type="color"].addPresetKit2Color {
        width: 100% !important;
        max-width: 100% !important;
        height: 45px !important;
        box-sizing: border-box !important;
      }
      
      [id^="presetFormContent_"] .form-group label {
        font-size: 12px !important;
        margin-bottom: 4px !important;
      }
      
      [id^="presetFormContent_"] .form-buttons {
        flex-direction: column !important;
        gap: 8px !important;
        width: 100% !important;
      }
      
      [id^="presetFormContent_"] .form-buttons .btn {
        width: 100% !important;
      }
      
      .presets-header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
      }
      
      .presets-header h2 {
        text-align: center;
        margin-bottom: 0;
      }
      
      .btn {
        font-size: 16px;
        padding: 12px 20px;
        width: 100%;
      }
      
      .preset-card {
        padding: 15px;
        margin-bottom: 10px;
        flex-direction: row;
        align-items: flex-start;
        justify-content: space-between;
      }
      
      .preset-content {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
      }
      
      .preset-left {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        flex: 1;
      }
      
      .preset-name {
        font-size: 16px;
        margin-right: 0;
        padding: 4px 8px;
        align-self: flex-start;
      }
      
      .preset-teams {
        width: 100%;
        justify-content: flex-start;
        align-self: flex-start;
      }
      
      .preset-team-name {
        font-size: 16px;
      }
      
      .preset-kit-color {
        width: 16px;
        height: 16px;
      }
      
      .preset-separator {
        font-size: 16px;
        margin: 0 4px;
      }
      
      .preset-right {
        align-self: flex-start;
        margin-top: 0;
        flex-shrink: 0;
      }
      
      .preset-edit-link {
        font-size: 14px;
        margin-left: 0;
      }
      
      .preset-apply-symbol {
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 5px 0 5px 7px;
        border-color: transparent transparent transparent #1976d2;
        vertical-align: middle;
        padding: 0;
        display: inline-block;
      }
      
      .preset-apply-symbol:hover {
        border-color: transparent transparent transparent #1565c0;
      }
      
      .preset-apply-symbol[style*="opacity: 0.5"] {
        border-color: transparent transparent transparent #999;
      }
      
      .form-row {
        flex-direction: column;
        gap: 15px;
        width: 100%;
        box-sizing: border-box;
      }
      
      .form-group {
        width: 100%;
        box-sizing: border-box;
      }
      
      .form-group input {
        font-size: 16px;
        padding: 10px 12px;
        width: 100%;
        box-sizing: border-box;
        max-width: 100%;
      }
      
      .form-group label {
        font-size: 14px;
        margin-bottom: 5px;
        display: block;
        width: 100%;
        box-sizing: border-box;
      }
      
      .edit-preset-form {
        padding: 15px;
        margin: 15px 0;
        box-sizing: border-box;
        width: 100%;
        max-width: 100%;
      }
      
      .team-divider {
        margin: 15px 0;
      }
    }
    
    .timer-running-warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: bold;
    }
    
    .disabled-field {
      opacity: 0.4;
      pointer-events: none;
      cursor: not-allowed !important;
      filter: grayscale(0.5);
    }
    
    .score-btn.disabled-field {
      background: #a8c0f0 !important;
      opacity: 0.5;
      filter: grayscale(0.3);
    }
    
    .kit-color.disabled-field,
    .kit-color.disabled-field:disabled,
    input[type="color"].kit-color.disabled-field,
    input[type="color"].kit-color:disabled {
      pointer-events: none;
      cursor: not-allowed !important;
      opacity: 1 !important;
      filter: none !important;
      -webkit-filter: none !important;
    }
    
    .preset-card.editable {
      cursor: pointer;
      border-style: dashed;
      border-color: #c5d9ff;
    }
    
    .preset-card.editable:hover {
      border-color: #338af3;
      background: #f8fbff;
      box-shadow: 0 4px 12px rgba(51, 138, 243, 0.15);
    }
    
    .tournament-preset-form {
      display: block;
      width: 100%;
      clear: both;
      margin-top: 12px;
      box-sizing: border-box;
    }
    
    .tournament-presets {
      display: block;
      width: 100%;
      margin-top: 12px;
      clear: both;
      box-sizing: border-box;
    }
    
    .tournament-presets.hidden {
      display: none;
    }
    
    .preset-edit-form-inline {
      background: #ffffff;
      border: 1px solid #c5d9ff;
      border-radius: 12px;
      padding: 9px 10px;
      margin: 6px 0;
      width: 100%;
      box-sizing: border-box;
      max-width: 100%;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(22, 61, 116, 0.08);
    }
    
    .preset-item.edit-mode {
      background: #f8f9fa;
    }
    
    .preset-item-wrapper {
      width: 100%;
      margin-bottom: 10px;
      display: block;
    }
      .presets-list {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 0;
      }
    
    .edit-preset-form {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .edit-preset-form .form-section {
      margin-bottom: 25px;
    }
    
    .edit-preset-form .form-group {
      margin-bottom: 15px;
    }
    
    .editable-title {
      cursor: pointer;
      border: 2px solid transparent;
      padding: 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .editable-title:hover {
      border-color: #007bff;
      background-color: #f8f9ff;
    }
    
    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      color: #1976d2;
      font-size: 16px;
      font-weight: 600;
    }
    
    .logo-mini {
      width: 25px;
      height: 25px;
      border-radius: 3px;
      border: 1px solid #ddd;
      object-fit: cover;
      display: inline-block;
      background: #f5f5f5;
    }
    
    .logo-mini img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 3px;
    }
    
    .logo-upload-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }
    
    .logo-mini-main {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      cursor: pointer;
      position: relative;
      border: none;
      background: none;
      transition: transform 0.2s;
    }
    
    .logo-mini-main:hover {
      transform: scale(1.05);
    }
    
    .logo-mini-main img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    
    .logo-delete-btn {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 16px;
      height: 16px;
      background: rgba(0, 0, 0, 0.3);
      color: rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.2s ease;
    }
    
    .logo-delete-btn:hover {
      background: rgba(220, 53, 69, 0.8);
      color: white;
      border: 1px solid white;
    }
    
    .logo-delete-btn-small {
      position: absolute;
      top: -3px;
      right: -3px;
      width: 12px;
      height: 12px;
      background: rgba(220, 53, 69, 0.8);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10;
      border: 1px solid white;
      transition: all 0.2s ease;
    }
    
    .logo-delete-btn-small:hover {
      background: #dc3545;
      transform: scale(1.1);
    }
    
    
    .preset-team-logo {
      display: inline-flex;
      align-items: center;
      flex-shrink: 0;
    }
    
    .preset-logo-mini {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      object-fit: cover;
    }
    
    .preset-team-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }
    
    .preset-kit-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      flex-shrink: 0;
    }
    
    .preset-separator {
      color: #666;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    .edit-preset-form .form-group input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .edit-preset-form .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
      font-size: 13px;
    }
    
    .logo-preview {
      margin-top: 8px;
      text-align: center;
    }
    
    .logo-preview img {
      width: 50px;
      height: 50px;
      border-radius: 4px;
      object-fit: cover;
    }
    
    .logo-preview .no-logo {
      color: #999;
      font-size: 12px;
      font-style: italic;
    }
    
    .edit-preset-form h3 {
      color: #1976d2;
      margin-top: 0;
    }
    
    .team-divider {
      height: 2px;
      background: #ddd;
      margin: 20px 0;
      border-radius: 1px;
    }
    
    .city-input-row.team-input-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .team-preset-row {
      display: flex;
      flex-direction: column;
      gap: 0;
      margin-top: auto;
      width: 100%;
    }
    
    .team-preset-row select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #c5d9ff;
      border-radius: 10px;
      font-size: 14px;
      background-color: #fff;
      color: #1f2d3d;
      font-weight: 500;
      box-shadow: 0 1px 3px rgba(22, 61, 116, 0.1);
      transition: border-color 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    
    .team-preset-row select:focus {
      outline: none;
      border-color: #338af3;
      box-shadow: 0 0 0 3px rgba(51, 138, 243, 0.1);
    }
    
    .team-preset-row select:hover {
      border-color: #338af3;
    }
    
    .team-display-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0;
      margin-top: 0;
      width: 100%;
    }
    
    .team-name-display {
      font-size: 16px;
      font-weight: 600;
      color: #1f2d3d;
      text-align: center;
      line-height: 1.4;
      height: 2.8em;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      word-break: break-word;
    }
    
    .team-city-display {
      font-size: 13px;
      color: #61708a;
      text-align: center;
      line-height: 1.3;
      margin-top: 4px;
    }
    
    .team-short-display {
      font-size: 1.2em;
      font-weight: 600;
      color: #163d74;
      text-transform: uppercase;
      letter-spacing: 2px;
      min-width: 50px;
      text-align: center;
    }
    
    .team-input-row .label-caption {
      font-size: 12px;
      color: #777;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <!-- Версия в углу -->
  <div class="version-info">v1.0.0</div>

  <!-- Управление табло -->
  <div class="camera-content">
    <div class="timer-row">
      <button id="playPauseBtn" class="playpause-btn" title="Пуск/Пауза">
        <svg id="playPauseIcon" width="32" height="32" viewBox="0 0 32 32" fill="none">
          <polygon id="playIcon" points="8,6 26,16 8,26" fill="white"/>
        </svg>
      </button>
      <div class="timer-inputs">
        <input type="text" id="timeInput" maxlength="5" placeholder="MM:SS" pattern="^\d{2}:\d{2}$" value="00:00" autocomplete="off" />
      </div>
      <button id="setBtn" class="set-btn">Set</button>
    </div>
    <form id="controlForm" autocomplete="off" spellcheck="false">
      <div class="score-row">
        <div class="score-upper-row">
          <div class="score-upper-section">
            <div class="team-logo-section-upper">
              <span id="team1LogoMini" class="logo-mini-main" 
                    onclick="handleMainLogoClick('team1', event)"
                    onmousedown="handleMainLogoPressStart('team1', event)"
                    onmouseup="handleMainLogoPressEnd('team1', event)"
                    onmouseleave="handleMainLogoPressEnd('team1', event)"
                    ontouchstart="handleMainLogoPressStart('team1', event)"
                    ontouchend="handleMainLogoPressEnd('team1', event)"
                    ontouchcancel="handleMainLogoPressEnd('team1', event)"></span>
              <input type="file" id="team1LogoUpload" accept="image/*" onchange="uploadMainLogo('team1', this)" style="display: none;">
            </div>
            <div class="score-controls">
              <button type="button" class="score-btn" id="score1Dec">-</button>
              <div class="score-divider"></div>
              <span class="score-value" id="score1Value">0</span>
              <div class="score-divider"></div>
              <button type="button" class="score-btn" id="score1Inc">+</button>
            </div>
            <span class="team-short-display-upper" id="team1ShortDisplayUpper">---</span>
          </div>
          <div class="divider-upper"></div>
          <div class="score-upper-section">
            <div class="team-logo-section-upper">
              <span id="team2LogoMini" class="logo-mini-main" 
                    onclick="handleMainLogoClick('team2', event)"
                    onmousedown="handleMainLogoPressStart('team2', event)"
                    onmouseup="handleMainLogoPressEnd('team2', event)"
                    onmouseleave="handleMainLogoPressEnd('team2', event)"
                    ontouchstart="handleMainLogoPressStart('team2', event)"
                    ontouchend="handleMainLogoPressEnd('team2', event)"
                    ontouchcancel="handleMainLogoPressEnd('team2', event)"></span>
              <input type="file" id="team2LogoUpload" accept="image/*" onchange="uploadMainLogo('team2', this)" style="display: none;">
            </div>
            <div class="score-controls">
              <button type="button" class="score-btn" id="score2Dec">-</button>
              <div class="score-divider"></div>
              <span class="score-value" id="score2Value">0</span>
              <div class="score-divider"></div>
              <button type="button" class="score-btn" id="score2Inc">+</button>
            </div>
            <span class="team-short-display-upper" id="team2ShortDisplayUpper">---</span>
          </div>
        </div>
        <div class="score-blocks-container">
          <div class="score-block">
            <div class="short-label-row">
              <input type="color" id="kit1Color" value="#2b2b2b" class="kit-color">
            </div>
            <div class="team-display-info">
              <div class="team-name-display" id="team1NameDisplay">Не введено</div>
              <div class="team-city-display" id="team1CityDisplay">Не введено</div>
            </div>
            <div class="team-preset-row">
              <select id="team1TournamentTeamSelect">
                <option value="">-- Выберите команду --</option>
              </select>
            </div>
          </div>
          <div class="divider"></div>
          <div class="score-block">
            <div class="short-label-row">
              <input type="color" id="kit2Color" value="#2b2b2b" class="kit-color">
            </div>
            <div class="team-display-info">
              <div class="team-name-display" id="team2NameDisplay">Не введено</div>
              <div class="team-city-display" id="team2CityDisplay">Не введено</div>
            </div>
            <div class="team-preset-row">
              <select id="team2TournamentTeamSelect">
                <option value="">-- Выберите команду --</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </form>

    <div class="penalty-toggle-row">
      <div class="penalty-toggle-info">
        <h3>Режим серии пенальти</h3>
        <span>Активируйте, чтобы управлять серией пенальти прямо из панели. Для безопасности потребуется подтверждение.</span>
      </div>
      <label class="penalty-switch">
        <input type="checkbox" id="penaltyModeToggle">
        <span class="penalty-switch-slider"></span>
      </label>
    </div>

    <div id="penaltyControls" class="penalty-controls hidden">
      <div class="penalty-controls-header">
        <div class="penalty-controls-header-left">
          <span>Пенальти активированы</span>
        </div>
        <button type="button" id="penaltyUndoBtn" class="penalty-undo-btn" disabled>Отменить удар</button>
      </div>
      <div class="penalty-stadium-mode-wrapper">
        <span class="penalty-stadium-mode-label">Отображение табло:</span>
        <div class="penalty-stadium-mode-buttons" id="penaltyStadiumModeButtons">
          <button type="button" id="penaltyNormalStadiumBtn" class="penalty-stadium-mode-btn active">Обычное</button>
          <button type="button" id="penaltyPenaltyStadiumBtn" class="penalty-stadium-mode-btn">Пенальти</button>
        </div>
      </div>
      <div class="penalty-mode-wrapper">
        <span class="penalty-mode-label">Пенальти:</span>
        <div class="penalty-mode-buttons">
          <button type="button" id="penaltyChildModeBtn" class="penalty-mode-btn" data-mode="child">3 удара</button>
          <button type="button" id="penaltyAdultModeBtn" class="penalty-mode-btn" data-mode="adult">5 ударов</button>
        </div>
      </div>
      <div id="penaltySeriesBoard" class="penalty-series-board hidden">
        <div class="penalty-series-summary">
          <span id="penaltySeriesStatus">Серия ещё не началась</span>
          <span id="penaltySeriesScore">0 : 0</span>
        </div>
        <div id="penaltySeriesRows"></div>
      </div>
    </div>
  </div>

  <!-- Секция предустановок -->
  <div class="presets-section">
    <div class="presets-header">
      <h2>Предустановки матчей</h2>
    </div>
    
    <!-- Предупреждение о работающем таймере -->
    <div id="timerWarning" class="timer-running-warning hidden">
      ⚠️ Таймер запущен! Блокированы: изменение команд, применение предустановок. Доступно: управление счетом, создание/редактирование предустановок.
    </div>
    
    <!-- Список турниров для создания пресетов -->
    <div id="tournamentsForPresets" style="margin-bottom: 30px;">
      <h3 style="margin-bottom: 15px; color: #333;">Создать пресет из турнира:</h3>
      <div id="tournamentsListForPresets" style="display: block; width: 100%;">
        <!-- Список турниров будет загружен динамически -->
      </div>
      <div id="tournamentsEmptyState" class="empty-state" style="padding: 20px; text-align: center; color: #999;">
        Нет созданных турниров. Создайте турнир в <a href="/private/settings.html?token=" id="settingsLinkInPresets" style="color: #338af3;">настройках</a>, чтобы добавить пресеты.
      </div>
    </div>
    
    <!-- Шаблон формы создания пресета (будет клонироваться в карточку турнира) -->
    <div id="addPresetFormTemplate" style="display: none;">
      <!-- Скрытый селект турнира для логики -->
      <select class="addPresetTournament" onchange="onTournamentSelectedForForm(this)" style="display: none;">
        <option value="">-- Выберите турнир --</option>
      </select>
      
      <div style="display: flex; align-items: center; gap: 10px; margin-top: 0; margin-bottom: 15px; width: 100%; flex-wrap: nowrap;">
        <h4 style="margin: 0;">Создать пресет</h4>
        <small style="color: #999; font-size: 11px; white-space: nowrap; flex-shrink: 0; margin-left: auto;">Имя пресета будет сформировано автоматически</small>
      </div>
      
      <!-- Строка с временем и именем пресета -->
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; width: 100%; flex-wrap: nowrap;">
        <input type="time" class="addPresetMatchTime" value="19:00" step="60" onchange="updatePresetNameForForm(this)" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; -webkit-appearance: none; appearance: none; flex-shrink: 0;" pattern="[0-9]{2}:[0-9]{2}" lang="ru">
        <h3 class="addPresetTitle" style="margin: 0; color: #1976d2; flex: 1; min-width: 0;">19:00 / Команда 1 - Команда 2</h3>
      </div>
      
      <!-- Компактная строка: Команда 1 с лого, цвет формы 1 -->
      <div class="form-section" style="margin-bottom: 15px;">
        <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: nowrap; width: 100%;">
          <div class="form-group" style="flex: 1; min-width: 0; display: flex; gap: 8px; align-items: flex-end;">
            <div class="addPresetTeam1LogoPreview" style="flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
              <div style="font-size: 10px; color: #999;">Лого</div>
            </div>
            <div style="flex: 1; min-width: 0;">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Команда 1</label>
              <select class="addPresetTeam1Select" onchange="onTeam1SelectedForForm(this)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <option value="">-- Выберите команду --</option>
              </select>
            </div>
          </div>
          <div class="form-group" style="flex-shrink: 0;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Цвет формы</label>
            <input type="color" class="addPresetKit1Color" id="addPresetKit1Color" value="#2b2b2b" onchange="this.dataset.manualEdit = 'true'; this.dataset.userEdited = 'true'" style="width: 70px; height: 38px; padding: 0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
          </div>
        </div>
      </div>
      
      <!-- Компактная строка: Команда 2 с лого, цвет формы 2 -->
      <div class="form-section" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: nowrap; width: 100%;">
          <div class="form-group" style="flex: 1; min-width: 0; display: flex; gap: 8px; align-items: flex-end;">
            <div class="addPresetTeam2LogoPreview" style="flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
              <div style="font-size: 10px; color: #999;">Лого</div>
            </div>
            <div style="flex: 1; min-width: 0;">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Команда 2</label>
              <select class="addPresetTeam2Select" onchange="onTeam2SelectedForForm(this)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <option value="">-- Выберите команду --</option>
              </select>
            </div>
          </div>
          <div class="form-group" style="flex-shrink: 0;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Цвет формы</label>
            <input type="color" class="addPresetKit2Color" id="addPresetKit2Color" value="#2b2b2b" onchange="this.dataset.manualEdit = 'true'; this.dataset.userEdited = 'true'" style="width: 70px; height: 38px; padding: 0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
          </div>
        </div>
      </div>
      
      <!-- Скрытые поля для совместимости со старой логикой -->
      <div style="display: none;">
        <div id="addPresetTeam1Details"></div>
        <div id="addPresetTeam1ColorRow"></div>
        <div id="addPresetTeam1LogoRow">
          <div id="addPresetTeam1LogoPreview" class="logo-preview"></div>
        </div>
        <input type="text" id="addPresetTeam1Name" readonly>
        <input type="text" id="addPresetTeam1City" readonly>
        <input type="text" id="addPresetTeam1Short" readonly>
        
        <div id="addPresetTeam2Details"></div>
        <div id="addPresetTeam2ColorRow"></div>
        <div id="addPresetTeam2LogoRow">
          <div id="addPresetTeam2LogoPreview" class="logo-preview"></div>
        </div>
        <input type="text" id="addPresetTeam2Name" readonly>
        <input type="text" id="addPresetTeam2City" readonly>
        <input type="text" id="addPresetTeam2Short" readonly>
      </div>
      
      <div class="form-buttons">
        <button class="btn btn-primary" onclick="saveNewPresetFromForm(this)">Сохранить</button>
        <button class="btn btn-secondary" onclick="cancelAddPresetFromForm(this)">Отмена</button>
      </div>
    </div>

    <!-- Форма редактирования предустановки -->
    <div id="editPresetForm" class="edit-preset-form hidden">
      <h3 id="editPresetTitle" class="editable-title" onclick="startEditingTitle()">Название матча</h3>
      <input type="text" id="editPresetNameInput" class="hidden" placeholder="Например: Финал чемпионата" onblur="finishEditingTitle()" onkeypress="handleTitleKeypress(event)">
      <div class="form-section">
        <h4 class="section-title">
          <span id="editPresetTeam1LogoMini" class="logo-mini" onclick="editPresetLogo('team1')" title="Нажмите для обновления логотипа"></span>
          Команда 1
          <input type="file" id="editPresetTeam1Logo" accept="image/*" onchange="uploadLogo('team1', this)" style="display: none;">
          <button type="button" class="logo-delete-btn-small" onclick="deletePresetLogo('team1'); event.stopPropagation()" title="Удалить логотип" style="display: none;">×</button>
        </h4>
        <div class="form-group">
          <label>Название</label>
          <input type="text" id="editPresetTeam1Name" placeholder="Название команды">
      </div>
        <div class="form-group">
          <label>Город</label>
          <input type="text" id="editPresetTeam1City" placeholder="Город">
    </div>
        <div class="form-group">
          <label>Шорткод</label>
          <input type="text" id="editPresetTeam1Short" placeholder="ХОЗ" maxlength="3">
          </div>
        <div class="form-group">
          <label>Цвет формы</label>
          <input type="color" id="editPresetKit1Color" value="#2b2b2b">
          </div>
          </div>
      <div class="team-divider"></div>
      <div class="form-section">
        <h4 class="section-title">
          Команда 2
          <span id="editPresetTeam2LogoMini" class="logo-mini" onclick="editPresetLogo('team2')" title="Нажмите для обновления логотипа"></span>
          <input type="file" id="editPresetTeam2Logo" accept="image/*" onchange="uploadLogo('team2', this)" style="display: none;">
          <button type="button" class="logo-delete-btn-small" onclick="deletePresetLogo('team2'); event.stopPropagation()" title="Удалить логотип" style="display: none;">×</button>
        </h4>
        <div class="form-group">
          <label>Название</label>
          <input type="text" id="editPresetTeam2Name" placeholder="Название команды">
          </div>
        <div class="form-group">
          <label>Город</label>
          <input type="text" id="editPresetTeam2City" placeholder="Город">
        </div>
        <div class="form-group">
          <label>Шорткод</label>
          <input type="text" id="editPresetTeam2Short" placeholder="ГОС" maxlength="3">
          </div>
        <div class="form-group">
          <label>Цвет формы</label>
          <input type="color" id="editPresetKit2Color" value="#2b2b2b">
          </div>
          </div>
      <div class="form-row">
        <button class="btn btn-primary" onclick="updatePreset()">Обновить</button>
        <button class="btn btn-danger" onclick="deletePresetFromEdit()">Удалить</button>
        <button class="btn" onclick="cancelEditPreset()">Отмена</button>
          </div>
        </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let presets = [];
    let tournaments = [];
    let expandedPresets = new Set(); // Храним ID турниров с раскрытыми пресетами
    let expandedDays = new Set(); // Храним ключи дней с раскрытыми пресетами (формат: tournamentId-isoDate)
    let ready = false;
    let timerRunning = false;
    let editingPresetId = null;
    let originalPresetData = null;
    let selectedTeams = {
      team1: null,
      team2: null
    };
    let mainTeamSelection = {
      team1: null,
      team2: null
    };
    
    // Переменные для пятикратного нажатия SET
    let setButtonClicks = 0;
    let setButtonClickTimeout = null;
    const SET_CLICK_RESET_TIME = 2000; // 2 секунды для сброса счетчика
    let uploadedLogos = {
      team1: null,
      team2: null
    };
    let state = {
      team1Logo: '',
      team2Logo: ''
    };

    const BREAK_WARNING_MESSAGE = 'На табло уже выставлены счёт или время. Похоже, сейчас идёт перерыв — переключение команд в основном меню может привести к ошибкам трансляции. Продолжить?';
    window.penaltyModeActive = false;

    let scoreboardState = {
      score1: 0,
      score2: 0,
      timerSeconds: 0,
      penaltyActive: false,
      penaltyMode: 'adult',
      penaltyMaxAttempts: 5,
      penaltySeries: null
    };
    let penaltyHoldTimeout = null;
    let syncingPenaltyControls = false;

    function getCurrentScoreboardSnapshot() {
      const score1ValueEl = document.getElementById('score1Value');
      const score2ValueEl = document.getElementById('score2Value');
      const currentScore1 = score1ValueEl ? parseInt(score1ValueEl.textContent, 10) || 0 : 0;
      const currentScore2 = score2ValueEl ? parseInt(score2ValueEl.textContent, 10) || 0 : 0;
      const currentTimerSeconds = getSecondsFromTimeInput('timeInput');

      scoreboardState.score1 = currentScore1;
      scoreboardState.score2 = currentScore2;
      scoreboardState.timerSeconds = currentTimerSeconds;

      return {
        score1: currentScore1,
        score2: currentScore2,
        timerSeconds: currentTimerSeconds
      };
    }

    function confirmBreakWarningIfNeeded() {
      const snapshot = getCurrentScoreboardSnapshot();
      if (snapshot.score1 === 0 && snapshot.score2 === 0 && snapshot.timerSeconds === 0) {
        return true;
      }
      return confirm(BREAK_WARNING_MESSAGE);
    }

    function getPenaltyMaxAttempts(mode) {
      return mode === 'child' ? 3 : 5;
    }

    function createEmptyPenaltySeries() {
      return {
        firstTeam: 'team1',
        currentTeam: 'team1',
        attempts: {
          team1: [],
          team2: []
        },
        maxAttempts: scoreboardState.penaltyMaxAttempts || getPenaltyMaxAttempts(scoreboardState.penaltyMode),
        suddenDeath: false,
        finished: false,
        winner: null,
        totalGoals: {
          team1: 0,
          team2: 0
        },
        history: []
      };
    }

    function ensurePenaltySeriesInitialized() {
      if (!scoreboardState.penaltySeries) {
        scoreboardState.penaltySeries = createEmptyPenaltySeries();
      } else {
        const series = scoreboardState.penaltySeries;
        if (!series.attempts) {
          series.attempts = { team1: [], team2: [] };
        }
        if (!series.totalGoals) {
          series.totalGoals = {
            team1: series.attempts.team1.filter(result => result === 'goal').length,
            team2: series.attempts.team2.filter(result => result === 'goal').length
          };
        }
        if (!series.firstTeam) {
          series.firstTeam = 'team1';
        }
        if (!series.currentTeam) {
          series.currentTeam = series.firstTeam;
        }
        if (!Array.isArray(series.history)) {
          series.history = [];
          const maxLen = Math.max(series.attempts.team1.length, series.attempts.team2.length);
          let turn = series.firstTeam;
          for (let i = 0; i < maxLen; i++) {
            if (series.attempts[turn][i] !== undefined) {
              series.history.push({ team: turn, result: series.attempts[turn][i] });
            }
            const other = turn === 'team1' ? 'team2' : 'team1';
            if (series.attempts[other][i] !== undefined) {
              series.history.push({ team: other, result: series.attempts[other][i] });
            }
            turn = series.firstTeam;
          }
        }
        series.maxAttempts = scoreboardState.penaltyMaxAttempts;
      }
      return scoreboardState.penaltySeries;
    }

    function updatePenaltyControlsUI() {
      const toggle = document.getElementById('penaltyModeToggle');
      const controls = document.getElementById('penaltyControls');
      const board = document.getElementById('penaltySeriesBoard');
      const undoBtn = document.getElementById('penaltyUndoBtn');
      const penaltyModeButtons = document.querySelectorAll('.penalty-mode-btn');
      const playPauseBtn = document.getElementById('playPauseBtn');
      const timerActive = !!timerRunning;

      if (!toggle || !controls) return;

      syncingPenaltyControls = true;
      toggle.checked = !!scoreboardState.penaltyActive;
      toggle.disabled = timerActive;
      toggle.classList.toggle('disabled-field', timerActive);
      controls.classList.toggle('hidden', !scoreboardState.penaltyActive);
      if (board) {
        board.classList.toggle('hidden', !scoreboardState.penaltyActive);
      }
      if (undoBtn) {
        const canUndo = scoreboardState.penaltyActive &&
          scoreboardState.penaltySeries &&
          Array.isArray(scoreboardState.penaltySeries.history) &&
          scoreboardState.penaltySeries.history.length > 0;
        undoBtn.disabled = !canUndo;
      }

      const currentMode = scoreboardState.penaltyMode || 'adult';
      penaltyModeButtons.forEach(button => {
        const buttonMode = button.dataset.mode;
        button.classList.toggle('active', buttonMode === currentMode);
        button.disabled = timerActive && scoreboardState.penaltyActive;
        button.classList.toggle('disabled-field', button.disabled);
      });

      // Блокируем кнопку play/pause, если режим пенальти активен и таймер не запущен
      if (playPauseBtn) {
        const shouldDisablePlay = scoreboardState.penaltyActive && !timerActive;
        if (shouldDisablePlay) {
          playPauseBtn.classList.add('disabled-field');
          playPauseBtn.style.opacity = '0.5';
          playPauseBtn.style.cursor = 'not-allowed';
        } else {
          playPauseBtn.classList.remove('disabled-field');
          playPauseBtn.style.opacity = '';
          playPauseBtn.style.cursor = '';
        }
      }

      // Управление кнопками переключения табло
      const stadiumModeButtons = document.getElementById('penaltyStadiumModeButtons');
      const normalStadiumBtn = document.getElementById('penaltyNormalStadiumBtn');
      const penaltyStadiumBtn = document.getElementById('penaltyPenaltyStadiumBtn');
      
      if (stadiumModeButtons && normalStadiumBtn && penaltyStadiumBtn) {
        if (scoreboardState.penaltyActive) {
          // Когда режим пенальти активен - кнопки активны
          stadiumModeButtons.classList.remove('disabled');
          normalStadiumBtn.disabled = false;
          penaltyStadiumBtn.disabled = false;
        } else {
          // Когда режим пенальти выключен - кнопки заблокированы, но видимы
          stadiumModeButtons.classList.add('disabled');
          normalStadiumBtn.disabled = true;
          penaltyStadiumBtn.disabled = true;
        }
      }

      syncingPenaltyControls = false;

      if (scoreboardState.penaltyActive) {
        ensurePenaltySeriesInitialized();
        renderPenaltySeries();
      }
    }

    function setPenaltyMode(mode, emitUpdate = true) {
      const normalizedMode = mode === 'child' ? 'child' : 'adult';
      if (normalizedMode === scoreboardState.penaltyMode) {
        return;
      }

      const series = scoreboardState.penaltySeries;
      const hasShots = series && Array.isArray(series.history) && series.history.length > 0;
      if (hasShots) {
        showNotification('Нельзя менять формат после начала серии пенальти', 'info');
        updatePenaltyControlsUI();
        return;
      }

      if (emitUpdate) {
        const confirmationMessage = normalizedMode === 'child'
          ? 'Переключить серию на формат 3 удара на команду?'
          : 'Переключить серию на формат 5 ударов на команду?';
        if (!confirm(confirmationMessage)) {
          updatePenaltyControlsUI();
          return;
        }
      }

      scoreboardState.penaltyMode = normalizedMode;
      const maxAttempts = getPenaltyMaxAttempts(normalizedMode);
      scoreboardState.penaltyMaxAttempts = maxAttempts;
      if (scoreboardState.penaltySeries) {
        scoreboardState.penaltySeries.maxAttempts = maxAttempts;
        resetSeriesStateFromHistory(scoreboardState.penaltySeries);
      }

      updatePenaltyControlsUI();

      if (emitUpdate) {
        const payload = {
          penaltyMode: normalizedMode,
          penaltyMaxAttempts: maxAttempts
        };
        if (scoreboardState.penaltyActive) {
          if (!scoreboardState.penaltySeries) {
            scoreboardState.penaltySeries = createEmptyPenaltySeries();
          }
          resetSeriesStateFromHistory(scoreboardState.penaltySeries);
          payload.penaltySeries = JSON.parse(JSON.stringify(scoreboardState.penaltySeries));
        }
        socket.emit('updateScoreboard', payload);
      }
    }

    function setupPenaltyControls() {
      const toggle = document.getElementById('penaltyModeToggle');

      if (toggle) {
        toggle.addEventListener('change', () => {
          if (syncingPenaltyControls) return;

          if (toggle.checked) {
            if (timerRunning) {
              showNotification('Нельзя активировать серию пенальти, пока таймер запущен', 'info');
              syncingPenaltyControls = true;
              toggle.checked = false;
              syncingPenaltyControls = false;
              return;
            }
            const confirmed = confirm('Активировать режим серии пенальти? Этот режим используется во время подготовки к серии ударов.');
            if (!confirmed) {
              syncingPenaltyControls = true;
              toggle.checked = false;
              syncingPenaltyControls = false;
              return;
            }

            scoreboardState.penaltyActive = true;
            const series = ensurePenaltySeriesInitialized();
            updatePenaltyControlsUI();
            socket.emit('updateScoreboard', {
              penaltyActive: true,
              penaltyMode: scoreboardState.penaltyMode,
              penaltyMaxAttempts: scoreboardState.penaltyMaxAttempts,
              penaltySeries: JSON.parse(JSON.stringify(series))
            });
            showNotification('Режим серии пенальти активирован', 'info');
          } else {
            scoreboardState.penaltyActive = false;
            scoreboardState.penaltySeries = null;
            updatePenaltyControlsUI();
            socket.emit('updateScoreboard', { penaltyActive: false, penaltySeries: null });
            showNotification('Режим серии пенальти отключён', 'info');
          }
        });
      }

      document.querySelectorAll('.penalty-mode-btn').forEach(button => {
        button.addEventListener('click', () => {
          if (timerRunning && scoreboardState.penaltyActive) {
            showNotification('Изменение формата серии заблокировано во время активного таймера', 'info');
            return;
          }
          const mode = button.dataset.mode === 'child' ? 'child' : 'adult';
          if (mode === scoreboardState.penaltyMode) return;
          setPenaltyMode(mode, true);
        });
      });

      const undoBtn = document.getElementById('penaltyUndoBtn');
      if (undoBtn && undoBtn.dataset.listenerAttached !== 'true') {
        undoBtn.addEventListener('click', () => undoLastPenaltyShot());
        undoBtn.dataset.listenerAttached = 'true';
      }

      const normalStadiumBtn = document.getElementById('penaltyNormalStadiumBtn');
      const penaltyStadiumBtn = document.getElementById('penaltyPenaltyStadiumBtn');
      
      // Функция для обновления активного состояния кнопок
      const updateStadiumModeButtons = async () => {
        try {
          const configResponse = await fetch(`/api/config?token=${getToken()}`);
          if (configResponse.ok) {
            const currentConfig = await configResponse.json();
            const isPenaltyMode = currentConfig.stadiumMode === 'penalty';
            
            if (normalStadiumBtn && penaltyStadiumBtn) {
              if (isPenaltyMode) {
                normalStadiumBtn.classList.remove('active');
                penaltyStadiumBtn.classList.add('active');
              } else {
                normalStadiumBtn.classList.add('active');
                penaltyStadiumBtn.classList.remove('active');
              }
            }
          }
        } catch (error) {
          console.error('Ошибка получения режима табло:', error);
        }
      };
      
      // Обработчик для кнопки "Обычное табло"
      if (normalStadiumBtn && normalStadiumBtn.dataset.listenerAttached !== 'true') {
        normalStadiumBtn.addEventListener('click', async () => {
          if (normalStadiumBtn.classList.contains('active')) return;
          
          if (!confirm('Переключить табло стадиона на обычное табло? Табло обновится моментально.')) {
            return;
          }
          
          try {
            const response = await fetch(`/api/config?token=${getToken()}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ stadiumMode: 'scoreboard' })
            });
            
            if (response.ok) {
              showNotification('Табло стадиона переключено на обычное табло!', 'success');
              updateStadiumModeButtons();
            } else {
              throw new Error('Ошибка переключения режима');
            }
          } catch (error) {
            console.error('Ошибка переключения режима табло:', error);
            showNotification('Ошибка переключения режима табло', 'error');
          }
        });
        normalStadiumBtn.dataset.listenerAttached = 'true';
      }
      
      // Обработчик для кнопки "Пенальти на табло"
      if (penaltyStadiumBtn && penaltyStadiumBtn.dataset.listenerAttached !== 'true') {
        penaltyStadiumBtn.addEventListener('click', async () => {
          if (penaltyStadiumBtn.classList.contains('active')) return;
          
          if (!confirm('Переключить табло стадиона на режим Пенальти? Табло обновится моментально.')) {
            return;
          }
          
          try {
            const response = await fetch(`/api/config?token=${getToken()}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ stadiumMode: 'penalty' })
            });
            
            if (response.ok) {
              showNotification('Табло стадиона переключено на режим Пенальти!', 'success');
              updateStadiumModeButtons();
            } else {
              throw new Error('Ошибка переключения режима');
            }
          } catch (error) {
            console.error('Ошибка переключения режима табло:', error);
            showNotification('Ошибка переключения режима табло', 'error');
          }
        });
        penaltyStadiumBtn.dataset.listenerAttached = 'true';
      }
      
      // Обновляем состояние кнопок при загрузке
      updateStadiumModeButtons();

      updatePenaltyControlsUI();
    }

    function getPenaltyTeamLabel(teamKey) {
      // Сначала пробуем получить из display элементов
      const nameDisplay = document.getElementById(teamKey === 'team1' ? 'team1NameDisplay' : 'team2NameDisplay');
      const shortDisplayUpper = document.getElementById(teamKey === 'team1' ? 'team1ShortDisplayUpper' : 'team2ShortDisplayUpper');
      
      // Пробуем получить из состояния
      const short = scoreboardState[teamKey === 'team1' ? 'team1Short' : 'team2Short'];
      const full = scoreboardState[teamKey === 'team1' ? 'team1Name' : 'team2Name'];
      
      // Приоритет: display элементы > состояние > дефолт
      if (shortDisplayUpper && shortDisplayUpper.textContent && shortDisplayUpper.textContent.trim() !== '---') {
        return shortDisplayUpper.textContent.trim().toUpperCase();
      }
      if (nameDisplay && nameDisplay.textContent && nameDisplay.textContent.trim() !== 'Не введено') {
        return nameDisplay.textContent.trim();
      }
      if (short && short.trim()) {
        return short.trim().toUpperCase();
      }
      if (full && full.trim()) {
        return full.trim();
      }

      return teamKey === 'team1' ? 'Команда 1' : 'Команда 2';
    }

    function getPenaltyTeamLogo(teamKey) {
      const logoKey = `${teamKey}Logo`;
      return state[logoKey] || scoreboardState[logoKey] || '';
    }

    function calculatePenaltyGoals(attempts) {
      return attempts.filter(result => result === 'goal').length;
    }
    function renderPenaltySeries() {
      const board = document.getElementById('penaltySeriesBoard');
      const rowsContainer = document.getElementById('penaltySeriesRows');
      const statusEl = document.getElementById('penaltySeriesStatus');
      const scoreEl = document.getElementById('penaltySeriesScore');

      if (!board || !rowsContainer) return;

      const series = ensurePenaltySeriesInitialized();
      resetSeriesStateFromHistory(series);
      const { attempts, currentTeam, finished, winner, suddenDeath } = series;

      const goalsTeam1 = calculatePenaltyGoals(attempts.team1);
      const goalsTeam2 = calculatePenaltyGoals(attempts.team2);

      if (statusEl) {
        if (finished) {
          const winnerLabel = winner ? (winner === 'team1' ? getPenaltyTeamLabel('team1') : getPenaltyTeamLabel('team2')) : '—';
          statusEl.innerHTML = `<strong>Серия завершена.</strong> Победитель: ${winnerLabel}`;
        } else if (attempts.team1.length === 0 && attempts.team2.length === 0) {
          statusEl.innerHTML = `<strong>Серия готова.</strong> Первый удар исполняет ${getPenaltyTeamLabel(currentTeam)}.`;
        } else if (suddenDeath) {
          statusEl.innerHTML = `<strong>Серия идёт.</strong> Серия на вылет, ходит ${getPenaltyTeamLabel(currentTeam)}.`;
        } else {
          statusEl.innerHTML = `<strong>Серия идёт.</strong> Ходит ${getPenaltyTeamLabel(currentTeam)}.`;
        }
      }

      if (scoreEl) {
        scoreEl.innerHTML = `<strong>${goalsTeam1}</strong> : <strong>${goalsTeam2}</strong>`;
      }

      const visibleSlots = Math.max(series.maxAttempts || scoreboardState.penaltyMaxAttempts || 1, 1);

      const penaltyLocked = !!timerRunning || (!!scoreboardState.penaltyActive && Array.isArray(series.history) && series.history.length > 0);

      const createTeamRow = (teamKey) => {
        const teamAttempts = attempts[teamKey];
        const logoUrl = getPenaltyTeamLogo(teamKey);
        const label = getPenaltyTeamLabel(teamKey);
        const isActiveTeam = currentTeam === teamKey && !finished;
        const isSelectable = !penaltyLocked && Array.isArray(series.history) && series.history.length === 0;
        const slots = new Array(visibleSlots).fill(null);
        teamAttempts.forEach((result, idx) => {
          const slotPosition = idx % visibleSlots;
          slots[slotPosition] = { status: result, index: idx };
        });

        const nextSlotIndex = teamAttempts.length % visibleSlots;

        const block = document.createElement('div');
        block.className = `penalty-team-block ${teamKey === 'team1' ? 'team-left' : 'team-right'}${isActiveTeam ? ' active' : ''}`;
        block.dataset.team = teamKey;

        const header = document.createElement('div');
        header.className = 'penalty-team-header';

        const logoEl = document.createElement('div');
        logoEl.className = 'penalty-team-logo';
        if (logoUrl) {
          const img = document.createElement('img');
          img.src = logoUrl;
          img.alt = label;
          logoEl.appendChild(img);
        } else {
          const span = document.createElement('span');
          span.textContent = label.slice(0, 1).toUpperCase();
          logoEl.appendChild(span);
        }

        const info = document.createElement('div');
        info.className = 'penalty-team-info';
        const nameEl = document.createElement('div');
        nameEl.className = 'penalty-team-name';
        nameEl.textContent = label;
        info.appendChild(nameEl);

        const infoWrapper = document.createElement('div');
        infoWrapper.className = 'penalty-team-info-wrapper';

        const scoreEl = document.createElement('div');
        scoreEl.className = 'penalty-team-score';
        scoreEl.textContent = teamKey === 'team1' ? goalsTeam1 : goalsTeam2;

        if (teamKey === 'team1') {
          infoWrapper.appendChild(logoEl);
          infoWrapper.appendChild(info);
          header.appendChild(infoWrapper);
          header.appendChild(scoreEl);
        } else {
          infoWrapper.appendChild(info);
          infoWrapper.appendChild(logoEl);
          header.appendChild(scoreEl);
          header.appendChild(infoWrapper);
        }

        block.appendChild(header);

        const attemptsCell = document.createElement('div');
        attemptsCell.className = 'penalty-attempts-track';

        for (let slotIndex = 0; slotIndex < visibleSlots; slotIndex++) {
          let slotData = slots[slotIndex];
          const attemptWrapper = document.createElement('div');
          attemptWrapper.className = 'penalty-attempt-wrapper';
          const attemptEl = document.createElement('div');
          let statusClass = 'pending';

          const isActiveAttempt = isActiveTeam &&
            !finished &&
            series.currentTeam === teamKey &&
            slotIndex === nextSlotIndex;

          const totalCyclesCompleted = Math.floor(teamAttempts.length / visibleSlots);
          if (slotData && isActiveAttempt) {
            const slotCycleIndex = Math.floor(slotData.index / visibleSlots);
            if (slotCycleIndex < totalCyclesCompleted) {
              slotData = null;
            }
          }

          if (slotData?.status === 'goal') {
            statusClass = 'goal';
          } else if (slotData?.status === 'miss') {
            statusClass = 'miss';
          }

          const isHistorySlot = !!slotData && !isActiveAttempt;

          const isLastRecordedAttempt = !!slotData &&
            slotData.index === teamAttempts.length - 1 &&
            !finished;

          attemptEl.className = `penalty-attempt ${statusClass}${isActiveAttempt ? ' active' : ''}`;
          attemptEl.textContent = '';

          if (isLastRecordedAttempt && !finished) {
            const holdStart = (event) => startPenaltyHold(teamKey, slotData.index, event);
            const holdCancel = () => cancelPenaltyHold();
            attemptEl.addEventListener('mousedown', holdStart);
            attemptEl.addEventListener('touchstart', holdStart, { passive: false });
            ['mouseup', 'mouseleave', 'touchend', 'touchcancel'].forEach(evt => {
              attemptEl.addEventListener(evt, holdCancel);
            });
            attemptEl.addEventListener('contextmenu', (evt) => evt.preventDefault());
          }

          if (isActiveAttempt) {
            const goalButton = document.createElement('button');
            goalButton.className = 'penalty-action-button goal-btn';
            goalButton.type = 'button';
            goalButton.textContent = 'Гол';
            goalButton.onclick = () => handlePenaltyShot(teamKey, 'goal');
            attemptWrapper.appendChild(goalButton);
          }

          attemptWrapper.appendChild(attemptEl);

          if (isActiveAttempt) {
            const missButton = document.createElement('button');
            missButton.className = 'penalty-action-button miss-btn';
            missButton.type = 'button';
            missButton.textContent = 'Мимо';
            missButton.onclick = () => handlePenaltyShot(teamKey, 'miss');
            attemptWrapper.appendChild(missButton);
          }

          attemptWrapper.classList.toggle('penalty-attempt-wrapper-history', isHistorySlot);
          attemptsCell.appendChild(attemptWrapper);
        }

        block.appendChild(attemptsCell);

        if (isSelectable) {
          block.style.cursor = 'pointer';
        } else {
          block.style.cursor = Array.isArray(series.history) && series.history.length > 0 ? 'not-allowed' : 'pointer';
        }

        if (isSelectable) {
          block.addEventListener('click', () => {
            if (!isSelectable) {
              showNotification('Нельзя менять порядок команд во время активного таймера или серии пенальти', 'info');
              return;
            }
            const localSeries = ensurePenaltySeriesInitialized();
            resetSeriesStateFromHistory(localSeries);
            if (Array.isArray(localSeries.history) && localSeries.history.length > 0) return;
            const newFirst = teamKey;
            if (localSeries.firstTeam === newFirst) return;

            const remappedHistory = [];
            if (Array.isArray(localSeries.history)) {
              const otherTeam = newFirst === 'team1' ? 'team2' : 'team1';
              localSeries.history.forEach(entry => {
                if (entry.team === newFirst) {
                  remappedHistory.push({ ...entry, team: 'team1' });
                } else if (entry.team === otherTeam) {
                  remappedHistory.push({ ...entry, team: 'team2' });
                } else {
                  remappedHistory.push(entry);
                }
              });
            }

            localSeries.firstTeam = newFirst;
            localSeries.currentTeam = newFirst;
            localSeries.history = remappedHistory;
            resetSeriesStateFromHistory(localSeries);
            updatePenaltyControlsUI();
            socket.emit('updateScoreboard', {
              penaltySeries: JSON.parse(JSON.stringify(localSeries))
            });
            showNotification(`Первыми бьют: ${getPenaltyTeamLabel(newFirst)}`, 'info');
          });
        }

        return { block };
      };

      rowsContainer.innerHTML = '';
      const team1Block = createTeamRow('team1');
      const team2Block = createTeamRow('team2');
      if (!team1Block || !team1Block.block || !team2Block || !team2Block.block) {
        console.error('Не удалось сформировать карточки пенальти', { team1Block, team2Block });
        return;
      }
      const teamsWrapper = document.createElement('div');
      teamsWrapper.className = 'penalty-teams-container';
      teamsWrapper.appendChild(team1Block.block);
      teamsWrapper.appendChild(team2Block.block);
      rowsContainer.appendChild(teamsWrapper);
    }

    function shouldFinishPenaltySeries(series) {
      const { attempts, maxAttempts, suddenDeath } = series;
      const team1Goals = calculatePenaltyGoals(attempts.team1);
      const team2Goals = calculatePenaltyGoals(attempts.team2);
      const team1Attempts = attempts.team1.length;
      const team2Attempts = attempts.team2.length;

      if (!suddenDeath) {
        const remainingTeam1 = maxAttempts - team1Attempts;
        const remainingTeam2 = maxAttempts - team2Attempts;

        if (team1Goals > team2Goals + Math.max(0, remainingTeam2)) {
          return { finished: true, winner: 'team1' };
        }
        if (team2Goals > team1Goals + Math.max(0, remainingTeam1)) {
          return { finished: true, winner: 'team2' };
        }

        if (team1Attempts >= maxAttempts && team2Attempts >= maxAttempts) {
          if (team1Goals > team2Goals) {
            return { finished: true, winner: 'team1' };
          }
          if (team2Goals > team1Goals) {
            return { finished: true, winner: 'team2' };
          }
          return { finished: false, winner: null, suddenDeath: true };
        }
      } else {
        if (team1Attempts === team2Attempts) {
          if (team1Goals > team2Goals) {
            return { finished: true, winner: 'team1' };
          }
          if (team2Goals > team1Goals) {
            return { finished: true, winner: 'team2' };
          }
        }
      }

      return { finished: false, winner: null };
    }

    function handlePenaltyShot(teamKey, result) {
      if (!scoreboardState.penaltyActive) return;

      const series = ensurePenaltySeriesInitialized();
      resetSeriesStateFromHistory(series);
      if (series.finished) return;
      if (series.currentTeam !== teamKey) return;

      cancelPenaltyHold();

      if (!Array.isArray(series.history)) {
        series.history = [];
      }
      series.history.push({ team: teamKey, result });
      resetSeriesStateFromHistory(series);

      updatePenaltyControlsUI();
      socket.emit('updateScoreboard', {
        penaltySeries: JSON.parse(JSON.stringify(series))
      });
    }

    function resetSeriesStateFromHistory(series) {
      const maxAttempts = series.maxAttempts || getPenaltyMaxAttempts(scoreboardState.penaltyMode);
      series.maxAttempts = maxAttempts;
      series.attempts = {
        team1: [],
        team2: []
      };
      series.totalGoals = { team1: 0, team2: 0 };
      series.suddenDeath = false;
      series.finished = false;
      series.winner = null;
      const firstTeam = series.firstTeam || 'team1';
      series.currentTeam = firstTeam;

      const history = Array.isArray(series.history) ? series.history : [];
      history.forEach(({ team, result }) => {
        series.attempts[team].push(result);
        if (result === 'goal') {
          series.totalGoals[team] += 1;
        }
        const evaluation = shouldFinishPenaltySeries(series);
        if (evaluation.suddenDeath) {
          series.suddenDeath = true;
        }
        if (evaluation.finished) {
          series.finished = true;
          series.winner = evaluation.winner;
          series.currentTeam = null;
        } else {
          series.currentTeam = team === 'team1' ? 'team2' : 'team1';
        }
      });

      if (!series.finished && history.length === 0) {
        series.currentTeam = firstTeam;
      }
      if (series.finished && !series.winner) {
        series.currentTeam = null;
      }
    }

    function undoLastPenaltyShot(triggerNotification = true) {
      const series = ensurePenaltySeriesInitialized();
      if (!Array.isArray(series.history) || series.history.length === 0) {
        if (triggerNotification) showNotification('Нет ударов для отмены', 'info');
        return;
      }
      series.history.pop();
      resetSeriesStateFromHistory(series);
      cancelPenaltyHold();
      updatePenaltyControlsUI();
      socket.emit('updateScoreboard', {
        penaltySeries: JSON.parse(JSON.stringify(series))
      });
      if (triggerNotification) showNotification('Удар отменён', 'info');
    }

    function startPenaltyHold(teamKey, attemptIndex, event) {
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      cancelPenaltyHold();
      const series = ensurePenaltySeriesInitialized();
      resetSeriesStateFromHistory(series);
      if (!Array.isArray(series.history) || series.history.length === 0) return;
      const lastEntry = series.history[series.history.length - 1];
      if (!lastEntry || lastEntry.team !== teamKey) return;
      if (attemptIndex !== series.attempts[teamKey].length - 1) return;

      penaltyHoldTimeout = setTimeout(() => {
        penaltyHoldTimeout = null;
        undoLastPenaltyShot();
      }, 4000);
    }

    function cancelPenaltyHold() {
      if (penaltyHoldTimeout) {
        clearTimeout(penaltyHoldTimeout);
        penaltyHoldTimeout = null;
      }
    }
    
    // Защита от случайного изменения счета
    let lastScoreChange = {
      team: null,
      timestamp: 0,
      value: 0
    };
    // Простая функция обновления UI - точно как в stadium.html
    // Без сложных проверок, просто обновляем элементы напрямую
    function updateUIFromServerData(data) {
      console.log('Updating UI from server data:', data);
      ready = false;
      const previousPenaltySignature = scoreboardState.penaltySeries ? JSON.stringify(scoreboardState.penaltySeries) : null;
      
      // Обновление таймера
      const isRunning = !!data.timerRunning;
      timerRunning = isRunning;
      window.timerRunning = isRunning;
      const playPauseIconEl = document.getElementById('playPauseIcon');
      if (playPauseIconEl) setPlayPauseIcon('playPauseIcon', isRunning);
      const timeInputEl = document.getElementById('timeInput');
      if (timeInputEl) {
        setTimeInputFromSeconds('timeInput', data.timerSeconds || 0);
        timeInputEl.disabled = isRunning;
      }
      
      // Предупреждение о таймере
      const warning = document.getElementById('timerWarning');
      if (warning) {
        if (isRunning) {
          warning.classList.remove('hidden');
        } else {
          warning.classList.add('hidden');
        }
      }
      
      // Блокировка полей при таймере
      const fieldsToDisable = [
        'kit1Color', 'kit2Color'
      ];
      const penaltyModeActiveInUpdate = typeof data.penaltyActive === 'boolean'
        ? data.penaltyActive
        : !!scoreboardState.penaltyActive;
      const disableInputs = isRunning || penaltyModeActiveInUpdate;
      fieldsToDisable.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && !field.closest('.edit-preset-form')) {
          if (disableInputs) {
            field.classList.add('disabled-field');
            // For color inputs, don't set disabled attribute to avoid browser graying them out
            // Instead, we block interaction via CSS (pointer-events: none)
            if (field.type !== 'color') {
              field.disabled = true;
            }
          } else {
            field.classList.remove('disabled-field');
            field.disabled = false;
          }
        }
      });

      toggleMainTeamPresetSelects(!disableInputs);
      
      // Update preset apply buttons state
      updatePresetApplyButtons();
      
      ['score1Inc', 'score1Dec', 'score2Inc', 'score2Dec'].forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
          if (penaltyModeActiveInUpdate) {
            btn.classList.add('disabled-field');
            btn.disabled = true;
          } else {
            btn.classList.remove('disabled-field');
            btn.disabled = false;
          }
        }
      });
      
      // Обновление счета - точно как в iskracup_scoreboard.html
      const score1ValueEl = document.getElementById('score1Value');
      const score2ValueEl = document.getElementById('score2Value');
      if (score1ValueEl) {
        score1ValueEl.textContent = typeof data.score1 === 'number' ? data.score1 : "0";
      }
      if (score2ValueEl) {
        score2ValueEl.textContent = typeof data.score2 === 'number' ? data.score2 : "0";
      }
      // Обновление команд - отображение информации (сначала обновляем команды, потом режим пенальти)
      const team1NameDisplay = document.getElementById('team1NameDisplay');
      const team1CityDisplay = document.getElementById('team1CityDisplay');
      const team1ShortDisplayUpper = document.getElementById('team1ShortDisplayUpper');
      const team2NameDisplay = document.getElementById('team2NameDisplay');
      const team2CityDisplay = document.getElementById('team2CityDisplay');
      const team2ShortDisplayUpper = document.getElementById('team2ShortDisplayUpper');
      const kit1ColorEl = document.getElementById('kit1Color');
      const kit2ColorEl = document.getElementById('kit2Color');
      
      // Обновляем отображение
      if (team1NameDisplay) team1NameDisplay.textContent = data.team1Name || 'Не введено';
      if (team2NameDisplay) team2NameDisplay.textContent = data.team2Name || 'Не введено';
      if (team1CityDisplay) team1CityDisplay.textContent = data.team1City || 'Не введено';
      if (team2CityDisplay) team2CityDisplay.textContent = data.team2City || 'Не введено';
      if (team1ShortDisplayUpper) team1ShortDisplayUpper.textContent = data.team1Short || '---';
      if (team2ShortDisplayUpper) team2ShortDisplayUpper.textContent = data.team2Short || '---';
      if (kit1ColorEl) kit1ColorEl.value = data.kit1Color || '#2b2b2b';
      if (kit2ColorEl) kit2ColorEl.value = data.kit2Color || '#2b2b2b';
      
      // Сохраняем шорткоды в состояние
      if (data.team1Short) scoreboardState.team1Short = data.team1Short;
      if (data.team2Short) scoreboardState.team2Short = data.team2Short;
      
      // Обновление логотипов - точно как в stadium.html
      const previousTeam1Logo = state.team1Logo || '';
      const previousTeam2Logo = state.team2Logo || '';
      const previousTeam1Name = scoreboardState.team1Name || '';
      const previousTeam2Name = scoreboardState.team2Name || '';
      const previousTeam1Short = scoreboardState.team1Short || '';
      const previousTeam2Short = scoreboardState.team2Short || '';
      
      // Обновляем логотипы только если они изменились (чтобы не моргали при работе таймера)
      const newTeam1Logo = data.team1Logo || '';
      const newTeam2Logo = data.team2Logo || '';
      
      if (previousTeam1Logo !== newTeam1Logo) {
        state.team1Logo = newTeam1Logo;
        if (newTeam1Logo && newTeam1Logo.trim() !== '') {
          updateMainLogoMini('team1', newTeam1Logo);
        } else {
          showKitColorCircle('team1');
        }
      }
      
      if (previousTeam2Logo !== newTeam2Logo) {
        state.team2Logo = newTeam2Logo;
        if (newTeam2Logo && newTeam2Logo.trim() !== '') {
          updateMainLogoMini('team2', newTeam2Logo);
        } else {
          showKitColorCircle('team2');
        }
      }
      
      // Сохраняем названия команд в состояние для сравнения
      if (data.team1Name) scoreboardState.team1Name = data.team1Name;
      if (data.team2Name) scoreboardState.team2Name = data.team2Name;
      
      // Перерисовка предустановок только если изменились данные команд
      const teamDataChanged = 
        previousTeam1Logo !== (data.team1Logo || '') ||
        previousTeam2Logo !== (data.team2Logo || '') ||
        previousTeam1Name !== (data.team1Name || '') ||
        previousTeam2Name !== (data.team2Name || '') ||
        previousTeam1Short !== (data.team1Short || '') ||
        previousTeam2Short !== (data.team2Short || '');
      
      if (!editingPresetId && teamDataChanged) {
        renderTournamentPresets();
      }
      
      syncMainTeamPresetSelectsFromState();
      
      // Обновление режима пенальти после обновления команд и логотипов
      if ('penaltyActive' in data || 'penaltyMode' in data || 'penaltyMaxAttempts' in data || 'penaltySeries' in data) {
        if (typeof data.penaltyActive === 'boolean') {
          scoreboardState.penaltyActive = data.penaltyActive;
        }
        if (typeof data.penaltyMode === 'string') {
          scoreboardState.penaltyMode = data.penaltyMode === 'child' ? 'child' : 'adult';
        }
        if (typeof data.penaltyMaxAttempts === 'number') {
          scoreboardState.penaltyMaxAttempts = data.penaltyMaxAttempts;
        } else {
          scoreboardState.penaltyMaxAttempts = getPenaltyMaxAttempts(scoreboardState.penaltyMode);
        }
        if (data.penaltySeries) {
          scoreboardState.penaltySeries = data.penaltySeries;
        } else if (data.penaltySeries === null) {
          scoreboardState.penaltySeries = null;
        }
        const newPenaltySignature = scoreboardState.penaltyActive
          ? JSON.stringify(scoreboardState.penaltySeries || null)
          : null;
        if (previousPenaltySignature !== newPenaltySignature) {
          cancelPenaltyHold();
        }
        window.penaltyModeActive = !!scoreboardState.penaltyActive;
        updatePenaltyControlsUI();
      }
      
      getCurrentScoreboardSnapshot();
      
      ready = true;
    }
    
    // Регистрируем обработчик ТОЧНО как в stadium.html - без дополнительных проверок
    socket.on('connect', () => {
      console.log('Socket connected, waiting for initial state from server...');
    });
    
    // Обработчик получения данных - точно как в stadium.html и iskracup_scoreboard.html
    socket.on('scoreboardUpdate', (data) => {
      console.log('Received scoreboardUpdate from server:', data);
      updateUIFromServerData(data);
    });
    
    // Обработчик получения состояния по запросу
    socket.on('currentState', (data) => {
      console.log('Received currentState from server:', data);
      if (data) {
        updateUIFromServerData(data);
      }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
      loadTournaments();
      setupControls();
      setupPenaltyControls();
      setupEditFormHandlers();
      setupTeamUpdateListener(); // Слушаем обновления команд из настроек
      
      // Простая проверка - если данные не пришли, запрашиваем через небольшую задержку
      setTimeout(() => {
        const team1NameEl = document.getElementById('team1Name');
        if (team1NameEl && !team1NameEl.value) {
          console.log('Fields are empty, requesting initial state from server...');
          socket.emit('getCurrentState');
        }
      }, 500);
    });
    
    // Загрузка турниров
    async function loadTournaments() {
      try {
        const response = await fetch(`/api/tournaments?token=${getToken()}`);
        if (response.ok) {
          tournaments = await response.json();
          renderTournamentsForPresets();
          populateMainTeamPresetSelects();
          // Загружаем пресеты после загрузки турниров
          if (presets.length === 0) {
            await loadPresets();
          } else {
            renderTournamentPresets();
          }
          syncMainTeamPresetSelectsFromState();
        }
      } catch (error) {
        console.error('Ошибка загрузки турниров:', error);
      }
    }
    
    // Слушаем обновления команд из настроек (через localStorage)
    function setupTeamUpdateListener() {
      window.addEventListener('storage', (e) => {
        if (e.key === 'teamUpdated' && e.newValue) {
          try {
            const data = JSON.parse(e.newValue);
            console.log('Team updated in settings, reloading presets:', data);
            // Перезагружаем турниры и пресеты для обновления логотипов
            loadTournaments().then(() => {
              loadPresets().then(() => {
                renderTournamentPresets();
              });
            });
          } catch (error) {
            console.error('Error parsing team update event:', error);
          }
        }
      });
      
      // Также проверяем при фокусе страницы (для обновления в той же вкладке)
      window.addEventListener('focus', () => {
        const teamUpdated = localStorage.getItem('teamUpdated');
        if (teamUpdated) {
          try {
            const data = JSON.parse(teamUpdated);
            // Проверяем, не слишком ли старое обновление (больше 5 секунд назад)
            if (data.timestamp && (Date.now() - data.timestamp) < 5000) {
              console.log('Team updated recently, reloading presets');
              loadTournaments().then(() => {
                loadPresets().then(() => {
                  renderTournamentPresets();
                });
              });
              // Очищаем флаг обновления
              localStorage.removeItem('teamUpdated');
            }
          } catch (error) {
            console.error('Error checking team update:', error);
          }
        }
      });
    }
    
    // Отображение турниров для создания пресетов
    function renderTournamentsForPresets() {
      const container = document.getElementById('tournamentsListForPresets');
      const emptyState = document.getElementById('tournamentsEmptyState');
      
      if (!container) return;
      
      if (tournaments.length === 0) {
        container.style.display = 'none';
        if (emptyState) {
          const settingsLink = document.getElementById('settingsLinkInPresets');
          if (settingsLink) {
            settingsLink.href = `/private/settings.html?token=${getToken()}`;
          }
          emptyState.style.display = 'block';
        }
        return;
      }
      
      container.style.display = 'flex';
      if (emptyState) {
        emptyState.style.display = 'none';
      }
      
      container.innerHTML = '';
      
      tournaments.forEach(tournament => {
        const teamCount = tournament.teams ? tournament.teams.length : 0;
        const card = document.createElement('div');
        card.className = 'preset-card';
        card.style.cssText = 'padding: 15px; margin-bottom: 10px; cursor: default; display: block; width: 100%; box-sizing: border-box;';
        
        const startDate = tournament.startDate ? new Date(tournament.startDate).toLocaleDateString('ru-RU') : '';
        const endDate = tournament.endDate ? new Date(tournament.endDate).toLocaleDateString('ru-RU') : '';
        const dates = startDate && endDate ? `${startDate} - ${endDate}` : (startDate || endDate || 'Даты не указаны');
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;" onclick="toggleTournamentPresets('${tournament.id}')" style="cursor: pointer;">
            <div style="flex: 1; min-width: 200px;">
              <div style="font-weight: bold; font-size: 16px; color: #333; margin-bottom: 5px;">${tournament.name}</div>
              <div style="font-size: 12px; color: #666;">${dates}</div>
              <div style="font-size: 12px; color: #999; margin-top: 3px;">Команд: ${teamCount} | Пресетов: <span id="presetCount-${tournament.id}">0</span></div>
            </div>
          </div>
          <div id="presetForm_${tournament.id}" class="tournament-preset-form hidden" style="width: 100%; margin-top: 15px; clear: both; display: block;"></div>
          <div id="presets-${tournament.id}" class="tournament-presets" style="width: 100%; margin-top: 15px; clear: both; display: block;"></div>
        `;
        
        container.appendChild(card);
      });
    }
    
    // Открытие формы создания пресета из турнира (опционально для конкретного дня)
    async function openAddPresetFromTournament(tournamentId, dayDate) {
      // Убеждаемся что турниры загружены
      if (tournaments.length === 0) {
        await loadTournaments();
      }
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament) {
        alert('Турнир не найден');
        return;
      }
      
      if (!tournament.teams || tournament.teams.length < 2) {
        alert('В турнире должно быть минимум 2 команды для создания пресета');
        return;
      }
      
      // Находим контейнер формы для этого турнира
      const formContainer = document.getElementById(`presetForm_${tournamentId}`);
      if (!formContainer) return;
      
      // Если форма уже открыта, закрываем её
      if (!formContainer.classList.contains('hidden')) {
        formContainer.classList.add('hidden');
        formContainer.innerHTML = '';
        return;
      }
      
      // Клонируем шаблон формы
      const template = document.getElementById('addPresetFormTemplate');
      if (!template) return;
      
      const form = template.cloneNode(true);
      form.id = `presetFormContent_${tournamentId}`;
      form.classList.remove('hidden');
      form.style.display = 'block';
      form.style.marginTop = '15px';
      form.style.padding = '15px';
      form.style.background = '#e3f2fd';
      form.style.border = '2px solid #2196f3';
      form.style.borderRadius = '8px';
      
      // Очищаем контейнер и добавляем форму
      formContainer.innerHTML = '';
      formContainer.appendChild(form);
      formContainer.classList.remove('hidden');
      
      // Устанавливаем выбранный турнир и день в форме
      const select = form.querySelector('.addPresetTournament');
      if (select) {
        select.value = tournamentId;
        // Также сохраняем в data-атрибут формы для надежности
        form.dataset.tournamentId = tournamentId;
        if (dayDate) {
          form.dataset.matchDate = dayDate; // YYYY-MM-DD
        }
        localStorage.setItem('lastSelectedTournament', tournamentId);
        console.log('Set tournament ID:', tournamentId, 'in form:', form.id);
      }
      
      // Заполняем команды турнира в этой форме
      fillTeamsFromTournamentForForm(tournament, form);
      
      // Находим последний созданный пресет из выбранного дня для получения времени по умолчанию
      const tournamentPresets = presets.filter(p => p.tournamentId === tournamentId && (!dayDate || p.matchDate === dayDate));
      let defaultTime = '19:00';
      
      if (tournamentPresets.length > 0) {
        // Сортируем по дате создания (если есть) или берем последний в массиве
        // Извлекаем время из названия последнего пресета
        const lastPreset = tournamentPresets[tournamentPresets.length - 1];
        if (lastPreset && lastPreset.name && lastPreset.name.includes(' / ')) {
          const timeMatch = lastPreset.name.match(/^(\d{2}:\d{2})\s*\/\s*/);
          if (timeMatch && timeMatch[1]) {
            defaultTime = timeMatch[1];
          }
        }
      }
      
      // Устанавливаем время по умолчанию из последнего пресета
      const timeInput = form.querySelector('.addPresetMatchTime');
      if (timeInput) {
        timeInput.value = defaultTime;
      }
      
      // Обновляем имя пресета
      updatePresetNameForForm(timeInput || form.querySelector('.addPresetMatchTime'));
      
      // Прокручиваем к форме
      setTimeout(() => {
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    }
    
    // Заполнение команд из турнира (для старой формы, если ещё используется)
    function fillTeamsFromTournament(tournament) {
      if (!tournament || !tournament.teams) return;
      
      // Заполняем селекты команд
      const team1Select = document.getElementById('addPresetTeam1Select');
      const team2Select = document.getElementById('addPresetTeam2Select');
      
      if (!team1Select || !team2Select) return;
      
      team1Select.innerHTML = '<option value="">-- Выберите команду --</option>';
      team2Select.innerHTML = '<option value="">-- Выберите команду --</option>';
      
      tournament.teams.forEach(team => {
        const option1 = document.createElement('option');
        option1.value = team.id;
        option1.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        team1Select.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = team.id;
        option2.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        team2Select.appendChild(option2);
      });
    }
    // Заполнение команд из турнира для конкретной формы
    function fillTeamsFromTournamentForForm(tournament, formContainer) {
      if (!tournament || !tournament.teams || !formContainer) return;
      
      // Заполняем селекты команд
      const team1Select = formContainer.querySelector('.addPresetTeam1Select');
      const team2Select = formContainer.querySelector('.addPresetTeam2Select');
      
      if (!team1Select || !team2Select) return;
      
      team1Select.innerHTML = '<option value="">-- Выберите команду --</option>';
      team2Select.innerHTML = '<option value="">-- Выберите команду --</option>';
      
      tournament.teams.forEach(team => {
        const option1 = document.createElement('option');
        option1.value = team.id;
        option1.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        option1.dataset.logo = team.logo || '';
        team1Select.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = team.id;
        option2.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        option2.dataset.logo = team.logo || '';
        team2Select.appendChild(option2);
      });
    }
    
    // Обработка выбора турнира
    function onTournamentSelected() {
      const tournamentId = document.getElementById('addPresetTournament').value;
      
      if (!tournamentId) {
        // Очищаем селекты команд
        document.getElementById('addPresetTeam1Select').innerHTML = '<option value="">-- Выберите команду --</option>';
        document.getElementById('addPresetTeam2Select').innerHTML = '<option value="">-- Выберите команду --</option>';
        return;
      }
      
      // Сохраняем выбор в localStorage
      localStorage.setItem('lastSelectedTournament', tournamentId);
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) {
        return;
      }
      
      // Заполняем селекты команд
      const team1Select = document.getElementById('addPresetTeam1Select');
      const team2Select = document.getElementById('addPresetTeam2Select');
      
      team1Select.innerHTML = '<option value="">-- Выберите команду --</option>';
      team2Select.innerHTML = '<option value="">-- Выберите команду --</option>';
      
      tournament.teams.forEach(team => {
        const option1 = document.createElement('option');
        option1.value = team.id;
        option1.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        team1Select.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = team.id;
        option2.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        team2Select.appendChild(option2);
      });
    }
    
    // Обработка выбора команды 1
    function onTeam1Selected() {
      const tournamentId = document.getElementById('addPresetTournament').value;
      const teamId = document.getElementById('addPresetTeam1Select').value;
      
      if (!tournamentId || !teamId) {
        hideTeam1Details();
        updatePresetName();
        return;
      }
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) return;
      
      const team = tournament.teams.find(t => t.id === teamId);
      if (!team) return;
      
      selectedTeams.team1 = team;
      fillTeam1Fields(team);
      showTeam1Details();
      updatePresetName(); // Обновляем имя сразу при выборе команды
    }
    
    // Обработка выбора команды 2
    function onTeam2Selected() {
      const tournamentId = document.getElementById('addPresetTournament').value;
      const teamId = document.getElementById('addPresetTeam2Select').value;
      
      if (!tournamentId || !teamId) {
        hideTeam2Details();
        updatePresetName();
        return;
      }
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) return;
      
      const team = tournament.teams.find(t => t.id === teamId);
      if (!team) return;
      
      selectedTeams.team2 = team;
      fillTeam2Fields(team);
      showTeam2Details();
      updatePresetName(); // Обновляем имя сразу при выборе команды
    }
    
    // Обновление имени пресета автоматически (для старой формы)
    function updatePresetName() {
      const timeInput = document.getElementById('addPresetMatchTime');
      const titleElement = document.getElementById('addPresetTitle');
      
      if (!timeInput || !titleElement) return;
      
      const matchTime = timeInput.value || '19:00';
      const team1Name = selectedTeams.team1 ? selectedTeams.team1.name : 'Команда 1';
      const team2Name = selectedTeams.team2 ? selectedTeams.team2.name : 'Команда 2';
      
      titleElement.textContent = `${matchTime} / ${team1Name} - ${team2Name}`;
    }
    
    // Обновление имени пресета для конкретной формы
    function updatePresetNameForForm(timeInputOrSelect) {
      if (!timeInputOrSelect) return;
      
      // Получаем контейнер формы - может быть передан timeInput или select элемент
      let formContainer = timeInputOrSelect.closest('[id^="presetFormContent_"]');
      
      // Если не нашли через closest (элемент может быть в другом контексте)
      if (!formContainer) {
        // Пробуем найти через родителя select элемента
        if (timeInputOrSelect.tagName === 'SELECT') {
          const parent = timeInputOrSelect.parentElement;
          if (parent) {
            formContainer = parent.closest('[id^="presetFormContent_"]');
          }
        }
      }
      
      // Если все еще не нашли, ищем открытую форму на странице
      if (!formContainer) {
        formContainer = document.querySelector('[id^="presetFormContent_"]');
      }
      
      if (!formContainer) {
        console.warn('Preset form container not found');
        return;
      }
      
      const titleElement = formContainer.querySelector('.addPresetTitle');
      if (!titleElement) {
        console.warn('Preset title element not found');
        return;
      }
      
      // Получаем время матча
      const timeInput = formContainer.querySelector('.addPresetMatchTime');
      const matchTime = timeInput?.value || '19:00';
      
      const team1Select = formContainer.querySelector('.addPresetTeam1Select');
      const team2Select = formContainer.querySelector('.addPresetTeam2Select');
      
      // Получаем tournamentId из разных источников (для надежности)
      let tournamentId = formContainer.querySelector('.addPresetTournament')?.value;
      
      // Если tournamentId не найден в селекте, пытаемся получить из data-атрибута формы или из ID формы
      if (!tournamentId || tournamentId.trim() === '') {
        tournamentId = formContainer.dataset.tournamentId;
      }
      
      // Если все еще не найдено, пытаемся извлечь из ID формы (presetFormContent_TOURNAMENT_ID)
      if (!tournamentId || tournamentId.trim() === '') {
        const formId = formContainer.id;
        const match = formId.match(/presetFormContent_(.+)/);
        if (match && match[1]) {
          tournamentId = match[1];
        }
      }
      
      let team1Name = 'Команда 1';
      let team2Name = 'Команда 2';
      
      if (team1Select && team1Select.value && tournamentId) {
        const tournament = tournaments.find(t => t.id === tournamentId);
        if (tournament && tournament.teams) {
          const team = tournament.teams.find(t => t.id === team1Select.value);
          if (team) team1Name = team.name;
        }
      }
      
      if (team2Select && team2Select.value && tournamentId) {
        const tournament = tournaments.find(t => t.id === tournamentId);
        if (tournament && tournament.teams) {
          const team = tournament.teams.find(t => t.id === team2Select.value);
          if (team) team2Name = team.name;
        }
      }
      
      titleElement.textContent = `${matchTime} / ${team1Name} - ${team2Name}`;
    }
    
    // Обработка выбора команды для формы (новая версия) - точно как в редактировании
    function onTeam1SelectedForForm(selectElement) {
      // Находим форму - она клонируется и имеет ID presetFormContent_*
      // Используем closest для поиска формы по ID, как в редактировании по классу
      let formContainer = selectElement.closest('[id^="presetFormContent_"]');
      
      // Если не нашли, ищем вверх по DOM дереву
      if (!formContainer) {
        let parent = selectElement.parentElement;
        while (parent && !formContainer) {
          if (parent.id && parent.id.startsWith('presetFormContent_')) {
            formContainer = parent;
            break;
          }
          parent = parent.parentElement;
        }
      }
      
      if (!formContainer) {
        console.error('Form container not found for team1');
        return;
      }
      
      // Получаем tournamentId из формы или из data-атрибута
      let tournamentId = formContainer.querySelector('.addPresetTournament')?.value;
      if (!tournamentId) {
        tournamentId = formContainer.dataset.tournamentId;
      }
      if (!tournamentId && formContainer.id) {
        // Извлекаем из ID формы: presetFormContent_TOURNAMENT_ID
        const match = formContainer.id.match(/presetFormContent_(.+)/);
        if (match && match[1]) {
          tournamentId = match[1];
        }
      }
      
      const teamId = selectElement.value;
      
      console.log('Team1 selected:', { tournamentId, teamId, formId: formContainer.id });
      
      if (!teamId || !tournamentId) {
        // Очищаем логотип и цвет при сбросе выбора (как в форме редактирования)
        const logoPreview = formContainer.querySelector('.addPresetTeam1LogoPreview');
        if (logoPreview) {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
        const colorInput = formContainer.querySelector('.addPresetKit1Color');
        if (colorInput) {
          colorInput.value = '#2b2b2b';
        }
        // Обновляем имя пресета после очистки выбора
        setTimeout(() => updatePresetNameForForm(selectElement), 0);
        return;
      }
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) {
        console.error('Tournament not found:', tournamentId);
        return;
      }
      
      const team = tournament.teams.find(t => t.id === teamId);
      if (!team) {
        console.error('Team not found:', teamId);
        return;
      }
      
      console.log('Team found:', { name: team.name, logo: team.logo, kitColor: team.kitColor });
      
      // Обновляем логотип команды - ищем относительно selectElement в структуре формы
      // Структура: form-section -> form-group -> addPresetTeam1LogoPreview
      const formSection = selectElement.closest('.form-section');
      let logoPreview = null;
      if (formSection) {
        logoPreview = formSection.querySelector('.addPresetTeam1LogoPreview');
      }
      // Если не нашли, пробуем через formContainer
      if (!logoPreview && formContainer) {
        logoPreview = formContainer.querySelector('.addPresetTeam1LogoPreview');
      }
      
      console.log('Logo preview element found:', !!logoPreview);
      if (logoPreview) {
        if (team.logo) {
          logoPreview.innerHTML = `<img src="${team.logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
          console.log('Logo updated:', team.logo);
        } else {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
      } else {
        console.error('Logo preview element not found!');
      }
      
      // Обновляем цвет формы из команды - ищем в той же form-section
      let colorInput = null;
      if (formSection) {
        colorInput = formSection.querySelector('.addPresetKit1Color');
      }
      // Если не нашли, пробуем через formContainer
      if (!colorInput && formContainer) {
        colorInput = formContainer.querySelector('.addPresetKit1Color');
      }
      
      console.log('Color input element found:', !!colorInput);
      if (colorInput) {
        // Всегда берем цвет из выбранной команды и обновляем
        const teamColor = team.kitColor || '#2b2b2b';
        // Устанавливаем значение
        colorInput.value = teamColor;
        console.log('Color value set:', teamColor, 'Current value:', colorInput.value);
        // Для input type="color" нужно явно обновить стиль
        colorInput.style.backgroundColor = teamColor;
        // Также триггерим события для гарантии обновления
        colorInput.dispatchEvent(new Event('input', { bubbles: true }));
        colorInput.dispatchEvent(new Event('change', { bubbles: true }));
        // Дополнительное обновление через setTimeout
        setTimeout(() => {
          if (colorInput) {
            colorInput.value = teamColor;
            colorInput.style.backgroundColor = teamColor;
            console.log('Color background updated:', colorInput.style.backgroundColor);
          }
        }, 10);
      } else {
        console.error('Color input element not found!');
      }
      
      // Заполняем скрытые поля команды (для совместимости)
      const nameInput = formContainer.querySelector('#addPresetTeam1Name') || formContainer.querySelector('[id*="Team1Name"]');
      const cityInput = formContainer.querySelector('#addPresetTeam1City') || formContainer.querySelector('[id*="Team1City"]');
      const shortInput = formContainer.querySelector('#addPresetTeam1Short') || formContainer.querySelector('[id*="Team1Short"]');
      
      if (nameInput) nameInput.value = team.name || '';
      if (cityInput) cityInput.value = team.city || '';
      if (shortInput) shortInput.value = team.short || '';
      
      // Обновляем имя пресета после выбора команды
      updatePresetNameForForm(selectElement);
    }
    function onTeam2SelectedForForm(selectElement) {
      // Находим форму - она клонируется и имеет ID presetFormContent_*
      // Используем closest для поиска формы по ID, как в редактировании по классу
      let formContainer = selectElement.closest('[id^="presetFormContent_"]');
      
      // Если не нашли, ищем вверх по DOM дереву
      if (!formContainer) {
        let parent = selectElement.parentElement;
        while (parent && !formContainer) {
          if (parent.id && parent.id.startsWith('presetFormContent_')) {
            formContainer = parent;
            break;
          }
          parent = parent.parentElement;
        }
      }
      
      if (!formContainer) {
        console.error('Form container not found for team2');
        return;
      }
      
      // Получаем tournamentId из формы или из data-атрибута
      let tournamentId = formContainer.querySelector('.addPresetTournament')?.value;
      if (!tournamentId) {
        tournamentId = formContainer.dataset.tournamentId;
      }
      if (!tournamentId && formContainer.id) {
        // Извлекаем из ID формы: presetFormContent_TOURNAMENT_ID
        const match = formContainer.id.match(/presetFormContent_(.+)/);
        if (match && match[1]) {
          tournamentId = match[1];
        }
      }
      
      const teamId = selectElement.value;
      
      console.log('Team2 selected:', { tournamentId, teamId, formId: formContainer.id });
      
      if (!teamId || !tournamentId) {
        // Очищаем логотип и цвет при сбросе выбора (как в форме редактирования)
        const logoPreview = formContainer.querySelector('.addPresetTeam2LogoPreview');
        if (logoPreview) {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
        const colorInput = formContainer.querySelector('.addPresetKit2Color');
        if (colorInput) {
          colorInput.value = '#2b2b2b';
        }
        // Обновляем имя пресета после очистки выбора
        updatePresetNameForForm(selectElement);
        return;
      }
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) {
        console.error('Tournament not found:', tournamentId);
        return;
      }
      
      const team = tournament.teams.find(t => t.id === teamId);
      if (!team) {
        console.error('Team not found:', teamId);
        return;
      }
      
      console.log('Team found:', { name: team.name, logo: team.logo, kitColor: team.kitColor });
      
      // Обновляем логотип команды - ищем относительно selectElement в структуре формы
      // Структура: form-section -> form-group -> addPresetTeam2LogoPreview
      const formSection = selectElement.closest('.form-section');
      let logoPreview = null;
      if (formSection) {
        logoPreview = formSection.querySelector('.addPresetTeam2LogoPreview');
      }
      // Если не нашли, пробуем через formContainer
      if (!logoPreview && formContainer) {
        logoPreview = formContainer.querySelector('.addPresetTeam2LogoPreview');
      }
      
      console.log('Logo preview element found:', !!logoPreview);
      if (logoPreview) {
        if (team.logo) {
          logoPreview.innerHTML = `<img src="${team.logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
          console.log('Logo updated:', team.logo);
        } else {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
      } else {
        console.error('Logo preview element not found!');
      }
      
      // Обновляем цвет формы из команды - ищем в той же form-section
      let colorInput = null;
      if (formSection) {
        colorInput = formSection.querySelector('.addPresetKit2Color');
      }
      // Если не нашли, пробуем через formContainer
      if (!colorInput && formContainer) {
        colorInput = formContainer.querySelector('.addPresetKit2Color');
      }
      
      console.log('Color input element found:', !!colorInput);
      if (colorInput) {
        // Всегда берем цвет из выбранной команды и обновляем
        const teamColor = team.kitColor || '#2b2b2b';
        // Устанавливаем значение
        colorInput.value = teamColor;
        console.log('Color value set:', teamColor, 'Current value:', colorInput.value);
        // Для input type="color" нужно явно обновить стиль
        colorInput.style.backgroundColor = teamColor;
        // Также триггерим события для гарантии обновления
        colorInput.dispatchEvent(new Event('input', { bubbles: true }));
        colorInput.dispatchEvent(new Event('change', { bubbles: true }));
        // Дополнительное обновление через setTimeout
        setTimeout(() => {
          if (colorInput) {
            colorInput.value = teamColor;
            colorInput.style.backgroundColor = teamColor;
            console.log('Color background updated:', colorInput.style.backgroundColor);
          }
        }, 10);
      } else {
        console.error('Color input element not found!');
      }
      
      // Заполняем скрытые поля команды (для совместимости)
      const nameInput = formContainer.querySelector('#addPresetTeam2Name') || formContainer.querySelector('[id*="Team2Name"]');
      const cityInput = formContainer.querySelector('#addPresetTeam2City') || formContainer.querySelector('[id*="Team2City"]');
      const shortInput = formContainer.querySelector('#addPresetTeam2Short') || formContainer.querySelector('[id*="Team2Short"]');
      
      if (nameInput) nameInput.value = team.name || '';
      if (cityInput) cityInput.value = team.city || '';
      if (shortInput) shortInput.value = team.short || '';
      
      // Обновляем имя пресета после выбора команды
      updatePresetNameForForm(selectElement);
    }
    
    function onTournamentSelectedForForm(selectElement) {
      // Эта функция не нужна в новой логике, так как турнир уже выбран при открытии формы
    }
    
    // Заполнение полей команды 1
    function fillTeam1Fields(team) {
      document.getElementById('addPresetTeam1Name').value = team.name || '';
      document.getElementById('addPresetTeam1City').value = team.city || '';
      document.getElementById('addPresetTeam1Short').value = team.short || '';
      document.getElementById('addPresetKit1Color').value = team.kitColor || '#2b2b2b';
      
      if (team.logo) {
        document.getElementById('addPresetTeam1LogoPreview').innerHTML = `<img src="${team.logo}" alt="${team.name}">`;
      } else {
        document.getElementById('addPresetTeam1LogoPreview').innerHTML = '<div class="no-logo">Нет логотипа</div>';
      }
      
      uploadedLogos.team1 = team.logo || null;
    }
    
    // Заполнение полей команды 2
    function fillTeam2Fields(team) {
      document.getElementById('addPresetTeam2Name').value = team.name || '';
      document.getElementById('addPresetTeam2City').value = team.city || '';
      document.getElementById('addPresetTeam2Short').value = team.short || '';
      document.getElementById('addPresetKit2Color').value = team.kitColor || '#2b2b2b';
      
      if (team.logo) {
        document.getElementById('addPresetTeam2LogoPreview').innerHTML = `<img src="${team.logo}" alt="${team.name}">`;
      } else {
        document.getElementById('addPresetTeam2LogoPreview').innerHTML = '<div class="no-logo">Нет логотипа</div>';
      }
      
      uploadedLogos.team2 = team.logo || null;
    }
    
    // Показать детали команды 1
    function showTeam1Details() {
      document.getElementById('addPresetTeam1Details').style.display = 'flex';
      document.getElementById('addPresetTeam1ColorRow').style.display = 'flex';
      document.getElementById('addPresetTeam1LogoRow').style.display = 'flex';
    }
    
    // Скрыть детали команды 1
    function hideTeam1Details() {
      document.getElementById('addPresetTeam1Details').style.display = 'none';
      document.getElementById('addPresetTeam1ColorRow').style.display = 'none';
      document.getElementById('addPresetTeam1LogoRow').style.display = 'none';
    }
    
    // Показать детали команды 2
    function showTeam2Details() {
      document.getElementById('addPresetTeam2Details').style.display = 'flex';
      document.getElementById('addPresetTeam2ColorRow').style.display = 'flex';
      document.getElementById('addPresetTeam2LogoRow').style.display = 'flex';
    }
    
    // Скрыть детали команды 2
    function hideTeam2Details() {
      document.getElementById('addPresetTeam2Details').style.display = 'none';
      document.getElementById('addPresetTeam2ColorRow').style.display = 'none';
      document.getElementById('addPresetTeam2LogoRow').style.display = 'none';
    }
    
    // Настройка обработчиков для формы редактирования
    function setupEditFormHandlers() {
      // Обработчик клика вне формы редактирования ОТКЛЮЧЕН
      // Форма редактирования теперь закрывается ТОЛЬКО по нажатию на кнопки "Сохранить" или "Отмена"
      // Это предотвращает случайное закрытие формы во время работы таймера
      // Старый код удален для предотвращения автоматического закрытия
      /*
      document.addEventListener('click', function(event) {
        const editForm = document.getElementById('editPresetForm');
        const editLinks = document.querySelectorAll('.preset-edit-link');
        const isEditLink = Array.from(editLinks).some(link => link.contains(event.target));
        
        if (editForm && !editForm.classList.contains('hidden') && 
            !editForm.contains(event.target) && !isEditLink) {
          handleEditFormClose();
        }
      });
      */
      
      // Обработчики изменений в полях формы
      const formFields = [
        'editPresetName', 'editPresetTeam1Name', 'editPresetTeam1City', 
        'editPresetTeam1Short', 'editPresetKit1Color', 'editPresetTeam2Name', 
        'editPresetTeam2City', 'editPresetTeam2Short', 'editPresetKit2Color'
      ];
      
      formFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', function() {
            // Поле изменено, можно отслеживать изменения
          });
        }
      });
    }
    
    // Проверка наличия изменений в форме
    function hasFormChanges() {
      if (!originalPresetData) return false;
      
      const currentData = {
        name: document.getElementById('editPresetName').value.trim(),
        team1Name: document.getElementById('editPresetTeam1Name').value.trim(),
        team1City: document.getElementById('editPresetTeam1City').value.trim(),
        team1Short: document.getElementById('editPresetTeam1Short').value.trim(),
        kit1Color: document.getElementById('editPresetKit1Color').value,
        team2Name: document.getElementById('editPresetTeam2Name').value.trim(),
        team2City: document.getElementById('editPresetTeam2City').value.trim(),
        team2Short: document.getElementById('editPresetTeam2Short').value.trim(),
        kit2Color: document.getElementById('editPresetKit2Color').value
      };
      
      return JSON.stringify(currentData) !== JSON.stringify(originalPresetData);
    }
    
    // Обработка закрытия формы редактирования
    function handleEditFormClose() {
      if (hasFormChanges()) {
        if (confirm('У вас есть несохраненные изменения. Сохранить перед закрытием?')) {
          updatePreset();
        }
      }
      cancelEditPreset();
    }
    
    // Загрузка логотипа
    async function uploadLogo(team, fileInput) {
      if (!fileInput.files[0]) return;
      
      const formData = new FormData();
      formData.append('logo', fileInput.files[0]);
      
      try {
        const response = await fetch(`/api/upload-logo?token=${getToken()}`, {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          const result = await response.json();
          uploadedLogos[team] = result.url; // Сохраняем полный URL
          showLogoPreview(team, result.url);
          updateLogoMini(team, result.url);
          showNotification('Логотип загружен успешно', 'success');
        } else {
          const error = await response.json();
          showNotification('Ошибка загрузки: ' + error.error, 'error');
        }
      } catch (error) {
        showNotification('Ошибка загрузки логотипа', 'error');
        console.error('Upload error:', error);
      }
    }
    
    // Показ превью логотипа
    function showLogoPreview(team, url) {
      // Для формы редактирования
      const editPreview = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}LogoPreview`);
      if (editPreview) {
        editPreview.innerHTML = `<img src="${url}" alt="Логотип ${team}">`;
      }
      
      // Для формы добавления
      const addPreview = document.getElementById(`addPresetTeam${team === 'team1' ? '1' : '2'}LogoPreview`);
      if (addPreview) {
        addPreview.innerHTML = `<img src="${url}" alt="Логотип ${team}">`;
      }
    }
    
    // Очистка логотипа
    function clearLogo(team) {
      uploadedLogos[team] = null;
      
      // Для формы редактирования
      const editPreview = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}LogoPreview`);
      if (editPreview) {
        editPreview.innerHTML = '<div class="no-logo">Нет логотипа</div>';
      }
      
      // Для формы добавления
      const addPreview = document.getElementById(`addPresetTeam${team === 'team1' ? '1' : '2'}LogoPreview`);
      if (addPreview) {
        addPreview.innerHTML = '<div class="no-logo">Нет логотипа</div>';
      }
      
      // Очищаем поле выбора файла в форме редактирования
      const editFileInput = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}Logo`);
      if (editFileInput) {
        editFileInput.value = '';
      }
      
      // Очищаем поле выбора файла в форме добавления
      const addFileInput = document.getElementById(`addPresetTeam${team === 'team1' ? '1' : '2'}Logo`);
      if (addFileInput) {
        addFileInput.value = '';
      }
    }
    
    // Редактирование заголовка (только для формы редактирования)
    function startEditingTitle() {
      // Проверяем только форму редактирования
      const editTitle = document.getElementById('editPresetTitle');
      const editInput = document.getElementById('editPresetNameInput');
      
      if (editTitle && !editTitle.classList.contains('hidden')) {
        // Форма редактирования
        editTitle.classList.add('hidden');
        editInput.classList.remove('hidden');
        editInput.value = editTitle.textContent;
        editInput.focus();
        editInput.select();
      }
    }
    
    function finishEditingTitle() {
      // Проверяем только форму редактирования
      const editTitle = document.getElementById('editPresetTitle');
      const editInput = document.getElementById('editPresetNameInput');
      
      if (editInput && !editInput.classList.contains('hidden')) {
        // Форма редактирования
        editTitle.textContent = editInput.value.trim() || 'Название матча';
        editTitle.classList.remove('hidden');
        editInput.classList.add('hidden');
      }
    }
    
    function handleTitleKeypress(event) {
      if (event.key === 'Enter') {
        finishEditingTitle();
      }
    }
    
    // Обновление миниатюр логотипов
    function updateLogoMini(team, logoUrl) {
      // Для формы редактирования
      const editMini = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}LogoMini`);
      if (editMini) {
        if (logoUrl) {
          editMini.innerHTML = `<img src="${logoUrl}" alt="Логотип ${team}">`;
          // Показываем кнопку удаления
          const deleteBtn = editMini.parentElement.querySelector('.logo-delete-btn-small');
          if (deleteBtn) deleteBtn.style.display = 'flex';
        } else {
          editMini.innerHTML = '';
          // Скрываем кнопку удаления
          const deleteBtn = editMini.parentElement.querySelector('.logo-delete-btn-small');
          if (deleteBtn) deleteBtn.style.display = 'none';
        }
      }
      
      // Для формы добавления (если есть миниатюры)
      const addMini = document.getElementById(`addPresetTeam${team === 'team1' ? '1' : '2'}LogoMini`);
      if (addMini) {
        if (logoUrl) {
          addMini.innerHTML = `<img src="${logoUrl}" alt="Логотип ${team}">`;
        } else {
          addMini.innerHTML = '';
        }
      }
    }
    
    // Обновление логотипа в форме редактирования
    function editPresetLogo(team) {
      const fileInput = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}Logo`);
      fileInput.click();
    }
    
    // Удаление логотипа из формы редактирования
    async function deletePresetLogo(team) {
      if (!confirm('Удалить логотип этой команды?')) return;
      
      // Очищаем логотип
      uploadedLogos[team] = null;
      
      // Обновляем миниатюру
      updateLogoMini(team, null);
      
      // Очищаем поле выбора файла
      const fileInput = document.getElementById(`editPresetTeam${team === 'team1' ? '1' : '2'}Logo`);
      if (fileInput) fileInput.value = '';
      
      showNotification('Логотип удален', 'success');
    }
    // Загрузка логотипа в основную форму
    async function uploadMainLogo(team, fileInput) {
      if (!fileInput || !fileInput.files || !fileInput.files[0]) {
        console.warn('No file selected for upload');
        return;
      }
      
      const formData = new FormData();
      formData.append('logo', fileInput.files[0]);
      
      try {
        const response = await fetch(`/api/upload-logo?token=${getToken()}`, {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.url) {
            updateMainLogoMini(team, result.url);
            updateMainLogoState(team, result.url);
            showNotification('Логотип загружен успешно', 'success');
          } else {
            showNotification('Ошибка: сервер не вернул URL логотипа', 'error');
            console.error('Server response:', result);
          }
        } else {
          // Пытаемся получить текст ошибки
          let errorText = 'Ошибка загрузки';
          try {
            const errorData = await response.json();
            errorText = errorData.error || errorText;
          } catch (e) {
            errorText = `Ошибка ${response.status}: ${response.statusText}`;
          }
          showNotification('Ошибка загрузки: ' + errorText, 'error');
          console.error('Upload failed:', response.status, errorText);
        }
      } catch (error) {
        showNotification('Ошибка загрузки логотипа: ' + (error.message || 'Неизвестная ошибка'), 'error');
        console.error('Upload error:', error);
      } finally {
        // Очищаем input, чтобы можно было загрузить тот же файл снова
        if (fileInput) {
          fileInput.value = '';
        }
      }
    }
    
    // Обновление миниатюры в основной форме
    function updateMainLogoMini(team, logoUrl) {
      const mini = document.getElementById(`${team}LogoMini`);
      
      if (logoUrl) {
        mini.innerHTML = `<img src="${logoUrl}" alt="Логотип ${team}">`;
      } else {
        mini.innerHTML = '';
      }
    }
    
    // Обновление состояния логотипа в основной форме
    function updateMainLogoState(team, logoUrl) {
      state[`${team}Logo`] = logoUrl;
      socket.emit('updateScoreboard', {
        [`${team}Logo`]: logoUrl
      });
    }
    
    // Показ серого круга цвета формы
    function showKitColorCircle(team) {
      const mini = document.getElementById(`${team}LogoMini`);
      const kitColor = document.getElementById(`kit${team === 'team1' ? '1' : '2'}Color`).value;
      mini.innerHTML = `<div style="width: 100%; height: 100%; background-color: ${kitColor}; border-radius: 50%;"></div>`;
    }
    
    // Переменные для отслеживания кликов и долгого нажатия по логотипам
    const logoClickTrackers = {
      team1: { lastClickTime: 0, deleteTimeoutId: null },
      team2: { lastClickTime: 0, deleteTimeoutId: null }
    };
    
    // Обработчик клика по логотипу в основном блоке управления (двойной клик для замены)
    function handleMainLogoClick(team, event) {
      event.stopPropagation();
      
      const tracker = logoClickTrackers[team];
      const now = Date.now();
      const DOUBLE_CLICK_DELAY = 300; // мс для двойного клика
      
      // Проверяем, был ли двойной клик (в течение DOUBLE_CLICK_DELAY)
      if (tracker.lastClickTime && (now - tracker.lastClickTime) < DOUBLE_CLICK_DELAY) {
        // Двойной клик - открываем выбор файла для замены
        tracker.lastClickTime = 0;
        document.getElementById(`${team}LogoUpload`).click();
        return;
      }
      
      // Сохраняем время клика для следующей проверки двойного клика
      tracker.lastClickTime = now;
    }
    
    // Обработчик начала долгого нажатия (для удаления)
    function handleMainLogoPressStart(team, event) {
      event.stopPropagation();
      
      // Отменяем стандартное поведение для touch событий
      if (event.type === 'touchstart') {
        event.preventDefault();
      }
      
      const tracker = logoClickTrackers[team];
      const HOLD_DELAY = 4000; // 4 секунды для долгого нажатия
      
      // Очищаем предыдущий таймер, если был
      if (tracker.deleteTimeoutId) {
        clearTimeout(tracker.deleteTimeoutId);
      }
      
      // Устанавливаем таймер для удаления
      tracker.deleteTimeoutId = setTimeout(() => {
        tracker.deleteTimeoutId = null;
        
        // Показываем подтверждение и удаляем
        if (confirm('Удалить логотип этой команды?')) {
          clearMainLogo(team);
        }
      }, HOLD_DELAY);
    }
    
    // Обработчик окончания долгого нажатия (отменяет удаление)
    function handleMainLogoPressEnd(team, event) {
      event.stopPropagation();
      
      const tracker = logoClickTrackers[team];
      
      // Отменяем таймер удаления, если пользователь отпустил до истечения 4 секунд
      if (tracker.deleteTimeoutId) {
        clearTimeout(tracker.deleteTimeoutId);
        tracker.deleteTimeoutId = null;
      }
    }
    
    // Удаление логотипа из основной панели
    async function clearMainLogo(team) {
      const currentLogoUrl = state[`${team}Logo`];
      
      if (!currentLogoUrl) return;
      
      const filename = currentLogoUrl.split('/').pop();
      
      // КРИТИЧНО: Не удаляем логотипы команд (team_) - они принадлежат записям команд в турнирах
      // Удаляем только логотипы главного окна (main_) и пресетов (preset_)
      if (filename && filename.startsWith('team_')) {
        // Это логотип команды из турнира - просто очищаем ссылку, файл не трогаем
        state[`${team}Logo`] = '';
        sendState();
        showKitColorCircle(team);
        showNotification('Логотип команды удален из панели управления', 'success');
        return;
      }
      
      // Очищаем состояние
      state[`${team}Logo`] = '';
      
      // Обновляем сервер
      sendState();
      
      // Показываем цветной круг
      showKitColorCircle(team);
      
      // Пытаемся удалить файл с сервера (только для main_ и preset_ логотипов)
      try {
        const response = await fetch(`/api/logo/${filename}?token=${getToken()}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showNotification('Логотип удален', 'success');
        } else if (response.status === 403) {
          const result = await response.json();
          if (result.protected) {
            showNotification('Логотип защищен от удаления: ' + (result.error || 'используется в активной секции'), 'info');
          }
        }
      } catch (error) {
        console.error('Ошибка удаления логотипа:', error);
        showNotification('Ошибка удаления логотипа', 'error');
      }
    }
    // Настройка контролов
    function setupControls() {
      // Таймер
      document.getElementById('playPauseBtn').onclick = function() {
        const isRunning = document.getElementById('playPauseIcon').innerHTML.includes('rect');
        const isPenaltyActive = scoreboardState.penaltyActive;
        
        // Если режим пенальти активен, можно только ставить на паузу, но не запускать
        if (isPenaltyActive && !isRunning) {
          showNotification('Запуск таймера недоступен во время режима пенальти. Можно только поставить на паузу или изменить время кнопкой Set.', 'info');
          return;
        }
        
        socket.emit('updateScoreboard', { 
          timerRunning: !isRunning 
        });
      };
      
      document.getElementById('setBtn').onclick = function() {
        // Увеличиваем счетчик нажатий
        setButtonClicks++;
        
        // Сбрасываем предыдущий таймаут
        if (setButtonClickTimeout) {
          clearTimeout(setButtonClickTimeout);
        }
        
        // Если достигли 5 нажатий
        if (setButtonClicks >= 5) {
          // Сбрасываем счетчик
          setButtonClicks = 0;
          
          // Показываем подтверждение
          if (confirm('Вы уверены, что хотите сбросить таймер и счет? Это действие нельзя отменить.')) {
            // Сбрасываем таймер и счет
            const resetPayload = {
              timerSeconds: 0,
              score1: 0,
              score2: 0
            };
            let penaltyWasReset = false;
            if (scoreboardState.penaltyActive || (scoreboardState.penaltySeries && Array.isArray(scoreboardState.penaltySeries.history))) {
              penaltyWasReset = true;
              cancelPenaltyHold();
              scoreboardState.penaltyActive = false;
              scoreboardState.penaltySeries = null;
              resetPayload.penaltyActive = false;
              resetPayload.penaltySeries = null;
            }
            socket.emit('updateScoreboard', resetPayload);
            
            // Обновляем отображение
            document.getElementById('timeInput').value = '00:00';
            document.getElementById('score1Value').textContent = '0';
            document.getElementById('score2Value').textContent = '0';

            scoreboardState.score1 = 0;
            scoreboardState.score2 = 0;
            scoreboardState.timerSeconds = 0;
            if (penaltyWasReset) {
              updatePenaltyControlsUI();
              showNotification('Режим пенальти отключён и серия сброшена', 'info');
            }
            
            console.log('Таймер и счет сброшены после пятикратного нажатия SET');
          }
        } else {
          // Обычная функциональность SET
          const seconds = getSecondsFromTimeInput('timeInput');
          socket.emit('updateScoreboard', { 
            timerSeconds: seconds 
          });
          scoreboardState.timerSeconds = seconds;
          
          // Устанавливаем таймаут для сброса счетчика
          setButtonClickTimeout = setTimeout(() => {
            setButtonClicks = 0;
            console.log('Счетчик нажатий SET сброшен');
          }, SET_CLICK_RESET_TIME);
        }
      };

      // Счет с защитой от случайных изменений
      const isPenaltyLocked = () => !!scoreboardState.penaltyActive;
      const notifyPenaltyLock = () => showNotification('Изменение основного счёта недоступно во время серии пенальти', 'info');

      document.getElementById('score1Inc').onclick = () => {
        if (isPenaltyLocked()) {
          notifyPenaltyLock();
          return;
        }
        const score1ValueEl = document.getElementById('score1Value');
        const current = parseInt(score1ValueEl.textContent) || 0;
        const newValue = current + 1;
        
        if (timerRunning && lastScoreChange.team === 'score1' && 
            (Date.now() - lastScoreChange.timestamp) < 60000) {
          if (!confirm('Похоже, вы уже прибавили счет совсем недавно. Подтвердите, что сейчас вы не случайно нажали второй раз?')) {
            return;
          }
        }
        
        lastScoreChange = { team: 'score1', timestamp: Date.now(), value: newValue };
        // Обновляем визуально сразу, до получения ответа от сервера
        score1ValueEl.textContent = newValue;
        scoreboardState.score1 = newValue;
        // Отправляем на сервер для синхронизации
        socket.emit('updateScoreboard', { score1: newValue });
      };
      
      document.getElementById('score1Dec').onclick = () => {
        if (isPenaltyLocked()) {
          notifyPenaltyLock();
          return;
        }
        const score1ValueEl = document.getElementById('score1Value');
        const current = parseInt(score1ValueEl.textContent) || 0;
        if (current > 0) {
          if (timerRunning) {
            if (!confirm('Подтвердите уменьшение счета во время игры?')) {
              return;
            }
          }
          const newValue = current - 1;
          // Обновляем визуально сразу, до получения ответа от сервера
          score1ValueEl.textContent = newValue;
          scoreboardState.score1 = newValue;
          // Отправляем на сервер для синхронизации
          socket.emit('updateScoreboard', { score1: newValue });
        }
      };
      
      document.getElementById('score2Inc').onclick = () => {
        if (isPenaltyLocked()) {
          notifyPenaltyLock();
          return;
        }
        const score2ValueEl = document.getElementById('score2Value');
        const current = parseInt(score2ValueEl.textContent) || 0;
        const newValue = current + 1;
        
        if (timerRunning && lastScoreChange.team === 'score2' && 
            (Date.now() - lastScoreChange.timestamp) < 60000) {
          if (!confirm('Похоже, вы уже прибавили счет совсем недавно. Подтвердите, что сейчас вы не случайно нажали второй раз?')) {
            return;
          }
        }
        
        lastScoreChange = { team: 'score2', timestamp: Date.now(), value: newValue };
        // Обновляем визуально сразу, до получения ответа от сервера
        score2ValueEl.textContent = newValue;
        scoreboardState.score2 = newValue;
        // Отправляем на сервер для синхронизации
        socket.emit('updateScoreboard', { score2: newValue });
      };
      
      document.getElementById('score2Dec').onclick = () => {
        if (isPenaltyLocked()) {
          notifyPenaltyLock();
          return;
        }
        const score2ValueEl = document.getElementById('score2Value');
        const current = parseInt(score2ValueEl.textContent) || 0;
        if (current > 0) {
          if (timerRunning) {
            if (!confirm('Подтвердите уменьшение счета во время игры?')) {
              return;
            }
          }
          const newValue = current - 1;
          // Обновляем визуально сразу, до получения ответа от сервера
          score2ValueEl.textContent = newValue;
          scoreboardState.score2 = newValue;
          // Отправляем на сервер для синхронизации
          socket.emit('updateScoreboard', { score2: newValue });
        }
      };

      // Обработчики изменений для цветов футболок - синхронизация с сервером
      const kit1ColorEl = document.getElementById('kit1Color');
      const kit2ColorEl = document.getElementById('kit2Color');
      
      if (kit1ColorEl) {
        kit1ColorEl.addEventListener('change', () => {
          if (ready) {
            sendState();
          }
        });
      }
      
      if (kit2ColorEl) {
        kit2ColorEl.addEventListener('change', () => {
          if (ready) {
            sendState();
          }
        });
      }

      // Обработка ввода времени
      document.getElementById('timeInput').addEventListener('input', function(e) {
        let v = this.value.replace(/[^\d:]/g, '');
        if (v.length === 2 && !v.includes(':')) v = v + ':';
        if (v.length > 5) v = v.slice(0,5);
        if (v.length === 3 && v[2] !== ':') v = v.slice(0,2) + ':' + v[2];
        if (!/^\d{0,2}:?\d{0,2}$/.test(v)) v = v.slice(0,-1);
        this.value = v;
      });

      setupMainTeamPresetSelects();
    }

    // Отправка состояния на сервер для сохранения (железобетонное сохранение)
    function sendState() {
      // Получаем текущие логотипы из состояния
      const team1Logo = state.team1Logo || '';
      const team2Logo = state.team2Logo || '';
      
      // Получаем значения из display элементов и цветов
      const team1NameDisplay = document.getElementById('team1NameDisplay');
      const team1CityDisplay = document.getElementById('team1CityDisplay');
      const team2NameDisplay = document.getElementById('team2NameDisplay');
      const team2CityDisplay = document.getElementById('team2CityDisplay');
      const kit1ColorEl = document.getElementById('kit1Color');
      const kit2ColorEl = document.getElementById('kit2Color');
      
      // Формируем объект состояния для отправки на сервер
      // ВАЖНО: отправляем все поля, чтобы сервер сохранил полное состояние
      const stateUpdate = {};
      
      if (team1NameDisplay) stateUpdate.team1Name = team1NameDisplay.textContent !== 'Не введено' ? team1NameDisplay.textContent : '';
      if (team1CityDisplay) stateUpdate.team1City = team1CityDisplay.textContent !== 'Не введено' ? team1CityDisplay.textContent : '';
      if (team2NameDisplay) stateUpdate.team2Name = team2NameDisplay.textContent !== 'Не введено' ? team2NameDisplay.textContent : '';
      if (team2CityDisplay) stateUpdate.team2City = team2CityDisplay.textContent !== 'Не введено' ? team2CityDisplay.textContent : '';
      // Шорткоды берем из текущего состояния, так как они не отображаются
      stateUpdate.team1Short = scoreboardState.team1Short || '';
      stateUpdate.team2Short = scoreboardState.team2Short || '';
      if (kit1ColorEl) stateUpdate.kit1Color = kit1ColorEl.value || '#2b2b2b';
      if (kit2ColorEl) stateUpdate.kit2Color = kit2ColorEl.value || '#2b2b2b';
      
      // Логотипы всегда отправляем из состояния
      stateUpdate.team1Logo = team1Logo;
      stateUpdate.team2Logo = team2Logo;
      
      // ОТПРАВЛЯЕМ НА СЕРВЕР - это сохранит состояние в state.json
      // Сервер автоматически сохранит все данные и разошлет всем клиентам
      socket.emit('updateScoreboard', stateUpdate);
    }

    // Загрузка предустановок
    async function loadPresets() {
      try {
        const response = await fetch(`/api/presets?token=${getToken()}`);
        presets = await response.json();
        console.log('Loaded presets:', presets);
        // Обновляем отображение пресетов для каждого турнира
        renderTournamentPresets();
      } catch (error) {
        console.error('Ошибка загрузки предустановок:', error);
      }
    }
    
    // Переключение отображения пресетов турнира
    function toggleTournamentPresets(tournamentId) {
      const presetsDiv = document.getElementById(`presets-${tournamentId}`);
      if (presetsDiv) {
        const isHidden = presetsDiv.classList.contains('hidden');
        if (isHidden) {
          // Показываем пресеты
          presetsDiv.classList.remove('hidden');
          expandedPresets.add(tournamentId);
          // Загружаем пресеты если еще не загружены
          renderTournamentPresets();
        } else {
          // Скрываем пресеты
          presetsDiv.classList.add('hidden');
          expandedPresets.delete(tournamentId);
        }
      }
    }
    
    // Переключение состояния дня (сворачивание/разворачивание списка пресетов дня)
    function toggleDayPresets(tournamentId, dayKey) {
      const dayKeyFull = `${tournamentId}-${dayKey || 'nodate'}`;
      const listEl = document.getElementById(`presets-list-${tournamentId}-${dayKey || 'nodate'}`);
      if (!listEl) return;
      
      // Проверяем текущее состояние через expandedDays
      const isCurrentlyExpanded = expandedDays.has(dayKeyFull);
      
      if (isCurrentlyExpanded) {
        listEl.style.display = 'none';
        expandedDays.delete(dayKeyFull);
      } else {
        listEl.style.display = 'flex';
        expandedDays.add(dayKeyFull);
      }
      
      // Обновляем стрелку
      const headerEl = listEl.previousElementSibling;
      if (headerEl) {
        const arrowEl = headerEl.querySelector('.day-toggle-arrow');
        if (arrowEl) {
          if (isCurrentlyExpanded) {
            arrowEl.classList.add('expanded');
          } else {
            arrowEl.classList.remove('expanded');
          }
        }
      }
    }
    
    // Отображение пресетов для турниров
    function renderTournamentPresets() {
      if (!tournaments || tournaments.length === 0) return;
      
      // КРИТИЧНО: Не перерисовываем пресеты, если открыта форма редактирования
      // Это предотвращает закрытие формы при обновлении состояния во время таймера
      if (editingPresetId) {
        console.log('Skipping renderTournamentPresets - editing form is open:', editingPresetId);
        return;
      }
      
      tournaments.forEach(tournament => {
        const presetsRoot = document.getElementById(`presets-${tournament.id}`);
        if (!presetsRoot) return;
        
        // Фильтруем пресеты этого турнира
        const tournamentPresets = presets.filter(p => p && p.tournamentId === tournament.id);
        
        // Обновляем счетчик пресетов (всегда, даже если секция не раскрыта)
        const presetCountEl = document.getElementById(`presetCount-${tournament.id}`);
        if (presetCountEl) {
          presetCountEl.textContent = tournamentPresets.length;
        }
        
        // Показываем пресеты только если секция не скрыта
        const presetsDiv = document.getElementById(`presets-${tournament.id}`);
        if (presetsDiv && presetsDiv.classList.contains('hidden')) {
          return;
        }
        
        // Добавляем в expandedPresets если еще не добавлен (для сохранения состояния)
        expandedPresets.add(tournament.id);
        
        // Готовим секции дней
        presetsRoot.innerHTML = '';
        const days = [];
        if (tournament.startDate && tournament.endDate) {
          const start = new Date(tournament.startDate);
          const end = new Date(tournament.endDate);
          start.setHours(0,0,0,0);
          end.setHours(0,0,0,0);
          for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const iso = d.toISOString().slice(0,10);
            days.push({ iso, label: d.toLocaleDateString('ru-RU', { weekday: 'short', day: '2-digit', month: '2-digit' }) });
          }
        }
        if (days.length === 0) days.push({ iso: null, label: 'Без даты' });
        
        // Создаем секции дней
        days.forEach(({ iso, label }) => {
          const dayKey = iso || 'nodate';
          const dayKeyFull = `${tournament.id}-${dayKey}`;
          // По умолчанию все дни развернуты при первой загрузке
          if (!expandedDays.has(dayKeyFull)) {
            expandedDays.add(dayKeyFull);
          }
          
          const isExpanded = expandedDays.has(dayKeyFull);
          const arrowClass = isExpanded ? 'expanded' : '';
          
          const section = document.createElement('div');
          section.className = 'tournament-day-section';
          section.style.cssText = 'width: 100%; box-sizing: border-box; margin-bottom: 12px; padding: 0;';
          section.innerHTML = `
            <div class="day-header" style="display: flex; align-items: center; justify-content: space-between; gap: 10px; margin: 4px 0; box-sizing: border-box; width: 100%; max-width: 100%; padding: 6px 8px 6px 0; flex-wrap: nowrap; cursor: pointer;" onclick="toggleDayPresets('${tournament.id}', '${dayKey}'); event.stopPropagation();">
              <div style="display: flex; align-items: center; gap: 8px; flex-wrap: nowrap; flex: 1; min-width: 0; padding-left: 0; margin-left: 0;">
                <span class="day-toggle-arrow ${arrowClass}" style="user-select: none; padding: 0; display: inline-block; box-sizing: border-box; flex-shrink: 0; vertical-align: middle; margin-left: 0; margin-right: 4px; position: relative; left: 0;"></span>
                <div style="font-weight: 600; color: #333; white-space: nowrap; flex-shrink: 0;">${label}</div>
              </div>
              <span class="preset-edit-link" style="flex-shrink: 0;" onclick="openAddPresetFromTournament('${tournament.id}', '${iso || ''}'); event.stopPropagation();" title="Добавить пресет">+add</span>
            </div>
            <div id="presets-list-${tournament.id}-${dayKey}" class="presets-list" style="width: 100%; display: ${isExpanded ? 'flex' : 'none'}; flex-direction: column;"></div>
          `;
          presetsRoot.appendChild(section);
        });
        
        // Если совсем нет пресетов
        if (tournamentPresets.length === 0) {
          const firstKey = days[0] ? days[0].iso || 'nodate' : 'nodate';
          const emptyEl = document.getElementById(`presets-list-${tournament.id}-${firstKey}`);
          if (emptyEl) emptyEl.innerHTML = '<div style="padding: 10px; color: #999; font-size: 12px;">Пресетов пока нет</div>';
          return;
        }
        
        tournamentPresets.forEach(preset => {
          const dayKey = preset.matchDate || (days[0] ? days[0].iso : null);
          const listTarget = document.getElementById(`presets-list-${tournament.id}-${dayKey || 'nodate'}`) || document.getElementById(`presets-list-${tournament.id}-${days[0] ? days[0].iso : 'nodate'}`);
          if (!listTarget) return;
          // Находим команды из турнира для получения актуальных логотипов
          let team1 = null;
          let team2 = null;
          if (preset.team1Id && tournament.teams) {
            team1 = tournament.teams.find(t => t.id === preset.team1Id);
          }
          if (preset.team2Id && tournament.teams) {
            team2 = tournament.teams.find(t => t.id === preset.team2Id);
          }
          
          // Используем актуальные логотипы из команд турнира, если команды найдены
          const team1Logo = (team1 && team1.logo) ? team1.logo : (preset.team1Logo || '');
          const team2Logo = (team2 && team2.logo) ? team2.logo : (preset.team2Logo || '');
          
          // Создаем контейнер для пресета (блок на всю ширину)
          const presetWrapper = document.createElement('div');
          presetWrapper.className = 'preset-item-wrapper';
          presetWrapper.style.cssText = 'width: 100%; margin-bottom: 10px;';
          presetWrapper.setAttribute('data-preset-id', preset.id);
          presetWrapper.setAttribute('data-tournament-id', tournament.id);
          
          // Элемент пресета (информация и кнопки)
          const presetItem = document.createElement('div');
          presetItem.className = 'preset-item';
          presetItem.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 6px; border: 1px solid #ddd; width: 100%; box-sizing: border-box;';
          presetItem.setAttribute('data-preset-id', preset.id);
          presetItem.setAttribute('data-tournament-id', tournament.id);
          
          presetItem.innerHTML = `
            <div class="preset-content" style="flex: 1; display: flex; align-items: center; justify-content: space-between; width: 100%;">
              <div class="preset-left" style="display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 0;">
                <div class="preset-name" style="font-weight: bold; color: #333; font-size: 15px;">${preset.name}</div>
                <div class="preset-teams" style="display: flex; align-items: center; gap: 6px;">
                  <span class="preset-team-logo">
                    ${team1Logo ? `<img src="${team1Logo}" alt="Логотип ${preset.team1Name}" class="preset-logo-mini">` : ''}
                  </span>
                  <span class="preset-team-name" style="font-size: 12px; color: #666;">${preset.team1Short ? preset.team1Short.toUpperCase() : ''}</span>
                  <span class="preset-kit-color" style="background-color: ${preset.kit1Color || '#2b2b2b'}; width: 12px; height: 12px; border-radius: 2px; border: 1px solid #ccc; display: inline-block;"></span>
                  <span class="preset-separator" style="color: #666; font-weight: bold; margin: 0 2px;">:</span>
                  <span class="preset-kit-color" style="background-color: ${preset.kit2Color || '#2b2b2b'}; width: 12px; height: 12px; border-radius: 2px; border: 1px solid #ccc; display: inline-block;"></span>
                  <span class="preset-team-name" style="font-size: 12px; color: #666;">${preset.team2Short ? preset.team2Short.toUpperCase() : ''}</span>
                  <span class="preset-team-logo">
                    ${team2Logo ? `<img src="${team2Logo}" alt="Логотип ${preset.team2Name}" class="preset-logo-mini">` : ''}
                  </span>
                </div>
              </div>
              <div class="preset-right" style="display: flex; align-items: center; gap: 12px; flex-shrink: 0;">
                <span class="preset-edit-link" onclick="editPresetInline('${tournament.id}', '${preset.id}')">edit</span>
                <span class="preset-apply-symbol" onclick="if (!window.timerRunning && !window.penaltyModeActive) confirmApplyPreset('${preset.id}'); else showNotification('Применение пресета заблокировано во время активного таймера или серии пенальти', 'info');" ${(timerRunning || scoreboardState.penaltyActive) ? 'style="opacity: 0.5; cursor: not-allowed; pointer-events: none;"' : ''} title="Применить предустановку"></span>
              </div>
            </div>
          `;
          
          // Форма редактирования (отдельный элемент, вставляется после presetItem)
          const editForm = document.createElement('div');
          editForm.id = `preset-edit-form-${tournament.id}-${preset.id}`;
          editForm.className = 'preset-edit-form-inline hidden';
          
          presetWrapper.appendChild(presetItem);
          presetWrapper.appendChild(editForm);
          
          listTarget.appendChild(presetWrapper);
        });
      });
    }
    
    // Обновление состояния кнопок "применить" для всех пресетов
    function updatePresetApplyButtons() {
      const isDisabled = !!timerRunning || !!window.timerRunning || !!scoreboardState.penaltyActive;
      const applyButtons = document.querySelectorAll('.preset-apply-symbol');
      applyButtons.forEach(button => {
        if (isDisabled) {
          button.style.opacity = '0.5';
          button.style.cursor = 'not-allowed';
          button.style.pointerEvents = 'none';
        } else {
          button.style.opacity = '';
          button.style.cursor = '';
          button.style.pointerEvents = '';
        }
      });
    }
    
    // Удаление пресета из турнира
    async function deletePresetFromTournament(tournamentId, presetId) {
      if (!confirm('Удалить этот пресет?')) return;
      
      try {
        const response = await fetch(`/api/presets/${presetId}?token=${getToken()}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          // Если удаляем из формы редактирования — немедленно закрываем её
          // и сбрасываем флаг, чтобы следующая перерисовка не была пропущена
          const editForm = document.getElementById(`preset-edit-form-${tournamentId}-${presetId}`);
          if (editForm) {
            editForm.classList.add('hidden');
            editForm.innerHTML = '';
          }
          // Сбрасываем защитный флаг, из‑за которого список мог не перерисоваться
          editingPresetId = null;
          originalPresetData = null;

          // Сохраняем состояние видимости пресетов
          const presetsDiv = document.getElementById(`presets-${tournamentId}`);
          const wasHidden = presetsDiv ? presetsDiv.classList.contains('hidden') : false;
          
          await loadPresets();
          await loadTournaments(); // Обновляем счетчик
          
          // Восстанавливаем состояние видимости
          if (presetsDiv) {
            if (wasHidden) {
              presetsDiv.classList.add('hidden');
              expandedPresets.delete(tournamentId);
            } else {
              presetsDiv.classList.remove('hidden');
              expandedPresets.add(tournamentId);
              renderTournamentPresets(); // Рендерим если видим (editingPresetId уже сброшен)
            }
          }
          
          showNotification('Пресет удален!', 'success');
        } else {
          throw new Error('Ошибка удаления пресета');
        }
      } catch (error) {
        console.error('Ошибка удаления пресета:', error);
        showNotification('Ошибка удаления пресета', 'error');
      }
    }
    // Inline редактирование пресета
    function editPresetInline(tournamentId, presetId) {
      const preset = presets.find(p => p.id === presetId);
      if (!preset) {
        alert('Пресет не найден');
        return;
      }
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) {
        alert('Турнир не найден');
        return;
      }
      
      // Восстанавливаем видимость всех пресетов, которые были в режиме редактирования
      document.querySelectorAll('.preset-item').forEach(item => {
        if (item.style.display === 'none' || item.classList.contains('edit-mode')) {
          item.style.display = '';
          item.classList.remove('edit-mode');
        }
      });
      
      // Скрываем все формы редактирования и очищаем их содержимое
      document.querySelectorAll('.preset-edit-form-inline').forEach(form => {
        form.classList.add('hidden');
        form.innerHTML = '';
      });
      
      // Скрываем форму создания пресета если открыта
      const addForm = document.getElementById(`presetForm_${tournamentId}`);
      if (addForm) {
        addForm.classList.add('hidden');
      }
      
      // Убеждаемся что пресеты раскрыты
      const presetsDiv = document.getElementById(`presets-${tournamentId}`);
      if (presetsDiv) {
        presetsDiv.classList.remove('hidden');
        expandedPresets.add(tournamentId);
      }
      
      // Находим wrapper пресета
      const presetWrapper = document.querySelector(`.preset-item-wrapper[data-preset-id="${presetId}"][data-tournament-id="${tournamentId}"]`);
      if (!presetWrapper) {
        alert('Элемент пресета не найден');
        return;
      }
      
      // Находим элемент пресета внутри wrapper
      const presetItem = presetWrapper.querySelector('.preset-item');
      if (!presetItem) {
        alert('Элемент пресета не найден');
        return;
      }
      
      // Показываем форму редактирования на месте пресета
      const editForm = presetWrapper.querySelector(`#preset-edit-form-${tournamentId}-${presetId}`);
      if (!editForm) {
        alert('Форма редактирования не найдена');
        return;
      }
      
      // Определяем текущие ID команд или находим их по именам
      let currentTeam1Id = preset.team1Id;
      let currentTeam2Id = preset.team2Id;
      
      // Если ID не сохранены, пытаемся найти по именам
      if (!currentTeam1Id && preset.team1Name) {
        const team = tournament.teams.find(t => t.name === preset.team1Name);
        if (team) currentTeam1Id = team.id;
      }
      
      if (!currentTeam2Id && preset.team2Name) {
        const team = tournament.teams.find(t => t.name === preset.team2Name);
        if (team) currentTeam2Id = team.id;
      }
      
      // Извлекаем время из имени пресета (формат: "19:00 / Команда 1 - Команда 2")
      let matchTime = '19:00';
      if (preset.name && preset.name.includes(' / ')) {
        const timeMatch = preset.name.match(/^(\d{2}:\d{2})\s*\/\s*/);
        if (timeMatch) {
          matchTime = timeMatch[1];
        }
      }
      
      // Заполняем форму содержимым ПЕРЕД показом
      editForm.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px; margin-top: 0; margin-bottom: 15px; width: 100%; flex-wrap: nowrap;">
            <h4 style="margin: 0;">Редактировать пресет</h4>
            <small style="color: #999; font-size: 11px; white-space: nowrap; flex-shrink: 0; margin-left: auto;">Имя пресета будет сформировано автоматически</small>
          </div>
          
          <!-- Строка с временем и именем пресета -->
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; width: 100%; flex-wrap: nowrap;">
            <input type="time" class="editPresetMatchTimeInline" value="${matchTime}" onchange="updateEditPresetNameInline('${tournamentId}', '${presetId}')" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; -webkit-appearance: none; appearance: none; flex-shrink: 0;" pattern="[0-9]{2}:[0-9]{2}" lang="ru">
            <h3 class="editPresetTitleInline" style="margin: 0; color: #1976d2; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${preset.name}</h3>
          </div>
          
          <!-- Компактная строка: Команда 1 с лого, цвет формы 1 -->
          <div class="form-section" style="margin-bottom: 15px;">
            <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: nowrap; width: 100%;">
              <div class="form-group" style="flex: 1; min-width: 0; display: flex; gap: 8px; align-items: flex-end;">
                <div class="editPresetTeam1LogoPreview" style="flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  ${preset.team1Logo ? `<img src="${preset.team1Logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">` : '<div style="font-size: 10px; color: #999;">Лого</div>'}
                </div>
                <div style="flex: 1; min-width: 0;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Команда 1</label>
                  <select class="editPresetTeam1SelectInline" onchange="onEditTeam1SelectedInline('${tournamentId}', '${presetId}', this)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="">-- Выберите команду --</option>
                  </select>
                </div>
              </div>
              <div class="form-group" style="flex-shrink: 0;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Цвет формы</label>
                <input type="color" class="editPresetKit1ColorInline" value="${preset.kit1Color || '#2b2b2b'}" onchange="this.dataset.manualEdit = 'true'; this.dataset.userEdited = 'true'" style="width: 70px; height: 38px; padding: 0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
              </div>
            </div>
          </div>
          
          <!-- Компактная строка: Команда 2 с лого, цвет формы 2 -->
          <div class="form-section" style="margin-bottom: 20px;">
            <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: nowrap; width: 100%;">
              <div class="form-group" style="flex: 1; min-width: 0; display: flex; gap: 8px; align-items: flex-end;">
                <div class="editPresetTeam2LogoPreview" style="flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  ${preset.team2Logo ? `<img src="${preset.team2Logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">` : '<div style="font-size: 10px; color: #999;">Лого</div>'}
                </div>
                <div style="flex: 1; min-width: 0;">
                  <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Команда 2</label>
                  <select class="editPresetTeam2SelectInline" onchange="onEditTeam2SelectedInline('${tournamentId}', '${presetId}', this)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="">-- Выберите команду --</option>
                  </select>
                </div>
              </div>
              <div class="form-group" style="flex-shrink: 0;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px;">Цвет формы</label>
                <input type="color" class="editPresetKit2ColorInline" value="${preset.kit2Color || '#2b2b2b'}" onchange="this.dataset.manualEdit = 'true'; this.dataset.userEdited = 'true'" style="width: 70px; height: 38px; padding: 0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
              </div>
            </div>
          </div>
          
          <div class="form-buttons">
            <button class="btn btn-primary" onclick="saveEditPresetInline('${tournamentId}', '${presetId}')">Сохранить</button>
            <button class="btn btn-secondary" onclick="cancelEditPresetInline('${tournamentId}', '${presetId}')">Отмена</button>
            <button class="btn btn-danger" onclick="deletePresetFromTournament('${tournamentId}', '${presetId}')" style="margin-left: auto;">Удалить</button>
          </div>
        `;
      
      // Сохраняем ссылки на элементы для использования в setTimeout
      const team1LogoPreview = editForm.querySelector('.editPresetTeam1LogoPreview');
      const team2LogoPreview = editForm.querySelector('.editPresetTeam2LogoPreview');
      const kit1ColorInput = editForm.querySelector('.editPresetKit1ColorInline');
      const kit2ColorInput = editForm.querySelector('.editPresetKit2ColorInline');
      
      let selectedTeam1 = null;
      let selectedTeam2 = null;
      
      // Устанавливаем начальные значения для логотипов и цветов
      // Показываем логотип пресета, если он есть, иначе логотип команды
      if (currentTeam1Id) {
        selectedTeam1 = tournament.teams.find(t => t.id === currentTeam1Id);
        if (team1LogoPreview) {
          // Сначала проверяем, есть ли у пресета свой preset_ логотип
          if (preset.team1Logo && preset.team1Logo.includes('preset_')) {
            team1LogoPreview.innerHTML = `<img src="${preset.team1Logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
          } else if (selectedTeam1 && selectedTeam1.logo) {
            team1LogoPreview.innerHTML = `<img src="${selectedTeam1.logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
          }
        }
      }
      
      if (currentTeam2Id) {
        selectedTeam2 = tournament.teams.find(t => t.id === currentTeam2Id);
        if (team2LogoPreview) {
          // Сначала проверяем, есть ли у пресета свой preset_ логотип
          if (preset.team2Logo && preset.team2Logo.includes('preset_')) {
            team2LogoPreview.innerHTML = `<img src="${preset.team2Logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
          } else if (selectedTeam2 && selectedTeam2.logo) {
            team2LogoPreview.innerHTML = `<img src="${selectedTeam2.logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
          }
        }
      }
      
      // Проверяем, был ли цвет изменен пользователем вручную в пресете
      // Если цвет пресета отличается от цвета команды - значит пользователь менял его
      if (selectedTeam1 && kit1ColorInput) {
        const presetColor = preset.kit1Color || '#2b2b2b';
        const teamColor = selectedTeam1.kitColor || '#2b2b2b';
        if (presetColor !== teamColor) {
          // Цвет был изменен вручную, помечаем как manualEdit (но не userEdited, так как это из пресета)
          kit1ColorInput.dataset.manualEdit = 'true';
          kit1ColorInput.dataset.userEdited = undefined;
          // Устанавливаем цвет из пресета
          kit1ColorInput.value = presetColor;
        } else {
          // Цвет совпадает с командой, оставляем возможность автоматического обновления
          kit1ColorInput.dataset.manualEdit = undefined;
          kit1ColorInput.dataset.userEdited = undefined;
          // Устанавливаем цвет из команды
          kit1ColorInput.value = teamColor;
        }
      } else if (!selectedTeam1 && kit1ColorInput) {
        // Если команда не выбрана, устанавливаем цвет из пресета если есть
        kit1ColorInput.value = preset.kit1Color || '#2b2b2b';
      }
      
      if (selectedTeam2 && kit2ColorInput) {
        const presetColor = preset.kit2Color || '#2b2b2b';
        const teamColor = selectedTeam2.kitColor || '#2b2b2b';
        if (presetColor !== teamColor) {
          // Цвет был изменен вручную, помечаем как manualEdit (но не userEdited, так как это из пресета)
          kit2ColorInput.dataset.manualEdit = 'true';
          kit2ColorInput.dataset.userEdited = undefined;
          // Устанавливаем цвет из пресета
          kit2ColorInput.value = presetColor;
        } else {
          // Цвет совпадает с командой, оставляем возможность автоматического обновления
          kit2ColorInput.dataset.manualEdit = undefined;
          kit2ColorInput.dataset.userEdited = undefined;
          // Устанавливаем цвет из команды
          kit2ColorInput.value = teamColor;
        }
      } else if (!selectedTeam2 && kit2ColorInput) {
        // Если команда не выбрана, устанавливаем цвет из пресета если есть
        kit2ColorInput.value = preset.kit2Color || '#2b2b2b';
      }
      
      // Обновляем имя пресета
      updateEditPresetNameInline(tournamentId, presetId);
      
      // КРИТИЧНО: Устанавливаем editingPresetId ПЕРЕД показом формы
      // Это защищает форму от перерисовки при обновлении состояния от сервера
      editingPresetId = presetId;
      originalPresetData = {
        name: preset.name,
        team1Name: preset.team1Name,
        team2Name: preset.team2Name,
        kit1Color: preset.kit1Color,
        kit2Color: preset.kit2Color
      };
      
      console.log('Edit form opened, editingPresetId set to:', presetId);
      
      // Теперь скрываем presetItem и показываем форму редактирования
      presetItem.style.display = 'none';
      editForm.classList.remove('hidden');
      presetItem.classList.add('edit-mode');
      
      // Заполняем селекты команд
      const team1Select = editForm.querySelector('.editPresetTeam1SelectInline');
      const team2Select = editForm.querySelector('.editPresetTeam2SelectInline');
      
      tournament.teams.forEach(team => {
        const option1 = document.createElement('option');
        option1.value = team.id;
        option1.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        if (currentTeam1Id && team.id === currentTeam1Id) {
          option1.selected = true;
          selectedTeam1 = team;
          // Логотип уже установлен выше (приоритет у preset_ логотипа)
        }
        team1Select.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = team.id;
        option2.textContent = `${team.name}${team.city ? ' (' + team.city + ')' : ''}`;
        if (currentTeam2Id && team.id === currentTeam2Id) {
          option2.selected = true;
          selectedTeam2 = team;
          // Логотип уже установлен выше (приоритет у preset_ логотипа)
        }
        team2Select.appendChild(option2);
      });
    }
    // Обновление имени пресета при редактировании
    function updateEditPresetNameInline(tournamentId, presetId) {
      const editForm = document.getElementById(`preset-edit-form-${tournamentId}-${presetId}`);
      if (!editForm) return;
      
      const timeInput = editForm.querySelector('.editPresetMatchTimeInline');
      const titleElement = editForm.querySelector('.editPresetTitleInline');
      const team1Select = editForm.querySelector('.editPresetTeam1SelectInline');
      const team2Select = editForm.querySelector('.editPresetTeam2SelectInline');
      
      if (!timeInput || !titleElement || !team1Select || !team2Select) return;
      
      const matchTime = timeInput.value || '19:00';
      
      let team1Name = 'Команда 1';
      let team2Name = 'Команда 2';
      
      if (team1Select.value) {
        const tournament = tournaments.find(t => t.id === tournamentId);
        if (tournament && tournament.teams) {
          const team = tournament.teams.find(t => t.id === team1Select.value);
          if (team) team1Name = team.name;
        }
      }
      
      if (team2Select.value) {
        const tournament = tournaments.find(t => t.id === tournamentId);
        if (tournament && tournament.teams) {
          const team = tournament.teams.find(t => t.id === team2Select.value);
          if (team) team2Name = team.name;
        }
      }
      
      titleElement.textContent = `${matchTime} / ${team1Name} - ${team2Name}`;
    }
    
    // Обработка выбора команды 1 при редактировании
    function onEditTeam1SelectedInline(tournamentId, presetId, selectElement) {
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) return;
      
      const teamId = selectElement.value;
      const editForm = selectElement.closest('.preset-edit-form-inline');
      
      if (!teamId) {
        // Очищаем логотип и цвет при сбросе выбора
        const logoPreview = editForm?.querySelector('.editPresetTeam1LogoPreview');
        if (logoPreview) {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
        // Сбрасываем флаг manualEdit при сбросе команды
        const colorInput = editForm?.querySelector('.editPresetKit1ColorInline');
        if (colorInput) {
          colorInput.dataset.manualEdit = undefined;
        }
        updateEditPresetNameInline(tournamentId, presetId);
        return;
      }
      
      const team = tournament.teams.find(t => t.id === teamId);
      if (!team) return;
      
      // Обновляем логотип команды
      const logoPreview = editForm?.querySelector('.editPresetTeam1LogoPreview');
      if (logoPreview) {
        if (team.logo) {
          logoPreview.innerHTML = `<img src="${team.logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
        } else {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
      }
      
      // Обновляем цвет формы из команды
      const colorInput = editForm?.querySelector('.editPresetKit1ColorInline');
      if (colorInput) {
        // Проверяем, был ли цвет изменен вручную пользователем в текущей сессии редактирования
        // Если флаг manualEdit установлен, значит пользователь явно менял цвет - не обновляем
        // Если флага нет, или он был установлен при инициализации (не вручную), обновляем из команды
        const wasManuallyEdited = colorInput.dataset.manualEdit === 'true' && 
                                  colorInput.dataset.userEdited === 'true';
        
        if (!wasManuallyEdited) {
          // Берем цвет из выбранной команды и обновляем
          colorInput.value = team.kitColor || '#2b2b2b';
          // Сбрасываем флаг manualEdit, так как цвет взят из команды
          colorInput.dataset.manualEdit = undefined;
          colorInput.dataset.userEdited = undefined;
          // Принудительно обновляем визуальное отображение
          setTimeout(() => {
            colorInput.style.backgroundColor = colorInput.value;
          }, 0);
        }
      }
      
      updateEditPresetNameInline(tournamentId, presetId);
    }
    
    // Обработка выбора команды 2 при редактировании
    function onEditTeam2SelectedInline(tournamentId, presetId, selectElement) {
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) return;
      
      const teamId = selectElement.value;
      const editForm = selectElement.closest('.preset-edit-form-inline');
      
      if (!teamId) {
        // Очищаем логотип и цвет при сбросе выбора
        const logoPreview = editForm?.querySelector('.editPresetTeam2LogoPreview');
        if (logoPreview) {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
        // Сбрасываем флаг manualEdit при сбросе команды
        const colorInput = editForm?.querySelector('.editPresetKit2ColorInline');
        if (colorInput) {
          colorInput.dataset.manualEdit = undefined;
        }
        updateEditPresetNameInline(tournamentId, presetId);
        return;
      }
      
      const team = tournament.teams.find(t => t.id === teamId);
      if (!team) return;
      
      // Обновляем логотип команды
      const logoPreview = editForm?.querySelector('.editPresetTeam2LogoPreview');
      if (logoPreview) {
        if (team.logo) {
          logoPreview.innerHTML = `<img src="${team.logo}" alt="Логотип" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
        } else {
          logoPreview.innerHTML = '<div style="font-size: 10px; color: #999;">Лого</div>';
        }
      }
      
      // Обновляем цвет формы из команды
      const colorInput = editForm?.querySelector('.editPresetKit2ColorInline');
      if (colorInput) {
        // Проверяем, был ли цвет изменен вручную пользователем в текущей сессии редактирования
        // Если флаг manualEdit установлен, значит пользователь явно менял цвет - не обновляем
        // Если флага нет, или он был установлен при инициализации (не вручную), обновляем из команды
        const wasManuallyEdited = colorInput.dataset.manualEdit === 'true' && 
                                  colorInput.dataset.userEdited === 'true';
        
        if (!wasManuallyEdited) {
          // Берем цвет из выбранной команды и обновляем
          colorInput.value = team.kitColor || '#2b2b2b';
          // Сбрасываем флаг manualEdit, так как цвет взят из команды
          colorInput.dataset.manualEdit = undefined;
          colorInput.dataset.userEdited = undefined;
          // Принудительно обновляем визуальное отображение
          setTimeout(() => {
            colorInput.style.backgroundColor = colorInput.value;
          }, 0);
        }
      }
      
      updateEditPresetNameInline(tournamentId, presetId);
    }
    
    // Сохранение редактируемого пресета inline
    async function saveEditPresetInline(tournamentId, presetId) {
      const editForm = document.getElementById(`preset-edit-form-${tournamentId}-${presetId}`);
      if (!editForm) return;
      
      // КРИТИЧНО: Сохраняем editingPresetId во временную переменную
      // Очистим его только после успешного сохранения, чтобы форма не закрылась во время операции
      const currentEditingPresetId = editingPresetId;
      
      // Находим текущий пресет для получения сохраненных логотипов
      const currentPreset = presets.find(p => p.id === presetId);
      
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) {
        alert('Турнир не найден');
        return;
      }
      
      const team1Select = editForm.querySelector('.editPresetTeam1SelectInline');
      const team2Select = editForm.querySelector('.editPresetTeam2SelectInline');
      const timeInput = editForm.querySelector('.editPresetMatchTimeInline');
      const kit1ColorInput = editForm.querySelector('.editPresetKit1ColorInline');
      const kit2ColorInput = editForm.querySelector('.editPresetKit2ColorInline');
      
      if (!team1Select || !team2Select || !team1Select.value || !team2Select.value) {
        alert('Выберите обе команды');
        return;
      }
      
      const team1Id = team1Select.value;
      const team2Id = team2Select.value;
      
      const team1 = tournament.teams.find(t => t.id === team1Id);
      const team2 = tournament.teams.find(t => t.id === team2Id);
      
      if (!team1 || !team2) {
        alert('Команды не найдены');
        return;
      }
      
      // Формируем имя пресета автоматически
      const matchTime = timeInput.value || '19:00';
      const presetName = `${matchTime} / ${team1.name} - ${team2.name}`;
      
      // Определяем логотипы:
      // 1. Если был явно загружен новый логотип (uploadedLogos) - используем его
      // 2. Если команда не изменилась и у пресета уже есть preset_ логотип - сохраняем его
      // 3. Если команда изменилась или у пресета нет preset_ логотипа - берем логотип команды (сервер создаст новый preset_)
      // Это НЕ изменяет логотип команды - только сохраняет уникальный логотип в пресет.
      
      const team1Changed = currentPreset && currentPreset.team1Id !== team1Id;
      const team2Changed = currentPreset && currentPreset.team2Id !== team2Id;
      
      let team1Logo = uploadedLogos.team1;
      if (!team1Logo) {
        // Если команда не изменилась и у пресета есть preset_ логотип - сохраняем его
        if (!team1Changed && currentPreset && currentPreset.team1Logo && currentPreset.team1Logo.includes('preset_')) {
          team1Logo = currentPreset.team1Logo;
        } else {
          // Команда изменилась или нет preset_ логотипа - берем логотип команды (сервер создаст новый preset_)
          team1Logo = team1.logo || '';
        }
      }
      
      let team2Logo = uploadedLogos.team2;
      if (!team2Logo) {
        // Если команда не изменилась и у пресета есть preset_ логотип - сохраняем его
        if (!team2Changed && currentPreset && currentPreset.team2Logo && currentPreset.team2Logo.includes('preset_')) {
          team2Logo = currentPreset.team2Logo;
        } else {
          // Команда изменилась или нет preset_ логотипа - берем логотип команды (сервер создаст новый preset_)
          team2Logo = team2.logo || '';
        }
      }
      
      const preset = {
        name: presetName,
        tournamentId: tournamentId,
        team1Id: team1Id,
        team2Id: team2Id,
        team1Name: team1.name,
        team1City: team1.city || '',
        team1Short: team1.short || '',
        team2Name: team2.name,
        team2City: team2.city || '',
        team2Short: team2.short || '',
        kit1Color: kit1ColorInput.value || '#2b2b2b',
        kit2Color: kit2ColorInput.value || '#2b2b2b',
        team1Logo: team1Logo,
        team2Logo: team2Logo
      };
      
      try {
        const response = await fetch(`/api/presets/${presetId}?token=${getToken()}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });
        
        if (response.ok) {
          // Сохраняем состояние видимости пресетов
          const presetsDiv = document.getElementById(`presets-${tournamentId}`);
          const wasHidden = presetsDiv ? presetsDiv.classList.contains('hidden') : false;

          // КРИТИЧНО: очищаем editingPresetId ПЕРЕД перерисовкой
          editingPresetId = null;
          originalPresetData = null;

          await loadPresets();
          await loadTournaments();

          // Очищаем uploadedLogos после сохранения, чтобы не влиять на следующее редактирование
          uploadedLogos.team1 = null;
          uploadedLogos.team2 = null;

          // Восстанавливаем состояние видимости и перерисовываем
          if (presetsDiv) {
            if (wasHidden) {
              presetsDiv.classList.add('hidden');
              expandedPresets.delete(tournamentId);
            } else {
              presetsDiv.classList.remove('hidden');
              expandedPresets.add(tournamentId);
            }
          }
          renderTournamentPresets();
          
          // Update preset apply buttons state after saving
          updatePresetApplyButtons();

          showNotification('Пресет обновлен!', 'success');
        } else {
          throw new Error('Ошибка обновления пресета');
        }
      } catch (error) {
        console.error('Ошибка обновления пресета:', error);
        showNotification('Ошибка обновления пресета', 'error');
        // В случае ошибки не очищаем editingPresetId, чтобы форма осталась открытой
      }
    }
    
    // Отмена редактирования пресета inline
    function cancelEditPresetInline(tournamentId, presetId) {
      const presetWrapper = document.querySelector(`.preset-item-wrapper[data-preset-id="${presetId}"][data-tournament-id="${tournamentId}"]`);
      if (!presetWrapper) return;
      
      const presetItem = presetWrapper.querySelector('.preset-item');
      const editForm = presetWrapper.querySelector(`#preset-edit-form-${tournamentId}-${presetId}`);
      
      // КРИТИЧНО: Очищаем editingPresetId ПЕРЕД закрытием формы
      // Это предотвращает срабатывание защитных проверок при перерисовке
      editingPresetId = null;
      originalPresetData = null;
      
      // Скрываем форму редактирования
      if (editForm) {
        editForm.classList.add('hidden');
        editForm.innerHTML = '';
      }
      
      // Показываем presetItem обратно
      if (presetItem) {
        presetItem.style.display = '';
        presetItem.classList.remove('edit-mode');
      }
      
      console.log('Edit form closed via Cancel button');
    }

    // Подтверждение применения предустановки
    function confirmApplyPreset(presetId) {
      if (timerRunning || scoreboardState.penaltyActive) {
        showNotification('Применение пресета заблокировано во время активного таймера или серии пенальти', 'info');
        return;
      }
      const preset = presets.find(p => p.id === presetId);
      if (!preset) return;
      
      const snapshot = getCurrentScoreboardSnapshot();
      const hasActiveScoreboard = snapshot.score1 !== 0 || snapshot.score2 !== 0 || snapshot.timerSeconds !== 0;

      // Создание модального окна подтверждения
      const modal = document.createElement('div');
      modal.className = 'confirmation-modal';
      modal.innerHTML = `
        <div class="confirmation-content">
          <h3>Применить предустановку?</h3>
          <p>Вы уверены, что хотите применить предустановку "<strong>${preset.name}</strong>"?</p>
          <p><small>Это заменит текущие данные команд.</small></p>
          ${hasActiveScoreboard ? `<p style="margin-top: 10px; padding: 10px; background: #fff8e1; border: 1px solid #f0c36d; border-radius: 6px; color: #8a5a0a; font-size: 13px;">
            На табло уже выставлены счёт или время. Похоже, сейчас идёт перерыв — переключение команд в основном меню может привести к ошибкам трансляции.
          </p>` : ''}
          <div class="confirmation-buttons">
            <button class="confirmation-btn confirm" onclick="applyPreset('${presetId}'); closeConfirmation()">Да, применить</button>
            <button class="confirmation-btn cancel" onclick="closeConfirmation()">Отмена</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    // Закрытие модального окна
    function closeConfirmation() {
      const modal = document.querySelector('.confirmation-modal');
      if (modal) {
        modal.remove();
      }
    }

    // Применение предустановки
    // Копирование логотипа из пресета в основную панель
    async function copyLogoFromPreset(team, presetLogoUrl) {
      if (!presetLogoUrl) return '';
      
      try {
        // Создаем уникальное имя файла с timestamp
        const timestamp = Date.now();
        const extension = presetLogoUrl.split('.').pop();
        const newFilename = `main_${team}_${timestamp}.${extension}`;
        
        // Копируем файл на сервере
        const response = await fetch(`/api/copy-logo?token=${getToken()}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceUrl: presetLogoUrl,
            newFilename: newFilename
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          return result.url;
        } else {
          console.error('Ошибка копирования логотипа:', await response.text());
          return presetLogoUrl; // Fallback к оригинальному URL
        }
      } catch (error) {
        console.error('Ошибка копирования логотипа:', error);
        return presetLogoUrl; // Fallback к оригинальному URL
      }
    }

    async function applyPreset(presetId) {
      if (timerRunning || scoreboardState.penaltyActive) {
        showNotification('Применение пресета заблокировано во время активного таймера или серии пенальти', 'info');
        return;
      }
      const preset = presets.find(p => p.id === presetId);
      if (!preset) return;

      if (!confirmBreakWarningIfNeeded()) {
        return;
      }
      
      // Сбрасываем счет и таймер в нулевые состояния (как при нажатии на кнопку set)
      const resetPayload = {
        timerSeconds: 0,
        score1: 0,
        score2: 0
      };
      let penaltyWasReset = false;
      if (scoreboardState.penaltyActive || (scoreboardState.penaltySeries && Array.isArray(scoreboardState.penaltySeries.history))) {
        penaltyWasReset = true;
        cancelPenaltyHold();
        scoreboardState.penaltyActive = false;
        scoreboardState.penaltySeries = null;
        resetPayload.penaltyActive = false;
        resetPayload.penaltySeries = null;
      }
      socket.emit('updateScoreboard', resetPayload);
      
      // Обновляем отображение
      const timeInputEl = document.getElementById('timeInput');
      const score1ValueEl = document.getElementById('score1Value');
      const score2ValueEl = document.getElementById('score2Value');
      if (timeInputEl) timeInputEl.value = '00:00';
      if (score1ValueEl) score1ValueEl.textContent = '0';
      if (score2ValueEl) score2ValueEl.textContent = '0';

      scoreboardState.score1 = 0;
      scoreboardState.score2 = 0;
      scoreboardState.timerSeconds = 0;
      if (penaltyWasReset) {
        updatePenaltyControlsUI();
      }
      
      // Находим турнир и команды для получения актуальных логотипов
      let team1Logo = '';
      let team2Logo = '';
      
      if (preset.tournamentId) {
        const tournament = tournaments.find(t => t.id === preset.tournamentId);
        if (tournament && tournament.teams) {
          if (preset.team1Id) {
            const team1 = tournament.teams.find(t => t.id === preset.team1Id);
            if (team1 && team1.logo) {
              team1Logo = team1.logo;
            }
          }
          if (preset.team2Id) {
            const team2 = tournament.teams.find(t => t.id === preset.team2Id);
            if (team2 && team2.logo) {
              team2Logo = team2.logo;
            }
          }
        }
      }
      
      // Если не нашли в турнире, используем значения из пресета (для обратной совместимости)
      if (!team1Logo && preset.team1Logo) {
        team1Logo = preset.team1Logo;
      }
      if (!team2Logo && preset.team2Logo) {
        team2Logo = preset.team2Logo;
      }
      
      // Применение данных предустановки к display элементам
      const team1NameDisplay = document.getElementById('team1NameDisplay');
      const team1CityDisplay = document.getElementById('team1CityDisplay');
      const team1ShortDisplayUpper = document.getElementById('team1ShortDisplayUpper');
      const team2NameDisplay = document.getElementById('team2NameDisplay');
      const team2CityDisplay = document.getElementById('team2CityDisplay');
      const team2ShortDisplayUpper = document.getElementById('team2ShortDisplayUpper');
      
      if (team1NameDisplay) team1NameDisplay.textContent = preset.team1Name || 'Не введено';
      if (team1CityDisplay) team1CityDisplay.textContent = preset.team1City || 'Не введено';
      if (team1ShortDisplayUpper) team1ShortDisplayUpper.textContent = preset.team1Short || '---';
      if (team2NameDisplay) team2NameDisplay.textContent = preset.team2Name || 'Не введено';
      if (team2CityDisplay) team2CityDisplay.textContent = preset.team2City || 'Не введено';
      if (team2ShortDisplayUpper) team2ShortDisplayUpper.textContent = preset.team2Short || '---';
      
      // Сохраняем шорткоды в состояние
      scoreboardState.team1Short = preset.team1Short || '';
      scoreboardState.team2Short = preset.team2Short || '';
      
      const kit1ColorEl = document.getElementById('kit1Color');
      const kit2ColorEl = document.getElementById('kit2Color');
      if (kit1ColorEl) kit1ColorEl.value = preset.kit1Color || '#2b2b2b';
      if (kit2ColorEl) kit2ColorEl.value = preset.kit2Color || '#2b2b2b';
      
      // Копирование логотипов из турнира (создание уникальных копий для основной панели)
      // Это НЕ изменяет логотипы команд в турнире, только применяет их к панели
      if (team1Logo) {
        const copiedLogoUrl = await copyLogoFromPreset('team1', team1Logo);
        updateMainLogoMini('team1', copiedLogoUrl);
        state.team1Logo = copiedLogoUrl;
      } else {
        showKitColorCircle('team1');
        state.team1Logo = '';
      }
      
      if (team2Logo) {
        const copiedLogoUrl = await copyLogoFromPreset('team2', team2Logo);
        updateMainLogoMini('team2', copiedLogoUrl);
        state.team2Logo = copiedLogoUrl;
      } else {
        showKitColorCircle('team2');
        state.team2Logo = '';
      }
      
      // СРАЗУ отправляем полное состояние на сервер для сохранения
      // Это критично для сохранения данных при перезагрузке
      socket.emit('updateScoreboard', {
        team1Name: preset.team1Name || '',
        team1City: preset.team1City || '',
        team1Short: preset.team1Short || '',
        team2Name: preset.team2Name || '',
        team2City: preset.team2City || '',
        team2Short: preset.team2Short || '',
        kit1Color: preset.kit1Color || '#2b2b2b',
        kit2Color: preset.kit2Color || '#2b2b2b',
        team1Logo: state.team1Logo || '',
        team2Logo: state.team2Logo || ''
      });
      
      // Показ уведомления
      showNotification(`Применена предустановка: ${preset.name}`, 'success');
    }

    // Удаление предустановки
    async function deletePreset(presetId) {
      if (!confirm('Удалить эту предустановку?')) return;
      
      try {
        await fetch(`/api/presets/${presetId}?token=${getToken()}`, {
          method: 'DELETE'
        });
        // Пресеты привязаны к турнирам, не нужно перезагружать список
      } catch (error) {
        console.error('Ошибка удаления предустановки:', error);
      }
    }
    // Сохранение предустановки из формы внутри турнира
    async function saveNewPresetFromForm(buttonElement) {
      // Ищем форму - кнопка находится внутри form-buttons, который внутри формы
      let formContainer = buttonElement.closest('[id^="presetFormContent_"]');
      
      // Если не нашли через closest (кнопка может быть вне формы), ищем через родителя
      if (!formContainer) {
        const formButtons = buttonElement.closest('.form-buttons');
        if (formButtons) {
          formContainer = formButtons.closest('[id^="presetFormContent_"]');
        }
      }
      
      // Если все еще не нашли, ищем последнюю открытую форму
      if (!formContainer) {
        formContainer = document.querySelector('[id^="presetFormContent_"]:not(.hidden)');
      }
      
      if (!formContainer) {
        console.error('Form container not found', buttonElement);
        alert('Ошибка: форма не найдена');
        return;
      }
      
      console.log('Form container found:', formContainer.id, formContainer);
      
      // Ищем элементы формы - используем более точные селекторы
      const tournamentSelect = formContainer.querySelector('select.addPresetTournament');
      
      // Получаем tournamentId из селекта, data-атрибута или из ID формы
      let tournamentId = tournamentSelect?.value;
      
      // Если tournamentId пустой, пытаемся получить из data-атрибута формы
      if (!tournamentId || tournamentId.trim() === '') {
        tournamentId = formContainer.dataset.tournamentId;
      }
      
      // Если все еще пустой, пытаемся извлечь его из ID формы (presetFormContent_TOURNAMENT_ID)
      if (!tournamentId || tournamentId.trim() === '') {
        const formId = formContainer.id;
        const match = formId.match(/presetFormContent_(.+)/);
        if (match && match[1]) {
          tournamentId = match[1];
          console.log('Extracted tournament ID from form ID:', tournamentId);
        }
      }
      
      const team1Select = formContainer.querySelector('select.addPresetTeam1Select');
      const team2Select = formContainer.querySelector('select.addPresetTeam2Select');
      
      console.log('Found elements:', {
        tournamentSelect: !!tournamentSelect,
        tournamentId: tournamentId,
        formId: formContainer.id,
        team1Select: !!team1Select,
        team2Select: !!team2Select
      });
      
      // Проверяем наличие элементов
      if (!team1Select) {
        console.error('Team1 select not found', formContainer.innerHTML.substring(0, 500));
        alert('Ошибка: не найден селект команды 1');
        return;
      }
      
      if (!team2Select) {
        console.error('Team2 select not found', formContainer.innerHTML.substring(0, 500));
        alert('Ошибка: не найден селект команды 2');
        return;
      }
      
      if (!tournamentId || tournamentId.trim() === '') {
        console.error('Tournament ID is empty', { tournamentSelect, formId: formContainer.id });
        alert('Ошибка: не удалось определить турнир. Пожалуйста, закройте и откройте форму создания пресета заново.');
        return;
      }
      
      const team1Id = team1Select.value;
      const team2Id = team2Select.value;
      
      if (!team1Id || !team2Id) {
        alert('Выберите обе команды из турнира');
        return;
      }
      
      // Получаем данные команд из турнира
      const tournament = tournaments.find(t => t.id === tournamentId);
      if (!tournament || !tournament.teams) {
        alert('Турнир не найден');
        return;
      }
      
      const team1 = tournament.teams.find(t => t.id === team1Id);
      const team2 = tournament.teams.find(t => t.id === team2Id);
      
      if (!team1 || !team2) {
        alert('Команды не найдены');
        return;
      }
      
      // Формируем имя пресета автоматически
      const matchTime = formContainer.querySelector('.addPresetMatchTime')?.value || '19:00';
      const presetName = `${matchTime} / ${team1.name} - ${team2.name}`;
      
      // Получаем поля формы (если они заполнены, используем их, иначе данные команды)
      const team1NameInput = formContainer.querySelector('[id*="Team1Name"]');
      const team1CityInput = formContainer.querySelector('[id*="Team1City"]');
      const team1ShortInput = formContainer.querySelector('[id*="Team1Short"]');
      // Ищем поле цвета по классу (как в форме редактирования)
      const team1KitColorInput = formContainer.querySelector('.addPresetKit1Color');
      
      const team2NameInput = formContainer.querySelector('[id*="Team2Name"]');
      const team2CityInput = formContainer.querySelector('[id*="Team2City"]');
      const team2ShortInput = formContainer.querySelector('[id*="Team2Short"]');
      // Ищем поле цвета по классу (как в форме редактирования)
      const team2KitColorInput = formContainer.querySelector('.addPresetKit2Color');
      
      // Берем цвет из input или из команды (как в форме редактирования)
      const kit1Color = team1KitColorInput?.value || team1.kitColor || '#2b2b2b';
      const kit2Color = team2KitColorInput?.value || team2.kitColor || '#2b2b2b';
      
      const preset = {
        name: presetName,
        tournamentId: tournamentId,
        matchDate: formContainer?.dataset?.matchDate || null,
        team1Id: team1Id,
        team2Id: team2Id,
        team1Name: (team1NameInput?.value.trim()) || team1.name,
        team1City: (team1CityInput?.value.trim()) || team1.city || '',
        team1Short: (team1ShortInput?.value.trim().toUpperCase()) || team1.short || '',
        team2Name: (team2NameInput?.value.trim()) || team2.name,
        team2City: (team2CityInput?.value.trim()) || team2.city || '',
        team2Short: (team2ShortInput?.value.trim().toUpperCase()) || team2.short || '',
        kit1Color: kit1Color,
        kit2Color: kit2Color,
        team1Logo: team1.logo || '',
        team2Logo: team2.logo || ''
      };
      
      // Валидация
      if (!preset.team1Name || !preset.team2Name) {
        alert('Названия команд обязательны');
        return;
      }
      
      try {
        const response = await fetch(`/api/presets?token=${getToken()}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });
        
        if (response.ok) {
          // Закрываем форму
          const formWrapper = formContainer.closest('[id^="presetForm_"]');
          if (formWrapper) {
            formWrapper.classList.add('hidden');
            formWrapper.innerHTML = '';
          }
          
          // Сохраняем состояние видимости пресетов
          const presetsDiv = document.getElementById(`presets-${tournamentId}`);
          const wasHidden = presetsDiv ? presetsDiv.classList.contains('hidden') : false;
          
          // Перезагружаем пресеты и турниры
          await loadPresets();
          await loadTournaments();
          
          // Восстанавливаем состояние видимости (по умолчанию пресеты видны)
          if (presetsDiv) {
            if (wasHidden) {
              presetsDiv.classList.add('hidden');
              expandedPresets.delete(tournamentId);
            } else {
              presetsDiv.classList.remove('hidden');
              expandedPresets.add(tournamentId);
              renderTournamentPresets(); // Рендерим если видим
            }
          }
          
          // Update preset apply buttons state after saving
          updatePresetApplyButtons();
          
          showNotification('Предустановка создана!', 'success');
        } else {
          throw new Error('Ошибка сохранения предустановки');
        }
      } catch (error) {
        console.error('Ошибка сохранения предустановки:', error);
        showNotification('Ошибка сохранения предустановки', 'error');
      }
    }
    
    // Отмена создания пресета из формы
    function cancelAddPresetFromForm(buttonElement) {
      const formContainer = buttonElement.closest('[id^="presetFormContent_"]');
      if (!formContainer) return;
      
      const formWrapper = formContainer.closest('[id^="presetForm_"]');
      if (formWrapper) {
        formWrapper.classList.add('hidden');
        formWrapper.innerHTML = '';
      }
    }
    
    // Сохранение предустановки (старая версия для совместимости)
    async function saveNewPreset() {
      if (!selectedTeams.team1 || !selectedTeams.team2) {
        alert('Выберите обе команды из турнира');
        return;
      }
      
      // Формируем имя пресета автоматически из времени и названий команд
      const matchTime = document.getElementById('addPresetMatchTime').value || '19:00';
      const presetName = `${matchTime} / ${selectedTeams.team1.name} - ${selectedTeams.team2.name}`;
      
      const preset = {
        name: presetName,
        team1Name: document.getElementById('addPresetTeam1Name').value.trim(),
        team1City: document.getElementById('addPresetTeam1City').value.trim(),
        team1Short: document.getElementById('addPresetTeam1Short').value.trim().toUpperCase(),
        team2Name: document.getElementById('addPresetTeam2Name').value.trim(),
        team2City: document.getElementById('addPresetTeam2City').value.trim(),
        team2Short: document.getElementById('addPresetTeam2Short').value.trim().toUpperCase(),
        kit1Color: document.getElementById('addPresetKit1Color').value,
        kit2Color: document.getElementById('addPresetKit2Color').value,
        team1Logo: uploadedLogos.team1 || '',
        team2Logo: uploadedLogos.team2 || ''
      };

      // Валидация
      if (!preset.team1Name || !preset.team2Name) {
        alert('Названия команд обязательны');
        return;
      }

      try {
        const response = await fetch(`/api/presets?token=${getToken()}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });

        if (!response.ok) {
          throw new Error('Ошибка сохранения предустановки');
        }

        // Очистка формы
        document.getElementById('addPresetForm').querySelectorAll('input').forEach(input => {
          if (input.type === 'text') input.value = '';
          if (input.type === 'color') {
            if (input.id.includes('Kit1')) input.value = '#2b2b2b';
            if (input.id.includes('Kit2')) input.value = '#2b2b2b';
          }
        });
        
        // Очистка логотипов
        uploadedLogos = { team1: null, team2: null };
        document.getElementById('addPresetTeam1LogoPreview').innerHTML = '';
        document.getElementById('addPresetTeam2LogoPreview').innerHTML = '';
        
        // Скрытие формы
        document.getElementById('addPresetForm').classList.add('hidden');
        
        // Перезагрузка предустановок
        // Пресеты привязаны к турнирам, не нужно перезагружать список
        // Но загружаем для редактирования если нужно
        await loadPresets();
        
        // Показ уведомления об успехе
        showNotification('Предустановка создана!', 'success');
        
      } catch (error) {
        console.error('Ошибка сохранения предустановки:', error);
        showNotification('Ошибка сохранения предустановки', 'error');
      }
    }
    async function savePreset() {
      const preset = {
        name: document.getElementById('presetName').value.trim(),
        team1Name: document.getElementById('presetTeam1Name').value.trim(),
        team1City: document.getElementById('presetTeam1City').value.trim(),
        team1Short: document.getElementById('presetTeam1Short').value.trim().toUpperCase(),
        team2Name: document.getElementById('presetTeam2Name').value.trim(),
        team2City: document.getElementById('presetTeam2City').value.trim(),
        team2Short: document.getElementById('presetTeam2Short').value.trim().toUpperCase(),
        kit1Color: document.getElementById('presetKit1Color').value,
        kit2Color: document.getElementById('presetKit2Color').value
      };

      // Валидация
      if (!preset.name) {
        alert('Введите название матча');
        return;
      }
      
      if (!preset.team1Name || !preset.team2Name) {
        alert('Введите названия обеих команд');
        return;
      }

      try {
        const response = await fetch(`/api/presets?token=${getToken()}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });
        
        if (!response.ok) {
          throw new Error('Ошибка сохранения предустановки');
        }
        
        // Очистка формы
        document.getElementById('addPresetForm').querySelectorAll('input').forEach(input => {
          if (input.type === 'text') input.value = '';
          if (input.type === 'color') {
            if (input.id.includes('Kit1')) input.value = '#2b2b2b';
            if (input.id.includes('Kit2')) input.value = '#2b2b2b';
          }
        });
        
        // Скрытие формы
        toggleAddPresetForm();
        
        // Перезагрузка предустановок
        // Пресеты привязаны к турнирам, не нужно перезагружать список
        // Но загружаем для редактирования если нужно
        await loadPresets();
        
        // Показ уведомления об успехе
        showNotification('Предустановка сохранена!', 'success');
        
      } catch (error) {
        console.error('Ошибка сохранения предустановки:', error);
        showNotification('Ошибка сохранения предустановки', 'error');
      }
    }

    
    function cancelAddPreset() {
      // Очистка формы
      document.getElementById('addPresetForm').querySelectorAll('input').forEach(input => {
        if (input.type === 'text') input.value = '';
        if (input.type === 'color') {
          if (input.id.includes('Kit1')) input.value = '#2b2b2b';
          if (input.id.includes('Kit2')) input.value = '#2b2b2b';
        }
      });
      
      // Очистка селектов
      const select = document.getElementById('addPresetTournament');
      if (select) {
        select.value = '';
      }
      
      // Сброс времени и имени
      document.getElementById('addPresetMatchTime').value = '19:00';
      selectedTeams = { team1: null, team2: null };
      document.getElementById('addPresetTitle').textContent = '19:00 / Команда 1 - Команда 2';
      
      document.getElementById('addPresetTeam1Select').innerHTML = '<option value="">-- Выберите команду --</option>';
      document.getElementById('addPresetTeam2Select').innerHTML = '<option value="">-- Выберите команду --</option>';
      
      // Очистка логотипов
      uploadedLogos = { team1: null, team2: null };
      selectedTeams = { team1: null, team2: null };
      document.getElementById('addPresetTeam1LogoPreview').innerHTML = '';
      document.getElementById('addPresetTeam2LogoPreview').innerHTML = '';
      
      // Скрытие деталей команд
      hideTeam1Details();
      hideTeam2Details();
      
      // Скрытие формы
      document.getElementById('addPresetForm').classList.add('hidden');
    }
    
    // Редактирование предустановки
    function editPreset(presetId) {
      const preset = presets.find(p => p.id === presetId);
      if (!preset) return;
      
      editingPresetId = presetId;
      
      // Сохраняем исходные данные для сравнения
      originalPresetData = {
        name: preset.name,
        team1Name: preset.team1Name,
        team1City: preset.team1City,
        team1Short: preset.team1Short,
        kit1Color: preset.kit1Color,
        team2Name: preset.team2Name,
        team2City: preset.team2City,
        team2Short: preset.team2Short,
        kit2Color: preset.kit2Color
      };
      
      // Заполняем форму редактирования
      document.getElementById('editPresetTitle').textContent = preset.name;
      document.getElementById('editPresetTeam1Name').value = preset.team1Name;
      document.getElementById('editPresetTeam1City').value = preset.team1City;
      document.getElementById('editPresetTeam1Short').value = preset.team1Short;
      document.getElementById('editPresetKit1Color').value = preset.kit1Color;
      document.getElementById('editPresetTeam2Name').value = preset.team2Name;
      document.getElementById('editPresetTeam2City').value = preset.team2City;
      document.getElementById('editPresetTeam2Short').value = preset.team2Short;
      document.getElementById('editPresetKit2Color').value = preset.kit2Color;
      
      // Загружаем логотипы если есть
      if (preset.team1Logo) {
        showLogoPreview('team1', preset.team1Logo);
        updateLogoMini('team1', preset.team1Logo);
        uploadedLogos.team1 = preset.team1Logo;
        console.log('Loaded team1 logo:', preset.team1Logo);
      } else {
        clearLogo('team1');
        updateLogoMini('team1', null);
        uploadedLogos.team1 = null;
      }
      
      if (preset.team2Logo) {
        showLogoPreview('team2', preset.team2Logo);
        updateLogoMini('team2', preset.team2Logo);
        uploadedLogos.team2 = preset.team2Logo;
        console.log('Loaded team2 logo:', preset.team2Logo);
      } else {
        clearLogo('team2');
        updateLogoMini('team2', null);
        uploadedLogos.team2 = null;
      }
      
      // Скрываем карточку пресета и показываем форму редактирования на ее месте
      const presetCard = document.querySelector(`[data-preset-id="${presetId}"]`);
      if (presetCard) {
        presetCard.style.display = 'none';
        const editForm = document.getElementById('editPresetForm');
        
        // Полностью сбрасываем форму перед перемещением
        const presetsSection = document.querySelector('.presets-section');
        
        // Если форма не в правильном месте, принудительно перемещаем
        if (editForm.parentNode && editForm.parentNode !== presetsSection) {
          editForm.parentNode.removeChild(editForm);
          presetsSection.appendChild(editForm);
        }
        
        // Сбрасываем все стили формы
        editForm.style.position = '';
        editForm.style.top = '';
        editForm.style.left = '';
        editForm.style.display = 'block';
        editForm.classList.remove('hidden');
        
        // Вставляем форму после карточки пресета
        presetCard.parentNode.insertBefore(editForm, presetCard.nextSibling);
      }
    }
    
    // Обновление предустановки
    async function updatePreset() {
      if (!editingPresetId) return;
      
      const preset = {
        name: document.getElementById('editPresetTitle').textContent.trim(),
        team1Name: document.getElementById('editPresetTeam1Name').value.trim(),
        team1City: document.getElementById('editPresetTeam1City').value.trim(),
        team1Short: document.getElementById('editPresetTeam1Short').value.trim().toUpperCase(),
        team2Name: document.getElementById('editPresetTeam2Name').value.trim(),
        team2City: document.getElementById('editPresetTeam2City').value.trim(),
        team2Short: document.getElementById('editPresetTeam2Short').value.trim().toUpperCase(),
        kit1Color: document.getElementById('editPresetKit1Color').value,
        kit2Color: document.getElementById('editPresetKit2Color').value,
        team1Logo: uploadedLogos.team1 || '',
        team2Logo: uploadedLogos.team2 || ''
      };
      
      console.log('Saving preset with logos:', {
        team1Logo: preset.team1Logo,
        team2Logo: preset.team2Logo,
        uploadedLogos: uploadedLogos
      });

      // Валидация
      if (!preset.name) {
        alert('Введите название матча');
        return;
      }
      
      if (!preset.team1Name || !preset.team2Name) {
        alert('Введите названия обеих команд');
        return;
      }

      try {
        const response = await fetch(`/api/presets/${editingPresetId}?token=${getToken()}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(preset)
        });
        
        if (!response.ok) {
          throw new Error('Ошибка обновления предустановки');
        }
        
        // Скрытие формы
        cancelEditPreset();
        
        // Перезагрузка предустановок
        // Пресеты привязаны к турнирам, не нужно перезагружать список
        // Но загружаем для редактирования если нужно
        await loadPresets();
        
        // Показ уведомления об успехе
        showNotification('Предустановка обновлена!', 'success');
        
      } catch (error) {
        console.error('Ошибка обновления предустановки:', error);
        showNotification('Ошибка обновления предустановки', 'error');
      }
    }
    
    // Отмена редактирования
    function cancelEditPreset() {
      console.log('Отмена редактирования пресета:', editingPresetId);
      editingPresetId = null;
      originalPresetData = null;
      
      // Восстанавливаем все карточки пресетов
      const presetCards = document.querySelectorAll('.preset-card');
      presetCards.forEach(card => {
        card.style.display = '';
      });
      
      // Полностью сбрасываем форму редактирования
      const editForm = document.getElementById('editPresetForm');
      const presetsSection = document.querySelector('.presets-section');
      
      // Принудительно перемещаем форму в конец секции пресетов
      if (editForm.parentNode) {
        editForm.parentNode.removeChild(editForm);
      }
      presetsSection.appendChild(editForm);
      
      // Скрываем форму
      editForm.classList.add('hidden');
      editForm.style.display = 'none';
      
      // Сбрасываем все состояния формы
      editForm.style.position = '';
      editForm.style.top = '';
      editForm.style.left = '';
    }
    
    // Удаление предустановки из формы редактирования
    async function deletePresetFromEdit() {
      if (!editingPresetId) return;
      
      if (!confirm('Удалить эту предустановку? Это действие нельзя отменить.')) return;
      
      try {
        const response = await fetch(`/api/presets/${editingPresetId}?token=${getToken()}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          throw new Error('Ошибка удаления предустановки');
        }
        
        // Скрытие формы
        cancelEditPreset();
        
        // Перезагрузка предустановок
        // Пресеты привязаны к турнирам, не нужно перезагружать список
        // Но загружаем для редактирования если нужно
        await loadPresets();
        
        // Показ уведомления об успехе
        showNotification('Предустановка удалена! Логотипы, используемые в активной секции, защищены от удаления.', 'success');
        
      } catch (error) {
        console.error('Ошибка удаления предустановки:', error);
        showNotification('Ошибка удаления предустановки', 'error');
      }
    }

    // Автогенерация шорткодов
    function autoShortName(fullId, shortId, def) {
      const fullInput = document.getElementById(fullId);
      const shortInput = document.getElementById(shortId);
      let manual = false;

      function updateShort() {
        if (!manual) {
          shortInput.value = (fullInput.value || def).toUpperCase().slice(0,3);
        }
      }
      fullInput.addEventListener('input', updateShort);
      shortInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/[^A-ZА-ЯЁ0-9]/gi, '').slice(0,3);
        manual = true;
      });
      updateShort();
    }

    // ОБРАБОТЧИК ПЕРЕНЕСЕН ВЫШЕ - используется updateUIFromServerData
    // Дублирующий обработчик удален

    // Вспомогательные функции
    function setPlayPauseIcon(iconId, isPlaying) {
      const icon = document.getElementById(iconId);
      icon.innerHTML = isPlaying
        ? `<rect x="8" y="6" width="5" height="20" fill="white"/><rect x="19" y="6" width="5" height="20" fill="white"/>`
        : `<polygon points="8,6 26,16 8,26" fill="white"/>`;
    }

    function setTimeInputFromSeconds(inputId, sec) {
      const input = document.getElementById(inputId);
      const mm = Math.floor(sec/60).toString().padStart(2, '0');
      const ss = (sec%60).toString().padStart(2, '0');
      input.value = `${mm}:${ss}`;
    }

    function getSecondsFromTimeInput(inputId) {
      const input = document.getElementById(inputId);
      if (!input) {
        return 0;
      }
      const val = input.value || '';
      if (/^\d{2}:\d{2}$/.test(val)) {
        const [mm, ss] = val.split(':').map(Number);
        return mm*60 + ss;
      }
      return 0;
    }

    function getToken() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('token') || 'MySecret111';
    }
    
    // Функция показа уведомлений
    function showNotification(message, type = 'info') {
      // Создание элемента уведомления
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
        color: white;
        padding: 12px 20px;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 10000;
        font-size: 14px;
        max-width: 300px;
        animation: slideIn 0.3s ease-out;
      `;
      notification.textContent = message;
      
      // Добавление стилей анимации
      if (!document.getElementById('notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
          @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(notification);
      
      // Автоматическое удаление через 3 секунды
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    function setupMainTeamPresetSelects() {
      const configs = [
        { id: 'team1TournamentTeamSelect', key: 'team1' },
        { id: 'team2TournamentTeamSelect', key: 'team2' }
      ];
 
      configs.forEach(({ id, key }) => {
        const select = document.getElementById(id);
        if (!select || select.dataset.listenerAttached === 'true') return;
        select.addEventListener('change', () => {
          handleMainTeamPresetSelection(key, select.value);
        });
        select.dataset.listenerAttached = 'true';
      });
    }

    function populateMainTeamPresetSelects() {
      const configs = [
        { id: 'team1TournamentTeamSelect', key: 'team1' },
        { id: 'team2TournamentTeamSelect', key: 'team2' }
      ];

      configs.forEach(({ id, key }) => {
        const select = document.getElementById(id);
        if (!select) return;

        const previousValue = select.value;

        select.innerHTML = '<option value="">-- Выберите команду --</option>';

        if (!Array.isArray(tournaments) || tournaments.length === 0) {
          select.disabled = true;
          select.classList.add('disabled-field');
          return;
        }

        select.disabled = false;
        select.classList.remove('disabled-field');

        tournaments
          .filter(tournament => tournament && Array.isArray(tournament.teams) && tournament.teams.length > 0)
          .forEach(tournament => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = tournament.name || `Турнир ${tournament.id}`;

            tournament.teams.forEach(team => {
              if (!team) return;
              const value = buildTournamentTeamOptionValue(tournament.id, team.id);
              const option = document.createElement('option');
              option.value = value;
              option.textContent = `${team.name || 'Без названия'}${team.city ? ' (' + team.city + ')' : ''}`;
              option.dataset.tournamentId = String(tournament.id);
              option.dataset.teamId = String(team.id);
              optgroup.appendChild(option);
            });

            select.appendChild(optgroup);
          });

        if (previousValue) {
          const exists = Array.from(select.options).some(opt => opt.value === previousValue);
          select.value = exists ? previousValue : '';
        } else {
          select.value = '';
        }

        const timerActive = !!timerRunning || !!window.timerRunning;
        if (timerActive) {
          select.disabled = true;
          select.classList.add('disabled-field');
        }

        if (select.disabled && select.options.length === 1) {
          select.classList.add('disabled-field');
        }

        if (select.dataset.listenerAttached !== 'true') {
          select.addEventListener('change', () => {
            handleMainTeamPresetSelection(key, select.value);
          });
          select.dataset.listenerAttached = 'true';
        }
      });

      syncMainTeamPresetSelectsFromState();
+      toggleMainTeamPresetSelects(!timerRunning);
    }

    function handleMainTeamPresetSelection(teamKey, value) {
      if (timerRunning) {
        console.warn('Выбор команды заблокирован во время работы таймера');
        syncMainTeamPresetSelectsFromState();
        return;
      }

      if (!value) {
        mainTeamSelection[teamKey] = null;
        syncMainTeamPresetSelectsFromState();
        return;
      }

      if (!confirmBreakWarningIfNeeded()) {
        syncMainTeamPresetSelectsFromState();
        return;
      }

      const parsed = parseTournamentTeamOptionValue(value);
      if (!parsed) {
        console.warn('Не удалось разобрать значение выбора команды:', value);
        return;
      }

      const tournament = (tournaments || []).find(t => String(t.id) === parsed.tournamentId);
      if (!tournament || !Array.isArray(tournament.teams)) {
        console.warn('Турнир не найден для выбора команды:', parsed.tournamentId);
        return;
      }

      const team = tournament.teams.find(t => String(t.id) === parsed.teamId);
      if (!team) {
        console.warn('Команда не найдена в выбранном турнире:', parsed.teamId);
        return;
      }

      mainTeamSelection[teamKey] = {
        tournamentId: String(tournament.id),
        teamId: String(team.id)
      };
      selectedTeams[teamKey] = team;

      applyMainTeamData(teamKey, team);
      syncMainTeamPresetSelectsFromState();
    }

    function applyMainTeamData(teamKey, team) {
      const wasReady = ready;
      ready = false;

      const nameDisplay = document.getElementById(`${teamKey}NameDisplay`);
      const cityDisplay = document.getElementById(`${teamKey}CityDisplay`);
      const kitInput = document.getElementById(teamKey === 'team1' ? 'kit1Color' : 'kit2Color');

      if (nameDisplay) nameDisplay.textContent = team.name || 'Не введено';
      if (cityDisplay) cityDisplay.textContent = team.city || 'Не введено';
      
      // Сохраняем шорткод в состояние для отправки на сервер
      const fallbackShort = team.short || (team.name ? team.name.replace(/[^A-Za-zА-Яа-я0-9]/g, '').slice(0, 3).toUpperCase() : '');
      const shortDisplay = document.getElementById(`${teamKey}ShortDisplay`);
      if (shortDisplay) shortDisplay.textContent = fallbackShort || '---';
      
      if (teamKey === 'team1') {
        scoreboardState.team1Short = fallbackShort;
      } else {
        scoreboardState.team2Short = fallbackShort;
      }

      const kitColor = team.kitColor || '#2b2b2b';
      if (kitInput) {
        kitInput.value = kitColor;
        kitInput.style.backgroundColor = kitColor;
      }

      const logoKey = `${teamKey}Logo`;
      state[logoKey] = team.logo || '';
      if (team.logo && team.logo.trim()) {
        updateMainLogoMini(teamKey, team.logo);
      } else {
        updateMainLogoMini(teamKey, '');
        showKitColorCircle(teamKey);
      }

      ready = wasReady;

      if (kitInput) {
        kitInput.dispatchEvent(new Event('input', { bubbles: true }));
        kitInput.dispatchEvent(new Event('change', { bubbles: true }));
      }

      sendState();
    }

    function syncMainTeamPresetSelectsFromState() {
      const configs = [
        { id: 'team1TournamentTeamSelect', key: 'team1' },
        { id: 'team2TournamentTeamSelect', key: 'team2' }
      ];

      configs.forEach(({ id, key }) => {
        const select = document.getElementById(id);
        if (!select) return;

        if (mainTeamSelection[key]) {
          const value = buildTournamentTeamOptionValue(mainTeamSelection[key].tournamentId, mainTeamSelection[key].teamId);
          const exists = Array.from(select.options).some(opt => opt.value === value);
          select.value = exists ? value : '';
          if (!exists) {
            mainTeamSelection[key] = null;
          }
          return;
        }

        const nameDisplay = document.getElementById(`${key}NameDisplay`);
        const cityDisplay = document.getElementById(`${key}CityDisplay`);
        const name = nameDisplay && nameDisplay.textContent !== 'Не введено' ? nameDisplay.textContent.trim() : '';
        const city = cityDisplay && cityDisplay.textContent !== 'Не введено' ? cityDisplay.textContent.trim() : '';

        if (!name) {
          select.value = '';
          return;
        }

        const found = findTournamentTeamByNameCity(name, city);
        if (found) {
          const value = buildTournamentTeamOptionValue(found.tournamentId, found.team.id);
          const exists = Array.from(select.options).some(opt => opt.value === value);
          if (exists) {
            select.value = value;
            mainTeamSelection[key] = {
              tournamentId: String(found.tournamentId),
              teamId: String(found.team.id)
            };
          } else {
            select.value = '';
            mainTeamSelection[key] = null;
          }
        } else {
          select.value = '';
          mainTeamSelection[key] = null;
        }
      });
    }

    function findTournamentTeamByNameCity(name, city) {
      if (!name || !Array.isArray(tournaments)) return null;
      const normalizedName = name.trim().toLowerCase();
      const normalizedCity = city ? city.trim().toLowerCase() : '';

      for (const tournament of tournaments) {
        if (!tournament || !Array.isArray(tournament.teams)) continue;
        const team = tournament.teams.find(t => {
          if (!t || !t.name) return false;
          const teamName = t.name.trim().toLowerCase();
          if (teamName !== normalizedName) return false;
          if (!normalizedCity) return true;
          const teamCity = t.city ? t.city.trim().toLowerCase() : '';
          return teamCity === normalizedCity;
        });

        if (team) {
          return { tournamentId: String(tournament.id), team };
        }
      }

      return null;
    }

    function buildTournamentTeamOptionValue(tournamentId, teamId) {
      return `${String(tournamentId)}__${String(teamId)}`;
    }

    function parseTournamentTeamOptionValue(value) {
      if (!value) return null;
      const parts = value.split('__');
      if (parts.length < 2) return null;
      const tournamentId = parts.shift();
      const teamId = parts.join('__');
      if (!tournamentId || !teamId) return null;
      return { tournamentId: String(tournamentId), teamId: String(teamId) };
    }

    function toggleMainTeamPresetSelects(enabled) {
      ['team1TournamentTeamSelect', 'team2TournamentTeamSelect'].forEach(id => {
        const select = document.getElementById(id);
        if (!select) return;

        const shouldDisable = !enabled || select.options.length === 0;
        select.toggleAttribute('disabled', shouldDisable);
        select.classList.toggle('disabled-field', shouldDisable);
      });
    }
  </script>
  
  <!-- Ссылка на настройки -->
  <div style="text-align: center; margin-top: 40px; padding: 20px; background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <a id="settingsLink" href="#" style="color: #338af3; text-decoration: none; font-size: 16px; font-weight: bold;">
      ⚙️ Настройки
    </a>
  </div>
  
  <script>
    // Устанавливаем ссылку на настройки с токеном
    document.addEventListener('DOMContentLoaded', function() {
      const settingsLink = document.getElementById('settingsLink');
      if (settingsLink) {
        settingsLink.href = `/private/settings.html?token=${getToken()}`;
      }
    });
  </script>
</body>
</html>
</html>
</html>