# Smoke Test для FSCOREBOARD

Проверочный список для локального запуска и продакшн развёртывания.

## Локальный запуск (npm start)

### Предварительные проверки
- [ ] Node.js 18+ установлен
- [ ] npm install выполнен успешно
- [ ] Файл .env создан и настроен
- [ ] Токен в .env изменён с дефолтного

### Запуск и базовые проверки
```bash
# 1. Запуск приложения
npm start

# 2. Проверка, что сервер запустился
curl -I http://localhost:3001/healthz
# Ожидаемый результат: HTTP/1.1 200 OK

# 3. Проверка панели управления (замените TOKEN на ваш)
curl -I "http://localhost:3001/control?token=YOUR_TOKEN"
# Ожидаемый результат: HTTP/1.1 200 OK

# 4. Проверка без токена (должна быть ошибка)
curl -I "http://localhost:3001/control"
# Ожидаемый результат: HTTP/1.1 403 Forbidden
```

### Проверка оверлеев
- [ ] http://localhost:3001/scoreboard_vmix.html — загружается
- [ ] http://localhost:3001/htbreak.html — загружается  
- [ ] http://localhost:3001/htbreak_score.html — загружается
- [ ] http://localhost:3001/preloader.html — загружается

### Проверка API
```bash
# Получение состояния (замените TOKEN)
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:3001/api/state

# Обновление состояния
curl -X PUT \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"score1": 2, "score2": 1}' \
     http://localhost:3001/api/state
```

### Проверка Socket.IO
1. Откройте http://localhost:3001/control?token=YOUR_TOKEN
2. Проверьте, что панель управления загружается
3. Проверьте индикатор подключения (должен быть зелёный)
4. Попробуйте изменить счёт — изменения должны отображаться
5. Попробуйте управление таймером

## Продакшн развёртывание (PM2 + Nginx)

### Предварительные проверки
- [ ] Ubuntu 24.04 с root/sudo доступом
- [ ] Node.js LTS установлен
- [ ] PM2 установлен глобально
- [ ] Nginx установлен и запущен
- [ ] Доменное имя настроено
- [ ] SSL сертификат получен

### Проверка PM2
```bash
# 1. Запуск приложения
sudo pm2 start ecosystem.config.js --env production

# 2. Проверка статуса
sudo pm2 status
# Ожидаемый результат: fscoreboard online

# 3. Проверка логов
sudo pm2 logs fscoreboard --lines 20

# 4. Проверка автозапуска
sudo pm2 save
sudo pm2 startup
```

### Проверка Nginx
```bash
# 1. Проверка конфигурации
sudo nginx -t
# Ожидаемый результат: syntax is ok, test is successful

# 2. Перезапуск Nginx
sudo systemctl restart nginx

# 3. Проверка статуса
sudo systemctl status nginx
# Ожидаемый результат: active (running)
```

### Проверка доступности
```bash
# 1. HTTP редирект на HTTPS
curl -I http://your-domain.com
# Ожидаемый результат: HTTP/1.1 301 Moved Permanently

# 2. HTTPS доступность
curl -I https://your-domain.com/healthz
# Ожидаемый результат: HTTP/2 200

# 3. Панель управления
curl -I "https://your-domain.com/control?token=YOUR_TOKEN"
# Ожидаемый результат: HTTP/2 200

# 4. API через HTTPS
curl -H "Authorization: Bearer YOUR_TOKEN" \
     https://your-domain.com/api/state
```

### Проверка WebSocket
1. Откройте https://your-domain.com/control?token=YOUR_TOKEN
2. Проверьте, что панель управления загружается по HTTPS
3. Проверьте индикатор подключения
4. Проверьте работу таймера и счёта

## Функциональные тесты

### Тест таймера
1. Откройте панель управления
2. Нажмите "Играть" — таймер должен запуститься
3. Нажмите "Пауза" — таймер должен остановиться
4. Установите время (например, 1200 секунд) — таймер должен обновиться
5. Перезапустите сервер — таймер должен сохранить состояние

### Тест счёта
1. Измените счёт команд через панель управления
2. Проверьте, что изменения отображаются на всех оверлеях
3. Проверьте, что изменения сохраняются после перезапуска

### Тест команд
1. Измените названия команд
2. Измените города команд
3. Измените шорткоды (только A-ZА-Я0-9, до 3 символов)
4. Измените цвета форм (hex формат)
5. Проверьте, что все изменения отображаются на оверлеях

### Тест валидации
1. Попробуйте ввести некорректные данные:
   - Отрицательный счёт (должен стать 0)
   - Шорткод длиннее 3 символов (должен обрезаться)
   - Некорректный цвет (должен остаться предыдущий)
   - Специальные символы в шорткоде (должны удалиться)

## Тест безопасности

### Тест токен-защиты
1. Попробуйте открыть /control без токена — должна быть ошибка 403
2. Попробуйте открыть /control с неверным токеном — должна быть ошибка 403
3. Попробуйте API без токена — должна быть ошибка 401
4. Попробуйте API с неверным токеном — должна быть ошибка 403

### Тест rate limiting
1. Выполните много запросов к API — должны появиться ограничения
2. Проверьте заголовки ответа на наличие X-RateLimit-*

### Тест HTTPS
1. Убедитесь, что все соединения используют HTTPS
2. Проверьте, что HTTP редиректится на HTTPS
3. Проверьте SSL сертификат в браузере

## Мониторинг

### Проверка логов
```bash
# Логи приложения
sudo pm2 logs fscoreboard --lines 50

# Логи Nginx
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# Системные логи
sudo journalctl -u nginx -f
```

### Проверка ресурсов
```bash
# Использование памяти и CPU
sudo pm2 monit

# Сетевая активность
sudo netstat -tlnp | grep :3001
sudo ss -tuln | grep :3001
```

## Устранение неполадок

### Если приложение не запускается
1. Проверьте логи: `sudo pm2 logs fscoreboard --err`
2. Проверьте конфигурацию: `sudo pm2 show fscoreboard`
3. Проверьте переменные окружения: `sudo pm2 env fscoreboard`

### Если Nginx не работает
1. Проверьте конфигурацию: `sudo nginx -t`
2. Проверьте статус: `sudo systemctl status nginx`
3. Проверьте логи: `sudo journalctl -u nginx`

### Если WebSocket не работает
1. Проверьте конфигурацию Nginx для WebSocket
2. Проверьте, что приложение запущено на порту 3001
3. Проверьте SSL сертификат

### Если API не отвечает
1. Проверьте токен в заголовке Authorization
2. Проверьте rate limiting
3. Проверьте логи на ошибки

## Критерии успеха

### Локальный запуск
- [ ] Сервер запускается без ошибок
- [ ] Все URL доступны
- [ ] Панель управления работает с токеном
- [ ] API отвечает с правильным токеном
- [ ] Socket.IO соединения работают
- [ ] Таймер и счёт функционируют

### Продакшн развёртывание
- [ ] PM2 запускает приложение
- [ ] Nginx проксирует запросы
- [ ] HTTPS работает корректно
- [ ] SSL сертификат валиден
- [ ] Все функции работают через HTTPS
- [ ] Мониторинг и логи настроены
- [ ] Резервное копирование работает

